Ext.define("conjoon.cn_mail.data.mail.AbstractCompoundKey",{inheritableStatics:{decode:function decode(a){return JSON.parse(atob(decodeURIComponent(a)))},fromRecord:function fromRecord(a){if(!(a instanceof Ext.data.Model)){Ext.raise({msg:"\"rec\" must be an instance of Ext.data.Model",rec:a})}return new this({mailAccountId:a.get("mailAccountId"),id:a.get("id")})},createFor:function createFor(a,b){return new this({mailAccountId:a,id:b})}},config:{mailAccountId:undefined,id:undefined},constructor:function constructor(a){var b=this;if(!a||!a.mailAccountId||!a.id){Ext.raise({msg:"\"cfg\" must be an object containing the properties "+"mailAccountId and id",cfg:a})}b.initConfig(a)},toArray:function toArray(){var a=this;return [a.getMailAccountId(),a.getId()]},toObject:function toObject(){var a=this;return {mailAccountId:a.getMailAccountId(),id:a.getId()}},toString:function toString(){return encodeURIComponent(btoa(JSON.stringify(this.toObject())))},toLocalId:function toLocalId(){var a=this;return a.getMailAccountId()+"-"+a.getId()},applyMailAccountId:function applyMailAccountId(b){var a=this;if(a.getMailAccountId()!==undefined){Ext.raise({msg:"\"mailAccountId\" was already set",mailAccountId:a.getMailAccountId()})}return b},applyId:function applyId(b){var a=this;if(a.getId()!==undefined){Ext.raise({msg:"\"id\" was already set",id:a.getId()})}return b},equalTo:function equalTo(a){var b=this;if(!(a instanceof conjoon.cn_mail.data.mail.AbstractCompoundKey)){return !1}return b.toLocalId()===a.toLocalId()}});Ext.define("conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator",{requires:["coon.core.data.field.CompoundKeyField","conjoon.cn_mail.data.mail.AbstractCompoundKey"],statics:{decorate:function decorate(b){var a=Ext.data.schema.Schema.lookupEntity(b);a.override(this.getPrototypeBody());a.addFields([{name:"localId",type:"string"},{name:"id",type:"cn_core-datafieldcompoundkey"},{name:"mailAccountId",type:"cn_core-datafieldcompoundkey"}]);a.removeFields(["__id__"])},getPrototypeBody:function getPrototypeBody(){return {idProperty:"localId",callerEntityName:"",compoundKeyFields:[],foreignKeyFields:["mailAccountId","id"],previousCompoundKey:null,inheritableStatics:{loadEntity:function loadEntity(b,a,c){if(!(b instanceof conjoon.cn_mail.data.mail.AbstractCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.AbstractCompoundKey",compoundKey:b})}var d=b.toLocalId();a=a||{};a.params=a.params||{};Ext.apply(a.params,b.toObject());return this.load(d,a,c)}},save:function save(c){var a=this;var b;if(a.dropped&&a.phantom){return a.callParent(arguments)}if(a.phantom){b=a.data}else {b=Ext.applyIf(Ext.apply({},a.modified),a.data)}a.checkForeignKeysForAction(b,"save");return a.callParent(arguments)},commit:function commit(){var a=this,d=a.getRepresentingCompoundKeyClass();var e=!1;if(!a.phantom&&a.modified){for(var c=0,i=a.foreignKeyFields.length;c<i;c++){if(Object.prototype.hasOwnProperty.call(a.modified,a.foreignKeyFields[c])){e=!0;break}}if(e){var h=Ext.applyIf(Ext.apply({},a.modified),a.data),f=[];for(var b=0,g=a.foreignKeyFields.length;b<g;b++){f.push(h[a.foreignKeyFields[b]])}a.previousCompoundKey=d.createFor.apply(d,f)}}return a.callParent(arguments)},getRepresentingCompoundKeyClass:function getRepresentingCompoundKeyClass(){Ext.raise("abstract method must be overwritten.")},load:function load(b){var c=this;var a=b?b.params:{};a=a||{};c.checkForeignKeysForAction(a,"read");return c.callParent(arguments)},checkForeignKeysForAction:function checkForeignKeysForAction(a,d){var b=this,e=b.phantom;a=a||{};for(var c=0,f=b.foreignKeyFields.length;c<f;c++){if(b.foreignKeyFields[c]!=="id"){if(!a[b.foreignKeyFields[c]]){Ext.raise({msg:"\""+b.foreignKeyFields[c]+"\" must be set",action:d,foreignKeField:a[b.foreignKeyFields[c]]})}}else if((d==="read"||!e)&&!a.id){Ext.raise({msg:"\"id\" must be set before",action:d,id:a.id})}}return !0},getAssociatedCompoundKeyedData:function getAssociatedCompoundKeyedData(){return []},set:function set(i,p){var a=this;var j=Ext.isString(i)?i:Ext.clone(i),e=a.getAssociatedCompoundKeyedData(),s=a.callParent(arguments),b=[],f={},d,n,c,g;if(Ext.isString(j)){f[j]=p}else {f=j}for(var k=0,q=e.length;k<q;k++){g=null;c=e[k];b=Ext.isArray(a.compoundKeyFields)?a.compoundKeyFields:a.compoundKeyFields[c.entityName];if(c.entityName===a.callerEntityName){continue}c.callerEntityName=a.entityName;for(d in f){g=d;if(Ext.isArray(b)&&b.indexOf(d)===-1||!Ext.isArray(b)&&!b[d]){continue}if(!Ext.isArray(b)){g=b[d]}n=f[d];c.set(g,n,{dirty:!1})}c.callerEntityName=""}var m=!1;for(var l=0,r=a.foreignKeyFields.length;l<r;l++){if(Object.prototype.hasOwnProperty.call(f,a.foreignKeyFields[l])){m=!0;break}}if(m){a.updateLocalId();e=a.getAssociatedCompoundKeyedData();for(var h=0,o=e.length;h<o;h++){e[h].updateLocalId()}}return s},compareAndApplyCompoundKeys:function compareAndApplyCompoundKeys(e){var p=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!0;var c=this;var a=Ext.isArray(c.compoundKeyFields)?c.compoundKeyFields:c.compoundKeyFields[e.entityName],b,d,o={};if(Ext.isArray(a)){for(var h=0,q=a.length;h<q;h++){o[a[h]]=a[h]}a=o}for(var m in a){b=m;d=a[m]}var l=0,k=0,j,f;for(var n in a){b=n;d=a[n];if(c.get(b)){l++}if(e.get(d)){k++}}var i=!1;if(k>=l&&p===!0){j=c;f=e;i=!0}else {j=e;f=c}for(var g in a){b=i?a[g]:g;d=i?g:a[g];if(b===c.getIdProperty()||d===e.getIdProperty()){continue}if(f.get(b)){j.set(d,f.get(b),{dirty:!1})}}return !0},updateLocalId:function updateLocalId(){var a=this,d=a.getRepresentingCompoundKeyClass();if(!a.isCompoundKeyConfigured()){return null}var e=[],b;for(var c=0,f=a.foreignKeyFields.length;c<f;c++){e.push(a.get(a.foreignKeyFields[c]))}b=d.createFor.apply(d,e).toLocalId();if(a.getId()===b){return b}a.setId(b,{dirty:!1});return b},isCompoundKeySet:function isCompoundKeySet(){var a=this;for(var b=0,c=a.foreignKeyFields.length;b<c;b++){if(!a.get(a.foreignKeyFields[b])){return !1}}return !0},processRecordAssociation:Ext.emptyFn,getCompoundKey:function getCompoundKey(){"use strict";var a=this,b=a.getRepresentingCompoundKeyClass();a.hasKeysModified(!0);return b.fromRecord(a)},hasKeysModified:function hasKeysModified(){var d=arguments.length>0&&arguments[0]!==undefined?arguments[0]:!1;var a=this,c=a.modified;if(!c){return !1}for(var b=0,e=a.foreignKeyFields.length;b<e;b++){if(Object.prototype.hasOwnProperty.call(c,a.foreignKeyFields[b])&&c[a.foreignKeyFields[b]]!==undefined){if(d===!0){Ext.raise("Field was modified, can not use current information.")}return !0}}return !1},getPreviousCompoundKey:function getPreviousCompoundKey(){var a=this;return a.previousCompoundKey?a.previousCompoundKey:a.getCompoundKey()},isCompoundKeyConfigured:function isCompoundKeyConfigured(){var a=this,c=a.data;for(var b=0,d=a.foreignKeyFields.length;b<d;b++){if(Ext.isEmpty(c[a.foreignKeyFields[b]])){return !1}}return !0}}}}});Ext.define("conjoon.cn_mail.data.mail.message.proxy.UtilityMixin",{purgeFilter:function purgeFilter(b,f){var c=Ext.decode(b.filter),e={},d=[];for(var a=0,g=c.length;a<g;a++){if(f.indexOf(c[a].property)===-1){d.push(c[a])}else {e[c[a].property]=c[a].value}}b=Ext.apply(b,e);if(!d.length){delete b.filter}else {b.filter=Ext.encode(d)}}});Ext.define("conjoon.cn_mail.data.mail.BaseProxy",{extend:"Ext.data.proxy.Rest",requires:["conjoon.cn_mail.data.mail.message.proxy.UtilityMixin","coon.core.data.request.Configurator"],mixins:{utilityMixin:"conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"},inheritableStatics:{required:{requestConfigurator:"coon.core.data.request.Configurator"}},entityName:null,appendId:!1,sendRequest:function sendRequest(a){var b=this;a=b.requestConfigurator.configure(a);return b.callParent([a])}});Ext.define("conjoon.cn_mail.data.mail.message.CompoundKey",{extend:"conjoon.cn_mail.data.mail.AbstractCompoundKey",inheritableStatics:{fromRecord:function fromRecord(a){if(!(a instanceof Ext.data.Model)){Ext.raise({msg:"\"rec\" must be an instance of Ext.data.Model",rec:a})}return new this({mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId"),id:a.get("id")})},createFor:function createFor(a,b,c){return new this({mailAccountId:a,mailFolderId:b,id:c})}},config:{mailFolderId:undefined},constructor:function constructor(a){var b=this;if(!a||!a.mailAccountId||!a.mailFolderId||!a.id){Ext.raise({msg:"\"cfg\" must be an object containing the properties "+"mailAccountId, mailFolderId and id",cfg:a})}b.callParent(arguments)},toArray:function toArray(){var a=this;return [a.getMailAccountId(),a.getMailFolderId(),a.getId()]},toObject:function toObject(){var a=this;return {mailAccountId:a.getMailAccountId(),mailFolderId:a.getMailFolderId(),id:a.getId()}},toLocalId:function toLocalId(){var a=this;return a.getMailAccountId()+"-"+a.getMailFolderId()+"-"+a.getId()},applyMailFolderId:function applyMailFolderId(b){var a=this;if(a.getMailFolderId()!==undefined){Ext.raise({msg:"\"mailFolderId\" was already set",mailFolderId:a.getMailFolderId()})}return b}});Ext.define("conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",{extend:"conjoon.cn_mail.data.mail.message.CompoundKey"});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader",{extend:"Ext.data.reader.Json",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"reader.cn_mail-mailmessageentityjsonreader",rootProperty:"data",getResponseData:function getResponseData(b){var d=this,c=b.request.action,a=d.callParent(arguments);if(!a.metaData){a.metaData={}}a.metaData.cn_action=c;return a},readRecords:function readRecords(a,e,d){var c=this,b=a&&a.metaData?a.metaData.cn_action:"";if(b!=="destroy"){a=c.applyCompoundKey(a,b)}return c.callParent([a,e,d])},applyCompoundKey:function applyCompoundKey(a,f){var d=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey,g=["create","update","read","destroy"];if(g.indexOf(f)===-1){var h=g.join(", ");Ext.raise("unexpected value for \"action\", expected any of \"".concat(h,"\", but got \"").concat(f,"\""))}if(Ext.isObject(a)){if(Ext.isArray(a.data)){var e=a.data,c,i=e.length,b;for(c=0;c<i;c++){b=e[c];b.localId=d.createFor(b.mailAccountId,b.mailFolderId,b.id).toLocalId()}return a}else if(Ext.isObject(a.data)){a.data.localId=d.createFor(a.data.mailAccountId,a.data.mailFolderId,a.data.id).toLocalId();return a}}if(Ext.isObject(a)&&a.success===!1){return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})}});Ext.define("conjoon.cn_mail.data.mail.message.writer.MessageEntityWriter",{extend:"Ext.data.writer.Json",alias:"writer.cn_mail-mailmessageentitywriter",writeRecords:function writeRecords(a,f){var e=this;a=e.callParent(arguments);var d=a.getJsonData(),b={},c=Object.fromEntries(Object.entries(d).filter(function(b){return !["messageBodyId","id","localId","mailAccountId","mailFolderId"].includes(b[0])}));b.data=Object.fromEntries(Object.entries(d).filter(function(b){return ["id","mailAccountId","mailFolderId"].includes(b[0])}));b.data.type=a.getProxy().entityName;if(a.getParams()&&a.getParams().action==="move"){c.mailFolderId=b.data.mailFolderId;b.data.mailFolderId=a.getOperation().getRecords()[0].modified.mailFolderId;delete a.getParams().action}b.data.attributes=c;a.setJsonData(b);return a}});Ext.define("conjoon.cn_mail.data.mail.message.proxy.MessageEntityProxy",{extend:"conjoon.cn_mail.data.mail.BaseProxy",requires:["l8","conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader","conjoon.cn_mail.data.mail.message.writer.MessageEntityWriter"],alias:"proxy.cn_mail-mailmessageentityproxy",writer:{type:"cn_mail-mailmessageentitywriter"},reader:{type:"cn_mail-mailmessageentityjsonreader"},idParam:"localId",validEntityNames:["MessageDraft","MessageItem","MessageBody"],assembleUrl:function assembleUrl(b){if(b.getRecords()&&b.getRecords().length>1){Ext.raise({msg:"Doesn't support batch operations with multiple records.",request:b})}var c=this,d=b.getParams()||{};if(c.validEntityNames.indexOf(c.entityName)===-1){Ext.raise({msg:"The entityName (\""+c.entityName+"\") is not allowed to be used with the url builder of this proxy.",entityName:c.entityName})}var h=c.getUrl(b),j=b.getAction(),e=b.getRecords()?b.getRecords()[0]:null,a;if(!h.match(c.slashRe)){h+="/"}if(j==="read"){a=d;if(a.filter){c.purgeFilter(d,["mailAccountId","mailFolderId"])}else if(e&&!a.id){a.id=e.data.id}}else if(e.phantom){a=e.data}else {a=Ext.applyIf(Ext.apply({},e.modified),e.data)}if(!a.mailAccountId||!a.mailFolderId){Ext.raise({msg:"Missing compound keys.",source:a})}h+="MailAccounts/"+encodeURIComponent(a.mailAccountId)+"/"+"MailFolders/"+encodeURIComponent(a.mailFolderId)+"/"+"MessageItems";var g=c.entityName,i="",f={target:g};switch(j){case "destroy":case "create":delete f.target;break;case "update":delete f.target;i=c.entityName;break;case "read":if(["MessageBody","MessageItem","MessageDraft"].includes(g)){i=g==="MessageBody"?"MessageBody":"";f=Object.assign({},c.getDefaultParameters(g))};break;}if(g==="MessageItem"&&j==="update"&&a.mailFolderId!==e.get("mailFolderId")){f.action="move"}b.setParams(Object.assign(b.getParams()||{},f));if(j!=="create"){if(Object.prototype.hasOwnProperty.call(a,"id")){h+="/"+a.id+(i?"/"+i:"")}}if(d){delete d.mailFolderId;delete d.mailAccountId;delete d.id;delete d.localId}return h},buildUrl:function buildUrl(a){var b=this,c=b.assembleUrl(a);a.setUrl(c);return b.callParent([a])},getDefaultParameters:function getDefaultParameters(b){var a={MessageItem:{attributes:"*,previewText,replyTo,cc,bcc"},MessageDraft:{attributes:"*,previewText,hasAttachments,size"},ListMessageItem:{options:JSON.stringify({previewText:{plain:{precedence:!0,length:200},html:{length:200}}}),limit:-1}};return l8.unchain(b,a,{})},getMethod:function getMethod(b){var a={create:"POST",read:"GET",update:"PATCH",destroy:"DELETE"};return a[b.getAction()]}});Ext.define("conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey",{extend:"conjoon.cn_mail.data.mail.message.CompoundKey",statics:{fromRecord:function fromRecord(a){if(!(a instanceof Ext.data.Model)){Ext.raise({msg:"\"rec\" must be an instance of Ext.data.Model",rec:a})}return new this({mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId"),parentMessageItemId:a.get("parentMessageItemId"),id:a.get("id")})},createFor:function createFor(b,c,a,d){return new this({mailAccountId:b,mailFolderId:c,parentMessageItemId:a,id:d})}},config:{parentMessageItemId:undefined},constructor:function constructor(a){var b=this;if(!a||!a.parentMessageItemId){Ext.raise({msg:"\"cfg\" must be an object containing the property parentMessageItemId",cfg:a})}b.callParent(arguments)},toArray:function toArray(){var b=this;var a=b.callParent(arguments);a.splice(2,0,b.getParentMessageItemId());return a},toObject:function toObject(){var b=this;var a=b.callParent(arguments);a.parentMessageItemId=b.getParentMessageItemId();return a},toLocalId:function toLocalId(){var a=this;return a.getMailAccountId()+"-"+a.getMailFolderId()+"-"+a.getParentMessageItemId()+"-"+a.getId()},applyParentMessageItemId:function applyParentMessageItemId(b){var a=this;if(a.getParentMessageItemId()!==undefined){Ext.raise({msg:"\"parentMessageItemId\" was already set",parentMessageItemId:a.getParentMessageItemId()})}return b}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageItemChildJsonReader",{extend:"conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey"],alias:"reader.cn_mail-mailmessageitemchildjsonreader",applyCompoundKey:function applyCompoundKey(a,d){var j=conjoon.cn_mail.data.mail.message.compoundKey,g=j.MessageEntityCompoundKey,f=j.MessageItemChildCompoundKey,i=["create","update","read","destroy"];if(i.indexOf(d)===-1){var k=i.join(", ");Ext.raise("unexpected value for \"action\", expected any of \"".concat(k,"\", but got \"").concat(d,"\""))}if(Ext.isObject(a)){if(Ext.isArray(a.data)){var h=a.data,l=h.length,b,e;for(e=0;e<l;e++){b=h[e];b.localId=f.createFor(b.mailAccountId,b.mailFolderId,b.parentMessageItemId,b.id).toLocalId();if(d==="read"){b.messageItemId=g.createFor(b.mailAccountId,b.mailFolderId,b.parentMessageItemId).toLocalId()}}return a}else if(Ext.isObject(a.data)){var c=a.data;c.localId=f.createFor(c.mailAccountId,c.mailFolderId,c.parentMessageItemId,c.id).toLocalId();if(d==="read"){c.messageItemId=g.createFor(c.mailAccountId,c.mailFolderId,c.parentMessageItemId).toLocalId()}return a}}if(Ext.isObject(a)&&(a.success===!1||a.success===!0)){return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})}});function _createForOfIteratorHelper(a,j){var b=typeof Symbol!=="undefined"&&a[Symbol.iterator]||a["@@iterator"];if(!b){if(Array.isArray(a)||(b=_unsupportedIterableToArray(a))||j&&a&&typeof a.length==="number"){if(b){a=b}var i=0;var c=function c(){};return {s:c,n:function n(){if(i>=a.length){return {done:!0}}return {done:!1,value:a[i++]}},e:function e(b){throw b},f:c}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d=!0,g=!1,h;return {s:function s(){b=b.call(a)},n:function n(){var c=b.next();d=c.done;return c},e:function e(b){g=!0;h=b},f:function f(){try{if(!d&&b["return"]!=null){b["return"]()}}finally{if(g){throw h}}}}}function _unsupportedIterableToArray(a,c){if(!a){return}if(typeof a==="string"){return _arrayLikeToArray(a,c)}var b=Object.prototype.toString.call(a).slice(8,-1);if(b==="Object"&&a.constructor){b=a.constructor.name}if(b==="Map"||b==="Set"){return Array.from(a)}if(b==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b)){return _arrayLikeToArray(a,c)}}function _arrayLikeToArray(c,a){if(a==null||a>c.length){a=c.length}for(var b=0,d=new Array(a);b<a;b++){d[b]=c[b]}return d}Ext.define("conjoon.cn_mail.data.mail.message.writer.AttachmentWriter",{extend:"coon.core.data.writer.FormData",alias:"writer.cn_mail-mailmessageattachmentwriter",writeRecords:function writeRecords(e,j){var i=this,c=i.callParent(arguments);if(!(c instanceof coon.core.data.FormDataRequest)){return c}var h=c.getFormData(),a=[];var b=_createForOfIteratorHelper(h.entries()),g;try{var f=function f(){var h=g.value;var k=h[0],f=h[1];var b=/(.*)\[(\d*)\]\[(.*)\]/gmi,i=["","type","index","keyName"];var c=void 0;var d=function d(){if(c.index===b.lastIndex){b.lastIndex++}var d={};c.forEach(function(b,a){d[i[a]]=b});if(!a[d.index]){a[d.index]={}}switch(d.type){case "file":{a[d.index]["blob"]=f};break;case "data":{a[d.index][d.keyName]=f};break;}};while((c=b.exec(k))!==null){d()}};for(b.s();!(g=b.n()).done;){f()}}catch(k){b.e(k)}finally{b.f()}var d=new FormData();a.forEach(function(b,c){var a=Object.entries(b);a.forEach(function(a){var g=a[0],f=a[1];d.set("files[".concat(c,"][").concat(g,"]"),f)})});e.setFormData(d);return e}});Ext.define("conjoon.cn_mail.data.mail.message.proxy.AttachmentProxy",{extend:"coon.core.data.proxy.RestForm",requires:["conjoon.cn_mail.data.mail.message.reader.MessageItemChildJsonReader","conjoon.cn_mail.data.mail.message.writer.AttachmentWriter","conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"],statics:{required:{requestConfigurator:"coon.core.data.request.Configurator"}},mixins:{utilityMixin:"conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"},alias:"proxy.cn_mail-mailmessageattachmentproxy",writer:{type:"cn_mail-mailmessageattachmentwriter"},reader:{type:"cn_mail-mailmessageitemchildjsonreader"},idParam:"localId",appendId:!1,entityName:null,validEntityNames:["DraftAttachment","ItemAttachment"],buildUrl:function buildUrl(b){if(b.getRecords()&&b.getRecords().length>1){Ext.raise({msg:"Doesn't support batch operations with multiple records.",request:b})}var c=this,d=b.getParams();if(c.validEntityNames.indexOf(c.entityName)===-1){Ext.raise({msg:"The entityName (\""+c.entityName+"\") is not allowed to be used with the url builder of this proxy.",entityName:c.entityName})}var f=c.getUrl(b),g=b.getAction(),e=b.getRecords()?b.getRecords()[0]:null,a;if(c.entityName!=="DraftAttachment"&&["create","update","destroy"].indexOf(g)!==-1){Ext.raise({msg:"Unexpected entityName with specified action",entityName:c.entityName,action:g})}if(!f.match(c.slashRe)){f+="/"}if(g==="read"){a=d;if(a.filter){c.purgeFilter(d,["mailAccountId","mailFolderId","parentMessageItemId"])}else if(e&&!a.id){a.id=e.data.id}}else if(e.phantom){a=e.data}else {a=Ext.applyIf(Ext.apply({},e.modified),e.data)}if(!a.mailAccountId||!a.mailFolderId||!a.parentMessageItemId){Ext.raise({msg:"Missing compound keys.",source:a})}f+="MailAccounts/"+encodeURIComponent(a.mailAccountId)+"/"+"MailFolders/"+encodeURIComponent(a.mailFolderId)+"/"+"MessageItems/"+encodeURIComponent(a.parentMessageItemId)+"/"+"Attachments";if(g!=="create"){if(Object.prototype.hasOwnProperty.call(a,"id")){f+="/"+a.id}}if(d){delete d.mailFolderId;delete d.mailAccountId;delete d.parentMessageItemId;delete d.id;delete d.localId}b.setUrl(f);return c.callParent([b])},sendRequest:function sendRequest(a){var b=this;a=b.requestConfigurator.configure(a);return b.callParent([a])}});Ext.define("conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey",{extend:"conjoon.cn_mail.data.mail.AbstractCompoundKey"});Ext.define("conjoon.cn_mail.data.mail.folder.reader.MailFolderJsonReader",{extend:"Ext.data.reader.Json",requires:["conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey"],alias:"reader.cn_mail-mailfolderjsonreader",mailFolderModelClass:"conjoon.cn_mail.model.mail.folder.MailFolder",readRecords:function readRecords(a,d,c){var b=this;a=b.applyCompoundKey(a);return b.callParent([a,d,c])},applyCompoundKey:function applyCompoundKey(a){var b=this;if(Ext.isObject(a)){if(a.success!==!1){b.recurseChildren([].concat(a.data))}return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})},recurseChildren:function recurseChildren(b){if(!Ext.isArray(b)){return}var d=this,e=conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey;var a;for(var c=0,f=b.length;c<f;c++){a=b[c];if(!a||!a.mailAccountId||!a.id){Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:b})}a.modelType=d.mailFolderModelClass;a.localId=e.createFor(a.mailAccountId,a.id).toLocalId();d.recurseChildren(a.data)}}});Ext.define("conjoon.cn_mail.data.mail.folder.MailFolderTypes",{statics:{INBOX:"INBOX",JUNK:"JUNK",TRASH:"TRASH",SENT:"SENT",FOLDER:"FOLDER",DRAFT:"DRAFT",ACCOUNT:"ACCOUNT"}});Ext.define("conjoon.cn_mail.data.mail.account.reader.MailAccountJsonReader",{extend:"Ext.data.reader.Json",requires:["conjoon.cn_mail.data.mail.folder.reader.MailFolderJsonReader","conjoon.cn_mail.data.mail.folder.MailFolderTypes"],alias:"reader.cn_mail-mailaccountjsonreader",rootProperty:"data",typeProperty:"modelType",mailAccountModelClass:"conjoon.cn_mail.model.mail.account.MailAccount",readRecords:function readRecords(a,d,c){var b=this;a=b.processHybridData(a);return b.callParent([a,d,c])},applyModelTypes:function applyModelTypes(a){var b=this,e=conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT,i=b.getTypeProperty();if(Ext.isObject(a)){if(Ext.isArray(a.data)){var f=a.data,c,h=f.length,d;for(c=0;c<h;c++){d=f[c];d.folderType=e;d[i]=b.mailAccountModelClass}return a}else if(Ext.isObject(a.data)){var g=a.data;g.folderType=e;g[b.getTypeProperty()]=b.mailAccountModelClass;return a}}if(Ext.isObject(a)&&a.success===!1){return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})},processHybridData:function processHybridData(a){var b=this;if(b.peekFolder(a)){if(!b.mailFolderReader){b.mailFolderReader=Ext.create("conjoon.cn_mail.data.mail.folder.reader.MailFolderJsonReader")}a=b.mailFolderReader.applyCompoundKey(a)}else {a=b.applyModelTypes(a)}return a},peekFolder:function peekFolder(a){if(Ext.isObject(a)){var b=[].concat(a.data);if(b[0]&&Object.prototype.hasOwnProperty.call(b[0],"mailAccountId")){return !0}}return !1}});Ext.define("conjoon.cn_mail.data.mail.account.proxy.MailAccountProxy",{extend:"conjoon.cn_mail.data.mail.BaseProxy",requires:["conjoon.cn_mail.data.mail.account.reader.MailAccountJsonReader"],alias:"proxy.cn_mail-mailaccountproxy",reader:{type:"cn_mail-mailaccountjsonreader"},idParam:"id",entityName:"MailAccount",buildUrl:function buildUrl(a){if(a.getRecords()&&a.getRecords().length>1){Ext.raise({msg:"Doesn't support batch operations with multiple records.",request:a})}var e=this,d=a.getAction();var b=e.getUrl(a),f=a.getRecords()?a.getRecords()[0]:null,c=a.getParams();if(!b.match(e.slashRe)){b+="/"}if(d!=="read"&&d!=="update"){Ext.raise("Unexpected error; any action other but \"read\" and \"update\" not supported.")}b+="MailAccounts";if(d==="read"){if(c.mailAccountId&&c.mailAccountId!=="root"){b+="/"+c.mailAccountId+"/MailFolders"}}else {b+="/"+f.getId()}if(c){delete c.mailAccountId}a.setUrl(b);return e.callParent([a])}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageItemJsonReader",{extend:"conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"reader.cn_mail-mailmessageitemjsonreader",foreignKeyProp:"messageBodyId",applyCompoundKey:function applyCompoundKey(a,g){var d=this,e=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey;a=d.callParent(arguments);if(Ext.isObject(a)){if(Ext.isArray(a.data)){var f=a.data,h=f.length,b,c;for(c=0;c<h;c++){b=f[c];if(g==="read"){b[d.foreignKeyProp]=e.createFor(b.mailAccountId,b.mailFolderId,b.id).toLocalId()}}return a}else if(Ext.isObject(a.data)){if(g==="read"){a.data[d.foreignKeyProp]=e.createFor(a.data.mailAccountId,a.data.mailFolderId,a.data.id).toLocalId()}return a}}if(Ext.isObject(a)&&a.success===!1){return a}}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageBodyJsonReader",{extend:"conjoon.cn_mail.data.mail.message.reader.MessageItemJsonReader",alias:"reader.cn_mail-mailmessagebodyjsonreader",foreignKeyProp:"messageDraftId"});Ext.define("conjoon.cn_mail.data.mail.BaseSchema",{extend:"coon.core.data.schema.BaseSchema",requires:["l8","conjoon.cn_mail.data.mail.message.proxy.MessageEntityProxy","conjoon.cn_mail.data.mail.message.proxy.AttachmentProxy","conjoon.cn_mail.data.mail.account.proxy.MailAccountProxy","conjoon.cn_mail.data.mail.message.reader.MessageItemJsonReader","conjoon.cn_mail.data.mail.message.reader.MessageBodyJsonReader"],alias:"schema.cn_mail-mailbaseschema",namespace:"conjoon.cn_mail.model.mail",id:"cn_mail-baseschema",urlPrefix:"cn_mail",proxy:{type:"rest",url:"{prefix}"},applyUrlPrefix:function applyUrlPrefix(a){return l8.isString(a)?l8.unify(a,"/","://"):undefined},privates:{constructProxy:function constructProxy(f){var e=this;var a=e.callParent(arguments),d=Ext.Object.chain(f),b=d.entityName,c=e.getUrlPrefix();if(["MessageItem","MessageDraft","MessageBody"].indexOf(b)!==-1){a.entityName=b;a.prefix=c;a.type="cn_mail-mailmessageentityproxy";if(b!=="MessageBody"){a.reader="cn_mail-mailmessageitemjsonreader"}else {a.reader="cn_mail-mailmessagebodyjsonreader"}}else if(["DraftAttachment","ItemAttachment"].indexOf(b)!==-1){a.entityName=b;a.prefix=c;a.type="cn_mail-mailmessageattachmentproxy"}else if(["MailAccount"].indexOf(b)!==-1){a.prefix=c;a.type="cn_mail-mailaccountproxy"}else {a.url=l8.unify(c+"/"+d.entityName,"/","://")}return a}}});Ext.define("conjoon.cn_mail.model.mail.BaseModel",{extend:"coon.core.data.BaseModel",idProperty:"__id__",requires:["conjoon.cn_mail.data.mail.BaseSchema"],schema:"cn_mail-mailbaseschema",constructor:function constructor(){var a=this;if(a.idProperty==="__id__"){Ext.raise({msg:"\"idProperty\" of coon.core.data.BaseModel needs to be explicitly set",idProperty:a.idProperty})}a.callParent(arguments)}});Ext.define("conjoon.cn_mail.model.mail.AbstractCompoundKeyedModel",{requires:["conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator"],extend:"conjoon.cn_mail.model.mail.BaseModel"},function(){conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator.decorate(this)});Ext.define("conjoon.cn_mail.model.mail.message.CompoundKeyedModel",{extend:"conjoon.cn_mail.model.mail.AbstractCompoundKeyedModel",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],fields:[{name:"mailFolderId",type:"cn_core-datafieldcompoundkey"}],compoundKeyFields:["mailAccountId","mailFolderId","id"],foreignKeyFields:["mailAccountId","mailFolderId","id"],getRepresentingCompoundKeyClass:function getRepresentingCompoundKeyClass(){return conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey}});Ext.define("conjoon.cn_mail.model.mail.message.MessageItemChildModel",{extend:"conjoon.cn_mail.model.mail.message.CompoundKeyedModel",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey"],fields:[{name:"parentMessageItemId",type:"cn_core-datafieldcompoundkey"}],foreignKeyFields:["mailAccountId","mailFolderId","parentMessageItemId","id"],getRepresentingCompoundKeyClass:function getRepresentingCompoundKeyClass(){return conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey}});Ext.define("conjoon.cn_mail.model.mail.message.AbstractAttachment",{extend:"conjoon.cn_mail.model.mail.message.MessageItemChildModel",requires:["coon.core.data.field.FileSize","coon.core.data.field.CompoundKeyField"],fields:[{name:"type",type:"string"},{name:"text",type:"string"},{name:"size",type:"int",persist:!1},{name:"previewImgSrc",type:"string",persist:!1},{name:"downloadUrl",type:"string",persist:!1}]});Ext.define("conjoon.cn_mail.store.mail.message.MessageAttachmentStore",{extend:"Ext.data.Store",alias:"store.cn_mail-mailmessageattachmentstore",load:function load(){var a=this;a.checkAndBuildCompoundKeyFilters();return a.callParent(arguments)},add:function add(a){var d=this;if(Ext.isArray(a)){var f=[];for(var e=0,i=a.length;e<i;e++){f.push(d.add(a[e]))}return f}var g=[].concat(a);if(a instanceof Ext.data.Model&&this.findExact("localId",a.getId())>-1){return a}var j=d.callParent(arguments);var b=d.getAssociatedEntity();if(b&&b.entityName==="MessageDraft"){for(var c=0,h=g.length;c<h;c++){b.processRecordAssociation(g[c])}}return j},checkAndBuildCompoundKeyFilters:function checkAndBuildCompoundKeyFilters(){var c=this,j=c.getFilters(),d={mailFolderId:!1,mailAccountId:!1,parentMessageItemId:!1},b=c.getAssociatedEntity()&&c.getAssociatedEntity().entityName==="MessageDraft"?c.getAssociatedEntity():null;var e,a,i,f;for(a in d){for(var g=j.length-1;g>=0;g--){e=j.getAt(g);i=e.getProperty();if(i===a){delete d[a];if(!b&&!e.getValue()){Ext.raise({msg:"no valid value set for filter \""+a+"\"",mailFolderId:e.getValue()})}if(b){f=a==="parentMessageItemId"?b.get("id"):b.get(a);e.setValue(f)}}else if(i==="messageItemId"){c.removeFilter(j.getAt(g),!0)}}}var h=[];for(a in d){if(d[a]===!1){h.push(a)}}if(h.length){if(b){for(var k in d){f=k==="parentMessageItemId"?b.get("id"):b.get(k);c.addFilter({property:k,value:f},!0)}}else {Ext.raise({msg:"filters for properties \"["+h.join(", ")+"]\" not set"})}}return !0}});Ext.define("conjoon.cn_mail.model.mail.message.ItemAttachment",{extend:"conjoon.cn_mail.model.mail.message.AbstractAttachment",requires:["conjoon.cn_mail.store.mail.message.MessageAttachmentStore"],entityName:"ItemAttachment",fields:[{name:"messageItemId",type:"string",reference:{type:"MessageItem",inverse:{role:"attachments",storeConfig:{type:"cn_mail-mailmessageattachmentstore"}}}}]});Ext.define("conjoon.cn_mail.model.mail.message.MessageBody",{extend:"conjoon.cn_mail.model.mail.message.CompoundKeyedModel",requires:["coon.core.data.field.CompoundKeyField"],entityName:"MessageBody",fields:[{name:"textPlain",type:"string"},{name:"textHtml",type:"string"},{persist:!1,name:"messageDraftId",type:"string",reference:{parent:"MessageDraft"},unique:!0,validators:"presence"}],getAssociatedCompoundKeyedData:function getAssociatedCompoundKeyedData(){var a=this;var b=a.getMessageDraft&&a.getMessageDraft()?[a.getMessageDraft()]:[];b=b.concat(a.getMessageItem&&a.getMessageItem()?[a.getMessageItem()]:[]);return b},load:function load(a){var c=this,b=c.getAssociatedCompoundKeyedData();a=a||{};a.params=a.params||{};if(b&&b.length===1&&b[0].entityName==="MessageDraft"){Ext.applyIf(a.params,b[0].getCompoundKey().toObject())}return c.callParent([a])}});Ext.define("conjoon.cn_mail.model.mail.message.AbstractMessageItem",{extend:"conjoon.cn_mail.model.mail.message.CompoundKeyedModel",requires:["conjoon.cn_mail.model.mail.message.MessageBody","coon.core.data.field.EmailAddress"],fields:[{name:"subject",type:"string"},{name:"date",type:"date",dateReadFormat:"Y-m-d H:i:s O"},{name:"from",type:"cn_core-datafieldemailaddress"},{persist:!1,name:"messageBodyId",type:"string",reference:{child:"MessageBody"},unique:!0,validators:"presence"},{name:"seen",type:"bool"},{name:"answered",type:"bool",persist:!1},{name:"flagged",type:"bool"},{name:"draft",type:"bool"},{name:"recent",type:"bool",persist:!1}],loadAttachments:function loadAttachments(b){var a=this;a.attachments().clearFilter(!0);a.attachments().addFilter([{property:"mailAccountId",value:a.get("mailAccountId")},{property:"mailFolderId",value:a.get("mailFolderId")},{property:"parentMessageItemId",value:a.get("id")}],!0);return a.attachments().load(b)},loadMessageBody:function loadMessageBody(b){var a=this;b=b||{};b.params=b.params||{};if(!a.get("mailFolderId")||!a.get("mailAccountId")||!a.get("id")){Ext.raise({msg:"Cannot load MessageBody, compound keys missing",data:a.data})}Ext.applyIf(b.params,{mailFolderId:a.get("mailFolderId"),mailAccountId:a.get("mailAccountId"),id:a.get("id")});return a.getMessageBody(b)},getAssociatedCompoundKeyedData:function getAssociatedCompoundKeyedData(){var a=this;var b=a._messageBody?[a._messageBody]:[];return b.concat(a.attachments().getRange())},privates:{onAssociatedRecordSet:function onAssociatedRecordSet(b,c){var a=this;a.processRecordAssociation(b);return a.callParent(arguments)}},processRecordAssociation:function processRecordAssociation(a){var b=this;if(a.entityName==="MessageBody"){b.compareAndApplyCompoundKeys(a,!0)}}});Ext.define("conjoon.cn_mail.model.mail.message.DraftAttachment",{extend:"conjoon.cn_mail.model.mail.message.AbstractAttachment",requires:["coon.core.data.proxy.RestForm","coon.core.data.field.Blob","conjoon.cn_mail.store.mail.message.MessageAttachmentStore"],entityName:"DraftAttachment",fields:[{persist:!1,name:"messageItemId",type:"string",reference:{parent:"MessageDraft",inverse:{role:"attachments",storeConfig:{type:"cn_mail-mailmessageattachmentstore"}}}},{name:"file",type:"cn_core-datafieldblob"}],compoundKeyFields:{MessageDraft:{"mailAccountId":"mailAccountId","mailFolderId":"mailFolderId","parentMessageItemId":"id"}},getAssociatedCompoundKeyedData:function getAssociatedCompoundKeyedData(){var a=this;return a.getMessageItem&&a.getMessageItem()?[a.getMessageItem()]:[]}});Ext.define("conjoon.cn_mail.model.mail.message.MessageDraft",{extend:"conjoon.cn_mail.model.mail.message.AbstractMessageItem",requires:["coon.core.data.field.EmailAddressCollection","coon.core.data.validator.EmailAddressCollection","conjoon.cn_mail.model.mail.message.DraftAttachment","coon.core.data.field.EmailAddress","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],entityName:"MessageDraft",preBatchCompoundKey:undefined,compoundKeyFields:{MessageBody:["mailAccountId","mailFolderId","id"],DraftAttachment:{"mailAccountId":"mailAccountId","mailFolderId":"mailFolderId","id":"parentMessageItemId"}},fields:[{name:"replyTo",type:"cn_core-datafieldemailaddress"},{name:"to",type:"cn_core-datafieldemailaddresscollection",validators:[{type:"cn_core-datavalidatoremailaddresscollection",allowEmpty:!0}]},{name:"cc",type:"cn_core-datafieldemailaddresscollection",validators:[{type:"cn_core-datavalidatoremailaddresscollection",allowEmpty:!0}]},{name:"bcc",type:"cn_core-datafieldemailaddresscollection",validators:[{type:"cn_core-datavalidatoremailaddresscollection",allowEmpty:!0}]},{name:"draft",type:"bool",defaultValue:!0},{name:"seen",type:"bool",critical:!0,defaultValue:!0},{name:"flagged",type:"bool",critical:!0,defaultValue:!1},{name:"answered",type:"bool",defaultValue:!1},{name:"recent",type:"bool",defaultValue:!1,persist:!1},{name:"messageId",type:"string",persist:!1},{name:"references",type:"string",defaultValue:null},{name:"inReplyTo",type:"string",defaultValue:null},{name:"xCnDraftInfo",type:"string",defaultValue:null},{name:"savedAt",type:"date",persist:!1}],processRecordAssociation:function processRecordAssociation(a){var b=this;b.callParent(arguments);if(a.entityName==="DraftAttachment"){b.compareAndApplyCompoundKeys(a,!1)}},storePreBatchCompoundKey:function storePreBatchCompoundKey(){var b=this;var a=undefined;if(b.isCompoundKeyConfigured()){a=b.getCompoundKey();b.preBatchCompoundKey=a}return a},getPreBatchCompoundKey:function getPreBatchCompoundKey(){var a=this;return a.preBatchCompoundKey},loadMessageBody:function loadMessageBody(a){var b=this;a=a||{};a.params=a.params||{};Ext.applyIf(a.params,{target:"MessageBodyDraft"});return b.callParent([a])}});Ext.define("conjoon.cn_mail.model.mail.message.MessageItem",{extend:"conjoon.cn_mail.model.mail.message.AbstractMessageItem",requires:["l8","conjoon.cn_mail.model.mail.message.ItemAttachment","coon.core.data.field.EmailAddressCollection","coon.core.data.field.FileSize"],entityName:"MessageItem",fields:[{name:"hasAttachments",type:"bool"},{name:"to",type:"cn_core-datafieldemailaddresscollection"},{name:"previewText",type:"string",persist:!1,convert:function convert(a,b){return a===undefined?undefined:l8.isNumber(a)||l8.isString(a)?""+a:""}},{name:"size",type:"int",persist:!1},{name:"cn_deleted",type:"bool",persist:!1},{name:"cn_moved",type:"bool",persist:!1}]});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater",{singleton:!0,requires:["conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.model.mail.message.MessageDraft"],updateItemWithDraft:function updateItemWithDraft(b,a){var g=this,e=0,c,d;if(!(b instanceof conjoon.cn_mail.model.mail.message.MessageItem)){Ext.raise({msg:"messageItem must be an instance of 'conjoon.cn_mail.model.mail.message.MessageItem'",cls:Ext.getClassName(g),messageItem:b})}if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({msg:"messageDraft must be an instance of 'conjoon.cn_mail.model.mail.message.MessageDraft'",cls:Ext.getClassName(g),messageDraft:a})}c=a.attachments().getRange();d=a.getMessageBody();e+=d.get("textPlain").length;e+=d.get("textHtml").length;for(var f=0,i=c.length;f<i;f++){e+=c[f].get("size")}var h={date:a.get("date"),to:a.get("to"),subject:a.get("subject"),hasAttachments:c.length>0,previewText:d.get("textPlain"),size:e,from:a.get("from"),seen:a.get("seen"),flagged:a.get("flagged"),recent:a.get("recent"),answered:a.get("answered"),draft:a.get("draft"),id:a.get("id"),messageBodyId:a.get("messageBodyId")};b.set(h);b.commit();return b},createItemFromDraft:function createItemFromDraft(a){var b=this;if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({msg:"messageDraft must be an instance of 'conjoon.cn_mail.model.mail.message.MessageDraft'",cls:Ext.getClassName(b),messageDraft:a})}var c=Ext.create("conjoon.cn_mail.model.mail.message.MessageItem",{localId:a.getId(),id:a.get("id"),mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId"),messageBodyId:a.getMessageBody().getId()});return b.updateItemWithDraft(c,a)}});Ext.define("conjoon.cn_mail.text.mail.message.reader.PlainReadableStrategy",{requires:["l8.text.toBlockquote","l8.text.toHyperlink","l8.text.toEmailLink","l8.text.toLineBreak"],process:function process(a){return l8.text.toLineBreak(l8.text.toHyperlink(l8.text.toEmailLink(l8.text.toBlockquote(a))))}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageViewModel",{extend:"Ext.app.ViewModel",requires:["l8","conjoon.cn_mail.model.mail.message.ItemAttachment","conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater","conjoon.cn_mail.text.mail.message.reader.PlainReadableStrategy","coon.core.util.Date","coon.core.ServiceLocator"],alias:"viewmodel.cn_mail-mailmessagereadermessageviewmodel",bodyLoadOperation:null,attachmentsLoadOperation:null,abortedRequestMap:null,emptySubjectText:"(No subject)",constructor:function constructor(){var a=this;a.userImageService=coon.core.ServiceLocator.resolve("coon.core.service.UserImageService");a.callParent(arguments)},data:{hasImages:!1,iframeLoaded:!1,isLoading:!1,messageItem:null,contextButtonsEnabled:!1},stores:{attachmentStore:{model:"conjoon.cn_mail.model.mail.message.ItemAttachment",data:"{attachments}"}},formulas:{textPlainToHtml:{bind:{textPlain:"{messageBody.textPlain}"},get:function get(b){if(!b.textPlain){return ""}var a=this;if(!a.plainReadableStrategy){a.plainReadableStrategy=Ext.create("conjoon.cn_mail.text.mail.message.reader.PlainReadableStrategy")}return a.plainReadableStrategy.process(b.textPlain)}},getSenderImage:{bind:{address:"{messageItem.from.address}"},get:function get(a){return this.userImageService.getImageSrc(a.address)}},getSubject:{bind:{subject:"{messageItem.subject}"},get:function get(a){return a.subject||this.emptySubjectText}},getDisplayToAddress:function getDisplayToAddress(b){var e=b("messageItem"),d=b("messageItem.to");if(!e){return ""}var c=[];for(var a=0,f=d.length;a<f;a++){c.push(d[a].name)}return c.join(", ")},getDisplayFromAddress:function getDisplayFromAddress(b){var c=b("messageItem"),a=b("messageItem.from");if(!c){return ""}return a?a.name:""},getFormattedDate:function getFormattedDate(a){return coon.core.util.Date.getHumanReadableDate(a("messageItem.date"))},getIndicatorText:function getIndicatorText(a){return !a("messageBody")&&!a("messageItem")?"Select a message for reading.":a("messageItem")&&(!a("messageBody")||!a("iframeLoaded"))?"Loading message body...":""},getIndicatorIcon:function getIndicatorIcon(a){return !a("messageBody")&&!a("messageItem")?"far fa-envelope":a("messageItem")&&(!a("messageBody")||!a("iframeLoaded"))?"fas fa-spin fa-spinner":""}},updateMessageItem:function updateMessageItem(a){var b=this,c=b.get("messageItem"),f=[],g,d;if(!c){Ext.raise({msg:"There is currently no messageItem available.",cls:Ext.getClassName(b),messageItem:b.get("messageItem")})}if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({msg:"messageDraft must be an instance of 'conjoon.cn_mail.model.mail.message.MessageDraft'",cls:Ext.getClassName(b),messageDraft:a})}if(a.getCompoundKey().getMailAccountId()!==c.getCompoundKey().getMailAccountId()){Ext.raise({msg:"The accountId of the compoundKey of the messageDraft does not equal to the accountId of the compoundKey of the messageItem",cls:Ext.getClassName(b),messageDraft:a,messageItem:c})}d=a.attachments().getRange();g=a.getMessageBody().copy();for(var e=0,h=d.length;e<h;e++){f.push(d[e].copy())}conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.updateItemWithDraft(c,a);b.set("attachments",f);b.set("messageBody",g)},setMessageItem:function setMessageItem(b){var a=this,c;a.set("messageBody",null);a.set("attachments",[]);if(b&&!(b instanceof conjoon.cn_mail.model.mail.message.MessageItem)){Ext.raise({sourceClass:Ext.getClassName(this),msg:"messageItem needs to be instance of conjoon.cn_mail.model.mail.message.MessageItem"})}a.set("messageItem",b);if(b){c=b.clone();a.loadMessageBodyFor(c);a.loadAttachmentsFor(c)}else {a.messageBodyLoaded(null,null)}},loadMessageBodyFor:function loadMessageBodyFor(c){var a=this,b;if(!a.abortedRequestMap){a.abortedRequestMap={}}if(a.bodyLoadOperation){a.abortMessageBodyLoad()}b=c.loadMessageBody({reload:a.abortedRequestMap[c.get("messageBodyId")]===!0,success:a.messageBodyLoaded,failure:a.onMessageBodyLoadFailure,scope:a});if(!b){a.messageBodyLoaded(null,null);return}if(b.loadOperation){a.bodyLoadOperation={messageBodyId:c.get("messageBodyId"),loadOperation:b.loadOperation}}},loadAttachmentsFor:function loadAttachmentsFor(b){var a=this;if(a.attachmentsLoadOperation){a.abortMessageAttachmentsLoad()}if(b.get("hasAttachments")){b.attachments().on("beforeload",a.onBeforeAttachmentsLoad,a,{single:!0});b.loadAttachments({callback:a.messageAttachmentsLoaded,scope:a})}},abortMessageAttachmentsLoad:function abortMessageAttachmentsLoad(){var a=this;if(a.attachmentsLoadOperation){a.attachmentsLoadOperation.abort();a.attachmentsLoadOperation=null}},abortMessageBodyLoad:function abortMessageBodyLoad(){var b=this,a=b.bodyLoadOperation;if(a&&a.loadOperation&&a.loadOperation.isRunning()){a.loadOperation.abort();b.abortedRequestMap[a.messageBodyId]=!0}b.bodyLoadOperation=null},privates:{messageAttachmentsLoaded:function messageAttachmentsLoaded(b,d,c){var a=this;a.attachmentsLoadOperation=null;if(c!==!0){return}a.set("attachments",b)},onBeforeAttachmentsLoad:function onBeforeAttachmentsLoad(c,a){var b=this;b.attachmentsLoadOperation=a},onMessageBodyLoadFailure:function onMessageBodyLoadFailure(b,a){var d=this,c=d.getView();if(a.error&&a.error.status===-1){return}c.onMessageItemLoadFailure(b,a)},messageBodyLoaded:function messageBodyLoaded(c,d){var a=this,b=a.get("messageItem");a.bodyLoadOperation=null;if(!c){a.set("messageBody",null);return}if(!b){return}delete a.abortedRequestMap[c.getId()];a.set("messageBody",c);b.set("recent",!1);if(b.get("seen")!==!0){b.set("seen",!0);b.save({callback:a.triggerMessageItemRead,scope:a})}},triggerMessageItemRead:function triggerMessageItemRead(a,d){var c=this,b=c.getView();b.fireEvent("cn_mail-mailmessageitemread",[a])}}});Ext.define("conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog",{requires:["coon.comp.component.MessageMask"],deleteMask:null,canCloseAfterDelete:!0,showMessageDeleteConfirmDialog:function showMessageDeleteConfirmDialog(e,d,c){var a=this;if(a.deleteMask){return a.deleteMask}var b=Ext.create("coon.comp.component.MessageMask",{title:"Delete Message",message:"Are you sure you want to delete the message permanently?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:d,scope:c});a.mon(b,"destroy",function(){this.deleteMask=null},a);b.show();a.deleteMask=b;return b},closeAfterDelete:function closeAfterDelete(){var a=this;if(!a.canCloseAfterDelete){return !1}if(a.deleteMask){a.deleteMask.close()}a.close();return !0}});Ext.define("conjoon.cn_mail.store.mail.message.MessageItemStore",{extend:"Ext.data.BufferedStore",requires:["conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"store.cn_mail-mailmessageitemstore",model:"conjoon.cn_mail.model.mail.message.MessageItem",remoteSort:!0,remoteFilter:!0,pageSize:50,autoLoad:!1,sorters:[{property:"date",direction:"DESC"}],applySorters:function applySorters(a){var b=this;if(a&&a.length!==0&&(b.getSorters(!1)&&b.getSorters(!1).length!==0||a.length!==1)){Ext.raise({sorters:a,msg:"Only one sorter allowed for MessageItem store"})}return b.callParent(arguments)},findByCompoundKey:function findByCompoundKey(a){if(!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:a})}var b=this;return b.findExact("localId",a.toLocalId())},afterEdit:function afterEdit(c,a){if(!a||a.indexOf("cn_moved")===-1&&a.indexOf("cn_deleted")===-1&&a.indexOf("recent")===-1&&a.indexOf("previewText")===-1&&a.indexOf("answered")===-1){return}var b=this;if(b.contains(c)){b.fireEvent("update",b,c,"edit",a)}}});Ext.define("conjoon.cn_mail.view.mail.inbox.InboxViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.store.mail.message.MessageItemStore"],alias:"viewmodel.cn_mail-mailinboxviewmodel",stores:{"cn_mail_mailmessageitemstore":{type:"cn_mail-mailmessageitemstore",autoLoad:!0,listeners:{beforeload:function beforeload(c){var b=c.getFilters();for(var a=0,d=b.length;a<d;a++){if(b.getAt(a).getDisabled()===!0){return !1}}}},filters:[{disabled:"{cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\"}",property:"mailFolderId",value:"{cn_mail_ref_mailfoldertree.selection.id}"},{disabled:"{cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\"}",property:"mailAccountId",value:"{cn_mail_ref_mailfoldertree.selection.mailAccountId}"}]}},data:{messageViewHidden:!1},formulas:{computeMessageGridMargin:function computeMessageGridMargin(a){var f=this,d=a("cn_mail_ref_mailfoldertree.selection.folderType"),c=f.getView().down("cn_mail-mailmessagereadermessageview"),b=c.splitter.orientation;var e=d==="ACCOUNT"?"0 0 0 0":a("messageViewHidden")?"0 5 5 0":b==="vertical"?"0 0 5 0":"0 5 0 0";return e}},updateUnreadMessageCount:function updateUnreadMessageCount(b,c,d){var f=this,e=f.get("cn_mail_mailfoldertreestore"),a;a=e.getRoot().findChild("id",b,!1);if(!a){return}a=a.findChild("id",c,!0);if(!a){return}a.set("unreadCount",a.get("unreadCount")+d)}});Ext.define("conjoon.cn_mail.data.mail.service.mailbox.Operation",{statics:{MOVE_OR_DELETE:1,DELETE:2,MOVE:3,NOOP:4,CANCELED:5,INVALID_TARGET:6},config:{request:undefined,result:undefined},constructor:function constructor(a){a=a||{};var b=this;if(!a.request){Ext.raise({msg:"'request' must be set",request:a.request})}b.initConfig(a)},applyResult:function applyResult(b){var a=this;if(a.getResult()!==undefined){Ext.raise({msg:"'result' was already set",result:a.getResult()})}return b},applyRequest:function applyRequest(b){var a=this;if(a.getRequest()!==undefined){Ext.raise({msg:"'request' was already set",request:a.getRequest()})}return b}});Ext.define("conjoon.cn_mail.model.mail.BaseTreeModel",{extend:"coon.core.data.BaseTreeModel",idProperty:"__id__",requires:["conjoon.cn_mail.data.mail.BaseSchema"],schema:"cn_mail-mailbaseschema",constructor:function constructor(){var a=this;if(a.idProperty==="__id__"){Ext.raise({msg:"\"idProperty\" of coon.core.data.BaseTreeModel needs to be explicitly set",idProperty:a.idProperty})}a.callParent(arguments)}});Ext.define("conjoon.cn_mail.model.mail.AbstractCompoundKeyedTreeModel",{requires:["conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator"],extend:"conjoon.cn_mail.model.mail.BaseTreeModel"},function(){conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator.decorate(this)});Ext.define("conjoon.cn_mail.model.mail.folder.MailFolder",{extend:"conjoon.cn_mail.model.mail.AbstractCompoundKeyedTreeModel",requires:["conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey"],entityName:"MailFolder",fields:[{name:"name",type:"string",validators:[{type:"presence"}]},{name:"unreadCount",type:"int",persist:!1},{name:"folderType",type:"string"}],foreignKeyFields:["mailAccountId","id"],getRepresentingCompoundKeyClass:function getRepresentingCompoundKeyClass(){return conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey},constructor:function constructor(){var a=this;a.callParent(arguments);a.getField("folderType").setModelValidators([{type:"inclusion",list:[conjoon.cn_mail.data.mail.folder.MailFolderTypes.INBOX,conjoon.cn_mail.data.mail.folder.MailFolderTypes.JUNK,conjoon.cn_mail.data.mail.folder.MailFolderTypes.TRASH,conjoon.cn_mail.data.mail.folder.MailFolderTypes.SENT,conjoon.cn_mail.data.mail.folder.MailFolderTypes.FOLDER,conjoon.cn_mail.data.mail.folder.MailFolderTypes.DRAFT]}])},toUrl:function toUrl(){var a=this,b="cn_mail/folder/";return b+a.get("mailAccountId")+"/"+a.get("id").replace("/","%2F")}});Ext.define("conjoon.cn_mail.model.mail.account.MailAccount",{extend:"conjoon.cn_mail.model.mail.BaseTreeModel",entityName:"MailAccount",idProperty:"id",requires:["conjoon.cn_mail.data.mail.folder.MailFolderTypes","coon.core.data.field.EmailAddress"],fields:[{name:"name",type:"string",validators:[{type:"presence"}]},{name:"folderType",type:"string"},{name:"from",type:"cn_core-datafieldemailaddress"},{name:"replyTo",type:"cn_core-datafieldemailaddress"},{name:"inbox_type",type:"string"},{name:"inbox_address",type:"string"},{name:"inbox_port",type:"string"},{name:"inbox_user",type:"string"},{name:"inbox_password",type:"string"},{name:"inbox_ssl",type:"boolean"},{name:"outbox_address",type:"string"},{name:"outbox_port",type:"string"},{name:"outbox_user",type:"string"},{name:"outbox_password",type:"string"},{name:"outbox_secure",type:"string"}],constructor:function constructor(){var a=this;a.callParent(arguments);a.getField("folderType").setModelValidators([{type:"inclusion",list:[conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT]}])},toUrl:function toUrl(){var b=this,a="cn_mail/account/";return a+b.get("id")}});Ext.define("conjoon.cn_mail.store.mail.folder.MailFolderTreeStore",{extend:"Ext.data.TreeStore",requires:["conjoon.cn_mail.model.mail.folder.MailFolder","conjoon.cn_mail.model.mail.account.MailAccount"],alias:"store.cn_mail-mailfoldertreestore",model:"conjoon.cn_mail.model.mail.account.MailAccount",autoLoad:!1,nodeParam:"mailAccountId",storeId:"cn_mail-mailfoldertreestore",statics:{getInstance:function getInstance(){var a=Ext.StoreManager.get("cn_mail-mailfoldertreestore");if(!a){a=Ext.create("conjoon.cn_mail.store.mail.folder.MailFolderTreeStore")}return Ext.StoreManager.get("cn_mail-mailfoldertreestore")}},root:{expanded:!0,data:[]},constructor:function constructor(){var a=this;a.callParent(arguments);a.on("load",a.onStoreHasLoadedRootNode,a,{single:!0})},onStoreHasLoadedRootNode:function onStoreHasLoadedRootNode(a){a.getRootNode().childNodes.forEach(function(b){return b.expand(!1,function(){b.collapse();b.expand()})})}});Ext.define("conjoon.cn_mail.data.mail.service.MailFolderHelper",{alternateClassName:["conjoon.cn_mail.MailFolderHelper"],requires:["conjoon.cn_mail.store.mail.folder.MailFolderTreeStore","conjoon.cn_mail.data.mail.folder.MailFolderTypes"],config:{store:null},statics:{getInstance:function getInstance(){var a=this.__inst;if(!a){a=Ext.create(this,{store:conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance()});this.__inst=a}return a}},constructor:function constructor(a){a=a||{};var b=this;b.initConfig(a)},applyStore:function applyStore(a){if(!a||!(a instanceof conjoon.cn_mail.store.mail.folder.MailFolderTreeStore)){Ext.raise({msg:"'store' must be an instance of conjoon.cn_mail.store.mail.folder.MailFolderTreeStore",store:a})}return a},getMailFolder:function getMailFolder(b,c){var d=this,a=d.getAccountNode(b);if(!a){return null}return a.findChild("id",c,!0)},getMailFolderIdForType:function getMailFolderIdForType(c,d){var e=this,a=e.getAccountNode(c);if(!a){return null}var b=a.findChild("folderType",d,!1);if(!b){return null}return b.get("id")},getAccountNode:function getAccountNode(c){var d=this,b=d.getStore(),a=b.findBy(function(a){if(a.get("id")===c&&a.get("folderType")===conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT){return !0}});if(a===-1){return null}return b.getAt(a)},doesFolderBelongToAccount:function doesFolderBelongToAccount(b,a){var c=this;if(c.getMailFolder(a,b)){return !0}return !1}});Ext.define("conjoon.cn_mail.data.mail.service.MailboxService",{alternateClassName:["conjoon.cn_mail.MailboxService"],requires:["conjoon.cn_mail.model.mail.message.AbstractMessageItem","conjoon.cn_mail.data.mail.service.mailbox.Operation","conjoon.cn_mail.data.mail.service.MailFolderHelper"],statics:{recentMessageItemKeys:new Set(),getInstance:function getInstance(){var a=this.__inst;if(!a){a=Ext.create(this,{mailFolderHelper:conjoon.cn_mail.MailFolderHelper.getInstance()});this.__inst=a}return a}},constructor:function constructor(a){a=a||{};var b=this;if(!a.mailFolderHelper||!(a.mailFolderHelper instanceof conjoon.cn_mail.data.mail.service.MailFolderHelper)){Ext.raise({msg:"'mailFolderHelper' must be an instance of conjoon.cn_mail.data.mail.service.MailFolderHelper",mailFolderHelper:a.mailFolderHelper})}b.initConfig(a)},moveToTrashOrDeleteMessage:function moveToTrashOrDeleteMessage(a,b){var c=this;a=c.filterMessageItemValue(a);var g=c.getMailFolderHelper(),d=g.getMailFolderIdForType(a.get("mailAccountId"),conjoon.cn_mail.data.mail.folder.MailFolderTypes.TRASH);if(d===null){var e=c.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.MOVE_OR_DELETE,record:a},{success:!1,reason:"Could not find TRASH folder."});if(b&&b.failure){b.failure.apply(b.scope,[e])}return e}var f=a.get("mailFolderId");if(a.phantom===!0||d===f){return c.deleteMessage(a,b)}return c.moveMessage(a,d,b)},deleteMessage:function deleteMessage(b,d){var c=this;b=c.filterMessageItemValue(b);var a=c.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.DELETE,record:b});if(c.callBefore(a,d)===!1){a.setResult({success:!1,code:conjoon.cn_mail.data.mail.service.mailbox.Operation.CANCELED});return a}b.erase(c.configureOperationCallbacks(a,d));return a},moveMessage:function moveMessage(a,c,d){var e=this,f=e.getMailFolderHelper();var b;a=e.filterMessageItemValue(a);if(!Ext.isString(c)){Ext.raise({msg:"'mailFolderId' must be a string",mailFolderId:c})}if(a.get("mailFolderId")===c){b=e.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.NOOP,record:a},{success:!0});if(d&&d.success){d.success.apply(d.scope,[b])}return b}b=e.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.MOVE,record:a,sourceFolderId:a.get("mailFolderId"),targetFolderId:c});if(!f.doesFolderBelongToAccount(c,a.get("mailAccountId"))){b.setResult({success:!1,code:conjoon.cn_mail.data.mail.service.mailbox.Operation.INVALID_TARGET});return b}e.callBefore(b,d);a.set("mailFolderId",c);a.save(e.configureOperationCallbacks(b,d));return b},getMailFolderHelper:function getMailFolderHelper(){var a=this;return a.mailFolderHelper},filterMessageItemValue:function filterMessageItemValue(a){if(!(a instanceof conjoon.cn_mail.model.mail.message.AbstractMessageItem)){Ext.raise({msg:"\"messageItem\" must be an instance of conjoon.cn_mail.model.mail.message.AbstractMessageItem",messageItem:a})}if(!a.get("mailAccountId")){Ext.raise({msg:"\"mailAccountId\" missing in messageItem",messageItem:a})}return a},configureOperationCallbacks:function configureOperationCallbacks(a,b){var d=this,c=conjoon.cn_mail.data.mail.service.mailbox.Operation;b=b||{};return {success:function success(){a.setResult({success:!0});if(a.getRequest().type===c.MOVE){d.moveCallback(a)}else if(a.getRequest().type===c.DELETE){d.deleteCallback(a)}if(b&&b.success){b.success.apply(b.scope,[a])}},failure:function failure(){a.setResult({success:!1});if(a.getRequest().type===c.MOVE){d.moveCallback(a)}else if(a.getRequest().type===c.DELETE){d.deleteCallback(a)}if(b&&b.failure){b.failure.apply(b.scope,[a])}},scope:this}},createOperation:function createOperation(a,b){var c=a||b?{}:undefined;if(a){c.request=a}if(b){c.result=b}return Ext.create("conjoon.cn_mail.data.mail.service.mailbox.Operation",c)},callBefore:function callBefore(b,a){if(a&&a.before){return a.before.apply(a.scope,[b])}},moveCallback:function moveCallback(g){var j=this,d=g.getRequest(),h=d.sourceFolderId,i=d.targetFolderId,a=d.record,f=a.get("mailAccountId"),e=j.getMailFolderHelper();if(g.getResult().success!==!0){return !1}a.set("messageBodyId",a.getId());if(a.entityName==="MessageDraft"){a.getMessageBody().commit(!0)}if(a.get("seen")){return !0}var b=e.getMailFolder(f,h),c=e.getMailFolder(f,i);if(b){b.set("unreadCount",Math.max(0,b.get("unreadCount")-1),{dirty:!1})}if(c){c.set("unreadCount",c.get("unreadCount")+1,{dirty:!1})}return !0},deleteCallback:function deleteCallback(c){var h=this,g=c.getRequest(),b=g.record,f=b.get("mailFolderId"),e=b.get("mailAccountId"),d=h.getMailFolderHelper();if(c.getResult().success!==!0){return !1}if(b.get("seen")){return}var a=d.getMailFolder(e,f);if(a){a.set("unreadCount",Math.max(0,a.get("unreadCount")-1),{dirty:!1})}return !0}});function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,c){if(!a){return}if(typeof a==="string"){return _arrayLikeToArray(a,c)}var b=Object.prototype.toString.call(a).slice(8,-1);if(b==="Object"&&a.constructor){b=a.constructor.name}if(b==="Map"||b==="Set"){return Array.from(a)}if(b==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b)){return _arrayLikeToArray(a,c)}}function _arrayLikeToArray(c,a){if(a==null||a>c.length){a=c.length}for(var b=0,d=new Array(a);b<a;b++){d[b]=c[b]}return d}function _iterableToArrayLimit(b,j){var a=null==b?null:"undefined"!=typeof Symbol&&b[Symbol.iterator]||b["@@iterator"];if(null!=a){var h,g,i,e,d=[],c=!0,f=!1;try{if(i=(a=a.call(b)).next,0===j){if(Object(a)!==a){return}c=!1}else {for(;!(c=(h=i.call(a)).done)&&(d.push(h.value),d.length!==j);c=!0){}}}catch(k){f=!0,g=k}finally{try{if(!c&&null!=a["return"]&&(e=a["return"](),Object(e)!==e)){return}}finally{if(f){throw g}}}return d}}function _arrayWithHoles(a){if(Array.isArray(a)){return a}}Ext.define("conjoon.cn_mail.view.mail.inbox.InboxViewController",{extend:"Ext.app.ViewController",alias:"controller.cn_mail-mailinboxviewcontroller",requires:["conjoon.cn_mail.data.mail.service.MailboxService","conjoon.cn_mail.data.mail.service.mailbox.Operation","conjoon.cn_mail.data.mail.service.MailFolderHelper","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater","conjoon.cn_mail.model.mail.message.MessageDraft"],control:{"cn_mail-mailmessagereadermessageview":{"cn_mail-mailmessageitemread":"onMessageItemRead"},"cn_mail-mailmessagereadermessageview #btn-deletedraft":{"click":"onDeleteClick"},"cn_mail-mailmessagereadermessageview #btn-delete":{"click":"onDeleteClick"},"cn_mail-mailfoldertree":{"beforeselect":"onMailFolderTreeBeforeSelect","select":"onMailFolderTreeSelect"},"cn_mail-mailmessagegrid":{"cn_comp-rowflymenu-itemclick":"onRowFlyMenuItemClick","cn_comp-rowflymenu-beforemenushow":"onRowFlyMenuBeforeShow"}},mailboxService:null,messageGrid:null,mailFolderTree:null,onRowFlyMenuBeforeShow:function onRowFlyMenuBeforeShow(c,d,a){var b=this;if(a.get("cn_deleted")||a.get("cn_moved")){return !1}b.getMessageGrid().updateRowFlyMenu(a)},onRowFlyMenuItemClick:function onRowFlyMenuItemClick(d,e,c,a){var b=this;switch(c){case "markunread":a.set("seen",!a.get("seen"));a.set("recent",!1);a.save({callback:b.onMessageItemRead,scope:b});break;case "flag":a.set("flagged",!a.get("flagged"));a.set("recent",!1);a.save();break;case "delete":b.moveOrDeleteMessage(a);break;}},onDeleteClick:function onDeleteClick(d){var a=this,c=a.getMessageView(),b=c.getViewModel().get("messageItem");a.moveOrDeleteMessage(b)},onMessageItemRead:function onMessageItemRead(d){var m=this,k=m.getView(),a={},g,b,e,j;d=[].concat(d);for(var h=0,l=d.length;h<l;h++){g=d[h];b=g.get("mailAccountId");e=g.get("mailFolderId");j=g.get("seen");if(!a[b]){a[b]={}}if(!a[b][e]){a[b][e]=0}a[b][e]+=j?-1:1}var c=null;for(var i in a){c=a[i];for(var f in c){if(!Object.prototype.hasOwnProperty.call(c,f)){continue}if(!c[f]){continue}k.getViewModel().updateUnreadMessageCount(i,f,c[f])}}},onMailFolderTreeSelect:function onMailFolderTreeSelect(c,a){var b=this;b.redirectTo(a)},onMailFolderTreeBeforeSelect:function onMailFolderTreeBeforeSelect(e,c){var d=this,a=d.getView(),b=a.down("cn_mail-mailaccountview");if(b.hasPendingChanges()){a.showMailAccountIsBeingEditedNotice(c);return !1}return !0},getMailboxService:function getMailboxService(){var a=this;if(!a.mailboxService){a.mailboxService=conjoon.cn_mail.MailboxService.getInstance()}return a.mailboxService},moveOrDeleteMessage:function moveOrDeleteMessage(d){var c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!1;var b=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var a=this;if(!b){b=a.getView()}return a.getMailboxService().moveToTrashOrDeleteMessage(d,{before:Ext.Function.bind(a.onBeforeMessageMoveOrDelete,a,[c,b],!0),success:Ext.Function.bind(a.onMessageMovedOrDeleted,a,[b],!0),failure:a.onMessageMovedOrDeletedFailure,scope:a})},onBeforeMessageMoveOrDelete:function onBeforeMessageMoveOrDelete(d,k,e){var b=this,j=b.getView(),a=d.getRequest().record,h=d.getRequest().type,f=conjoon.cn_mail.data.mail.service.mailbox.Operation,m=b.getMessageGrid(),l=a.entityName==="MessageDraft",i=b.getLivegrid().isConfigured();var g,c;switch(h){case f.MOVE:g="cn_moved";break;case f.DELETE:if(j.fireEvent("cn_mail-beforemessageitemdelete",j,a,e)===!1){return !1};if(k!==!0){e.showMessageDeleteConfirmDialog(a,function(b,f){var c=this;if(b==="yesButton"){c.moveOrDeleteMessage(a,!0,e)}},b);return !1};g="cn_deleted";break;default:Ext.raise({msg:"Unexpected operation type for before-callback",type:h});break;}if(i){if(l||a.store!==b.getMessageGrid().getStore()){c=b.getLivegrid().getRecordById(a.getId())}else {c=a}if(c){c.set(g,!0,{dirty:!1})}}d.getRequest().owningStore=a.store;a.unjoin(a.store);if(h===f.DELETE){a.drop(!1)}if(i){m.getSelectionModel().deselect(c);b.getRowFlyMenu().detachMenuAndUnset()}return d},onMessageMovedOrDeletedFailure:function onMessageMovedOrDeletedFailure(f){var i=this,c=f.getRequest(),a=c.record,g=c.type,e=conjoon.cn_mail.data.mail.service.mailbox.Operation,b=c.owningStore,h=a.entityName==="MessageDraft";var d;switch(g){case e.MOVE:d="cn_moved";break;case e.DELETE:d="cn_deleted";break;default:Ext.raise({msg:"Unexpected operation type for failure-callback",type:g});break;}a.reject();b&&a.join(b);if(!h&&b===i.getMessageGrid().getStore()){a.set(d,!1,{dirty:!1})}return f},onMessageMovedOrDeleted:function onMessageMovedOrDeleted(s,j){var b=this,d=s.getRequest(),t=b.getView(),a=d.record,e=d.type,c=conjoon.cn_mail.data.mail.service.mailbox.Operation,k=b.getMessageGrid(),f=d.owningStore,r=b.getLivegrid().isConfigured(),i=a.entityName==="MessageDraft",p=b.getMailboxService().getMailFolderHelper();var n;switch(e){case c.MOVE:n="cn_moved";break;case c.DELETE:n="cn_deleted";break;default:Ext.raise({msg:"Unexpected operation type for failure-callback",type:e});break;}if(!i&&f===b.getMessageGrid().getStore()){a.set(n,!1,{dirty:!1})}var g=b.getSelectedMailFolder(),h=e===c.MOVE?d.targetFolderId:a.get("mailFolderId"),u=h&&g&&g.get("id")!==h,v=h&&g&&g.get("id")===h;if(a.isCompoundKeyConfigured()&&r&&(u||e===c.DELETE)){var o=null,m;if(e===c.DELETE){o=a.getCompoundKey()}else {o=i?a.getPreviousCompoundKey():a.getCompoundKey()}m=b.getLivegrid().getRecordByCompoundKey(o);if(m){b.getLivegrid().remove(m)}}var l;switch(e){case c.MOVE:if(r&&v){if(i){var q=conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.createItemFromDraft(a);q.join(k.getStore());b.getLivegrid().add(q)}else {if(f){a.join(f)}else {a.unjoin(k.getStore());a.join(k.getStore())}b.getLivegrid().add(a)}}else if(!i){f&&a.join(f)};l=a.get("mailAccountId");t.fireEvent("cn_mail-messageitemmove",t,a,j,p.getMailFolder(l,d.sourceFolderId),p.getMailFolder(l,d.targetFolderId));break;case c.DELETE:if(j){j.closeAfterDelete()};break;}return s},updateViewForCreatedDraft:function updateViewForCreatedDraft(c){var b=this,a=b.getSelectedMailFolder();if(!a||a.get("folderType")!==conjoon.cn_mail.data.mail.folder.MailFolderTypes.DRAFT||a.get("mailAccountId")!==c.get("mailAccountId")){return}var d=conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.createItemFromDraft(c),e=b.getMessageGrid();d.join(e.getStore());b.getLivegrid().add(d)},updateViewForSentDraft:function updateViewForSentDraft(b){var a=this,h=a.getSelectedMailFolder(),o=b.getCompoundKey(),g=a.getLivegrid();var j=a.getMailboxService().getMailFolderHelper().getMailFolderIdForType(b.get("mailAccountId"),conjoon.cn_mail.data.mail.folder.MailFolderTypes.SENT),c;if(h){var f=b.get("xCnDraftInfo");if(f){var l=Ext.decode(atob(f)),d=_slicedToArray(l,3),i=d[0],k=d[1],n=d[2],e=g.getRecordByCompoundKey(conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey.createFor(i,k,n));if(e){e.set("answered",!0,{dirty:!1})}}var m=h.get("id");if(m===b.get("mailFolderId")){c=g.getRecordByCompoundKey(o)}}if(!c){c=conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.createItemFromDraft(b)}c.set("draft",!1);return a.getMailboxService().moveMessage(c,j,{before:a.onBeforeMessageMoveOrDelete,success:a.onMessageMovedOrDeleted,failure:a.onMessageMovedOrDeletedFailure,scope:a})},getMessageView:function getMessageView(){return this.getView().down("cn_mail-mailmessagereadermessageview")},getLivegrid:function getLivegrid(){return this.getMessageGrid().view.getFeature("cn_mail-mailMessageFeature-livegrid")},getRowFlyMenu:function getRowFlyMenu(){return this.getMessageGrid().view.getFeature("cn_mail-mailMessageFeature-rowFlyMenu")},getSelectedMailFolder:function getSelectedMailFolder(){var a=this.getMailFolderTree().getSelection();if(a&&a.length){return a[0]}return null},getMessageGrid:function getMessageGrid(){var a=this;if(!a.messageGrid){a.messageGrid=a.getView().down("cn_mail-mailmessagegrid")}return a.messageGrid},getMailFolderTree:function getMailFolderTree(){var a=this;if(!a.mailFolderTree){a.mailFolderTree=a.getView().down("cn_mail-mailfoldertree")}return a.mailFolderTree}});Ext.define("conjoon.cn_mail.view.mail.folder.MailFolderTreeColumn",{extend:"Ext.tree.Column",alias:"widget.cn_mail-mailfoldertreecolumn",cellTpl:["<tpl for=\"lines\">","<div class=\"{parent.childCls} {parent.elbowCls}-img ","{parent.elbowCls}-<tpl if=\".\">line<tpl else>empty</tpl>\" role=\"presentation\"></div>","</tpl>","<tpl if=\"glyph\">","<span class=\"{baseIconCls}\" ","<tpl if=\"glyphFontFamily\">","style=\"font-family:{glyphFontFamily}\"","</tpl>",">{glyph}</span>","<tpl else>","<tpl if=\"iconCls\">","<tpl if=\"icon\">","<img src=\"{blankUrl}\"","<tpl else>","<div","</tpl>"," role=\"presentation\" class=\"{childCls} {baseIconCls} {customIconCls} ","{baseIconCls}-<tpl if=\"leaf\">leaf<tpl else><tpl if=\"expanded\">parent-expanded<tpl else>parent</tpl></tpl> {iconCls}\" ","<tpl if=\"icon\">style=\"background-image:url({icon})\"/>"+"<tpl else>"+"></div>"+"</tpl>","</tpl>","</tpl>","<tpl if=\"href\">","<a href=\"{href}\" role=\"link\" target=\"{hrefTarget}\" class=\"{textCls} {childCls}\">{value}</a>","<tpl else>","<span class=\"{textCls} {childCls}\">{value}</span>","</tpl>","<div class=\"{childCls} {elbowCls}-img {elbowCls}","<tpl if=\"isLast\">-end</tpl>"+"<tpl if=\"expandable\">-plus {expanderCls}</tpl>\" role=\"presentation\"></div>"],initTemplateRendererData:function initTemplateRendererData(i,e,b,g,f,h,j){var d=this,c=b.get("folderType");var a;a=Ext.tree.Column.prototype.initTemplateRendererData.apply(this,arguments);if(a.lines.length<=1){b.data.iconCls=a.lines.length===0?" ":d.getIconClsForMailFolderType(c)}else {b.data.iconCls=""}if(a.lines&&a.lines.length<2){a.lines=[]}return a},getIconClsForMailFolderType:function getIconClsForMailFolderType(b){var a="fas fa-folder";switch(b){case "INBOX":a="fas fa-inbox";break;case "DRAFT":a="fas fa-edit";break;case "JUNK":a="fas fa-recycle";break;case "TRASH":a="fas fa-trash";break;case "SENT":a="fas fa-paper-plane";break;}return a}});Ext.define("conjoon.cn_mail.view.mail.folder.MailFolderTree",{extend:"Ext.tree.Panel",requires:["conjoon.cn_mail.view.mail.folder.MailFolderTreeColumn"],alias:"widget.cn_mail-mailfoldertree",width:240,cls:"cn_mail-mailfoldertree",useArrows:!0,rootVisible:!1,hideHeaders:!0,selModel:{toggleOnClick:!1},viewConfig:{outerRowTpl:["<table id=\"{rowId}\" role=\"presentation\" ","data-boundView=\"{view.id}\" ","data-recordId=\"{record.internalId}\" ","data-recordIndex=\"{recordIndex}\" ","class=\"{[values.itemClasses.join(\" \")]} {[this.getOuterRowClass(values.record, values.view.dataSource)]}\" cellpadding=\"0\" cellspacing=\"0\" style=\"{itemStyle};width:0;\">","{%","this.nextTpl.applyOut(values, out, parent)","%}","</table>",{getOuterRowClass:function getOuterRowClass(c,g){var a=c.get("folderType").toLowerCase(),b="cn_"+(a==="folder"?"generic":a),d=c.parentNode,f=g.getRoot(),e=d&&d!==f&&d.parentNode!==f;if(!e&&a!=="account"){b+=" cn_folder"}if(a==="account"&&!c.previousSibling){b+=" first"}else if(e){b+=" cn_subfolder"}return b},priority:9999}]},columns:[{xtype:"cn_mail-mailfoldertreecolumn",dataIndex:"name",flex:1,renderer:function renderer(b,d,c){var a=c.get("unreadCount");if(a>0){return b+"<span class=\"badge-unreadcount\">"+a+"</span>"}return b}}]});Ext.define("conjoon.cn_mail.view.mail.message.grid.feature.Livegrid",{extend:"coon.comp.grid.feature.Livegrid",requires:["conjoon.cn_mail.data.mail.message.CompoundKey","coon.core.data.pageMap.PageMapUtil"],alias:"feature.cn_mail-mailmessagegridfeature-livegrid",getRecordByCompoundKey:function getRecordByCompoundKey(a){var b=this;if(!(a instanceof conjoon.cn_mail.data.mail.message.CompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.CompoundKey",compoundKey:a})}return coon.core.data.pageMap.PageMapUtil.getRecordBy(function(b){return !b.hasKeysModified()&&b.getCompoundKey().equalTo(a)===!0},b.pageMapFeeder)}});Ext.define("conjoon.cn_mail.view.mail.message.grid.feature.PreviewTextLazyLoad",{extend:"Ext.grid.feature.Feature",alias:"feature.cn_webmailplug-previewtextlazyload",requires:["l8","conjoon.cn_mail.data.mail.message.CompoundKey","coon.core.data.pageMap.PageMapUtil","coon.core.data.pageMap.RecordPosition","coon.core.data.request.Configurator"],statics:{required:{requestConfigurator:"coon.core.data.request.Configurator"}},init:function init(b){"use strict";var a=this;b.on("afterrender",a.installListeners,a,{single:!0})},installListeners:function installListeners(){"use strict";var a=this,b=a.grid;if(a.installed){throw new Error("The listeners for this feature were already installed")}var f=b.view.getFeature("cn_mail-mailMessageFeature-messagePreview");b.on("cn_mail-mailmessagegridbeforeload",function(b){b.getProxy().extraParams.attributes="*,previewText";b.on("filterchange",a.onStoreFilterChange,a)},null,{single:!0});f.getPreviewTextRow=function(b){var a=b.get("previewText");return "<div class=\"previewText".concat(a===undefined?" loading":"","\">")+(a!==undefined?Ext.util.Format.nbsp(a):"")+"</div>"};var c=a.requestPreviewText,d={buffer:500},e=b.view.getScrollable();a.mon(e,"scroll",c,a,d);a.mon(b,"cn_mail-mailmessagegridload",c,a,d);a.mon(b,"cn_mail-mailmessagegridprefetch",c,a,d);a.installed=!0},requestPreviewText:function requestPreviewText(){"use strict";var a=this,f=a.grid,e=f.getStore();if(!e){return !1}var b=a.getPagesToBrowse();if(!b){return !1}if(!a.pendingLazies){a.pendingLazies={}}var d=a.getUrlGroups(b.browse,b.pageMap),c=a.assembleUrls(d);Object.keys(c).forEach(function(b){a.pendingLazies[b]=a.processRequestedIds(c[b],a.pendingLazies[b]?a.pendingLazies[b]:[],b)});return a.pendingLazies},getPagesToBrowse:function getPagesToBrowse(){var j=this,i=j.grid,b=i.view.getFeature("cn_mail-mailMessageFeature-livegrid"),c=b.getPageMap(),g=c.getPageSize(),d=[],a=b.getCurrentViewRange();if(!a){return !1}var h=l8.createRange(a.getStart().getPage(),a.getEnd().getPage()),e=a.getStart().getIndex(),f=a.getEnd().getIndex();h.forEach(function(c,a,b){d.push([c,a===0?e:0,a===b.length-1?f:g-1])});return {browse:d,pageMap:c}},assembleUrls:function assembleUrls(a){var h=this,c=Object.create(null),b=Ext.create("Ext.data.Request",{action:"read"}),g=h.grid,f=g.getStore(),e=f.getProxy();var d="";Object.keys(a).forEach(function(f){Object.keys(a[f]).forEach(function(g){b.setParams({mailAccountId:f,mailFolderId:g});d=e.assembleUrl(b);c[d]=a[f][g]})});return c},getUrlGroups:function getUrlGroups(e,d){"use strict";var a={},c=coon.core.data.pageMap.PageMapUtil,b=coon.core.data.pageMap.RecordPosition;e.forEach(function(g){for(var i=g[1],j=g[2];i<=j;i++){var h=c.getRecordAt(b.create(g[0],i),d);if(h&&h.get("previewText")===undefined){var f=h.getCompoundKey().toArray();if(!a[f[0]]){a[f[0]]={}}if(!a[f[0]][f[1]]){a[f[0]][f[1]]=[]}a[f[0]][f[1]].push(f[2])}}});return a},processRequestedIds:function processRequestedIds(d,c,e){var b=this;var a=b.computeIdsToLoad(d,c);if(a!==null){b.sendRequest(a.ids,e);return a.pendingLazies}return []},computeIdsToLoad:function computeIdsToLoad(c,a){var b=c.filter(function(b){return a.indexOf(b)===-1});a=a.concat(b);if(!b.length){return null}return {ids:b,pendingLazies:a}},processLoadedPreviewText:function processLoadedPreviewText(a){var b=this,d=conjoon.cn_mail.data.mail.message.CompoundKey,c=a.request.url,e=JSON.parse(a.request.params.filter)[0].value,f=b.grid.view.getFeature("cn_mail-mailMessageFeature-livegrid");b.pendingLazies[c]=l8.extract(b.pendingLazies[c].concat(e));var g=JSON.parse(a.responseText);g.data.forEach(function(b){setTimeout(function(){var c=f.getRecordByCompoundKey(d.createFor(b.mailAccountId,b.mailFolderId,b.id));if(c){c.set("previewText",b.previewText?b.previewText:"")}},1)})},onStoreFilterChange:function onStoreFilterChange(c,b){"use strict";var a=this;a.pendingLazies={}},sendRequest:function sendRequest(b,f){var a=this,e=a.grid,d=e.getStore(),c=d.getProxy();Ext.Ajax.request(a.requestConfigurator.configure(a.getDefaultRequestCfg({url:f,idsToLoad:b,options:c.getDefaultParameters("ListMessageItem.options")}))).then(a.processLoadedPreviewText.bind(a))},getDefaultRequestCfg:function getDefaultRequestCfg(a){var d=a.url,b=a.idsToLoad,c=a.options;return {method:"get",url:d,params:{attributes:"previewText",options:c,filter:JSON.stringify([{"property":"id","operator":"in","value":b}])}}}});Ext.define("conjoon.cn_mail.view.mail.message.MessageGrid",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Date","coon.comp.grid.feature.RowBodySwitch","conjoon.cn_mail.view.mail.message.grid.feature.Livegrid","conjoon.cn_mail.view.mail.message.grid.feature.PreviewTextLazyLoad","conjoon.cn_mail.store.mail.message.MessageItemStore","coon.comp.grid.feature.RowFlyMenu","coon.core.util.Date"],alias:"widget.cn_mail-mailmessagegrid",myStoreRelayers:null,cls:"cn_mail-mailmessagegrid",flex:1,headerBorders:!1,rowLines:!1,selModel:{toggleOnClick:!1,pruneRemoved:!1},tools:[{itemId:"cn_mail-mailmessagegrid-refresh",type:"refresh"}],emptyText:"This folder is empty.",representedFolderType:null,features:[{ftype:"cn_mail-mailmessagegridfeature-livegrid",id:"cn_mail-mailMessageFeature-livegrid"},{ftype:"cn_comp-gridfeature-rowbodyswitch",variableRowHeight:!1,enableCls:"previewEnabled",disableCls:"previewDisabled",id:"cn_mail-mailMessageFeature-messagePreview",emptySubjectText:"(No subject)",getPreviewTextRow:function getPreviewTextRow(a){return "<div class=\"previewText\">".concat(Ext.util.Format.nbsp(a.get("previewText")),"</div>")},getAdditionalData:function getAdditionalData(d,f,a,e){var b=this,c=coon.core.util.Date;if(b.disabled){return undefined}return {rowBody:"<div class=\"head"+(!a.get("seen")?" unread":"")+(a.get("recent")?" recent":"")+"\">"+"<div class=\"subject"+(!a.get("seen")?" seen":"")+(a.get("recent")?" recent":"")+"\">"+(a.get("answered")?"<span class=\"fa fa-reply\"></span>":"")+(a.get("flagged")?"<span class=\"fa fa-flag\"></span>":"")+(a.get("draft")?"<span class=\"draft\">[Draft]</span>":"")+(a.get("subject")===""?b.emptySubjectText:a.get("subject"))+"</div>"+"<div class=\"date\">"+c.getHumanReadableDate(a.get("date"))+"</div>"+"</div>"+b.getPreviewTextRow(a),rowBodyCls:"cn_mail-mailmessagepreviewfeature"}},previewColumnConfig:{"seen":{hidden:!0},"subject":{hidden:!0},"to":{hidden:!0},"from":{hidden:!0},"draftDisplayAddress":{flex:1},"date":{hidden:!0},"hasAttachments":{},"size":{hidden:!0}}},{ftype:"cn_comp-gridfeature-rowflymenu",id:"cn_mail-mailMessageFeature-rowFlyMenu",items:[{cls:"fa fa-trash","data-qtip":"Delete Message",action:"delete",id:"cn_mail-mailMessageFeature-rowFlyMenu-delete"},{cls:"fa fa-envelope","data-qtip":"Mark as Unread",action:"markunread",id:"cn_mail-mailMessageFeature-rowFlyMenu-markUnread"},{cls:"fa fa-flag","data-qtip":"Add Flag",action:"flag",id:"cn_mail-mailMessageFeature-rowFlyMenu-flag"}],alignTo:["tr-tr",[-12,4]]}],viewConfig:{markDirty:!1,getRowClass:function getRowClass(a,d,c,e){var b=a.get("recent")?"recent":"";b+=a.get("seen")?"":" boldFont";if(a.get("cn_deleted")){b+=" cn-deleted"}else if(a.get("cn_moved")){b+=" cn-moved"}return b}},columns:[{dataIndex:"seen",hideable:!1,text:"<span class=\"x-fa fa-circle\"></span>",renderer:function renderer(a,b,c){return "<span class=\""+(!a?"fas":"far")+" fa-circle\"></span>"},menuDisabled:!0,width:40},{dataIndex:"hasAttachments",hideable:!1,text:"<span class=\"x-fa fa-paperclip\"></span>",renderer:function renderer(a){return a?"<span class=\"x-fa fa-paperclip\"></span>":""},menuDisabled:!0,width:40},{dataIndex:"subject",text:"Subject",width:150},{dataIndex:"to",text:"To",width:240,renderer:function renderer(a,g,e,d,c,f,b){return b.grid.stringifyTo(a)}},{dataIndex:"from",text:"From",width:140,renderer:function renderer(a,c,g,f,e,h,d){var b=d.getFeature("cn_mail-mailMessageFeature-messagePreview");if(!b.disabled){c.tdCls+="previewLarge"}return a?a.name:""}},{dataIndex:"draftDisplayAddress",hidden:!0,hideable:!1,text:"Draft Display Address",menuDisabled:!0},{dataIndex:"date",xtype:"datecolumn",format:"d.m.Y H:i",align:"right",text:"Date",width:140},{dataIndex:"size",align:"right",text:"Size",width:80,renderer:Ext.util.Format.fileSize}],setRepresentedFolderType:function setRepresentedFolderType(a){var b=this;b.representedFolderType=a},initComponent:function initComponent(){var a=this;a.fireEvent("cn_init",a);for(var b=0,c=a.columns.length;b<c;b++){if(a.columns[b].dataIndex==="draftDisplayAddress"){a.columns[b].renderer=a.renderDraftDisplayAddress}}a.callParent(arguments);a.relayEvents(a.view.getFeature("cn_mail-mailMessageFeature-rowFlyMenu"),["itemclick","beforemenushow"],"cn_comp-rowflymenu-")},renderDraftDisplayAddress:function renderDraftDisplayAddress(i,d,a,g,f,h,b){var e=this,c=b.getFeature("cn_mail-mailMessageFeature-messagePreview");if(!c.disabled){d.tdCls+="previewLarge";if(a.get("draft")||e.representedFolderType==="SENT"){return b.grid.stringifyTo(a.get("to"))}}return a.get("from")?a.get("from").name:""},enableRowPreview:function enableRowPreview(b){var a=this,g=a.getView(),e=g.getFeature("cn_mail-mailMessageFeature-messagePreview"),d=g.getFeature("cn_mail-mailMessageFeature-rowFlyMenu");b=b===undefined?!0:!!b;if(a.getStore().isLoading()){Ext.raise({msg:"cannot call enableRowPreview during store's load-operation",isLoading:a.getStore().isLoading()})}var c=a.getStore().pageRequests;for(var f in c){if(!Object.prototype.hasOwnProperty.call(c,f)){continue}c[f].getOperation().abort()}a.getStore().reload();if(b){e.enable();d.enable()}else {e.disable();d.disable()}},bindStore:function bindStore(a,c){var b=this;if(a&&!a.isEmptyStore&&!(a instanceof conjoon.cn_mail.store.mail.message.MessageItemStore)){Ext.raise({msg:"store must be an instance of \"conjoon.cn_mail.store.message.MessageItemStore\"",store:a})}if(a&&b.getStore()!==a){b.myStoreRelayers=b.relayEvents(a,["beforeload","load","prefetch"],"cn_mail-mailmessagegrid")}return b.callParent(arguments)},unbindStore:function unbindStore(b){var a=this;if(a.myStoreRelayers){a.myStoreRelayers.destroy()}a.myStoreRelayers=null;return a.callParent(arguments)},updateRowFlyMenu:function updateRowFlyMenu(c){var f=this,e=f.view.getFeature("cn_mail-mailMessageFeature-rowFlyMenu"),d=e.menu,b=d.query("div[id=cn_mail-mailMessageFeature-rowFlyMenu-markUnread]",!0),a=d.query("div[id=cn_mail-mailMessageFeature-rowFlyMenu-flag]",!0);switch(c.get("seen")){case !0:b[0].setAttribute("data-qtip","Mark as Unread");break;default:b[0].setAttribute("data-qtip","Mark as Read");}switch(c.get("flagged")){case !0:a[0].setAttribute("data-qtip","Remove Flag");break;default:a[0].setAttribute("data-qtip","Add Flag");}},stringifyTo:function stringifyTo(b){var c=[];for(var a=0,d=b.length;a<d;a++){c.push(b[a].name)}return c.join(", ")}});Ext.define("conjoon.cn_mail.view.mail.mixin.LoadingFailedDialog",{requires:["coon.comp.component.MessageMask","coon.comp.window.Toast"],loadingFailedMask:null,showLoadingFailedDialog:function showLoadingFailedDialog(){var c=arguments.length>0&&arguments[0]!==undefined?arguments[0]:!0;var a=this;if(a.loadingFailedMask){return a.loadingFailedMask}var b=Ext.create("coon.comp.component.MessageMask",{title:"Loading failed",message:"I'm sorry, I could not load the message.",buttons:c!==!1?coon.comp.component.MessageMask.OK:undefined,target:a,callback:c!==!1?function(){a.close()}:undefined,scope:a,icon:coon.comp.component.MessageMask.FAILURE,dialogStyle:!1});a.mon(b,"destroy",function(){this.loadingFailedMask=null},a);b.show();a.loadingFailedMask=b;a.updateTargetHeader();a.showToast();return b},updateTargetHeader:function updateTargetHeader(){var a=this;a.setTitle("oops.");a.setIconCls("far fa-frown")},showToast:function showToast(){return coon.Toast.fail("The message could not be loaded.")}});Ext.define("conjoon.cn_mail.view.mail.message.AbstractAttachmentList",{extend:"Ext.view.View",requires:["conjoon.cn_mail.model.mail.message.AbstractAttachment","coon.core.util.Mime"],cls:"cn_mail-attachment-list",overItemCls:"over",selectedItemCls:"selected",itemSelector:"div.attachment",tpl:["<tpl for=\".\">","<div target=\"_blank\" class=\"attachment {[this.getPreviewCssClass(values.type, values.previewImgSrc)]}\" ","style=\"background-image:url({previewImgSrc})\">","<div class=\"imagecont\">","<span class=\"mimetype far {[this.getMimeTypeIcon(values.type)]}\"></span>","</div>","<div class=\"actioncont\">","<div class=\"attachmenticon fa fa-download\"></div>","<div class=\"linkcont\">","<div class=\"filename\">{text}</div>","<div class=\"filesize\">{[Ext.util.Format.fileSize(values.size)]}</div>","<div class=\"attachmentaction\">","<tpl if=\"this.displayButtonType('DOWNLOAD')\">","<a role=\"link\" href=\"{downloadUrl}\" class=\"downloadbutton fa fa-arrow-down\" download=\"{text}\"></a>","</tpl>","<tpl if=\"this.displayButtonType('REMOVE')\">","<a class=\"removebutton fa fa-times\"></a>","</tpl>","</div>","</div>","</div>","</div>","</tpl>"],initComponent:function initComponent(){var a=this;a.tpl=a.tpl.concat([{displayButtonType:a.displayButtonType.bind(a),getPreviewCssClass:a.getPreviewCssClass.bind(a),getMimeTypeIcon:a.getMimeTypeIcon.bind(a)}]);a.callParent(arguments)},getPreviewCssClass:function getPreviewCssClass(a,b){return coon.core.util.Mime.isImage(a)&&b?"preview":""},displayButtonType:Ext.emptyFn,getMimeTypeIcon:function getMimeTypeIcon(a){a=a+"";switch(a.toLowerCase()){case "image/jpeg":case "image/jpg":case "image/gif":case "image/png":case "image":return "fa-file-image";case "audio":return "fa-file-audio";case "video":return "fa-file-video";case "application/pdf":return "fa-file-pdf";case "text/plain":return "fa-file-alt";case "text/html":case "application/json":return "fa-file-code";case "application/gzip":case "application/zip":case "application/x-rar-compressed":case "application/x-zip-compressed":return "fa-file-archive";}return "fa-file"}});Ext.define("conjoon.cn_mail.view.mail.message.AbstractAttachmentListController",{extend:"Ext.app.ViewController",init:function init(){var a=this;a.mon(a.getView(),"itemclick",a.onAttachmentItemClick,a)},onAttachmentItemClick:Ext.emptyFn});Ext.define("conjoon.cn_mail.view.mail.message.reader.AttachmentListController",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentListController",alias:"controller.cn_mail-mailmessagereaderattachmentlistcontroller"});Ext.define("conjoon.cn_mail.view.mail.message.reader.AttachmentList",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentList",requires:["conjoon.cn_mail.view.mail.message.reader.AttachmentListController"],alias:"widget.cn_mail-mailmessagereaderattachmentlist",controller:"cn_mail-mailmessagereaderattachmentlistcontroller",displayButtonType:function displayButtonType(a){return a==="DOWNLOAD"}});function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(b){return typeof b}:function(b){return b&&"function"==typeof Symbol&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},_typeof(a)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function _regeneratorRuntime(){return a};var a={},l=Object.prototype,c=l.hasOwnProperty,f=Object.defineProperty||function(c,b,a){c[b]=a.value},k="function"==typeof Symbol?Symbol:{},g=k.iterator||"@@iterator",m=k.asyncIterator||"@@asyncIterator",i=k.toStringTag||"@@toStringTag";function define(b,a,c){return Object.defineProperty(b,a,{value:c,enumerable:!0,configurable:!0,writable:!0}),b[a]}try{define({},"")}catch(n){define=function define(c,b,a){return c[b]=a}}function wrap(g,a,h,d){var c=a&&a.prototype instanceof Generator?a:Generator,b=Object.create(c.prototype),e=new Context(d||[]);return f(b,"_invoke",{value:makeInvokeMethod(g,h,e)}),b}function tryCatch(c,b,a){try{return {type:"normal",arg:c.call(b,a)}}catch(o){return {type:"throw",arg:o}}}a.wrap=wrap;var b={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var h={};define(h,g,function(){return this});var j=Object.getPrototypeOf,e=j&&j(j(values([])));e&&e!==l&&c.call(e,g)&&(h=e);var d=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(h);function defineIteratorMethods(a){["next","throw","return"].forEach(function(b){define(a,b,function(c){return this._invoke(b,c)})})}function AsyncIterator(d,b){function invoke(i,j,e,f){var g=tryCatch(d[i],d,j);if("throw"!==g.type){var h=g.arg,a=h.value;return a&&"object"==_typeof(a)&&c.call(a,"__await")?b.resolve(a.__await).then(function(a){invoke("next",a,e,f)},function(a){invoke("throw",a,e,f)}):b.resolve(a).then(function(a){h.value=a,e(h)},function(a){return invoke("throw",a,e,f)})}f(g.arg)}var a;f(this,"_invoke",{value:function value(c,e){function callInvokeWithMethodAndArg(){return new b(function(a,f){invoke(c,e,a,f)})}return a=a?a.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(d,e,a){var c="suspendedStart";return function(i,j){if("executing"===c){throw new Error("Generator is already running")}if("completed"===c){if("throw"===i){throw j}return doneResult()}for(a.method=i,a.arg=j;;){var h=a.delegate;if(h){var g=maybeInvokeDelegate(h,a);if(g){if(g===b){continue}return g}}if("next"===a.method){a.sent=a._sent=a.arg}else if("throw"===a.method){if("suspendedStart"===c){throw c="completed",a.arg}a.dispatchException(a.arg)}else {"return"===a.method&&a.abrupt("return",a.arg)}c="executing";var f=tryCatch(d,e,a);if("normal"===f.type){if(c=a.done?"completed":"suspendedYield",f.arg===b){continue}return {value:f.arg,done:a.done}}"throw"===f.type&&(c="completed",a.method="throw",a.arg=f.arg)}}}function maybeInvokeDelegate(c,a){var d=a.method,g=c.iterator[d];if(undefined===g){return a.delegate=null,"throw"===d&&c.iterator["return"]&&(a.method="return",a.arg=undefined,maybeInvokeDelegate(c,a),"throw"===a.method)||"return"!==d&&(a.method="throw",a.arg=new TypeError("The iterator does not provide a '"+d+"' method")),b}var f=tryCatch(g,c.iterator,a.arg);if("throw"===f.type){return a.method="throw",a.arg=f.arg,a.delegate=null,b}var e=f.arg;return e?e.done?(a[c.resultName]=e.value,a.next=c.nextLoc,"return"!==a.method&&(a.method="next",a.arg=undefined),a.delegate=null,b):e:(a.method="throw",a.arg=new TypeError("iterator result is not an object"),a.delegate=null,b)}function pushTryEntry(a){var b={tryLoc:a[0]};1 in a&&(b.catchLoc=a[1]),2 in a&&(b.finallyLoc=a[2],b.afterLoc=a[3]),this.tryEntries.push(b)}function resetTryEntry(b){var a=b.completion||{};a.type="normal",delete a.arg,b.completion=a}function Context(a){this.tryEntries=[{tryLoc:"root"}],a.forEach(pushTryEntry,this),this.reset(!0)}function values(a){if(a){var e=a[g];if(e){return e.call(a)}if("function"==typeof a.next){return a}if(!isNaN(a.length)){var d=-1,b=function b(){for(;++d<a.length;){if(c.call(a,d)){return b.value=a[d],b.done=!1,b}}return b.value=undefined,b.done=!0,b};return b.next=b}}return {next:doneResult}}function doneResult(){return {value:undefined,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,f(d,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),f(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,i,"GeneratorFunction"),a.isGeneratorFunction=function(b){var a="function"==typeof b&&b.constructor;return !!a&&(a===GeneratorFunction||"GeneratorFunction"===(a.displayName||a.name))},a.mark=function(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,GeneratorFunctionPrototype):(a.__proto__=GeneratorFunctionPrototype,define(a,i,"GeneratorFunction")),a.prototype=Object.create(d),a},a.awrap=function(a){return {__await:a}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,m,function(){return this}),a.AsyncIterator=AsyncIterator,a.async=function(f,d,g,e,b){void 0===b&&(b=Promise);var c=new AsyncIterator(wrap(f,d,g,e),b);return a.isGeneratorFunction(d)?c:c.next().then(function(a){return a.done?a.value:c.next()})},defineIteratorMethods(d),define(d,i,"Generator"),define(d,g,function(){return this}),define(d,"toString",function(){return "[object Generator]"}),a.keys=function(d){var b=Object(d),a=[];for(var c in b){a.push(c)}return a.reverse(),function next(){for(;a.length;){var c=a.pop();if(c in b){return next.value=c,next.done=!1,next}}return next.done=!0,next}},a.values=values,Context.prototype={constructor:Context,reset:function reset(b){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!b){for(var a in this){"t"===a.charAt(0)&&c.call(this,a)&&!isNaN(+a.slice(1))&&(this[a]=undefined)}}},stop:function stop(){this.done=!0;var a=this.tryEntries[0].completion;if("throw"===a.type){throw a.arg}return this.rval},dispatchException:function dispatchException(f){if(this.done){throw f}var b=this;function handle(c,a){return h.type="throw",h.arg=f,b.next=c,a&&(b.method="next",b.arg=undefined),!!a}for(var d=this.tryEntries.length-1;d>=0;--d){var a=this.tryEntries[d],h=a.completion;if("root"===a.tryLoc){return handle("end")}if(a.tryLoc<=this.prev){var g=c.call(a,"catchLoc"),e=c.call(a,"finallyLoc");if(g&&e){if(this.prev<a.catchLoc){return handle(a.catchLoc,!0)}if(this.prev<a.finallyLoc){return handle(a.finallyLoc)}}else if(g){if(this.prev<a.catchLoc){return handle(a.catchLoc,!0)}}else {if(!e){throw new Error("try statement without catch or finally")}if(this.prev<a.finallyLoc){return handle(a.finallyLoc)}}}}},abrupt:function abrupt(f,g){for(var h=this.tryEntries.length-1;h>=0;--h){var d=this.tryEntries[h];if(d.tryLoc<=this.prev&&c.call(d,"finallyLoc")&&this.prev<d.finallyLoc){var a=d;break}}a&&("break"===f||"continue"===f)&&a.tryLoc<=g&&g<=a.finallyLoc&&(a=null);var e=a?a.completion:{};return e.type=f,e.arg=g,a?(this.method="next",this.next=a.finallyLoc,b):this.complete(e)},complete:function complete(a,c){if("throw"===a.type){throw a.arg}return "break"===a.type||"continue"===a.type?this.next=a.arg:"return"===a.type?(this.rval=this.arg=a.arg,this.method="return",this.next="end"):"normal"===a.type&&c&&(this.next=c),b},finish:function finish(d){for(var c=this.tryEntries.length-1;c>=0;--c){var a=this.tryEntries[c];if(a.finallyLoc===d){return this.complete(a.completion,a.afterLoc),resetTryEntry(a),b}}},"catch":function _catch(e){for(var b=this.tryEntries.length-1;b>=0;--b){var a=this.tryEntries[b];if(a.tryLoc===e){var c=a.completion;if("throw"===c.type){var d=c.arg;resetTryEntry(a)}return d}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(c,a,d){return this.delegate={iterator:values(c),resultName:a,nextLoc:d},"next"===this.method&&(this.arg=undefined),b}},a}function asyncGeneratorStep(h,c,e,f,d,i,g){try{var b=h[i](g);var a=b.value}catch(j){e(j);return}if(b.done){c(a)}else {Promise.resolve(a).then(f,d)}}function _asyncToGenerator(a){return function(){var c=this,b=arguments;return new Promise(function(d,e){var f=a.apply(c,b);function _next(b){asyncGeneratorStep(f,d,e,_next,_throw,"next",b)}function _throw(b){asyncGeneratorStep(f,d,e,_next,_throw,"throw",b)}_next(undefined)})}}Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageViewIframe",{extend:"coon.comp.component.Iframe",alias:"widget.cn_mail-mailmessagereadermessageviewiframe",requires:["coon.core.Template","coon.core.ThemeManager","coon.core.Environment","coon.core.ConfigManager"],publishes:["imagesAllowed"],imagesAllowed:!1,setSrcDoc:function setSrcDoc(a){var b=arguments,c=this;return _asyncToGenerator(_regeneratorRuntime().mark(function _callee(){var f,d,h,e,g,i;return _regeneratorRuntime().wrap(function _callee$(j){while(1){switch(j.prev=j.next){case 0:f=b.length>1&&b[1]!==undefined?b[1]:!1;d=c;d.imagesAllowed=!!f;d.publishState("imagesAllowed",d.imagesAllowed);if(a){j.next=6;break};return j.abrupt("return",d.superclass.setSrcDoc.apply(d,[a]));case 6:h=coon.core.ThemeManager.getTheme();e=h.get();g=coon.core.Environment.getPathForResource(coon.core.ConfigManager.get("extjs-app-webmail","resources.templates.html.reader"),"extjs-app-webmail");j.next=11;return coon.core.Template.load(g);case 11:i=j.sent;a=i.render({theme:e?e:{},reader:{body:a,imagesAllowed:d.imagesAllowed}});return j.abrupt("return",d.superclass.setSrcDoc.apply(d,[a]));case 14:case "end":return j.stop();}}},_callee)}))()},getImagesAllowed:function getImagesAllowed(){return this.imagesAllowed}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageViewController",{extend:"Ext.app.ViewController",alias:"controller.cn_mail-mailmessagereadermessageviewcontroller",requires:["coon.core.Environment"],control:{"cn_mail-mailmessagereadermessageviewiframe":{load:"onIframeLoad",beforesrcdoc:"onBeforeSrcDoc"},"#remoteImageWarning":{afterrender:"onRemoteImageWarningAfterrender"},"cn_mail-mailmessagereadermessageview":{resize:"onViewResize"}},onViewResize:function onViewResize(i,e,d,h,g){var f=this,a=f.getIframe(),c=a.getBody(),b=Ext.getScrollbarSize();a.setSize(e-b.width,d-b.height);a.setSize(c.scrollWidth,c.scrollHeight)},onRemoteImageWarningAfterrender:function onRemoteImageWarningAfterrender(b){var a=this;b.getEl().on("click",a.reloadWithImages,a)},onBeforeSrcDoc:function onBeforeSrcDoc(b,c){var a=this;a.getView().getViewModel().set("iframeLoaded",!1)},onIframeLoad:function onIframeLoad(a){var c=this,h=c.getView(),d=h.getViewModel(),f=a.getBody(),b=h.down("#msgBodyContainer"),e=Ext.getScrollbarSize();c.sanitizeLinks(a.cn_iframeEl.dom.contentWindow.document.getElementsByTagName("a"));var g=a.cn_iframeEl.dom.contentWindow.document.getElementsByTagName("img");d.set("hasImages",g.length>0);if(!a.getImagesAllowed()){c.sanitizeImages(g)}b.setScrollY(0);b.setScrollX(0);d.set("iframeLoaded",!0);d.notify();a.setSize(b.getWidth()-e.width,b.getHeight()-e.height);a.setSize(f.scrollWidth,f.scrollHeight)},sanitizeLinks:function sanitizeLinks(d){var a,b;for(var c=0,e=d.length;c<e;c++){a=d[c];b=a.getAttribute("href");if(!/^(((http|https|ftp):\/\/)|(mailto:))/.test(b)){a.removeAttribute("href");a.removeAttribute("target");continue}if(b.indexOf("mailto:")===0){a.setAttribute("href","#cn_mail/message/compose/"+encodeURIComponent(b));a.setAttribute("target","_top");continue}a.setAttribute("target","_blank")}},reloadWithImages:function reloadWithImages(){var a=this,b=a.getIframe();b.setSrcDoc(a.getViewModel().get("messageBody.textHtml"),!0)},sanitizeImages:function sanitizeImages(c){var b,a,d=c.length;for(a=0;a<d;a++){b=c[a];b.style.border="1px solid black";b.setAttribute("src",coon.core.Environment.getPathForResource("resources/images/img_block.png","extjs-app-webmail"))}},getIframe:function getIframe(){var b=this,a=b.getView();return a.down("cn_mail-mailmessagereadermessageviewiframe")}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageView",{extend:"Ext.Panel",mixins:["conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog","conjoon.cn_mail.view.mail.mixin.LoadingFailedDialog"],requires:["conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.view.mail.message.reader.MessageViewModel","conjoon.cn_mail.view.mail.message.reader.AttachmentList","conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.view.mail.message.reader.MessageViewIframe","conjoon.cn_mail.view.mail.message.reader.MessageViewController"],alias:"widget.cn_mail-mailmessagereadermessageview",config:{contextButtonsEnabled:!1},isCnMessageView:!0,layout:{type:"vbox",align:"stretch"},controller:"cn_mail-mailmessagereadermessageviewcontroller",viewModel:{type:"cn_mail-mailmessagereadermessageviewmodel"},hideMode:"offsets",split:!0,cls:"cn_mail-mailmessagereadermessageview shadow-panel",flex:1,title:"Loading...",iconCls:"fa fa-spin fa-spinner",bind:{title:"{isLoading ? \"Loading...\" : getSubject}",iconCls:"{isLoading ? \"fas fa-spin fa-spinner\" : \"far fa-envelope\"}"},closable:!0,loadingItem:null,loadingMask:null,items:[{xtype:"container",itemId:"msgHeaderContainer",cls:"cn_mail-header",height:82,layout:{type:"hbox",align:"stretch"},hidden:!0,bind:{hidden:"{!messageItem}"},items:[{xtype:"image",autoEl:"div",bind:{src:"{getSenderImage}"},cls:"sender-img fas fa-user",margin:"8 8 0 8"},{xtype:"container",flex:1,layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",margin:"5 5 0 0",layout:{type:"hbox"},items:[{xtype:"component",flex:1,cls:"message-subject",bind:{data:{date:"{getFormattedDate}",displayToAddress:"{getDisplayToAddress}",displayFromAddress:"{getDisplayFromAddress}"}},tpl:["<div class=\"from\">{displayFromAddress}</div>","<div class=\"to\">to {displayToAddress} on {date}</div>"]},{xtype:"button",scale:"small",reference:"htmlplainButton",enableToggle:!0,bind:{pressed:"{!!messageBody.textHtml}",iconCls:"{htmlplainButton.pressed ? \"fas fa-code\" : \"fas fa-align-left\"}",disabled:"{!messageBody.textHtml || !messageBody.textPlain}",visible:"{messageBody.textHtml || messageBody.textPlain}"},tooltip:{text:"Show text/html"}},{xtype:"button",scale:"small",iconCls:"fas fa-edit",tooltip:{text:"Edit this draft"},itemId:"btn-editdraft",visible:!1,bind:{visible:"{messageItem.draft && contextButtonsEnabled}"}},{xtype:"button",scale:"small",iconCls:"fas fa-trash",itemId:"btn-deletedraft",tooltip:{text:"Delete this draft"},visible:!1,bind:{visible:"{messageItem.draft && contextButtonsEnabled}"}},{visible:!1,bind:{visible:"{!messageItem.draft && contextButtonsEnabled}"},xtype:"splitbutton",iconCls:"fas fa-reply-all",text:"Reply all",itemId:"btn-replyall",menuAlign:"tr-br",menu:{items:[{text:"Reply",iconCls:"fas fa-reply",itemId:"btn-reply"},{text:"Forward",iconCls:"fas fa-share",itemId:"btn-forward"},"-",{text:"Delete",iconCls:"fas fa-trash",itemId:"btn-delete"}]}}]},{xtype:"component",flex:1,cls:"message-subject",bind:{data:{subject:"{getSubject}",hasAttachments:"{messageItem.hasAttachments}",isDraft:"{messageItem.draft}"}},tpl:["<div class=\"subject\">"+"<tpl if=\"isDraft\"><span class=\"draft\">[Draft]</span></tpl>"+"<tpl if=\"hasAttachments\"><span class=\"fa fa-paperclip\"></span></tpl>"+"{subject}","</div>"]}]}]},{xtype:"component",hidden:!0,bind:{hidden:"{!hasImages || cn_mail_iframe.imagesAllowed || !iframeLoaded}"},itemId:"remoteImageWarning",autoEl:{cls:"cn_mail-reloadWithImages",tag:"div",html:"Remote images are blocked in this message to protect your privacy. <span class=\"loadImg\">Display Images</span>"}},{flex:1,xtype:"box",hidden:!1,bind:{hidden:"{messageItem && messageBody && iframeLoaded}",data:{indicatorText:"{getIndicatorText}",indicatorIcon:"{getIndicatorIcon}"}},itemId:"msgIndicatorBox",tpl:["<div class=\"messageIndicator\">","<div class=\"{indicatorIcon} icon\"></div>","<div>{indicatorText}</div>","</div>"]},{xtype:"container",hideMode:"offsets",flex:1,cls:"cn_mail-body",hidden:!0,bind:{hidden:"{!messageBody || !iframeLoaded}"},itemId:"msgBodyContainer",scrollable:!0,layout:"auto",items:[{xtype:"cn_mail-mailmessagereaderattachmentlist",hidden:!0,bind:{store:"{attachmentStore}",hidden:"{!messageItem.hasAttachments}"}},{reference:"cn_mail_iframe",cls:"cn_mail-mailmessagereadermessageviewiframe",xtype:"cn_mail-mailmessagereadermessageviewiframe",scrolling:"no",sandbox:Ext.isGecko?"allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-top-navigation":"allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation",src:"",bind:{srcDoc:"{htmlplainButton.pressed ? messageBody.textHtml : textPlainToHtml}"}}]}],initComponent:function initComponent(){var a=this;a.on("afterrender",function(){var a=this;a.loadingMask=Ext.create("Ext.LoadMask",{target:a,bind:{hidden:"{!isLoading}"},listeners:{hide:function hide(b){b.destroy();a.loadingMask=null}}});a.loadingMask.show()},a,{single:!0});a.on("beforedestroy",function(){var a=this,b=a.getViewModel();if(a.loadingMask){a.loadingMask.destroy();a.loadingMask=null}if(a.loadingFailedMask){a.loadingFailedMask.destroy();a.loadingFailedMask=null}if(a.loadingItem){a.loadingItem.abort();a.loadingItem=null}b.abortMessageBodyLoad();b.abortMessageAttachmentsLoad()},a);a.callParent(arguments)},getMessageItem:function getMessageItem(){var a=this;return a.getViewModel().get("messageItem")},setMessageItem:function setMessageItem(b){var a=this;if(a.loadingFailedMask){a.loadingFailedMask.close();a.loadingFailedMask=null}a.getViewModel().setMessageItem(b?b:null)},loadMessageItem:function loadMessageItem(b){var a=this,c=a.getViewModel();if(!(b instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:b})}c.set("isLoading",!0);if(a.loadingItem){a.loadingItem.abort()}a.loadingItem=conjoon.cn_mail.model.mail.message.MessageItem.loadEntity(b,{success:a.onMessageItemLoaded,failure:a.onMessageItemLoadFailure,scope:a})},updateMessageItem:function updateMessageItem(a){var b=this;b.getViewModel().updateMessageItem(a)},privates:{onMessageItemLoadFailure:function onMessageItemLoadFailure(e,b){var a=this,c=a.getViewModel();c.set("isLoading",!1);c.notify();if(b.error&&b.error.status===-1){return}var d=a.ownerCt instanceof Ext.tab.Panel;return a.showLoadingFailedDialog(d)},onMessageItemLoaded:function onMessageItemLoaded(b){var a=this,c=a.getViewModel();a.setMessageItem(b);c.set("isLoading",!1);a.loadingItem=null;a.fireEvent("cn_mail-messageitemload",a,b)}},updateContextButtonsEnabled:function updateContextButtonsEnabled(a){var b=this;b.getViewModel().set("contextButtonsEnabled",a)}});Ext.define("conjoon.cn_mail.view.mail.account.MailAccountViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.model.mail.account.MailAccount"],alias:"viewmodel.cn_mail-mailaccountviewmodel",sourceMailAccounts:null,data:{mailAccount:null},formulas:{processReplyTo:{get:function get(b){var a=b("mailAccount.replyTo");return a.address},set:function set(c){var b=this,a=Ext.clone(b.get("mailAccount.replyTo")),d=b.get("mailAccount");a.address=c;d.set("replyTo",a)}},processFrom:{get:function get(a){var b=a("mailAccount.from");return b.address},set:function set(c){var b=this,a=Ext.clone(b.get("mailAccount.from")),d=b.get("mailAccount");a.address=c;d.set("from",a)}},processUserName:{get:function get(a){var b=a("mailAccount.from");return b.name},set:function set(c){var a=this,d=Ext.clone(a.get("mailAccount.from")),b=Ext.clone(a.get("mailAccount.replyTo")),e=a.get("mailAccount");d.name=c;b.name=c;e.set("from",d);e.set("replyTo",b)}}},constructor:function constructor(){var a=this;a.callParent(arguments);a.sourceMailAccounts={};a.saveOperations={}},setMailAccount:function setMailAccount(b){if(!(b instanceof conjoon.cn_mail.model.mail.account.MailAccount)){Ext.raise({msg:"\"mailAccount\" must be an instance of conjoon.cn_mail.model.mail.account.MailAccount",mailAccount:b})}var a=this,c=b.getId(),e=a.saveOperations[c]?a.saveOperations[c].getRecords()[0]:null;a.cleanup();if(a.saveOperations[c]){a.set("mailAccount",e);return e}var d=b.clone();a.sourceMailAccounts[c]=b;a.set("mailAccount",d);return d},cleanup:function cleanup(){var b=this,a=b.get("mailAccount.id");if(a&&b.saveOperations[a]&&b.saveOperations[a].isComplete()){delete b.saveOperations[a];delete b.sourceMailAccounts[a];return !0}return !1},savePendingChanges:function savePendingChanges(){var a=this,c=a.getView(),b=a.get("mailAccount");if(!b||!b.modified){return null}c.fireEvent("cn_mail-mailaccountbeforesave",c,b);var d=b.save({success:a.onSaveSuccess,failure:a.onSaveFailure,scope:a});a.saveOperations[b.getId()]=d;return d},onSaveSuccess:function onSaveSuccess(a){var d=this,c=d.getView(),b=d.sourceMailAccounts[a.getId()];var e=Ext.copy({},a.data,["name","from","replyTo","inbox_type","inbox_address","inbox_port","inbox_ssl","inbox_user","inbox_password","outbox_type","outbox_address","outbox_port","outbox_secure","outbox_user","outbox_password"].join(","));b.set(e);b.commit();c.fireEvent("cn_mail-mailaccountsave",c,a)},onSaveFailure:function onSaveFailure(b){var c=this,a=c.getView();a.fireEvent("cn_mail-mailaccountsavefailure",a,b)}});Ext.define("conjoon.cn_mail.view.mail.account.MailAccountViewController",{extend:"Ext.app.ViewController",alias:"controller.cn_mail-mailaccountviewcontroller",control:{"cn_mail-mailaccountview":{"cn_mail-mailaccountbeforesave":"onBeforeMailAccountSave","cn_mail-mailaccountsave":"onMailAccountSaveCallback","cn_mail-mailaccountsavefailure":"onMailAccountSaveCallback",hide:"onMailAccountViewHide"},"#saveButton":{click:"onSaveButtonClick"},"#cancelButton":{click:"onCancelButtonClick"}},onSaveButtonClick:function onSaveButtonClick(c){var b=this,a=b.getView();return a.getViewModel().savePendingChanges()},onCancelButtonClick:function onCancelButtonClick(c){var b=this,a=b.getView();return a.rejectPendingChanges()},onBeforeMailAccountSave:function onBeforeMailAccountSave(a,b){a.setBusy()},onMailAccountSaveCallback:function onMailAccountSaveCallback(a,b){a.setBusy(!1);if(!a.isVisible()){a.getViewModel().cleanup()}},onMailAccountViewHide:function onMailAccountViewHide(a){a.getViewModel().cleanup()}});Ext.define("conjoon.cn_mail.view.mail.account.MailAccountView",{extend:"Ext.Panel",requires:["Ext.form.FieldSet","conjoon.cn_mail.view.mail.account.MailAccountViewModel","conjoon.cn_mail.view.mail.account.MailAccountViewController"],alias:"widget.cn_mail-mailaccountview",viewModel:"cn_mail-mailaccountviewmodel",controller:"cn_mail-mailaccountviewcontroller",cls:"cn_mail-mailaccountview",layout:{type:"vbox",align:"center"},busyMask:null,items:[{scrollable:"y",bodyPadding:"0 40 0 40",margin:"0 0 5 0",flex:1,layout:{type:"vbox",align:"stretch"},xtype:"form",bind:{title:"Account Settings - {mailAccount.name}"},buttons:[{text:"Cancel",width:108,itemId:"cancelButton"},{text:"Save",itemId:"saveButton",width:108}],minWidth:800,cls:"fieldsetCnt",defaults:{margin:"40 0 0 0",defaults:{labelWidth:160,labelAlign:"right",flex:"1"},layout:{type:"vbox",align:"stretch"}},items:[{xtype:"fieldset",title:"General Information",margin:"10 0 0 0",items:[{xtype:"textfield",fieldLabel:"Account Name",name:"name",bind:{value:"{mailAccount.name}"}},{xtype:"textfield",fieldLabel:"Your Name",name:"userName",bind:{value:"{processUserName}"}},{xtype:"textfield",name:"from",fieldLabel:"Email-Address",bind:{value:"{processFrom}"}},{xtype:"textfield",name:"replyTo",fieldLabel:"Reply-To",bind:{value:"{processReplyTo}"}}]},{xtype:"fieldset",bind:{title:"Incoming Server ({mailAccount.inbox_type})"},items:[{xtype:"container",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:9,labelWidth:160,fieldLabel:"Address",name:"inbox_address",bind:{value:"{mailAccount.inbox_address}"}},{xtype:"textfield",margin:"0 0 0 5",flex:1,labelWidth:10,fieldLabel:" ",name:"inbox_port",bind:{value:"{mailAccount.inbox_port}"}}]},{xtype:"checkbox",labelWidth:160,inputValue:!0,fieldLabel:"Use SSL",name:"inbox_ssl",bind:{value:"{mailAccount.inbox_ssl}"}},{xtype:"container",margin:"0 0 10 0",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:1,labelWidth:160,name:"inbox_user",fieldLabel:"Username",bind:{value:"{mailAccount.inbox_user}"}},{xtype:"textfield",margin:"0 0 0 20",inputType:"password",flex:1,labelWidth:80,name:"inbox_password",fieldLabel:"Password",bind:{value:"{mailAccount.inbox_password}"}}]}]},{xtype:"fieldset",title:"SMTP Server",items:[{xtype:"container",anchor:"100%",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:9,labelWidth:160,fieldLabel:"Address",name:"outbox_address",bind:{value:"{mailAccount.outbox_address}"}},{xtype:"textfield",margin:"0 0 0 5",flex:1,name:"outbox_port",labelWidth:10,fieldLabel:" ",bind:{value:"{mailAccount.outbox_port}"}}]},{xtype:"combobox",labelWidth:160,fieldLabel:"Secure",cls:"outbox_secure",name:"outbox_secure",displayField:"value",editable:!1,valueField:"id",store:{data:[{id:"ssl",value:"SSL"},{id:"tls",value:"TLS"}]},bind:{value:"{mailAccount.outbox_secure}"}},{xtype:"container",margin:"0 0 10 0",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:1,labelWidth:160,name:"outbox_user",fieldLabel:"Username",bind:{value:"{mailAccount.outbox_user}"}},{xtype:"textfield",margin:"0 0 0 20",inputType:"password",flex:1,labelWidth:80,name:"outbox_password",fieldLabel:"Password",bind:{value:"{mailAccount.outbox_password}"}}]}]}]}],setMailAccount:function setMailAccount(a){var b=this,c=b.getViewModel(),d=a?a.getId():null;if(!a){return null}b.setBusy(!!c.saveOperations[d]);return c.setMailAccount(a)},hasPendingChanges:function hasPendingChanges(){var b=this,a=b.getViewModel().get("mailAccount");return !!(a&&a.modified)},rejectPendingChanges:function rejectPendingChanges(){var b=this,a=b.getViewModel().get("mailAccount");if(!a||!a.modified){return !1}a.reject();return !0},setBusy:function setBusy(){var c=arguments.length>0&&arguments[0]!==undefined?arguments[0]:!0;var b=this;var a=b.busyMask;if(c===!1){if(a){a.hide()}return a}if(!a&&c!==!1){a=Ext.create("coon.comp.component.LoadMask",{msg:"Saving account",msgAction:"Please wait...",glyphCls:"fa fa-spin fa-gear",target:b});b.busyMask=a}a.show();a.loopProgress();return a}});Ext.define("conjoon.cn_mail.view.mail.inbox.InboxView",{extend:"Ext.Panel",alias:"widget.cn_mail-mailinboxview",mixins:["conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog"],requires:["conjoon.cn_mail.view.mail.inbox.InboxViewModel","conjoon.cn_mail.view.mail.inbox.InboxViewController","conjoon.cn_mail.view.mail.folder.MailFolderTree","conjoon.cn_mail.view.mail.message.MessageGrid","conjoon.cn_mail.view.mail.message.reader.MessageView","conjoon.cn_mail.view.mail.account.MailAccountView"],layout:{type:"hbox",align:"stretch"},viewModel:"cn_mail-mailinboxviewmodel",controller:"cn_mail-mailinboxviewcontroller",bodyCls:"cn_mail-panel-body",iconCls:"fa fa-paper-plane",title:"Emails",canCloseAfterDelete:!1,deleteMask:null,items:[{xtype:"cn_mail-mailfoldertree",margin:"0 0 5 0",reference:"cn_mail_ref_mailfoldertree",bind:{store:"{cn_mail_mailfoldertreestore}"}},{split:!0,xtype:"panel",itemId:"cn_mail-mailInboxViewPanelBody",flex:1,bodyCls:"cn_mail-panel-body",layout:{type:"hbox",enableSplitters:!0,align:"stretch"},items:[{xtype:"container",itemId:"cn_mail-mailmessagegridcontainer",cls:"messageGridContainer shadow-panel",bind:{margin:"{computeMessageGridMargin}"},layout:{type:"vbox",align:"stretch"},flex:1,items:[{flex:1,xtype:"box",margin:"0 5 5 0",hidden:!1,cls:"cn-lightestBox shadow-panel",bind:{hidden:"{cn_mail_ref_mailfoldertree.selection}"},data:{indicatorIcon:"fa-folder",indicatorText:"Select a folder to view its contents."},itemId:"msgIndicatorBox",tpl:["<div class=\"messageIndicator\">","<div class=\"far {indicatorIcon} icon\"></div>","<div>{indicatorText}</div>","</div>"]},{flex:1,hidden:!0,xtype:"cn_mail-mailaccountview",bind:{mailAccount:"{cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\" && cn_mail_ref_mailfoldertree.selection}",hidden:"{!cn_mail_ref_mailfoldertree.selection || cn_mail_ref_mailfoldertree.selection.folderType !== \"ACCOUNT\"}"}},{flex:1,hidden:!0,xtype:"cn_mail-mailmessagegrid",reference:"cn_mail_ref_mailmessagegrid",bind:{representedFolderType:"{cn_mail_ref_mailfoldertree.selection.folderType}",title:"{cn_mail_ref_mailfoldertree.selection.name}",hidden:"{!cn_mail_ref_mailfoldertree.selection || cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\"}",store:"{cn_mail_mailmessageitemstore}"}}]},{flex:1,xtype:"cn_mail-mailmessagereadermessageview",margin:"0 5 5 0",header:!1,hidden:!0,bind:{contextButtonsEnabled:"{cn_mail_ref_mailmessagegrid.selection}",hidden:"{messageViewHidden || (!cn_mail_ref_mailfoldertree.selection || cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\")}",messageItem:"{cn_mail_ref_mailmessagegrid.selection}"}}]}],toggleReadingPane:function toggleReadingPane(a){a=a==="right"||a==="bottom"?a:!1;var d=this,g=a==="right"?"vertical":"horizontal",f=a==="right"?"left":"bottom",c=d.down("#cn_mail-mailInboxViewPanelBody"),b=c.down("cn_mail-mailmessagereadermessageview"),e=c.down("#cn_mail-mailmessagegridcontainer");if(!a){d.getViewModel().set("messageViewHidden",!0);return}d.getViewModel().set("messageViewHidden",!1);d.getViewModel().notify();b.splitter.destroy();b.splitter=null;b.collapseDirection=f;c.getLayout().setVertical(a!=="right");c.getLayout().insertSplitter(b,1,!1,{collapseTarget:"next"});b.splitter.setOrientation(g);if(a==="right"){e.setMargin("0 0 5 0")}else {e.setMargin("0 5 0 0")}},updateViewForCreatedDraft:function updateViewForCreatedDraft(a){var b=this;b.getController().updateViewForCreatedDraft(a)},updateViewForSentDraft:function updateViewForSentDraft(a){var b=this;b.getController().updateViewForSentDraft(a)},showMailAccountIsBeingEditedNotice:function showMailAccountIsBeingEditedNotice(e){var a=this,d=a.getIconCls(),f=a.down("cn_mail-mailfoldertree"),c=a.down("cn_mail-mailaccountview"),b;b=Ext.create("coon.comp.component.MessageMask",{title:"Pending Changes",message:"The changes to the Email-Account have not been saved yet. Do you want to discard the changes?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:function callback(a){var b=this;b.setIconCls(d);if(a==="yesButton"){c.rejectPendingChanges();f.getSelectionModel().select(e);return}},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);b.show();return b}});Ext.define("conjoon.cn_mail.view.mail.message.editor.AttachmentListController",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentListController",requires:["coon.core.util.Mime","conjoon.cn_mail.model.mail.message.DraftAttachment"],alias:"controller.cn_mail-mailmessageeditorattachmentlistcontroller",control:{"cn_mail-mailmessageeditorattachmentlist":{"beforedestroy":"onAttachmentListBeforeDestroy"}},addAttachment:function addAttachment(a){var f=this,g=f.getView(),e=g.getStore(),d=e.getModel().getName(),h=d==="conjoon.cn_mail.model.mail.message.DraftAttachment",b,c;if(!(a instanceof File)){Ext.raise({source:Ext.getClassName(this),msg:"argument for addAttachment must be a native File Object"})}if(!h){Ext.raise({source:Ext.getClassName(this),msg:"The store's model must be of type DraftAttachment."})}c=Ext.create(d,{text:a.name,size:a.size,type:a.type,downloadUrl:window.URL.createObjectURL(a),file:a});e.add(c);if(coon.core.util.Mime.isImage(a.type)){b=new FileReader();b.addEventListener("load",f.onFileReaderLoad.bind(this),{once:!0});b.cn_id=c.getId();b.readAsDataURL(a)}return c},onFileReaderLoad:function onFileReaderLoad(b){var f=this,d=f.getView(),c=d.getStore(),e=b.target.cn_id,a;a=c.findExact("localId",e);if(a===-1){return}a=c.getAt(a);a.set("previewImgSrc",b.target.result);b=null;return a},onAttachmentItemClick:function onAttachmentItemClick(b,a,f,e,c,d){if(c.target.className.indexOf("removebutton")!==-1){b.getStore().remove(a)}},onAttachmentListBeforeDestroy:function onAttachmentListBeforeDestroy(){var b=this,a=b.getView().getStore(),c=a&&!a.destroyed?a.getRange():[];b.destroyFileAssociations(c)},privates:{destroyFileAssociations:function destroyFileAssociations(b){for(var a=0,c=b.length;a<c;a++){window.URL.revokeObjectURL(b[a].get("downloadUrl"))}}}});Ext.define("conjoon.cn_mail.view.mail.message.editor.AttachmentList",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentList",requires:["conjoon.cn_mail.model.mail.message.AbstractAttachment","conjoon.cn_mail.view.mail.message.editor.AttachmentListController","coon.core.util.Mime"],alias:"widget.cn_mail-mailmessageeditorattachmentlist",controller:"cn_mail-mailmessageeditorattachmentlistcontroller",config:{editMode:undefined},applyEditMode:function applyEditMode(a){var b=this;a=a===undefined?"CREATE":a;if(Ext.Array.indexOf(["CREATE","EDIT"],a)===-1){Ext.raise({source:Ext.getClassName(b),msg:"editMode must be one of EDIT or CREATE"});return}if(b.getEditMode()===undefined){return a}else {Ext.raise({source:Ext.getClassName(b),msg:"Property editMode cannot be changed during runtime"})}},addAttachment:function addAttachment(a){return this.getController().addAttachment(a)},displayButtonType:function displayButtonType(a){return !0}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditorDragDropListener",{dragEnterCount:0,view:null,constructor:function constructor(a){var b=this;Ext.apply(b,a)},init:function init(){var a=this,b=a.view;b.on("afterrender",a.installDragDropListeners,a,{single:!0})},installDragDropListeners:function installDragDropListeners(){var a=this,b=a.view,c=b.down("#attachmentListWrap").el;b.mon(c,"dragenter",a.onAttachmentListWrapDragEnter,a);b.mon(c,"dragover",a.onAttachmentListWrapDragOver,a);b.mon(c,"dragleave",a.onAttachmentListWrapDragLeave,a);b.mon(c,"dragend",a.onAttachmentListWrapDragEnd,a);b.mon(c,"drop",a.onAttachmentListWrapDrop,a)},registerAttachmentListWrapEnter:function registerAttachmentListWrapEnter(c,b){var a=this,d=a.view;if(c){a.dragEnterCount++}else {a.dragEnterCount--}a.dragEnterCount=a.dragEnterCount<0||b===!0?0:a.dragEnterCount;d.down("#attachmentListWrap").el[a.dragEnterCount?"addCls":"removeCls"]("hover")},onAttachmentListWrapDragOver:function onAttachmentListWrapDragOver(a){a.preventDefault()},onAttachmentListWrapDragEnter:function onAttachmentListWrapDragEnter(b){b.preventDefault();var a=this;a.registerAttachmentListWrapEnter(!0)},onAttachmentListWrapDragLeave:function onAttachmentListWrapDragLeave(b){b.preventDefault();var a=this;a.registerAttachmentListWrapEnter(!1)},onAttachmentListWrapDragEnd:function onAttachmentListWrapDragEnd(b){b.preventDefault();var a=this;a.registerAttachmentListWrapEnter(!1,!0)},onAttachmentListWrapDrop:function onAttachmentListWrapDrop(c){c.preventDefault();var b=this,a=c.event.dataTransfer,d=b.view.getController();b.registerAttachmentListWrapEnter(!1,!0);if(a&&a.files){d.addAttachmentsFromFileList(a.files)}}});Ext.define("conjoon.cn_mail.data.mail.message.EditingModes",{statics:{EDIT:"EDIT",CREATE:"CREATE",REPLY_TO:"REPLY_TO",REPLY_ALL:"REPLY_ALL",FORWARD:"FORWARD"}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditorViewController",{extend:"Ext.app.ViewController",requires:["l8","coon.core.ConfigManager","conjoon.cn_mail.view.mail.message.editor.MessageEditorDragDropListener","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.service.MailboxService","coon.core.data.request.Configurator"],statics:{required:{requestConfigurator:"coon.core.data.request.Configurator"}},alias:"controller.cn_mail-mailmessageeditorviewcontroller",control:{"cn_mail-mailmessageeditorhtmleditor > toolbar > cn_comp-formfieldfilebutton":{change:"onFormFileButtonChange"},"#showCcBccButton":{click:"onShowCcBccButtonClick"},"#sendButton":{click:"onSendButtonClick"},"#saveButton":{click:"onSaveButtonClick"},"cn_mail-mailmessageeditor":{"beforedestroy":"onMailMessageEditorBeforeDestroy","cn_mail-mailmessagesaveoperationcomplete":"onMailMessageSaveOperationComplete","cn_mail-mailmessagesaveoperationexception":"onMailMessageSaveOperationException","cn_mail-mailmessagesavecomplete":"onMailMessageSaveComplete","cn_mail-mailmessagebeforesave":"onMailMessageBeforeSave","cn_mail-mailmessagebeforesend":"onMailMessageBeforeSend","cn_mail-mailmessagesendcomplete":"onMailMessageSendComplete","cn_mail-mailmessagesendexception":"onMailMessageSendException"}},deferTimers:null,ddListener:null,mailboxService:null,closeAfterMs:1000,init:function init(){var a=this,b=a.getView();a.deferTimers={};a.ddListener=Ext.create("conjoon.cn_mail.view.mail.message.editor.MessageEditorDragDropListener",{view:b});b.on({"afterrender":{fn:a.onMessageEditorAfterrender,scope:a,single:!0},"beforeclose":{fn:a.onMailEditorBeforeClose,scope:a}});a.ddListener.init()},onMessageEditorAfterrender:function onMessageEditorAfterrender(e){var d=this,a=d.getView(),c,b;a.showMessageDraftLoadingNotice(a.editMode==="CREATE");if(a.editMode===conjoon.cn_mail.data.mail.message.EditingModes.FORWARD){c=a.down("#toField");d.deferTimers["toFieldFocus"]=Ext.Function.defer(c.focus,100,c)}else {b=a.down("cn_mail-mailmessageeditorhtmleditor");d.deferTimers["htmlEditorFocus"]=Ext.Function.defer(b.focus,100,b)}},onMailEditorBeforeClose:function onMailEditorBeforeClose(){var b=this,c=b.getViewModel(),a=b.getView();if(!a.getMessageDraft()||!c.isDraftDirty()){return !0}b.redirectTo(a.cn_href);a.showConfirmCloseDialog();return !1},onMailMessageEditorBeforeDestroy:function onMailMessageEditorBeforeDestroy(){var b=this,a=b.getView();for(var c in b.deferTimers){if(!Object.prototype.hasOwnProperty.call(b.deferTimers,c)){continue}window.clearTimeout(b.deferTimers[c]);delete b.deferTimers[c]}if(a.busyMask){a.busyMask.destroy();a.busyMask=null}if(a.loadingFailedMask){a.loadingFailedMask.destroy();a.loadingFailedMask=null}if(a.loadingMask){a.loadingMask.destroy();a.loadingMask=null}if(b.ddListener){b.ddListener.destroy();b.ddListener=null}},addAttachmentsFromFileList:function addAttachmentsFromFileList(b){var f=this,d=f.getView(),c=d.down("cn_mail-mailmessageeditorattachmentlist");for(var a=0,e=b.length;a<e;a++){c.addAttachment(b[a])}},onFormFileButtonChange:function onFormFileButtonChange(c,e,d,a){var b=this;b.addAttachmentsFromFileList(a)},onShowCcBccButtonClick:function onShowCcBccButtonClick(c){var b=this,a=b.getView();a.showCcBccFields(a.down("#ccField").isHidden())},onSendButtonClick:function onSendButtonClick(b){var a=this;a.configureAndStartSaveBatch(!0)},onSaveButtonClick:function onSaveButtonClick(b){var a=this;a.configureAndStartSaveBatch()},onMailMessageSaveOperationComplete:function onMailMessageSaveOperationComplete(d,c,a){var b=this;b.setViewBusy(a)},onMailMessageSaveOperationException:function onMailMessageSaveOperationException(h,b,e,d,c,f){var a=this,g=a.getView();a.endBusyState("saving");g.showMailMessageSaveFailedNotice(b,e,Ext.Function.bindCallback(function(k,j,l,g){var i=this,a=i.getView();if(g!=="yesButton"||a.fireEvent("cn_mail-mailmessagebeforesave",a,b,k,j,!0)===!1){if(g!=="yesButton"){a.getViewModel().get("messageDraft.attachments").rejectChanges()}i.endBusyState("saving");return}l.retry()},a,[d,c,f]));return !1},onMailMessageSaveComplete:function onMailMessageSaveComplete(f,d,c,b,e){var a=this;a.setViewBusy(c,1);if(b!==!0){a.deferTimers["savecomplete"]=Ext.Function.defer(a.endBusyState,750,a,["saving"])}else {a.deferTimers["savecompletesend"]=Ext.Function.defer(function(){var a=this;a.endBusyState("saving");a.sendMessage()},750,a)}},onMailMessageBeforeSave:function onMailMessageBeforeSave(g,a,f,e){var c=this,b=c.getView(),d=b.getViewModel();if(!a.get("mailFolderId")||!a.get("mailAccountId")){Ext.raise({msg:"compound key for message draft missing",mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId")});return !1}if(!Ext.String.trim(a.get("subject"))&&d.get("isSubjectRequired")===!0){b.showSubjectMissingNotice(a,Ext.Function.bindCallback(function(c,b,d,h,i){var j=this;if(h!=="okButton"){return}if(!Ext.String.trim(i)){d.set("isSubjectRequired",!1)}j.configureAndStartSaveBatch(c,b)},c,[f,e,d]));return !1}c.commitBodyAndAttachments();d.set("isSaving",!0);b.setBusy({msg:"Saving Mail",msgAction:"Stand by..."})},commitBodyAndAttachments:function commitBodyAndAttachments(){"use strict";var g=this,f=g.getViewModel();var d,c,b,a;d=f.get("messageDraft.attachments").getRange();for(var e=d.length-1;e>=0;e--){b=d[e];a=b.modified?Object.keys(b.modified):null;if(b.crudState==="U"&&a&&a.length===1&&a[0]==="messageItemId"){b.commit(!0)}}c=f.get("messageDraft.messageBody");a=c.modified?Object.keys(c.modified):null;if(c.crudState==="U"&&a&&a.length===1&&a[0]==="messageBodyId"){c.commit(!0)}},onMailMessageBeforeSend:function onMailMessageBeforeSend(e,a){var c=this,b=c.getView(),d=b.getViewModel();if(!a.get("to").length&&!a.get("cc").length&&!a.get("bcc").length){b.showAddressMissingNotice(a);return !1}d.set("isSending",!0);b.setBusy({msg:"Sending Mail",msgAction:"Please wait..."})},onMailMessageSendComplete:function onMailMessageSendComplete(d,c){var a=this,b=a.getView();b.setBusy({msgAction:"Message sent successfully.",progress:1});b.un("beforeclose",a.onMailEditorBeforeClose,a);a.deferTimers.sendcomplete=Ext.Function.defer(b.close,a.closeAfterMs,b)},onMailMessageSendException:function onMailMessageSendException(e,d){var a=this,b=a.getView(),c=b.getViewModel();c.set("isSending",!1);b.setBusy({msgAction:"Error :(",progress:1});a.deferTimers["sendexception"]=Ext.Function.defer(a.endBusyState,750,a,["sending"])},privates:{getSendMessageDraftRequestConfig:function getSendMessageDraftRequestConfig(a,b){var d=this;if(!l8.isString(b)){throw "\"baseAddress\" must be a string"}var c=[b,"MailAccounts",encodeURIComponent(a.getCompoundKey().getMailAccountId()),"MailFolders",encodeURIComponent(a.getCompoundKey().getMailFolderId()),"MessageItems",encodeURIComponent(a.getCompoundKey().getId())].join("/");return d.requestConfigurator.configure({url:l8.unify(c,"/","://"),method:"POST"})},buildRequest:function buildRequest(a){return a},sendMessage:function sendMessage(){"use strict";var c=this,a=c.getView(),e=a.getViewModel(),b=e.get("messageDraft");if(b.dirty||b.phantom){Ext.raise({msg:"Cannot send MessageDraft: Needs to get saved before.",cls:Ext.getClassName(c)})}if(a.fireEvent("cn_mail-mailmessagebeforesend",a,b)===!1){return !1}var d=coon.core.ConfigManager.get("extjs-app-webmail","service.rest-api-email.base");Ext.Ajax.request(c.getSendMessageDraftRequestConfig(b,d)).then(function(c,d){a.fireEvent("cn_mail-mailmessagesendcomplete",a,b)},function(c,d){a.fireEvent("cn_mail-mailmessagesendexception",a,b)})},configureAndStartSaveBatch:function configureAndStartSaveBatch(e){var f=this,a=f.getView(),h=a.getViewModel(),g=a.getSession(),b=h.get("messageDraft"),d=b.phantom===!0,c;f.applyAccountInformation(b);if(a.fireEvent("cn_mail-mailmessagebeforesave",a,b,e===!0,d===!0)===!1){return !1}c=g.getSaveBatch();c.setPauseOnException(!0);c.on({operationcomplete:{fn:function fn(d,c){a.fireEvent("cn_mail-mailmessagesaveoperationcomplete",a,b,c)},scope:a},exception:{fn:function fn(f,c){a.fireEvent("cn_mail-mailmessagesaveoperationexception",a,b,c,e===!0,d===!0,f)},scope:a},complete:{fn:function fn(f,c){b.set("savedAt",new Date());a.fireEvent("cn_mail-mailmessagesavecomplete",a,b,c,e===!0,d===!0)},scope:a,single:!0}});c.start()},applyAccountInformation:function applyAccountInformation(a){var e=this,g=e.getView(),h=g.getViewModel(),f=e.getMailboxService(),c=a.get("mailAccountId");if(!a.get("mailFolderId")){var d=f.getMailFolderHelper().getMailFolderIdForType(c,conjoon.cn_mail.data.mail.folder.MailFolderTypes.DRAFT);if(!d){Ext.raise({msg:"Unexpected error: No draft folder for mailAccountId found",mailAccountId:c})}a.set("mailFolderId",d)}var b=h.get("cn_mail_mailfoldertreestore").findRecord("id",c);a.set("from",{name:b.get("from").name,address:b.get("from").address});a.set("replyTo",{name:b.get("replyTo").name,address:b.get("replyTo").address});a.set("date",new Date())},getMailboxService:function getMailboxService(){var a=this;if(!a.mailboxService){a.mailboxService=conjoon.cn_mail.MailboxService.getInstance()}return a.mailboxService},endBusyState:function endBusyState(a){var c=this,b=c.getView(),d=b.getViewModel();switch(a){case "sending":d.set("isSending",!1);break;case "saving":d.set("isSaving",!1);break;default:Ext.raise({msg:"Unknown busy type.",type:a,cls:Ext.getClassName(c)});}b.setBusy(!1)},setViewBusy:function setViewBusy(a,b){var d=this,c=d.getView();c.setBusy({msgAction:Ext.String.format("{1} {0}.",a.getAction()==="destroy"?"removed":"saved",a.entityType.entityName),progress:b})}}});Ext.define("conjoon.cn_mail.model.mail.message.EmailAddress",{extend:"conjoon.cn_mail.model.mail.BaseModel",entityName:"EmailAddress",idProperty:"id",fields:[{name:"name",type:"string"},{name:"address",type:"string"}]});Ext.define("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",{config:{to:undefined,cc:undefined,bcc:undefined,subject:undefined,seen:!0,textPlain:undefined,textHtml:undefined,attachments:undefined,answered:!1,recent:!1,draft:!0,flagged:!1,mailAccountId:undefined,mailFolderId:undefined,references:undefined,inReplyTo:undefined,xCnDraftInfo:undefined},constructor:function constructor(a){this.initConfig(a)},toObject:function toObject(){var a=this,b={};if(a.getTo()!==undefined){b.to=a.getTo()}if(a.getCc()!==undefined){b.cc=a.getCc()}if(a.getBcc()!==undefined){b.bcc=a.getBcc()}if(a.getSubject()!==undefined){b.subject=a.getSubject()}if(a.getTextPlain()!==undefined){b.messageBody=b.messageBody||{};b.messageBody.textPlain=a.getTextPlain()}if(a.getTextHtml()!==undefined){b.messageBody=b.messageBody||{};b.messageBody.textHtml=a.getTextHtml()}if(a.getAttachments()!==undefined){b.attachments=a.getAttachments()}if(a.getSeen()!==undefined){b.seen=a.getSeen()}if(a.getAnswered()!==undefined){b.answered=a.getAnswered()}if(a.getDraft()!==undefined){b.draft=a.getDraft()}if(a.getFlagged()!==undefined){b.flagged=a.getFlagged()}if(a.getRecent()!==undefined){b.recent=a.getRecent()}if(a.getMailFolderId()!==undefined){b.mailFolderId=a.getMailFolderId()}if(a.getMailAccountId()!==undefined){b.mailAccountId=a.getMailAccountId()}if(a.getReferences()!==undefined){b.references=a.getReferences()}if(a.getInReplyTo()!==undefined){b.inReplyTo=a.getInReplyTo()}if(a.getXCnDraftInfo()!==undefined){b.xCnDraftInfo=a.getXCnDraftInfo()}return b},applyFlagged:function applyFlagged(b){var a=this;if(a.getFlagged()!==undefined){Ext.raise({flagged:a.getFlagged(),msg:"\"flagged\" is immutable"})}return b},applySeen:function applySeen(b){var a=this;if(a.getSeen()!==undefined){Ext.raise({seen:a.getSeen(),msg:"\"seen\" is immutable"})}return b},applyRecent:function applyRecent(b){var a=this;if(a.getRecent()!==undefined){Ext.raise({recent:a.getRecent(),msg:"\"recent\" is immutable"})}return b},applyDraft:function applyDraft(b){var a=this;if(a.getDraft()!==undefined){Ext.raise({draft:a.getDraft(),msg:"\"draft\" is immutable"})}return b},applyAnswered:function applyAnswered(b){var a=this;if(a.getAnswered()!==undefined){Ext.raise({answered:a.getAnswered(),msg:"\"answered\" is immutable"})}return b},applyTextPlain:function applyTextPlain(b){var a=this;if(a.getTextPlain()!==undefined){Ext.raise({textPlain:a.getTextPlain(),msg:"\"textPlain\" is immutable"})}return b},applyTextHtml:function applyTextHtml(b){var a=this;if(a.getTextHtml()!==undefined){Ext.raise({textHtml:a.getTextHtml(),msg:"\"textHtml\" is immutable"})}return b},applySubject:function applySubject(b){var a=this;if(a.getSubject()!==undefined){Ext.raise({subject:a.getSubject(),msg:"\"subject\" is immutable"})}return b},applyMailFolderId:function applyMailFolderId(b){var a=this;if(a.getMailFolderId()!==undefined){Ext.raise({mailFolderId:a.getMailFolderId(),msg:"\"mailFolderId\" is immutable"})}return b},applyMailAccountId:function applyMailAccountId(b){var a=this;if(a.getMailAccountId()!==undefined){Ext.raise({mailAccountId:a.getMailAccountId(),msg:"\"mailAccountId\" is immutable"})}return b},applyAttachments:function applyAttachments(a){var d=this,c=[];if(a===undefined){return}if(d.getAttachments()!==undefined){Ext.raise({attachments:d.getAttachments(),msg:"\"attachments\" is immutable"})}if(!Ext.isArray(a)){Ext.raise({attachments:a,msg:"\"attachments\" must be an array"})}for(var b=0,e=a.length;b<e;b++){c.push(Ext.copy({},a[b],"type,text,size,previewImgSrc,downloadImgUrl,sourceId"))}return c},applyTo:function applyTo(b){var a=this;return a.applyAddressFactory(b,"to")},applyCc:function applyCc(a){var b=this;return b.applyAddressFactory(a,"cc")},applyBcc:function applyBcc(a){var b=this;return b.applyAddressFactory(a,"bcc")},applyAddressFactory:function applyAddressFactory(a,c){var g=this,b=a,e;if(g["get"+c.charAt(0).toUpperCase()+c.substring(1)]()!==undefined){Ext.raise({value:a,type:c,msg:"\""+c+"\" is immutable"})}if(Ext.isString(a)&&a!==""){b=[{name:a,address:a}]}else if(Ext.isArray(b)){b=[];for(var d=0,f=a.length;d<f;d++){e=a[d];if(Ext.isObject(e)){if(Object.prototype.hasOwnProperty.call(e,"address")&&Object.prototype.hasOwnProperty.call(e,"name")){b.push(e)}else {Ext.raise({value:a,type:c,msg:"\""+c+"\" seems to be malformed"})}}else if(a[d]!==""){b.push({name:a[d],address:a[d]})}}}return b},applyReferences:function applyReferences(b){var a=this;if(a.getReferences()!==undefined){Ext.raise({references:a.getReferences(),msg:"\"references\" is immutable"})}return b},applyInReplyTo:function applyInReplyTo(b){var a=this;if(a.getInReplyTo()!==undefined){Ext.raise({inReplyTo:a.getInReplyTo(),msg:"\"inReplyTo\" is immutable"})}return b},applyXCnDraftInfo:function applyXCnDraftInfo(b){var a=this;if(a.getXCnDraftInfo()!==undefined){Ext.raise({xCnDraftInfo:a.getXCnDraftInfo(),msg:"\"xCnDraftInfo\" is immutable"})}return b}});Ext.define("conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest",{requires:["conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],config:{compoundKey:undefined,editMode:undefined,defaultMailAccountId:undefined,defaultMailFolderId:undefined},constructor:function constructor(a){var b=this;a=a||{};if(!Object.prototype.hasOwnProperty.call(a,"compoundKey")){Ext.raise({config:a,msg:"Property \"compoundKey\" must be specified."})}if(!Object.prototype.hasOwnProperty.call(a,"editMode")){Ext.raise({config:a,msg:"Property \"editMode\" must be specified."})}b.initConfig(a)},isConfigured:function isConfigured(){var a=this;return !!(a.getDefaultMailFolderId()&&a.getDefaultMailAccountId())},applyDefaultMailFolderId:function applyDefaultMailFolderId(b){var a=this;if(a.getDefaultMailFolderId()!==undefined){Ext.raise({compoundKey:a.getDefaultMailFolderId(),msg:"Property \"defaultMailFolderId\" was already set."})}return b},applyDefaultMailAccountId:function applyDefaultMailAccountId(b){var a=this;if(a.getDefaultMailAccountId()!==undefined){Ext.raise({compoundKey:a.getDefaultMailAccountId(),msg:"Property \"defaultMailAccountId\" was already set."})}return b},applyCompoundKey:function applyCompoundKey(a){var b=this;if(b.getCompoundKey()!==undefined){Ext.raise({compoundKey:b.getCompoundKey(),msg:"Property \"compoundKey\" was already set."})}if(!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:a})}return a},applyEditMode:function applyEditMode(b){var d=this,c,a;if(d.getEditMode()!==undefined){Ext.raise({editMode:d.getEditMode(),msg:"Property \"editMode\" was already set."})}a=conjoon.cn_mail.data.mail.message.EditingModes;c=[a.REPLY_TO,a.REPLY_ALL,a.FORWARD];if(c.indexOf(b)===-1){Ext.raise({editMode:b,msg:Ext.String.format("Property \"editMode\" must be one of {0}.",c.join(", "))})}return b}});Ext.define("conjoon.cn_mail.text.mail.message.CopyDecorator",{requires:["conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig"],messageDraft:null,constructor:function constructor(a){var b=this;if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({messageDraft:a,msg:"\"messageDraft\" must be an instance of conjoon.cn_mail.model.mail.message.MessageDraft",cls:Ext.getClassName(b)})}if(!a.getMessageBody()||a.getMessageBody().loadOperation){Ext.raise({messageDraft:a,msg:"\"MessageBody\" of messageDraft is not available",cls:Ext.getClassName(b)})}if(a.attachments().getRange().length===0&&!a.attachments().isLoaded()){Ext.raise({messageDraft:a,msg:"\"Attachments\" of messageDraft are not available",cls:Ext.getClassName(b)})}b.messageDraft=a},getTextPlain:function getTextPlain(){var a=this;return a.messageDraft.getMessageBody().get("textPlain")},getTextHtml:function getTextHtml(){var a=this;return a.messageDraft.getMessageBody().get("textHtml")},getSubject:function getSubject(){var a=this;return a.messageDraft.get("subject")},getSeen:function getSeen(){return !0},getDraft:function getDraft(){return !0},getAnswered:function getAnswered(){return !1},getRecent:function getRecent(){return !1},getFlagged:function getFlagged(){return !1},getFrom:function getFrom(){var b=this,a=b.messageDraft.get("from");return a?Ext.copy({},a,"name,address"):null},getReplyTo:function getReplyTo(){var b=this,a=b.messageDraft.get("replyTo");return a?Ext.copy({},a,"name,address"):b.getFrom()},getTo:function getTo(){return this.copyAddresses("to")},getCc:function getCc(){return this.copyAddresses("cc")},getBcc:function getBcc(){return this.copyAddresses("bcc")},getAttachments:function getAttachments(){var e=this,c=e.messageDraft.attachments().getRange(),b=[];for(var a=0,d=c.length;a<d;a++){b.push(Ext.copy({},c[a].data,"type,text,size,previewImgSrc,downloadImgUrl,sourceId"))}return b},toMessageDraftConfig:function toMessageDraftConfig(){var b=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var a=this;var c=Ext.applyIf({to:a.getTo(),cc:a.getCc(),bcc:a.getBcc(),subject:a.getSubject(),textPlain:a.getTextPlain(),textHtml:a.getTextHtml(),attachments:a.getAttachments(),seen:a.getSeen(),flagged:a.getFlagged(),answered:a.getAnswered(),draft:a.getDraft(),recent:a.getRecent()},b);return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",c)},privates:{copyAddresses:function copyAddresses(a){var f=this,e=["to","cc","bcc"],c=f.messageDraft.get(a),d=[];if(e.indexOf(a)===-1){Ext.raise({type:a,msg:Ext.String.format("\"type\" is not in list of {0}",e.join(", ")),cls:Ext.getClassName(f)})}for(var b=0,g=c.length;b<g;b++){d.push(Ext.copy({},c[b],"name,address"))}return d}}});Ext.define("conjoon.cn_mail.text.mail.message.DecoratorFormat",{singleton:!0,stringifyEmailAddress:function stringifyEmailAddress(d){var b=[].concat(d),c=[];for(var a=0,e=b.length;a<e;a++){if(!b[a]){continue}c.push(Ext.String.format("&lt;{0}&gt; {1}",b[a].address,b[a].name))}return c.join(", ")}});Ext.define("conjoon.cn_mail.text.mail.message.ForwardMessageDecorator",{extend:"conjoon.cn_mail.text.mail.message.CopyDecorator",requires:["conjoon.cn_mail.text.mail.message.DecoratorFormat"],getTo:function getTo(){return []},getCc:function getCc(){return []},getBcc:function getBcc(){return []},getTextHtml:function getTextHtml(){var b=this,a=b.messageDraft;return ["<br /><br />",b.getMessageBodyIntroText(a),"<br/>","<blockquote style=\"margin-left:4px;padding-left:10px;border-left:4px solid #bee9fc\">",b.getMessageBodyIntroHeaderFields(a),"<br /><br />",a.getMessageBody().get("textHtml"),"</blockquote>"].join("")},getMessageBodyIntroText:function getMessageBodyIntroText(a){return "--- Begin of the forwarded message:"},getMessageBodyIntroHeaderFields:function getMessageBodyIntroHeaderFields(a){var d=a.get("from"),b=conjoon.cn_mail.text.mail.message.DecoratorFormat,c;c=[Ext.String.format("<b>From:</b> {0}",b.stringifyEmailAddress(d)),Ext.String.format("<b>Date:</b> {0}",Ext.util.Format.date(a.get("date"),"d.m.Y H:i")),Ext.String.format("<b>To:</b> {0}",b.stringifyEmailAddress(a.get("to"))),Ext.String.format("<b>Subject:</b> {0}",a.get("subject")),Ext.String.format("<b>Reply to:</b> {0}",a.get("replyTo")?b.stringifyEmailAddress(a.get("replyTo")):b.stringifyEmailAddress(d))].join("<br />");return c}});Ext.define("conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator",{extend:"conjoon.cn_mail.text.mail.message.CopyDecorator",requires:["conjoon.cn_mail.text.mail.message.DecoratorFormat"],getTo:function getTo(){var a=this;return [a.getReplyTo()]},getCc:function getCc(){return []},getBcc:function getBcc(){return []},getTextHtml:function getTextHtml(){var b=this,a=b.messageDraft;return ["<br /><br/>","<blockquote style=\"margin-left:4px;padding-left:10px;border-left:4px solid #bee9fc\">",b.getMessageBodyIntroHeaderFields(a),"<br /><br />",a.getMessageBody().get("textHtml"),"</blockquote>"].join("")},getMessageBodyIntroHeaderFields:function getMessageBodyIntroHeaderFields(a){var d=a.get("from"),c=conjoon.cn_mail.text.mail.message.DecoratorFormat,b;b=[Ext.String.format("<b>On {0} at {1}, {2} wrote:</b>",Ext.util.Format.date(a.get("date"),"d.m.Y"),Ext.util.Format.date(a.get("date"),"H:i"),c.stringifyEmailAddress(d))].join("<br />");return b},getAttachments:function getAttachments(){return []},getReferences:function getReferences(){var c=this,d=c.messageDraft,b=d.get("messageId");var a=c.messageDraft.get("references");return a?a+" "+b:b},getInReplyTo:function getInReplyTo(){var c=this,a=c.messageDraft,b=a.get("messageId");return b},getXCnDraftInfo:function getXCnDraftInfo(){var b=this,a=b.messageDraft;return btoa(Ext.encode([a.get("mailAccountId"),a.get("mailFolderId"),a.get("id")]))},toMessageDraftConfig:function toMessageDraftConfig(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var b=this;a["references"]=b.getReferences();a["inReplyTo"]=b.getInReplyTo();a["xCnDraftInfo"]=b.getXCnDraftInfo();return b.callParent([a])}});Ext.define("conjoon.cn_mail.text.mail.message.ReplyAllMessageDecorator",{extend:"conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator",requires:["conjoon.cn_mail.text.mail.message.DecoratorFormat"],getTo:function getTo(){var a=this;return a.callParent().concat(a.copyAddresses("to"))},getCc:function getCc(){var a=this;return a.copyAddresses("cc")}});Ext.define("conjoon.cn_mail.data.mail.message.editor.MessageDraftCopier",{requires:["conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.text.mail.message.ForwardMessageDecorator","conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator","conjoon.cn_mail.text.mail.message.ReplyAllMessageDecorator","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest"],loadMessageDraftCopy:function loadMessageDraftCopy(a,c,e){var b=this,f,d;if(!(a instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest)){Ext.raise({messageDraftCopyRequest:a,msg:"\"messageDraftCopyRequest\" must be an instance of conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest"})}if(!a.isConfigured()){Ext.raise({msg:"\"messageDraftCopyRequest\" is not fully configured",messageDraftCopyRequest:a})}if(!Ext.isFunction(c)){Ext.raise({callback:c,msg:"\"callback\" must be a valid callback"})}f=a.getCompoundKey();d=a.getEditMode();conjoon.cn_mail.model.mail.message.MessageDraft.loadEntity(f,{success:Ext.Function.bind(b.onMessageDraftLoad,b,[d,c,e,a],!0),failure:Ext.Function.bind(b.onLoadMessageDraftCopyFailure,b,[c,e],!0),scope:b})},privates:{onMessageDraftLoad:function onMessageDraftLoad(c,g,f,b,d,e){var a=this;c.loadMessageBody({success:Ext.Function.bind(a.onMessageBodyLoad,a,[c,f,b,d,e],!0),failure:Ext.Function.bind(a.onLoadMessageDraftCopyFailure,a,[b,d],!0),scope:a})},onMessageBodyLoad:function onMessageBodyLoad(h,g,b,e,d,f,c){var a=this;b.loadAttachments({callback:Ext.Function.bind(a.onAttachmentsLoad,a,[b,e,d,f,c],!0),scope:a})},onAttachmentsLoad:function onAttachmentsLoad(c,h,a,f,j,i,k,e){var d=this,g=[];if(a){for(var b=0,l=c.length;b<l;b++){g.push(c[b].copy(null))}}i.apply(k||null,[d,a?d.createMessageDraftConfig(f,j,e):null,a,h])},onLoadMessageDraftCopyFailure:function onLoadMessageDraftCopyFailure(e,a,b,c){var d=this;b.apply(c||null,[d,null,!1,a])},createMessageDraftConfig:function createMessageDraftConfig(b,d,c){var a=null;switch(d){case conjoon.cn_mail.data.mail.message.EditingModes.FORWARD:a=Ext.create("conjoon.cn_mail.text.mail.message.ForwardMessageDecorator",b);break;case conjoon.cn_mail.data.mail.message.EditingModes.REPLY_TO:a=Ext.create("conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator",b);break;case conjoon.cn_mail.data.mail.message.EditingModes.REPLY_ALL:a=Ext.create("conjoon.cn_mail.text.mail.message.ReplyAllMessageDecorator",b);break;}return a.toMessageDraftConfig({mailAccountId:c.getDefaultMailAccountId(),mailFolderId:c.getDefaultMailFolderId()})}}});Ext.define("conjoon.cn_mail.data.mail.message.session.MessageCompoundBatchVisitor",{extend:"coon.core.data.session.SplitBatchVisitor",config:{messageDraft:undefined},applyMessageDraft:function applyMessageDraft(a){var b=this;if(b.getMessageDraft()){Ext.raise("\"messageDraft\" was already set")}if(a!==undefined&&!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise("\"messageDraft\" must be an instance of conjoon.cn_mail.model.mail.message.MessageDraft")}return a},getBatch:function getBatch(c){var a=this,b=a.callParent(arguments);b.un("operationcomplete",a.onBatchOperationComplete,a);b.on("operationcomplete",a.onBatchOperationComplete,a);b.start=Ext.Function.createInterceptor(b.start,function(){var b=this,a=b.getMessageDraft();a.storePreBatchCompoundKey()},a);return b},onBatchOperationComplete:function onBatchOperationComplete(g,f){var d=this;if(f.hasException()){return null}var i=g.current+1,e=g.getOperations(),b=e[i],a,c,h;if(!d.getMessageDraft()){Ext.raise("Missing messageDraft configuration.")}d.seedRetrievedKey(f);d.refreshKeyForDestroy(b);if(!b){return null}a=b.getRecords();if(!a||!a.length){return null}if(a.length>1){Ext.raise("Unexpected number of records. Need 1, got "+a.length)}a=a[0];c=null;if(d.isOperationSwappable(b)){h=a.getProxy();c=h.createOperation("update",{records:[a],params:{origin:b.getAction()}});c.entityType=Ext.getClass(a);b.destroy();b=null;e[i]=c}return c},seedRetrievedKey:function seedRetrievedKey(a){if(!a||!a.getRecords()){return !1}var g=this,f=a.getRecords()[0],c=g.getMessageDraft(),b=a.getResponse(),d=b.responseType,e=d==="json"?b.responseJson:Ext.decode(b.responseText);if(a.getAction()==="destroy"&&f.entityName==="DraftAttachment"){c.set("id",e.data.id);c.commit();return !0}return !1},refreshKeyForDestroy:function refreshKeyForDestroy(b){if(!b||b.getAction()!=="destroy"){return !1}var d=this,a=b.getRecords()[0],c=d.getMessageDraft();if(a.entityName!=="DraftAttachment"){Ext.raise("no handler for \""+a.entityName+"\" found")}a.reject();a.set("parentMessageItemId",c.get("id"));a.commit();a.drop();return !0},isOperationSwappable:function isOperationSwappable(b){var a=b.getRecords();a=Ext.isArray(a)?a[0]:a;return b.getAction()==="create"&&(a.entityName==="MessageDraft"||a.entityName==="MessageItem")&&a.isCompoundKeyConfigured()}});Ext.define("conjoon.cn_mail.data.mail.message.session.MessageDraftSession",{extend:"coon.core.data.Session",requires:["conjoon.cn_mail.data.mail.BaseSchema","conjoon.cn_mail.data.mail.message.session.MessageCompoundBatchVisitor","conjoon.cn_mail.model.mail.message.MessageDraft"],config:{messageDraft:undefined},schema:"cn_mail-mailbaseschema",batchVisitorClassName:"conjoon.cn_mail.data.mail.message.session.MessageCompoundBatchVisitor",applyMessageDraft:function applyMessageDraft(a){var b=this;if(b.getMessageDraft()){Ext.raise("\"messageDraft\" was already set")}if(a!==undefined&&!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise("\"messageDraft\" must be an instance of conjoon.cn_mail.model.mail.message.MessageDraft")}if(a!==undefined){b.adopt(a)}return a},privates:{createVisitor:function createVisitor(){var c=this,b=c.callParent(arguments),a=c.getMessageDraft();if(!a){Ext.raise("\"messageDraft\" must be set.")}b.setMessageDraft(a);return b}}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditorViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.model.mail.message.MessageBody","conjoon.cn_mail.model.mail.message.EmailAddress","conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopier","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.message.session.MessageDraftSession"],alias:"viewmodel.cn_mail-mailmessageeditorviewmodel",loadingDraft:null,loadingFailed:!1,emptySubjectText:"(No subject)",messageDraftCopier:null,pendingCopyRequest:null,data:{isSaving:!1,isSending:!1,isSubjectRequired:!0},formulas:{lastSavedMessage:{bind:{date:"{messageDraft.savedAt}"},get:function get(a){return a.date?"Last saved at ".concat(Ext.Date.format(a.date,"d.m.Y H:i:s")):"Opened for editing"}},isPhantom:function isPhantom(a){return a("messageDraft").phantom&&!a("messageDraft.savedAt")},isAccountAndFolderSet:function isAccountAndFolderSet(a){var b=a("messageDraft.mailAccountId"),c=a("messageDraft.mailFolderId");return !!(b&&c)},isMessageBodyLoading:function isMessageBodyLoading(b){var a=b("messageDraft.messageBody");return a&&a.loading!==undefined?a.loading:!1},isCcOrBccValueSet:{bind:{cc:"{messageDraft.cc}",bcc:"{messageDraft.bcc}"},get:function get(a){return !!(a.cc&&a.cc.length)||!!(a.bcc&&a.bcc.length)}},addressStoreData:{single:!0,bind:{to:"{messageDraft.to}",cc:"{messageDraft.cc}",bcc:"{messageDraft.bcc}"},get:function get(a){return [].concat(a.to,a.cc,a.bcc)}},getSubject:{bind:{subject:"{messageDraft.subject}"},get:function get(a){var b=a.subject||this.emptySubjectText;return b},set:function set(a){this.set("messageDraft.subject",a||this.emptySubjectText)}}},stores:{mailAccountStore:{source:"{cn_mail_mailfoldertreestore}",filters:[{property:"folderType",value:"ACCOUNT"}]},addressStore:{model:"conjoon.cn_mail.model.mail.message.EmailAddress",data:"{addressStoreData}"}},constructor:function constructor(c){var a=this,b;if(!c||!c.messageDraft){Ext.raise({source:Ext.getClassName(this),msg:"arguments \"config\" and  \"config.messageDraft\" must be set."})}b=c.messageDraft;delete c.messageDraft;Ext.apply(c,{formulas:a.createAddressFormulas()});a.callParent([c]);var e=a.getSession();if(!(e instanceof conjoon.cn_mail.data.mail.message.session.MessageDraftSession)){Ext.raise({msg:"This ViewModel requires a data session of the type conjoon.cn_mail.data.mail.message.session.MessageDraftSession",session:e})}var g=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey,f,d;switch(!0){case b instanceof g:f=b.toLocalId();d=e.peekRecord("MessageDraft",f);if(!d){var h={params:b.toObject(),success:function success(b){var a=this,d=a.getView();a.getSession().setMessageDraft(b);b.loadMessageBody({success:function success(e){a.set("messageDraft",b);a.notify();a.loadingDraft=null;d.fireEvent("cn_mail-messagedraftload",d,b)},scope:a})},failure:a.processMessageDraftLoadFailure,scope:a};a.loadingDraft=conjoon.cn_mail.model.mail.message.MessageDraft.loadEntity(b,h)}else {a.getSession().setMessageDraft(d);a.set("messageDraft",d)};return;case b instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig:a.createDraftFromData(b);return;case b instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest:a.messageDraftCopier=Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftCopier");if(b.isConfigured()){a.pendingCopyRequest=b;a.processPendingCopyRequest()}else {a.pendingCopyRequest=b};return;}Ext.raise({messageDraft:b,msg:"\"messageDraft\" must either be an instance of "+"MessageDraftConfig, of MessageDraftCopyRequest or of "+"MessageEntityCompoundKey."})},processMessageDraftLoadFailure:function processMessageDraftLoadFailure(c,b){var a=this;a.loadingFailed=!0;a.loadingDraft=null;if(b.error&&b.error.status===-1){return null}return a.getView().showLoadingFailedDialog()},hasPendingCopyRequest:function hasPendingCopyRequest(){var a=this;return !!a.pendingCopyRequest},processPendingCopyRequest:function processPendingCopyRequest(c,d){var b=this;var a=b.pendingCopyRequest;if(!a){Ext.raise({msg:"\"pendingCopyRequest\" is not available."})}if(!a.isConfigured()){if(!c||!d){Ext.raise({msg:"\"pendingCopyRequest\" is not properly configured, and arguments are missing.",args:arguments,pendingCopyRequest:a})}a.setDefaultMailAccountId(c);a.setDefaultMailFolderId(d)}b.messageDraftCopier.loadMessageDraftCopy(a,b.onMessageDraftCopyLoad,b);b.pendingCopyRequest=null},destroy:function destroy(){var a=this;if(a.messageDraftCopier){a.messageDraftCopier.destroy();a.messageDraftCopier=null}a.callParent(arguments)},privates:{onMessageDraftCopyLoad:function onMessageDraftCopyLoad(f,c,e,d){var a=this,b=a.getView();if(e===!1){return a.processMessageDraftLoadFailure(null,d)}a.createDraftFromData(c);a.notify();b.fireEvent("cn_mail-messagedraftload",b,a.get("messageDraft"))},createDraftFromData:function createDraftFromData(c){"use strict";var b=this;var e,d,a;if(!(c instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig)){Ext.raise({messageDraftConfig:c,msg:"\"messageDraftConfig\" must be an instance of conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig"})}a=c.toObject();e=a.messageBody;d=a.attachments;delete a.messageBody;delete a.attachments;b.linkTo("messageDraft",{type:"MessageDraft",create:a});var f=b.getSession();f.setMessageDraft(b.get("messageDraft"));b.set("messageDraft.messageBody",f.createRecord("MessageBody",e||{}));b.get("messageDraft").attachments().add(d||[])},createAddressFormulas:function createAddressFormulas(){var f=["to","cc","bcc"],a=null,e={},b={},d;for(var c=0,g=f.length;c<g;c++){a=f[c];d="get"+Ext.String.capitalize(a);b={bind:{},get:this.getAddressValuesFromDraft.bind(this,a),set:this.setAddressesForDraft.bind(this,a)};b["bind"][a]="{messageDraft."+a+"}";e[d]=b}return e},getAddressValuesFromDraft:function getAddressValuesFromDraft(e,d){var c=[],b=d[e]||[];for(var a=0,f=b.length;a<f;a++){c.push(b[a]["address"])}return c},setAddressesForDraft:function setAddressesForDraft(g,c){var i=this,a=[],e=i.getStore("addressStore"),d,f;for(var b=0,h=c.length;b<h;b++){d=e.find("address",c[b],0,!1,!1,!0);if(d!==-1){f=e.getAt(d);a.push(Ext.copy({},f.data,"address,name"))}else {a.push({address:c[b]})}}this.set("messageDraft."+g,a);return a},isDraftDirty:function isDraftDirty(){var e=this,b=e.get("messageDraft"),a=b.attachments(),d=["id","localId","mailAccountId","mailFolderId","messageBodyId","messageDraftId"];var c=Object.entries(b.getMessageBody().modified||{}).map(function(a){return a[0]}).filter(function(a){return !d.includes(a)});return !!b.modified||!!c.length||!!a.getRemovedRecords().length||!!a.getRange().filter(function(a){return a.dirty===!0}).length||!!a.getRange().filter(function(a){return a.phantom===!0}).length}}});function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(b){return typeof b}:function(b){return b&&"function"==typeof Symbol&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},_typeof(a)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function _regeneratorRuntime(){return a};var a={},l=Object.prototype,c=l.hasOwnProperty,f=Object.defineProperty||function(c,b,a){c[b]=a.value},k="function"==typeof Symbol?Symbol:{},g=k.iterator||"@@iterator",m=k.asyncIterator||"@@asyncIterator",i=k.toStringTag||"@@toStringTag";function define(b,a,c){return Object.defineProperty(b,a,{value:c,enumerable:!0,configurable:!0,writable:!0}),b[a]}try{define({},"")}catch(n){define=function define(c,b,a){return c[b]=a}}function wrap(g,a,h,d){var c=a&&a.prototype instanceof Generator?a:Generator,b=Object.create(c.prototype),e=new Context(d||[]);return f(b,"_invoke",{value:makeInvokeMethod(g,h,e)}),b}function tryCatch(c,b,a){try{return {type:"normal",arg:c.call(b,a)}}catch(o){return {type:"throw",arg:o}}}a.wrap=wrap;var b={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var h={};define(h,g,function(){return this});var j=Object.getPrototypeOf,e=j&&j(j(values([])));e&&e!==l&&c.call(e,g)&&(h=e);var d=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(h);function defineIteratorMethods(a){["next","throw","return"].forEach(function(b){define(a,b,function(c){return this._invoke(b,c)})})}function AsyncIterator(d,b){function invoke(i,j,e,f){var g=tryCatch(d[i],d,j);if("throw"!==g.type){var h=g.arg,a=h.value;return a&&"object"==_typeof(a)&&c.call(a,"__await")?b.resolve(a.__await).then(function(a){invoke("next",a,e,f)},function(a){invoke("throw",a,e,f)}):b.resolve(a).then(function(a){h.value=a,e(h)},function(a){return invoke("throw",a,e,f)})}f(g.arg)}var a;f(this,"_invoke",{value:function value(c,e){function callInvokeWithMethodAndArg(){return new b(function(a,f){invoke(c,e,a,f)})}return a=a?a.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(d,e,a){var c="suspendedStart";return function(i,j){if("executing"===c){throw new Error("Generator is already running")}if("completed"===c){if("throw"===i){throw j}return doneResult()}for(a.method=i,a.arg=j;;){var h=a.delegate;if(h){var g=maybeInvokeDelegate(h,a);if(g){if(g===b){continue}return g}}if("next"===a.method){a.sent=a._sent=a.arg}else if("throw"===a.method){if("suspendedStart"===c){throw c="completed",a.arg}a.dispatchException(a.arg)}else {"return"===a.method&&a.abrupt("return",a.arg)}c="executing";var f=tryCatch(d,e,a);if("normal"===f.type){if(c=a.done?"completed":"suspendedYield",f.arg===b){continue}return {value:f.arg,done:a.done}}"throw"===f.type&&(c="completed",a.method="throw",a.arg=f.arg)}}}function maybeInvokeDelegate(c,a){var d=a.method,g=c.iterator[d];if(undefined===g){return a.delegate=null,"throw"===d&&c.iterator["return"]&&(a.method="return",a.arg=undefined,maybeInvokeDelegate(c,a),"throw"===a.method)||"return"!==d&&(a.method="throw",a.arg=new TypeError("The iterator does not provide a '"+d+"' method")),b}var f=tryCatch(g,c.iterator,a.arg);if("throw"===f.type){return a.method="throw",a.arg=f.arg,a.delegate=null,b}var e=f.arg;return e?e.done?(a[c.resultName]=e.value,a.next=c.nextLoc,"return"!==a.method&&(a.method="next",a.arg=undefined),a.delegate=null,b):e:(a.method="throw",a.arg=new TypeError("iterator result is not an object"),a.delegate=null,b)}function pushTryEntry(a){var b={tryLoc:a[0]};1 in a&&(b.catchLoc=a[1]),2 in a&&(b.finallyLoc=a[2],b.afterLoc=a[3]),this.tryEntries.push(b)}function resetTryEntry(b){var a=b.completion||{};a.type="normal",delete a.arg,b.completion=a}function Context(a){this.tryEntries=[{tryLoc:"root"}],a.forEach(pushTryEntry,this),this.reset(!0)}function values(a){if(a){var e=a[g];if(e){return e.call(a)}if("function"==typeof a.next){return a}if(!isNaN(a.length)){var d=-1,b=function b(){for(;++d<a.length;){if(c.call(a,d)){return b.value=a[d],b.done=!1,b}}return b.value=undefined,b.done=!0,b};return b.next=b}}return {next:doneResult}}function doneResult(){return {value:undefined,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,f(d,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),f(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,i,"GeneratorFunction"),a.isGeneratorFunction=function(b){var a="function"==typeof b&&b.constructor;return !!a&&(a===GeneratorFunction||"GeneratorFunction"===(a.displayName||a.name))},a.mark=function(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,GeneratorFunctionPrototype):(a.__proto__=GeneratorFunctionPrototype,define(a,i,"GeneratorFunction")),a.prototype=Object.create(d),a},a.awrap=function(a){return {__await:a}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,m,function(){return this}),a.AsyncIterator=AsyncIterator,a.async=function(f,d,g,e,b){void 0===b&&(b=Promise);var c=new AsyncIterator(wrap(f,d,g,e),b);return a.isGeneratorFunction(d)?c:c.next().then(function(a){return a.done?a.value:c.next()})},defineIteratorMethods(d),define(d,i,"Generator"),define(d,g,function(){return this}),define(d,"toString",function(){return "[object Generator]"}),a.keys=function(d){var b=Object(d),a=[];for(var c in b){a.push(c)}return a.reverse(),function next(){for(;a.length;){var c=a.pop();if(c in b){return next.value=c,next.done=!1,next}}return next.done=!0,next}},a.values=values,Context.prototype={constructor:Context,reset:function reset(b){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!b){for(var a in this){"t"===a.charAt(0)&&c.call(this,a)&&!isNaN(+a.slice(1))&&(this[a]=undefined)}}},stop:function stop(){this.done=!0;var a=this.tryEntries[0].completion;if("throw"===a.type){throw a.arg}return this.rval},dispatchException:function dispatchException(f){if(this.done){throw f}var b=this;function handle(c,a){return h.type="throw",h.arg=f,b.next=c,a&&(b.method="next",b.arg=undefined),!!a}for(var d=this.tryEntries.length-1;d>=0;--d){var a=this.tryEntries[d],h=a.completion;if("root"===a.tryLoc){return handle("end")}if(a.tryLoc<=this.prev){var g=c.call(a,"catchLoc"),e=c.call(a,"finallyLoc");if(g&&e){if(this.prev<a.catchLoc){return handle(a.catchLoc,!0)}if(this.prev<a.finallyLoc){return handle(a.finallyLoc)}}else if(g){if(this.prev<a.catchLoc){return handle(a.catchLoc,!0)}}else {if(!e){throw new Error("try statement without catch or finally")}if(this.prev<a.finallyLoc){return handle(a.finallyLoc)}}}}},abrupt:function abrupt(f,g){for(var h=this.tryEntries.length-1;h>=0;--h){var d=this.tryEntries[h];if(d.tryLoc<=this.prev&&c.call(d,"finallyLoc")&&this.prev<d.finallyLoc){var a=d;break}}a&&("break"===f||"continue"===f)&&a.tryLoc<=g&&g<=a.finallyLoc&&(a=null);var e=a?a.completion:{};return e.type=f,e.arg=g,a?(this.method="next",this.next=a.finallyLoc,b):this.complete(e)},complete:function complete(a,c){if("throw"===a.type){throw a.arg}return "break"===a.type||"continue"===a.type?this.next=a.arg:"return"===a.type?(this.rval=this.arg=a.arg,this.method="return",this.next="end"):"normal"===a.type&&c&&(this.next=c),b},finish:function finish(d){for(var c=this.tryEntries.length-1;c>=0;--c){var a=this.tryEntries[c];if(a.finallyLoc===d){return this.complete(a.completion,a.afterLoc),resetTryEntry(a),b}}},"catch":function _catch(e){for(var b=this.tryEntries.length-1;b>=0;--b){var a=this.tryEntries[b];if(a.tryLoc===e){var c=a.completion;if("throw"===c.type){var d=c.arg;resetTryEntry(a)}return d}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(c,a,d){return this.delegate={iterator:values(c),resultName:a,nextLoc:d},"next"===this.method&&(this.arg=undefined),b}},a}function asyncGeneratorStep(h,c,e,f,d,i,g){try{var b=h[i](g);var a=b.value}catch(j){e(j);return}if(b.done){c(a)}else {Promise.resolve(a).then(f,d)}}function _asyncToGenerator(a){return function(){var c=this,b=arguments;return new Promise(function(d,e){var f=a.apply(c,b);function _next(b){asyncGeneratorStep(f,d,e,_next,_throw,"next",b)}function _throw(b){asyncGeneratorStep(f,d,e,_next,_throw,"throw",b)}_next(undefined)})}}Ext.define("conjoon.cn_mail.view.mail.message.editor.HtmlEditor",{extend:"Ext.form.field.HtmlEditor",requires:["coon.comp.form.field.FileButton","coon.core.ThemeManager","coon.core.Environment","coon.core.ConfigManager","coon.core.FileLoader","coon.core.Template"],alias:"widget.cn_mail-mailmessageeditorhtmleditor",createToolbar:function createToolbar(){var c=this,a=c.callParent(arguments);a.add("-");a.add({xtype:"cn_comp-formfieldfilebutton",iconCls:"fas fa-paperclip",tooltip:{title:"Add Attachment(s)...",text:"Add one or more attachments to this message.",cls:Ext.baseCSSPrefix+"html-editor-tip"}});var b=a.getLayout().overflowHandler;b.addComponentToMenu=c.createOverflowHandlerInterceptor(b.addComponentToMenu);return a},getToolbarCfg:function getToolbarCfg(){var b=this,a=b.callParent(arguments);a.listeners.click=function(b,a){if(a.className.indexOf("x-form-file-input")!==-1){return}b.preventDefault()};return a},initFrameDoc:function initFrameDoc(){var a=arguments,b=this;return _asyncToGenerator(_regeneratorRuntime().mark(function _callee(){var c;return _regeneratorRuntime().wrap(function _callee$(d){while(1){switch(d.prev=d.next){case 0:c=b;if(!(c.destroying||c.destroyed)){d.next=3;break};return d.abrupt("return",c.superclass.initFrameDoc.apply(c,a));case 3:d.next=5;return c.loadMarkup();case 5:c.editorHtmlTemplateTxt=d.sent;return d.abrupt("return",c.superclass.initFrameDoc.apply(c,a));case 7:case "end":return d.stop();}}},_callee)}))()},loadMarkup:function loadMarkup(){return _asyncToGenerator(_regeneratorRuntime().mark(function _callee2(){var b,a,d,c;return _regeneratorRuntime().wrap(function _callee2$(e){while(1){switch(e.prev=e.next){case 0:b=coon.core.ThemeManager.getTheme();a=coon.core.Environment.getPathForResource(coon.core.ConfigManager.get("extjs-app-webmail","resources.templates.html.editor"),"extjs-app-webmail");e.next=4;return coon.core.Template.load(a);case 4:d=e.sent;c=d.render({theme:b});return e.abrupt("return",c);case 7:case "end":return e.stop();}}},_callee2)}))()},getDocMarkup:function getDocMarkup(){var a=this;if(a.editorHtmlTemplateTxt){return a.editorHtmlTemplateTxt}return ["<!DOCTYPE html>","<html><head>","<style type=\"text/css\">","</style></head><body></body></html>"].join("")},createOverflowHandlerInterceptor:function createOverflowHandlerInterceptor(a){"use strict";return Ext.Function.createInterceptor(a,function(c,b){if(b instanceof coon.comp.form.field.FileButton){return !1}})}});Ext.define("conjoon.cn_mail.view.mail.message.editor.AddressField",{extend:"Ext.form.field.Tag",requires:["conjoon.cn_mail.model.mail.message.EmailAddress"],alias:"widget.cn_mail-mailmessageeditoraddressfield",cls:"cn_mail-mailmessageeditoraddressfield",displayField:"name",valueField:"address",config:{addressType:undefined},store:{data:[],model:"conjoon.cn_mail.model.mail.message.EmailAddress"},queryMode:"local",forceSelection:!1,triggerOnClick:!1,createNewOnEnter:!0,hideTrigger:!0,createNewOnBlur:!1,initComponent:function initComponent(){var b=this,a=b.getAddressType();if(a==="cc"||a==="bcc"){b.tagItemTextCls=Ext.baseCSSPrefix+"tagfield-item-text x-fa "+a}b.callParent(arguments)}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditor",{extend:"Ext.form.Panel",mixins:{deleteConfirmDialog:"conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog",loadingFailedDialog:"conjoon.cn_mail.view.mail.mixin.LoadingFailedDialog"},requires:["coon.comp.component.LoadMask","conjoon.cn_mail.view.mail.message.editor.AttachmentList","conjoon.cn_mail.view.mail.message.editor.MessageEditorViewController","conjoon.cn_mail.view.mail.message.editor.MessageEditorViewModel","conjoon.cn_mail.view.mail.message.editor.HtmlEditor","conjoon.cn_mail.view.mail.message.editor.AddressField","conjoon.cn_mail.model.mail.message.EmailAddress","conjoon.cn_mail.data.mail.message.session.MessageDraftSession","coon.comp.component.MessageMask","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"widget.cn_mail-mailmessageeditor",controller:"cn_mail-mailmessageeditorviewcontroller",viewModel:"cn_mail-mailmessageeditorviewmodel",isCnMessageEditor:!0,layout:{type:"vbox",align:"stretch"},margin:"0 5 14 0",bodyPadding:"8 8 8 8",cls:"cn_mail-mailmessageeditor shadow-panel",title:"Loading...",iconCls:"fa fa-spin fa-spinner",bind:{closable:"{!isMessageBodyLoading && !isSaving && !isSending}",title:"{!isMessageBodyLoading ? getSubject : \"Loading...\"}",iconCls:"{getSubject && !isSaving && !isSending && !isMessageBodyLoading ? \"fa fa-edit\" : \"fa fa-spin fa-spinner\"}"},closable:!1,buttonAlign:"right",editMode:"CREATE",busyMask:null,loadingMask:null,dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{xtype:"combobox",itemId:"accountCombo",flex:1,cls:"accountCombo",matchFieldWidth:!1,hideTrigger:!0,editable:!1,forceSelection:!0,queryMode:"local",bind:{disabled:"{!isPhantom}",store:"{mailAccountStore}",value:"{messageDraft.mailAccountId}"},labelWidth:50,fieldLabel:"Account",displayField:"name",valueField:"id",listConfig:{getInnerTpl:function getInnerTpl(){return "{from.name} &lt;{from.address}&gt;"}},displayTpl:"<tpl for=\".\">{name}</tpl>"},"->",{xtype:"button",iconCls:"fa fa-envelope",cls:"seenButton",enableToggle:!0,bind:{pressed:"{messageDraft.seen}"}},{xtype:"button",iconCls:"fa fa-flag",cls:"flagButton",enableToggle:!0,bind:{pressed:"{messageDraft.flagged}"}},{width:213,xtype:"displayfield",cls:"lastSavedDateField",bind:{value:"{lastSavedMessage}"}},{scale:"small",text:"Save",width:108,itemId:"saveButton"},{scale:"small",text:"Send",itemId:"sendButton",width:108}]}],items:[{xtype:"container",margin:"0 0 12 0",layout:"hbox",items:[{flex:1,xtype:"cn_mail-mailmessageeditoraddressfield",emptyText:"To",itemId:"toField",bind:{value:"{getTo}",store:"{addressStore}"}},{xtype:"button",itemId:"showCcBccButton",cls:"showCcBccButton",text:"CC / BCC",bind:{hidden:"{isCcOrBccValueSet}"}}]},{xtype:"cn_mail-mailmessageeditoraddressfield",emptyText:"Cc",itemId:"ccField",addressType:"cc",bind:{hidden:{bindTo:"{!isCcOrBccValueSet}",single:!0},value:"{getCc}",store:"{addressStore}"}},{xtype:"cn_mail-mailmessageeditoraddressfield",emptyText:"Bcc",addressType:"bcc",itemId:"bccField",bind:{hidden:{bindTo:"{!isCcOrBccValueSet}",single:!0},value:"{getBcc}",store:"{addressStore}"}},{xtype:"textfield",emptyText:"Subject",cls:"subjectField",itemId:"subjectField",bind:{value:"{messageDraft.subject}"}},{xtype:"container",flex:1,margin:"12 0 0 0",layout:{type:"hbox",align:"stretch"},items:[{flex:1,xtype:"cn_mail-mailmessageeditorhtmleditor",bind:{value:"{messageDraft.messageBody.textHtml}"}},{xtype:"container",itemId:"attachmentListWrap",cls:"attachmentlist-wrap",layout:"fit",width:230,margin:"0 0 0 10",items:[{xtype:"box",autoEl:{tag:"div",cls:"dropzone-text",html:"Attach files by dragging and dropping them here."}},{flex:1,xtype:"cn_mail-mailmessageeditorattachmentlist",reference:"cn_mail_ref_mailmessageeditorattachmentlist",margin:"10 0 10 0",width:228,scrollable:"y",bind:{store:"{messageDraft.attachments}"}}]}]}],constructor:function constructor(a){var c=this,d=conjoon.cn_mail.data.mail.message.EditingModes,b;if(!a||!a.messageDraft){Ext.raise({source:Ext.getClassName(this),msg:"argument \"config\" and \"config.messageDraft\" must be set."})}b=a.messageDraft;if(a.viewModel){Ext.raise({source:Ext.getClassName(this),msg:"Cannot set ViewModel for MessageEditor without overriding constructor."})}Ext.apply(a,{session:Ext.create("conjoon.cn_mail.data.mail.message.session.MessageDraftSession"),viewModel:{type:"cn_mail-mailmessageeditorviewmodel",messageDraft:b}});c.editMode=d.CREATE;if(b instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey){c.editMode=d.EDIT}else if(b instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest){c.editMode=b.getEditMode()}delete a.messageDraft;this.callParent(arguments)},initComponent:function initComponent(){var b=this,d=null,a=conjoon.cn_mail.data.mail.message.EditingModes,e=[a.CREATE,a.REPLY_TO,a.REPLY_ALL,a.FORWARD],c=function c(a){Ext.each(a,function(b){if(b.xtype==="cn_mail-mailmessageeditorattachmentlist"){d=b;return !1}if(b.items){return c(b.items)}})};c(b.items);if(d){d.editMode=e.indexOf(b.editMode)!==-1?a.CREATE:a.EDIT}else {Ext.raise({sourceClass:Ext.getClassName(b),msg:"MessageEditor needs to have conjoon.cn_mail.view.mail.message.AttachmentList"})}b.callParent(arguments)},showCcBccFields:function showCcBccFields(a){var b=this;a=a===undefined?!0:a;b.down("#ccField").setHidden(!a);b.down("#bccField").setHidden(!a);return this},setBusy:function setBusy(b){var d=this,a=d.busyMask,c=b===!1,f=!c?b.progress:undefined,g=!c?b.msg:undefined,e=!c?b.msgAction:undefined;if(b!==!1&&!Ext.isObject(b)){Ext.raise({conf:b,cls:Ext.getClassName(d),msg:"Argument \"conf\" must either be boolean=false or an "+"object suiting configuration options for "+"coon.comp.component.LoadMask"})}if(c&&!a){return this}if(!a&&!c){a=Ext.create("coon.comp.component.LoadMask",{msg:g,msgAction:e,glyphCls:"fa fa-envelope",target:d});d.busyMask=a}if(c){a.hide();return this}a.show();if(f===undefined){a.loopProgress()}if(f!==undefined){a.updateProgress(f)}if(e!==undefined){a.updateActionMsg(e)}if(g!==undefined){a.updateMsg(g)}return this},showAddressMissingNotice:function showAddressMissingNotice(d){var a=this,c,b;a.getViewModel().notify();b=a.getIconCls();c=Ext.create("coon.comp.component.MessageMask",{title:"Address Missing",message:"Could not send the message. Please specify one or more recipients.",target:a,buttons:coon.comp.component.MessageMask.OK,icon:coon.comp.component.MessageMask.ERROR,callback:function callback(c){var a=this;a.down("#toField").focus();a.setClosable(!0);a.setIconCls(b)},scope:a});a.setIconCls("fa fa-exclamation-circle");a.setClosable(!1);c.show()},showConfirmCloseDialog:function showConfirmCloseDialog(){"use strict";var a=this;var c,b;a.getViewModel().notify();b=a.getIconCls();c=Ext.create("coon.comp.component.MessageMask",{title:"Close without saving",message:"Do you want to close the editor without saving your changes?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:function callback(c){var a=this;if(c==="noButton"){a.setClosable(!0);a.setIconCls(b);return}a.suspendEvent("beforeclose");a.close();a.resumeEvent("beforeclose")},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);c.show()},showSubjectMissingNotice:function showSubjectMissingNotice(e,b){var a=this,d,c;a.getViewModel().notify();c=a.getIconCls();d=Ext.create("coon.comp.component.MessageMask",{title:"Subject Missing",message:"If you wish, you can specify a subject here before leaving it empty.",target:a,buttons:coon.comp.component.MessageMask.OKCANCEL,icon:coon.comp.component.MessageMask.QUESTION,input:{emptyText:"Subject"},callback:function callback(d,f){var a=this;if(d==="okButton"){e.set("subject",f)}a.setClosable(!0);a.setIconCls(c);if(b){b.apply(a,[d,f])}},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);d.show()},showMailMessageSaveFailedNotice:function showMailMessageSaveFailedNotice(e,f,b){var a=this,d,c;a.getViewModel().notify();c=a.getIconCls();d=Ext.create("coon.comp.component.MessageMask",{title:"Saving Failed",message:"Saving the message failed. Do you want to retry to save the message?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:function callback(d,g){var a=this;a.setClosable(!0);a.setIconCls(c);if(b){b.apply(a,arguments)}},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);d.show()},showMessageDraftLoadingNotice:function showMessageDraftLoadingNotice(b){var a=this;a.loadingMask=Ext.create("Ext.LoadMask",{target:a,bind:{hidden:b?"{isAccountAndFolderSet}":"{!isMessageBodyLoading}"},listeners:{hide:function hide(a){var c=this;c.loadingMask=null;a.destroy()},scope:this}});a.loadingMask.show()},getMessageDraft:function getMessageDraft(){return this.getViewModel().get("messageDraft")},isDraftLoading:function isDraftLoading(){var b=this,a=b.getViewModel();return !!(a.get("isMessageBodyLoading")||a.hasPendingCopyRequest()||a.loadingDraft)},hasLoadingFailed:function hasLoadingFailed(){var a=this,b=a.getViewModel();return b.loadingFailed},showLoadingFailedDialog:function showLoadingFailedDialog(){var a=this;a.setClosable(!0);a.mixins.loadingFailedDialog.showLoadingFailedDialog.call(a)}});Ext.define("conjoon.cn_mail.text.QueryStringParser",{parse:function parse(a){a=a+"";var d=/(\?|&)([^=]+)=([^&|^#]+)/g,b=null,c={};if(!Ext.String.startsWith(a,"?")){Ext.raise({text:a,msg:"\"text\" must start with a \"?\""})}while((b=d.exec(a))!==null){c[b[2]]=b[3]}return c}});Ext.define("conjoon.cn_mail.view.mail.MailDesktopViewController",{extend:"Ext.app.ViewController",requires:["conjoon.cn_mail.view.mail.message.reader.MessageView","conjoon.cn_mail.view.mail.message.editor.MessageEditor","conjoon.cn_mail.view.mail.message.editor.MessageEditorViewModel","conjoon.cn_mail.text.QueryStringParser","conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore"],alias:"controller.cn_mail-maildesktopviewcontroller",control:{"cn_mail-maildesktopview":{"tabchange":"onTabChange"},"cn_mail-maildesktopview > cn_mail-mailmessagereadermessageview":{"cn_mail-mailmessageitemread":"onMessageItemRead"},"cn_mail-mailmessagegrid":{"rowdblclick":"onMailMessageGridDoubleClick"},"cn_mail-mailmessagegrid #cn_mail-mailmessagegrid-refresh":{"click":"onMailMessageGridRefreshClick"},"cn_mail-mailmessageeditor":{"cn_mail-mailmessagesavecomplete":"onMailMessageSaveComplete","cn_mail-mailmessagesendcomplete":"onMailMessageSendComplete"},"cn_mail-maildesktopview > cn_mail-mailinboxview":{"cn_mail-beforemessageitemdelete":"onBeforeMessageItemDelete","cn_mail-messageitemmove":"onMessageItemMove"},"cn_mail-mailinboxview #btn-replyall":{"click":"onInboxViewReplyAllClick"},"cn_mail-mailinboxview #btn-reply":{"click":"onInboxViewReplyClick"},"cn_mail-mailinboxview #btn-forward":{"click":"onInboxViewForwardClick"},"cn_mail-mailinboxview #btn-editdraft":{"click":"onInboxViewEditDraftClick"}},mailInboxView:null,messageViewIdMap:null,parser:null,starvingEditors:null,defaultAccountInformations:null,constructor:function constructor(){var a=this;a.messageViewIdMap={};a.callParent(arguments)},init:function init(){this.configureWithMailFolderTreeStore()},configureWithMailFolderTreeStore:function configureWithMailFolderTreeStore(){var b=this,a=conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance();a.on("load",b.onMailFolderTreeStoreLoad,this);if(a.isLoaded()){a.getRootNode().childNodes.forEach(function(a){a.childNodes&&b.seedFolders(a.childNodes)})}},onBeforeMessageItemDelete:function onBeforeMessageItemDelete(j,a){var h=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var g=this,f=g.getView(),d=a.isCompoundKeyConfigured()?a.getCompoundKey():null;if(!d){return !0}var e=g.getMessageItemsFromOpenedViews(d,!0);for(var c=0,i=e.length;c<i;c++){var b=e[c].view;if(b&&b!==h){f.showMessageCannotBeDeletedWarning(a);f.setActiveTab(b);return !1}}return !0},onMessageItemMove:function onMessageItemMove(j,a,h,i,d){var b=this;if(h!==j){b.getView().showMessageMovedInfo(a,i,d)}b.updateMessageItemsFromOpenedViews(a.getPreviousCompoundKey(),{"mailFolderId":d.get("id"),"id":a.get("id")});var e=b.getMessageItemsFromOpenedViews(a.getCompoundKey(),!0),c,g,f;for(c=0,g=e.length;c<g;c++){f=e[c].view;b.updateHistoryForMessageRelatedView(f,a)}},showMailEditor:function showMailEditor(b,g){var a=this,k=a.getView(),h=conjoon.cn_mail.data.mail.message.EditingModes,i="conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest",e=a.defaultAccountInformations;var f,c={messageDraft:null},j=a.getItemIdForMessageRelatedView(b,g),l=a.buildCnHref(b,g),d={};if(a.defaultAccountInformations){d.defaultMailAccountId=e.mailAccountId;d.defaultMailFolderId=e.mailFolderId}switch(g){case "edit":c.messageDraft=b;break;case "replyTo":c.messageDraft=Ext.create(i,Ext.apply({compoundKey:b,editMode:h.REPLY_TO},d));break;case "replyAll":c.messageDraft=Ext.create(i,Ext.apply({compoundKey:b,editMode:h.REPLY_ALL},d));break;case "forward":c.messageDraft=Ext.create(i,Ext.apply({compoundKey:b,editMode:h.FORWARD},d));break;default:c.messageDraft=a.createMessageDraftConfig(b,e?e:{});break;}f=k.down("#"+j);if(!f){f=k.add(Ext.apply(c,{xtype:"cn_mail-mailmessageeditor",margin:"12 5 5 0",itemId:j,cn_href:l}));if(!e&&g!=="edit"){if(!a.starvingEditors){a.starvingEditors=[]}a.starvingEditors.push(j)}}k.setActiveTab(f);return f},showMailAccountFor:function showMailAccountFor(c){var a=this,f=a.getView(),b=f.down("cn_mail-mailinboxview"),g=b.down("cn_mail-mailaccountview"),e=b.down("cn_mail-mailfoldertree"),d=e.getStore();if(d.isLoading()||d.getProxy().type==="memory"){b.mon(e,"load",Ext.Function.bind(a.processMailFolderSelectionForRouting,a,[c,null,!0]),a,{single:!0})}else {a.processMailFolderSelectionForRouting(c,null,!0)}f.setActiveTab(b);return g},showInboxViewFor:function showInboxViewFor(c,d){var a=this,g=a.getView(),b=g.down("cn_mail-mailinboxview"),f=b.down("cn_mail-mailfoldertree"),e=f.getStore();if(e.isLoading()||e.getProxy().type==="memory"){b.mon(f,"load",Ext.Function.bind(a.processMailFolderSelectionForRouting,a,[c,d]),a)}else {a.processMailFolderSelectionForRouting(c,d)}return g.setActiveTab(b)},processMailFolderSelectionForRouting:function processMailFolderSelectionForRouting(h,e){var g=arguments.length>2&&arguments[2]!==undefined?arguments[2]:!1;var j=this,i=j.getView(),d=i.down("cn_mail-mailinboxview"),f=d.down("cn_mail-mailfoldertree");var a,c=f.getStore().getRoot().findChild("id",h,!1);if(!c){return !1}else if(g===!0&&e===null){a=c}else {a=c.findChild("id",e.replace("%2F","/"),!0);if(!a){return !1}}d.cn_href=a.toUrl();f.getSelectionModel().select(a);Ext.History.add(d.cn_href);var b=a.parentNode;while(b){b.expand();b=b.parentNode}return !0},showMailMessageViewFor:function showMailMessageViewFor(a){if(!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:a})}var d=this,e=d.getView(),g=d.getItemIdForMessageRelatedView(a,"read"),b=e.down("#"+g),f=e.down("cn_mail-mailmessagegrid"),c=f?f.getStore():null,h=c&&!c.isEmptyStore?c.findByCompoundKey(a):-1;if(!b){b=e.add({xtype:"cn_mail-mailmessagereadermessageview",itemId:g,cn_href:d.buildCnHref(a,"read"),margin:"12 5 5 0"});if(h>-1){b.setMessageItem(c.getAt(h))}else {b.loadMessageItem(a)}}d.getView().setActiveTab(b);return b},onMailMessageSendComplete:function onMailMessageSendComplete(c,a){var b=this;b.getView().down("cn_mail-mailinboxview").updateViewForSentDraft(a)},onMailMessageSaveComplete:function onMailMessageSaveComplete(r,a,s,t,q){var g=this,j=g.getView(),c=j.down("cn_mail-mailmessagegrid"),p=c?c.getStore():null,i=j.down("cn_mail-mailinboxview"),h=i?i.down("cn_mail-mailmessagereadermessageview"):null;var l,n,e,f,o,b;b=a.getPreBatchCompoundKey();if(b){o=g.getItemIdForMessageRelatedView(b,"read");f=j.down("#"+o)}g.updateHistoryForMessageRelatedView(r,a);if(q){i.updateViewForCreatedDraft(a);return}var d=[];if(b){d.push(b)}if(h&&b){l=h.getViewModel().get("messageItem.localId");if(l===b.toLocalId()){h.updateMessageItem(a);d.push(a.getCompoundKey())}}if(c&&d.length){for(var k=d.length-1;k>=0;k--){e=p.findExact("localId",d[k].toLocalId());if(e>-1){break}}if(e>-1){n=p.getAt(e);var m=c.getSelectionModel().getSelected().getAt(0);if(m&&m.getId()===a.getId()){c.getSelectionModel().clearSelections();c.getSelectionModel().select(e)}conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.updateItemWithDraft(n,a)}}if(f){f.updateMessageItem(a);g.updateHistoryForMessageRelatedView(f,a)}},onMessageItemRead:function onMessageItemRead(b){var a=this;if(!a.mailInboxView){a.mailInboxView=a.getView().down("cn_mail-mailinboxview")}a.mailInboxView.getController().onMessageItemRead(b)},onMailMessageGridDoubleClick:function onMailMessageGridDoubleClick(e,b){var d=this,a=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey;var c=["cn_mail/message/read",a.fromRecord(b).toArray().map(function(a){return a.replace("/","%2F")}).join("/")].join("/");d.redirectTo(c)},onTabChange:function onTabChange(g,a,h,i){var d=this,e=a.getItemId();if(!a.cn_href){return}var b=!1;for(var f in d.messageViewIdMap){var c=d.messageViewIdMap[f];if(c.itemId===e&&c.deprecated===!0){b=!0;break}}if(b===!0){Ext.History.replace(a.cn_href)}else {Ext.History.add(a.cn_href)}},getItemIdForMessageRelatedView:function getItemIdForMessageRelatedView(a,c){var b=this;var d,e=b.checkArgumentsForEditorOrView(a,c);d="cn_mail-"+c+"-"+Ext.id();a=e?a.toLocalId():a;a=b.computeIdForMessageViewMap(a,c);if(!b.messageViewIdMap[a]){b.messageViewIdMap[a]={itemId:d}}return b.messageViewIdMap[a].itemId},buildCnHref:function buildCnHref(a,b){var d=this;var c=d.checkArgumentsForEditorOrView(a,b);a=c?a.toArray().map(function(c){return c.replace("/","%2F")}).join("/"):a;switch(b){case "read":return "cn_mail/message/read/"+a;case "edit":return "cn_mail/message/edit/"+a;case "replyTo":return "cn_mail/message/replyTo/"+a;case "replyAll":return "cn_mail/message/replyAll/"+a;case "forward":return "cn_mail/message/forward/"+a;default:return "cn_mail/message/compose/"+a;}},createMessageDraftConfig:function createMessageDraftConfig(e){var f=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i=this;if(!e||!Ext.isString(e)&&!Ext.isNumber(e)){Ext.raise({key:e,msg:"\"id\" is not a valid value"})}var h,c,b,d,a=decodeURIComponent(e+"");if(Ext.String.startsWith(a,"mailto:",!0)){a=a.substring(7)}else {return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",f)}c="";if((h=a.indexOf("?"))!==-1){c=a.substring(0,h).split(",");a=a.substring(h)}else {c=a?a.split(","):[];a=""}if(!a){if(c&&c.length){return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",Ext.apply({to:c},f))}return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",f)}if(!i.parser){i.parser=Ext.create("conjoon.cn_mail.text.QueryStringParser")}b=i.parser.parse(a);for(var g in b){if(!Object.prototype.hasOwnProperty.call(b,g)){continue}d=!0;while(d){d=decodeURIComponent(b[g]);if(!d||d===b[g]){break}b[g]=d}}if(Object.prototype.hasOwnProperty.call(b,"body")){b.textHtml=b.body;delete b.body}return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",Ext.apply(Ext.apply({to:c},b),f))},updateHistoryForMessageRelatedView:function updateHistoryForMessageRelatedView(a,b){var e=this,g=e.getView();var d=null;if(a){d=a.isCnMessageEditor?"edit":"read"}if(!(b instanceof conjoon.cn_mail.model.mail.message.AbstractMessageItem)){Ext.raise({msg:"\"messageItem\" must be an instance of conjoon.cn_mail.model.mail.message.AbstractMessageItem",messageItem:b})}var f=b.getCompoundKey(),c=e.buildCnHref(f,d);if(c===a.cn_href){return null}e.updateMessageViewIdMapForMessage(a,b,d);a.cn_href=c;if(g.getActiveTab()===a){Ext.History.suspendEvents();window.location.replace("#"+c);Ext.Function.defer(function(){Ext.History.resumeEvents()},500)}return c},updateMessageViewIdMapForMessage:function updateMessageViewIdMapForMessage(a,h,j){var c=this,b=conjoon.cn_mail.data.mail.message.EditingModes;if(!a||!a.isCnMessageEditor&&!a.isCnMessageView){Ext.raise({msg:Ext.String.format("\"panel\" does not seem to be a MessageEditor or MessageView"),panel:a})}var e=[b.CREATE,b.EDIT,b.REPLY_TO,b.REPLY_ALL,b.FORWARD];if(a.isCnMessageEditor&&e.indexOf(a.editMode)===-1){Ext.raise({msg:Ext.String.format("'editMode' of Editor must be any of {0}",e.join(", ")),editor:a})}var g=h.getCompoundKey(),d=a.getItemId(),i=c.computeIdForMessageViewMap(g.toLocalId(),j);for(var k in c.messageViewIdMap){var f=c.messageViewIdMap[k];if(f.itemId===d){f.deprecated=!0}}c.messageViewIdMap[i]={itemId:d}},onInboxViewReplyClick:function onInboxViewReplyClick(){this.redirectToEditorFromInboxMessageView("replyTo")},onInboxViewForwardClick:function onInboxViewForwardClick(){this.redirectToEditorFromInboxMessageView("forward")},onInboxViewReplyAllClick:function onInboxViewReplyAllClick(){this.redirectToEditorFromInboxMessageView("replyAll")},onInboxViewEditDraftClick:function onInboxViewEditDraftClick(){this.redirectToEditorFromInboxMessageView("edit")},redirectToEditorFromInboxMessageView:function redirectToEditorFromInboxMessageView(c){var b=this,d=b.getCompoundKeyFromInboxMessageView(),a=["cn_mail/message/"+c,d.toArray().map(function(a){return a.replace("/","%2F")}).join("/")].join("/");b.redirectTo(a);return a},getCompoundKeyFromInboxMessageView:function getCompoundKeyFromInboxMessageView(){var a=this.getView().down("cn_mail-mailinboxview").down("cn_mail-mailmessagereadermessageview").getViewModel().get("messageItem");return a.getCompoundKey()},getMessageItemsFromOpenedViews:function getMessageItemsFromOpenedViews(){var d=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var h=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!1;var j=this,g=j.getView(),b=h!==!0?g.down("cn_mail-mailinboxview").down("cn_mail-mailmessagereadermessageview"):null;var f=[],e=function e(b,a){return f.push({view:b,messageItem:a})},c=b?b.getMessageItem():null;if(b&&c){if(d===null){e(b,c)}else if(!c.hasKeysModified()&&c.getCompoundKey().equalTo(d)){e(b,c)}}var i=g.items,a;i.each(function(b){a=null;if(b.isCnMessageView===!0){a=b.getMessageItem()}else if(b.isCnMessageEditor===!0){a=b.getMessageDraft()}if(!a||d!==null&&(!a.isCompoundKeyConfigured()||!a.getCompoundKey().equalTo(d))){return}e(b,a)});return f},updateMessageItemsFromOpenedViews:function updateMessageItemsFromOpenedViews(e,a,h){var j=this,f=j.getMessageItemsFromOpenedViews(e);if(!(e instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:e})}if(!Ext.isObject(a)){var i=a;a={};a[i]=h}var d,b,g;for(d=0,g=f.length;d<g;d++){b=f[d].messageItem;for(var c in a){if(!b.getField(c)){Ext.raise({msg:"cannot set field \""+c+"\" since it was not defined in the Model",field:c,messageItem:b})}b.set(c,a[c])}b.commit()}},checkArgumentsForEditorOrView:function checkArgumentsForEditorOrView(a,b){if(!a||!Ext.isString(a)&&!Ext.isNumber(a)&&!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({id:a,msg:"\"id\" is not a valid value"})}if(["edit","compose","replyTo","replyAll","forward","read"].indexOf(b)===-1){Ext.raise({type:b,msg:"\"type\" is not a valid value"})}var c=a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey;if(b!=="compose"&&!c){Ext.raise({msg:"anything but \"compose\" expects an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",id:a,type:b})}return c},onMailFolderTreeStoreLoad:function onMailFolderTreeStoreLoad(e,a,b,d){var c=this;if(!b||!a){return null}return c.seedFolders(a)},seedFolders:function seedFolders(e){var a=this,k=a.getView(),h=conjoon.cn_mail.data.mail.folder.MailFolderTypes;if(!e.length||e[0].get("folderType")===h.ACCOUNT){return null}if(!a.defaultAccountInformations){var f=e[0].parentNode,g=f.findChild("folderType",h.DRAFT,!1);if(!g){Ext.raise({msg:"No suitable node found for saving drafts"})}a.defaultAccountInformations={mailAccountId:f.get("id"),mailFolderId:g.get("id")}}if(a.starvingEditors){var i,d,c,b=a.defaultAccountInformations;for(var j=a.starvingEditors.length-1;j>-1;j--){c=k.down("#"+a.starvingEditors.pop());d=c.getViewModel();if(d.hasPendingCopyRequest()){d.processPendingCopyRequest(b.mailAccountId,b.mailFolderId)}else {i=d.get("messageDraft");if(c.editMode!=="CREATE"){Ext.raise({msg:"Unexpected editMode for starving editor: "+c.editMode})}i.set({"mailAccountId":b.mailAccountId,"mailFolderId":b.mailFolderId},{dirty:!1})}}}return a.defaultAccountInformations},computeIdForMessageViewMap:function computeIdForMessageViewMap(b,a){return a+"-"+b},onMailMessageGridRefreshClick:function onMailMessageGridRefreshClick(){var d=this,c=d.getView(),a=c.down("cn_mail-mailmessagegrid"),b=a?a.getStore():null;if(b){b.reload()}}});Ext.define("conjoon.cn_mail.view.mail.MailDesktopViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.store.mail.folder.MailFolderTreeStore"],alias:"viewmodel.cn_mail-maildesktopviewmodel",stores:{"cn_mail_mailfoldertreestore":{type:"cn_mail-mailfoldertreestore",autoLoad:!0}},privates:{applyStores:function applyStores(a){if(a.cn_mail_mailfoldertreestore){var b=!!a.cn_mail_mailfoldertreestore;a.cn_mail_mailfoldertreestore=conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance();b&&a.cn_mail_mailfoldertreestore.load()}return this.callParent([a])}}});Ext.define("conjoon.cn_mail.view.mail.MailDesktopView",{extend:"Ext.tab.Panel",alias:"widget.cn_mail-maildesktopview",requires:["conjoon.cn_mail.view.mail.inbox.InboxView","conjoon.cn_mail.view.mail.MailDesktopViewController","conjoon.cn_mail.view.mail.MailDesktopViewModel","conjoon.cn_mail.data.mail.BaseSchema","coon.comp.window.Toast"],controller:"cn_mail-maildesktopviewcontroller",viewModel:"cn_mail-maildesktopviewmodel",layout:"fit",cls:"cn_mail-tab-panel",bodyCls:"cn_mail-tab-body",flex:1,margin:"10 10 10 10",maxTabWidth:240,items:[{margin:"12 0 0 0",xtype:"cn_mail-mailinboxview",cn_href:"cn_mail/home"}],showMailMessageViewFor:function showMailMessageViewFor(a){var b=this;b.getController().showMailMessageViewFor(a)},showMailEditor:function showMailEditor(b,a){var c=this;return c.getController().showMailEditor(b,a)},showInboxViewFor:function showInboxViewFor(a,b){var c=this;return c.getController().showInboxViewFor(a,b)},showMessageMovedInfo:function showMessageMovedInfo(c,b,a){return coon.Toast.info(Ext.String.format("The message was moved to the \"{0}\" folder.",a.get("name")))},showMessageCannotBeDeletedWarning:function showMessageCannotBeDeletedWarning(a){return coon.Toast.warn("Please close all related tabs to this message first.")},showMailAccountFor:function showMailAccountFor(a){var b=this;return b.getController().showMailAccountFor(a)}});Ext.define("conjoon.cn_mail.app.PackageController",{extend:"coon.core.app.PackageController",requires:["l8","conjoon.cn_mail.view.mail.MailDesktopView","conjoon.cn_mail.view.mail.message.editor.MessageEditor","conjoon.cn_mail.view.mail.message.reader.MessageView","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.BaseSchema","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore"],routes:{"cn_mail/message/compose/:id":{action:"onComposeMessageRoute",conditions:{":id":"([0-9]+$)"},before:"onBeforePackageRoute"},"cn_mail/message/compose/mailto%3A:id":{action:"onComposeMailtoMessageRoute",conditions:{":id":"(.+)"},before:"onBeforePackageRoute"},"cn_mail/message/edit/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onEditMessageRoute",before:"onBeforePackageRoute"},"cn_mail/message/replyTo/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onReplyToRoute",before:"onBeforePackageRoute"},"cn_mail/message/replyAll/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onReplyAllRoute",before:"onBeforePackageRoute"},"cn_mail/message/forward/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onForwardRoute",before:"onBeforePackageRoute"},"cn_mail/message/read/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onReadMessageRoute",before:"onBeforePackageRoute"},"cn_mail/folder/:mailAccountId/:id":{action:"onMailFolderRoute",conditions:{":mailAccountId":"(.+)",":id":"(.+)"},before:"onBeforePackageRoute"},"cn_mail/account/:mailAccountId":{action:"onMailAccountRoute",conditions:{":mailAccountId":"(.+)"},before:"onBeforePackageRoute"},"cn_mail/home":{action:"onHomeTabRoute",before:"onBeforePackageRoute"}},control:{"cn_mail-maildesktopview":{tabchange:"onMailDesktopViewTabChange"},"cn_mail-maildesktopview > cn_mail-mailinboxview > cn_mail-mailfoldertree":{selectionchange:"onMailFolderTreeSelectionChange"},"cn_mail-maildesktopview > cn_mail-mailinboxview":{activate:"onMailInboxViewActivate",deactivate:"onMailInboxViewDeactivate"},"cn_mail-maildesktopview > cn_mail-mailinboxview > panel > container > cn_mail-mailmessagegrid":{deselect:"onMailMessageGridDeselect",select:"onMailMessageGridSelect","cn_mail-mailmessagegridbeforeload":"onMailMessageGridBeforeLoad","cn_mail-mailmessagegridload":"onMailMessageGridLoad"},"cn_navport-tbar > #cn_mail-nodeNavCreateMessage":{click:"onMessageComposeButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavEditMessage":{click:"onMessageEditButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavDeleteMessage":{click:"onMessageDeleteButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavReplyTo":{click:"onReplyToButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavReplyAll":{click:"onReplyAllButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavForward":{click:"onForwardButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavReadingPane > menu > menucheckitem":{checkchange:"onReadingPaneCheckChange"},"cn_navport-tbar > #cn_mail-nodeNavToggleList":{toggle:"onToggleListViewButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavToggleFolder":{toggle:"onToggleFolderViewButtonClick"}},refs:[{ref:"mailDesktopView",selector:"cn_mail-maildesktopview"},{ref:"mailInboxView",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview"},{ref:"mailMessageGrid",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview > panel > container > cn_mail-mailmessagegrid"},{ref:"gridContainer",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview > panel > container > cn_mail-mailmessagegridcontainer"},{ref:"mailFolderTree",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview > cn_mail-mailfoldertree"},{ref:"navigationToolbar",selector:"cn_navport-tbar"},{ref:"toggleGridListButton",selector:"cn_navport-tbar > #cn_mail-nodeNavToggleList"},{ref:"switchReadingPaneButton",selector:"cn_navport-tbar > #cn_mail-nodeNavReadingPane"},{ref:"replyToButton",selector:"cn_navport-tbar > #cn_mail-nodeNavReplyTo"},{ref:"replyAllButton",selector:"cn_navport-tbar > #cn_mail-nodeNavReplyAll"},{ref:"forwardButton",selector:"cn_navport-tbar > #cn_mail-nodeNavForward"},{ref:"editButton",selector:"cn_navport-tbar > #cn_mail-nodeNavEditMessage"},{ref:"deleteButton",selector:"cn_navport-tbar > #cn_mail-nodeNavDeleteMessage"}],observedMessageView:null,observedMessageEditor:null,init:function init(b){"use strict";var c=this,a=b.getPackageConfig(c,"service.rest-api-email.base");if(!l8.isString(a)){throw "no configured \"base\"-address found in the Package Configuration for \"conjoon.cn_mail.data.mail.BaseSchema\""}Ext.data.schema.Schema.get("cn_mail-mailbaseschema").setUrlPrefix(l8.unify(a,"/","://"))},onMailDesktopViewTabChange:function onMailDesktopViewTabChange(c,b){var a=this;if(a.observedMessageView){a.observedMessageView.un("cn_mail-messageitemload",a.onMailMessageItemLoadForActivatedView,a)}if(a.observedMessageEditor){a.observedMessageEditor.un("cn_mail-messagedraftload",a.messageEditorIsActivatedTab,a)}if(b===a.getMailInboxView()){return !1}a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0);if(b.isCnMessageEditor){if(b.isDraftLoading()){a.observedMessageEditor=b.on("cn_mail-messagedraftload",a.messageEditorIsActivatedTab,a,{single:!0})}else if(b.hasLoadingFailed()!==!0){a.messageEditorIsActivatedTab()}}else if(b.isCnMessageView){if(b.loadingItem){a.observedMessageView=b.on("cn_mail-messageitemload",a.onMailMessageItemLoadForActivatedView,a,{single:!0})}else {a.onMailMessageItemLoadForActivatedView(b)}}return !0},disableEmailEditButtons:function disableEmailEditButtons(b,a){var c=this,e=c.getEditButton(),d=c.getDeleteButton();if(arguments.length===1){a=b}e.setDisabled(b);d.setDisabled(a)},disableEmailActionButtons:function disableEmailActionButtons(a){var b=this,e=b.getReplyToButton(),c=b.getReplyAllButton(),d=b.getForwardButton();e.setDisabled(a);c.setDisabled(a);d.setDisabled(a)},activateButtonsForMessageGrid:function activateButtonsForMessageGrid(){var a=this,b=a.getMailMessageGrid().getSelection();if(b.length){a.activateButtonsForMessageItem(b[0])}else {a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)}},activateButtonsForMessageItem:function activateButtonsForMessageItem(c){var a=this,b=c.get("draft");switch(b){case !0:a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!1,!1);break;default:a.disableEmailActionButtons(!1);a.disableEmailEditButtons(!0,!1);break;}},onMailInboxViewActivate:function onMailInboxViewActivate(h){var a=this,f=conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT;var e=!1,c=!1,d=a.getMailFolderTree().getSelection(),g=d.length&&d[0].get("folderType"),b=g===f;if(d.length===0||b){e=!0;c=!0;if(b){a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)}}else if(a.getMailMessageGrid().getStore().isLoading()){c=!0}if(!b){a.activateButtonsForMessageGrid()}a.getToggleGridListButton().setDisabled(c);a.getSwitchReadingPaneButton().setDisabled(e)},onMailInboxViewDeactivate:function onMailInboxViewDeactivate(b){var a=this;a.getToggleGridListButton().setDisabled(!0);a.getSwitchReadingPaneButton().setDisabled(!0)},onMailMessageGridBeforeLoad:function onMailMessageGridBeforeLoad(b){var a=this;a.getToggleGridListButton().setDisabled(!0)},onMailMessageGridLoad:function onMailMessageGridLoad(b){var a=this;if(a.getMailDesktopView().getLayout().getActiveItem()!==a.getMailInboxView()){return}a.getToggleGridListButton().setDisabled(!1)},onToggleFolderViewButtonClick:function onToggleFolderViewButtonClick(d,b){var c=this,a=c.getMailFolderTree();if(b){a.show()}else {a.hide()}},onToggleListViewButtonClick:function onToggleListViewButtonClick(d,b){var c=this,a=c.getMailMessageGrid();a.enableRowPreview(!b)},onReadingPaneCheckChange:function onReadingPaneCheckChange(b,c){if(!c){return}var d=this,a=d.getMailInboxView();b=b.getItemId();switch(b){case "right":return a.toggleReadingPane("right");case "bottom":return a.toggleReadingPane("bottom");case "hide":return a.toggleReadingPane();}},onMailFolderTreeSelectionChange:function onMailFolderTreeSelectionChange(d,b){var a=this;if(b.length>1){Ext.raise({records:b,msg:"unexpected multiple records"})}var c=b.length<=0||b[0].get("folderType")===conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT;a.getSwitchReadingPaneButton().setDisabled(c);a.getToggleGridListButton().setDisabled(c);if(c){a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)}else {a.activateButtonsForMessageGrid()}},onMailMessageGridDeselect:function onMailMessageGridDeselect(b,c){var a=this;if(a.getMailDesktopView().getActiveTab()!==a.getMailInboxView()){return}a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)},onMailMessageGridSelect:function onMailMessageGridSelect(c,a){var b=this;b.activateButtonsForMessageItem(a)},onHomeTabRoute:function onHomeTabRoute(){var b=this,a=b.getMainPackageView();a.setActiveTab(a.down("cn_mail-mailinboxview"))},onReadMessageRoute:function onReadMessageRoute(c,d,f){var a=this,b=a.getMainPackageView(),e=a.createCompoundKeyFromUrlFragments(c,d,f);b.showMailMessageViewFor(e)},onMailAccountRoute:function onMailAccountRoute(b){var c=this,a=c.getMainPackageView();a.showMailAccountFor(decodeURI(b))},onMailFolderRoute:function onMailFolderRoute(b,c){var d=this,a=d.getMainPackageView();a.showInboxViewFor(decodeURI(b),decodeURI(c))},onComposeMessageRoute:function onComposeMessageRoute(a){this.showMailEditor(a,"compose")},onComposeMailtoMessageRoute:function onComposeMailtoMessageRoute(a){a="mailto%3A"+a;this.showMailEditor(a,"compose")},onMessageComposeButtonClick:function onMessageComposeButtonClick(a){this.showMailEditor(Date.now(),"compose")},onEditMessageRoute:function onEditMessageRoute(b,c,d){var a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"edit")},onReplyToRoute:function onReplyToRoute(b,c,d){var a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"replyTo")},onReplyAllRoute:function onReplyAllRoute(b,c,d){var a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"replyAll")},onForwardRoute:function onForwardRoute(b,c,d){var a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"forward")},onMessageEditButtonClick:function onMessageEditButtonClick(c){var a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"edit")},onMessageDeleteButtonClick:function onMessageDeleteButtonClick(c){var a=this,b=a.getItemOrDraftFromActiveView();if(b===null){Ext.raise("Unexpected null-value for item.")}a.getMailInboxView().getController().moveOrDeleteMessage(b,!1,a.getMailDesktopView().getActiveTab())},onReplyToButtonClick:function onReplyToButtonClick(c){var a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"replyTo")},onReplyAllButtonClick:function onReplyAllButtonClick(c){var a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"replyAll")},onForwardButtonClick:function onForwardButtonClick(c){var a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"forward")},postLaunchHook:function postLaunchHook(){conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance().load();return {navigation:[{text:"Email",route:"cn_mail/home",view:"conjoon.cn_mail.view.mail.MailDesktopView",iconCls:"fas fa-paper-plane",nodeNav:[{xtype:"button",iconCls:"fas fa-plus",itemId:"cn_mail-nodeNavCreateMessage"},{xtype:"tbseparator"},{xtype:"button",iconCls:"fas fa-reply",disabled:!0,itemId:"cn_mail-nodeNavReplyTo"},{xtype:"button",iconCls:"fas fa-reply-all",itemId:"cn_mail-nodeNavReplyAll",disabled:!0},{xtype:"button",iconCls:"fas fa-share",itemId:"cn_mail-nodeNavForward",disabled:!0},{xtype:"button",iconCls:"fas fa-edit",itemId:"cn_mail-nodeNavEditMessage",disabled:!0},{xtype:"button",iconCls:"fas fa-trash",itemId:"cn_mail-nodeNavDeleteMessage",disabled:!0},{xtype:"tbseparator"},{xtype:"button",iconCls:"far fa-folder",disabled:!1,cls:"toggleFolderViewBtn",itemId:"cn_mail-nodeNavToggleFolder",enableToggle:!0,pressed:!0},{xtype:"button",iconCls:"fas fa-list",disabled:!0,cls:"toggleGridViewBtn",itemId:"cn_mail-nodeNavToggleList",enableToggle:!0},{xtype:"button",disabled:!0,iconCls:"fas fa-columns",itemId:"cn_mail-nodeNavReadingPane",menu:[{iconCls:"fas fa-toggle-right",text:"Right",itemId:"right",checked:!0,xtype:"menucheckitem",group:"cn_mail-nodeNavReadingPaneRGroup"},{iconCls:"fas fa-toggle-down",text:"Bottom",itemId:"bottom",xtype:"menucheckitem",group:"cn_mail-nodeNavReadingPaneRGroup"},{iconCls:"fas fa-close",text:"Hidden",itemId:"hide",xtype:"menucheckitem",group:"cn_mail-nodeNavReadingPaneRGroup"}]}]}]}},getMainPackageView:function getMainPackageView(){var a=this,c=a.getApplication();var b=c.getPackageConfig(a,"title");b&&Ext.fireEvent("conjoon.application.TitleAvailable",a,b);return c.activateViewForHash("cn_mail/home")},privates:{getItemOrDraftFromActiveView:function getItemOrDraftFromActiveView(){var b=this,a=b.getMailDesktopView().getActiveTab();if(a instanceof conjoon.cn_mail.view.mail.message.editor.MessageEditor){return a.getMessageDraft()}else if(a instanceof conjoon.cn_mail.view.mail.message.reader.MessageView){return a.getMessageItem()}else if(a===b.getMailInboxView()){return b.getMailMessageGrid().getSelection()[0]}return null},getCompoundKeyFromGridOrMessageView:function getCompoundKeyFromGridOrMessageView(){var b=this,a=b.getMailDesktopView().getActiveTab();if(a instanceof conjoon.cn_mail.view.mail.message.reader.MessageView){return a.getMessageItem().getCompoundKey()}else if(a===b.getMailInboxView()){return b.getMailMessageGrid().getSelection()[0].getCompoundKey()}return null},onMailMessageItemLoadForActivatedView:function onMailMessageItemLoadForActivatedView(c,b){var a=this;if(!b){b=c.getViewModel().get("messageItem")}if(b.get("draft")){a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!1,!1)}else {a.disableEmailActionButtons(!1);a.disableEmailEditButtons(!0,!1)}a.observedMessageView=null},showMailEditor:function showMailEditor(b,a){var d=this,c=d.getMainPackageView();if(a!=="compose"&&!(b instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"anything but \"compose\" expects an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",key:b,type:a})}c.showMailEditor(b,a)}},createCompoundKeyFromUrlFragments:function createCompoundKeyFromUrlFragments(a,b,c){return conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey.createFor(decodeURIComponent(a),decodeURIComponent(b),decodeURIComponent(c))},messageEditorIsActivatedTab:function messageEditorIsActivatedTab(){var a=this;a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0,!1)}});Ext.define("conjoon.cn_mail.app.plugin.MailtoProtocolHandlerPlugin",{extend:"coon.core.app.plugin.ControllerPlugin",run:function run(b){"use strict";if(navigator.registerProtocolHandler){var a=window.location.origin;navigator.registerProtocolHandler("mailto",a+"/#cn_mail/message/compose/%s","mailto handler")}return !0}});Ext.define("conjoon.cn_mail.data.mail.MailboxSubscriptionMixin",{requires:["l8"],initSubscriptions:function initSubscriptions(){"use strict";var a=this;if(!a.subscriptions){a.subscriptions={}}},getSubscription:function getSubscription(b){"use strict";var a=this;a.initSubscriptions();var c=a.getSubscriptionId(b);return a.subscriptions[c]},addSubscription:function addSubscription(c,b){"use strict";var a=this;a.initSubscriptions();var d=a.getSubscriptionId(c);a.subscriptions[d]=b;return b},getSubscriptionId:function getSubscriptionId(a){"use strict";if(l8.isObject(a)&&l8.isFunction(a.get)){return a.get("id")}if(!l8.isString(a)){throw new Error("Unexpected type for \"mailAccount\" submitted")}return a}});function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(b){return typeof b}:function(b){return b&&"function"==typeof Symbol&&b.constructor===Symbol&&b!==Symbol.prototype?"symbol":typeof b},_typeof(a)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function _regeneratorRuntime(){return a};var a={},l=Object.prototype,c=l.hasOwnProperty,f=Object.defineProperty||function(c,b,a){c[b]=a.value},k="function"==typeof Symbol?Symbol:{},g=k.iterator||"@@iterator",m=k.asyncIterator||"@@asyncIterator",i=k.toStringTag||"@@toStringTag";function define(b,a,c){return Object.defineProperty(b,a,{value:c,enumerable:!0,configurable:!0,writable:!0}),b[a]}try{define({},"")}catch(n){define=function define(c,b,a){return c[b]=a}}function wrap(g,a,h,d){var c=a&&a.prototype instanceof Generator?a:Generator,b=Object.create(c.prototype),e=new Context(d||[]);return f(b,"_invoke",{value:makeInvokeMethod(g,h,e)}),b}function tryCatch(c,b,a){try{return {type:"normal",arg:c.call(b,a)}}catch(o){return {type:"throw",arg:o}}}a.wrap=wrap;var b={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var h={};define(h,g,function(){return this});var j=Object.getPrototypeOf,e=j&&j(j(values([])));e&&e!==l&&c.call(e,g)&&(h=e);var d=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(h);function defineIteratorMethods(a){["next","throw","return"].forEach(function(b){define(a,b,function(c){return this._invoke(b,c)})})}function AsyncIterator(d,b){function invoke(i,j,e,f){var g=tryCatch(d[i],d,j);if("throw"!==g.type){var h=g.arg,a=h.value;return a&&"object"==_typeof(a)&&c.call(a,"__await")?b.resolve(a.__await).then(function(a){invoke("next",a,e,f)},function(a){invoke("throw",a,e,f)}):b.resolve(a).then(function(a){h.value=a,e(h)},function(a){return invoke("throw",a,e,f)})}f(g.arg)}var a;f(this,"_invoke",{value:function value(c,e){function callInvokeWithMethodAndArg(){return new b(function(a,f){invoke(c,e,a,f)})}return a=a?a.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(d,e,a){var c="suspendedStart";return function(i,j){if("executing"===c){throw new Error("Generator is already running")}if("completed"===c){if("throw"===i){throw j}return doneResult()}for(a.method=i,a.arg=j;;){var h=a.delegate;if(h){var g=maybeInvokeDelegate(h,a);if(g){if(g===b){continue}return g}}if("next"===a.method){a.sent=a._sent=a.arg}else if("throw"===a.method){if("suspendedStart"===c){throw c="completed",a.arg}a.dispatchException(a.arg)}else {"return"===a.method&&a.abrupt("return",a.arg)}c="executing";var f=tryCatch(d,e,a);if("normal"===f.type){if(c=a.done?"completed":"suspendedYield",f.arg===b){continue}return {value:f.arg,done:a.done}}"throw"===f.type&&(c="completed",a.method="throw",a.arg=f.arg)}}}function maybeInvokeDelegate(c,a){var d=a.method,g=c.iterator[d];if(undefined===g){return a.delegate=null,"throw"===d&&c.iterator["return"]&&(a.method="return",a.arg=undefined,maybeInvokeDelegate(c,a),"throw"===a.method)||"return"!==d&&(a.method="throw",a.arg=new TypeError("The iterator does not provide a '"+d+"' method")),b}var f=tryCatch(g,c.iterator,a.arg);if("throw"===f.type){return a.method="throw",a.arg=f.arg,a.delegate=null,b}var e=f.arg;return e?e.done?(a[c.resultName]=e.value,a.next=c.nextLoc,"return"!==a.method&&(a.method="next",a.arg=undefined),a.delegate=null,b):e:(a.method="throw",a.arg=new TypeError("iterator result is not an object"),a.delegate=null,b)}function pushTryEntry(a){var b={tryLoc:a[0]};1 in a&&(b.catchLoc=a[1]),2 in a&&(b.finallyLoc=a[2],b.afterLoc=a[3]),this.tryEntries.push(b)}function resetTryEntry(b){var a=b.completion||{};a.type="normal",delete a.arg,b.completion=a}function Context(a){this.tryEntries=[{tryLoc:"root"}],a.forEach(pushTryEntry,this),this.reset(!0)}function values(a){if(a){var e=a[g];if(e){return e.call(a)}if("function"==typeof a.next){return a}if(!isNaN(a.length)){var d=-1,b=function b(){for(;++d<a.length;){if(c.call(a,d)){return b.value=a[d],b.done=!1,b}}return b.value=undefined,b.done=!0,b};return b.next=b}}return {next:doneResult}}function doneResult(){return {value:undefined,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,f(d,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),f(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,i,"GeneratorFunction"),a.isGeneratorFunction=function(b){var a="function"==typeof b&&b.constructor;return !!a&&(a===GeneratorFunction||"GeneratorFunction"===(a.displayName||a.name))},a.mark=function(a){return Object.setPrototypeOf?Object.setPrototypeOf(a,GeneratorFunctionPrototype):(a.__proto__=GeneratorFunctionPrototype,define(a,i,"GeneratorFunction")),a.prototype=Object.create(d),a},a.awrap=function(a){return {__await:a}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,m,function(){return this}),a.AsyncIterator=AsyncIterator,a.async=function(f,d,g,e,b){void 0===b&&(b=Promise);var c=new AsyncIterator(wrap(f,d,g,e),b);return a.isGeneratorFunction(d)?c:c.next().then(function(a){return a.done?a.value:c.next()})},defineIteratorMethods(d),define(d,i,"Generator"),define(d,g,function(){return this}),define(d,"toString",function(){return "[object Generator]"}),a.keys=function(d){var b=Object(d),a=[];for(var c in b){a.push(c)}return a.reverse(),function next(){for(;a.length;){var c=a.pop();if(c in b){return next.value=c,next.done=!1,next}}return next.done=!0,next}},a.values=values,Context.prototype={constructor:Context,reset:function reset(b){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!b){for(var a in this){"t"===a.charAt(0)&&c.call(this,a)&&!isNaN(+a.slice(1))&&(this[a]=undefined)}}},stop:function stop(){this.done=!0;var a=this.tryEntries[0].completion;if("throw"===a.type){throw a.arg}return this.rval},dispatchException:function dispatchException(f){if(this.done){throw f}var b=this;function handle(c,a){return h.type="throw",h.arg=f,b.next=c,a&&(b.method="next",b.arg=undefined),!!a}for(var d=this.tryEntries.length-1;d>=0;--d){var a=this.tryEntries[d],h=a.completion;if("root"===a.tryLoc){return handle("end")}if(a.tryLoc<=this.prev){var g=c.call(a,"catchLoc"),e=c.call(a,"finallyLoc");if(g&&e){if(this.prev<a.catchLoc){return handle(a.catchLoc,!0)}if(this.prev<a.finallyLoc){return handle(a.finallyLoc)}}else if(g){if(this.prev<a.catchLoc){return handle(a.catchLoc,!0)}}else {if(!e){throw new Error("try statement without catch or finally")}if(this.prev<a.finallyLoc){return handle(a.finallyLoc)}}}}},abrupt:function abrupt(f,g){for(var h=this.tryEntries.length-1;h>=0;--h){var d=this.tryEntries[h];if(d.tryLoc<=this.prev&&c.call(d,"finallyLoc")&&this.prev<d.finallyLoc){var a=d;break}}a&&("break"===f||"continue"===f)&&a.tryLoc<=g&&g<=a.finallyLoc&&(a=null);var e=a?a.completion:{};return e.type=f,e.arg=g,a?(this.method="next",this.next=a.finallyLoc,b):this.complete(e)},complete:function complete(a,c){if("throw"===a.type){throw a.arg}return "break"===a.type||"continue"===a.type?this.next=a.arg:"return"===a.type?(this.rval=this.arg=a.arg,this.method="return",this.next="end"):"normal"===a.type&&c&&(this.next=c),b},finish:function finish(d){for(var c=this.tryEntries.length-1;c>=0;--c){var a=this.tryEntries[c];if(a.finallyLoc===d){return this.complete(a.completion,a.afterLoc),resetTryEntry(a),b}}},"catch":function _catch(e){for(var b=this.tryEntries.length-1;b>=0;--b){var a=this.tryEntries[b];if(a.tryLoc===e){var c=a.completion;if("throw"===c.type){var d=c.arg;resetTryEntry(a)}return d}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(c,a,d){return this.delegate={iterator:values(c),resultName:a,nextLoc:d},"next"===this.method&&(this.arg=undefined),b}},a}function asyncGeneratorStep(h,c,e,f,d,i,g){try{var b=h[i](g);var a=b.value}catch(j){e(j);return}if(b.done){c(a)}else {Promise.resolve(a).then(f,d)}}function _asyncToGenerator(a){return function(){var c=this,b=arguments;return new Promise(function(d,e){var f=a.apply(c,b);function _next(b){asyncGeneratorStep(f,d,e,_next,_throw,"next",b)}function _throw(b){asyncGeneratorStep(f,d,e,_next,_throw,"throw",b)}_next(undefined)})}}Ext.define("conjoon.cn_mail.data.mail.MailboxRunner",{requires:["l8","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.data.mail.service.MailboxService","coon.core.data.request.Configurator"],statics:{required:{requestConfigurator:"coon.core.data.request.Configurator"}},mixins:["conjoon.cn_mail.data.mail.MailboxSubscriptionMixin"],interval:120000,constructor:function constructor(a){a=a||{};var c=this,b=a.mailFolderTreeStore;delete a.mailFolderTreeStore;Object.assign(c,a);if(b){this.init(b)}},init:function init(a){"use strict";var b=this;if(b.mailFolderTreeStore){throw new Error("MailboxRunner was already initialized")}if(!(a instanceof conjoon.cn_mail.store.mail.folder.MailFolderTreeStore)){throw new Error("\"treeStore\" must be an instance of conjoon.cn_mail.store.mail.folder.MailFolderTreeStore")}b.mailFolderTreeStore=a;a.on("load",b.onMailFolderTreeStoreLoad,b);if(a.isLoaded()){var c=a.getRoot().childNodes;c&&c.forEach(function(c){return b.createSubscription(c)})}},createSubscription:function createSubscription(a){"use strict";var c=this;if(c.getSubscription(a)){return !1}var b=conjoon.cn_mail.data.mail.folder.MailFolderTypes;if(a.get("folderType")!==b.ACCOUNT){throw new Error("The folderType of the passed node must be ".concat(b.ACCOUNT))}if(a.childNodes.length===0){throw new Error("need at least one child node to subscribe to")}var d=a.findChild("folderType",b.INBOX,!1);if(!d){throw new Error("no INBOX node found for creating a subscription")}var e=c.addSubscription(a,{folder:d});c.start(a);return e},visitSubscription:function visitSubscription(a){"use strict";var b=this;return _asyncToGenerator(_regeneratorRuntime().mark(function _callee(){var c,g,h,e,f,l,d,m,j,i,k;return _regeneratorRuntime().wrap(function _callee$(n){while(1){switch(n.prev=n.next){case 0:c=b,g=a.get("mailAccountId"),h=a.get("id"),e=a.get("uidNext"),f=conjoon.cn_mail.model.mail.message.MessageItem.getProxy(),l=[{property:"mailAccountId",value:g},{property:"mailFolderId",value:h}],d=[{property:"recent",value:!0,operator:"="}];if(e){d.push({property:"id",value:e,operator:">="})};m=f.assembleUrl(Ext.create("Ext.data.Request",{action:"read",params:{filter:JSON.stringify(l)}}));j=Object.assign(f.getDefaultParameters("ListMessageItem"),{filter:JSON.stringify(d)}),i=c.getDefaultRequestCfg({url:m,parameters:j,latestFilter:d}),k=c.requestConfigurator.configure(i);Ext.Ajax.request(k).then(c.onSubscriptionResponseAvailable.bind(c,a));case 5:case "end":return n.stop();}}},_callee)}))()},getDefaultRequestCfg:function getDefaultRequestCfg(a){var c=a.url,b=a.parameters;return {method:"get",action:"read",url:c,params:b}},start:function start(c){"use strict";var b=this,a=b.getSubscription(c);if(!a){return !1}if(!a.extjsTask){a.extjsTask=Ext.TaskManager.start({run:b.visitSubscription,fireOnStart:!1,scope:b,args:[a.folder],interval:b.interval})}return a},stop:function stop(c){"use strict";var b=this,a=b.getSubscription(c);if(!a){return !1}if(a.extjsTask){Ext.TaskManager.stop(a.extjsTask,!0);delete a.extjsTask}delete b.subscriptions[b.getSubscriptionId(c)];return a},pause:function pause(b){"use strict";var c=this,a=c.getSubscription(b);if(!a||!a.extjsTask){return !1}if(a.extjsTask){Ext.TaskManager.stop(a.extjsTask,!1)}return a},resume:function resume(b){"use strict";var c=this,a=c.getSubscription(b);if(!a||!a.extjsTask){return !1}if(a.extjsTask&&a.extjsTask.stopped){Ext.TaskManager.start(a.extjsTask,!1)}return a},onMailFolderTreeStoreLoad:function onMailFolderTreeStoreLoad(e,a,b){"use strict";if(!b){return}var d=this;var c=conjoon.cn_mail.data.mail.folder.MailFolderTypes;if(a[0].get("folderType")===c.ACCOUNT){return}d.createSubscription(a[0].parentNode)},destroy:function destroy(){var a=this;if(a.mailFolderTreeStore){a.mailFolderTreeStore.un("load",a.onMailFolderTreeStoreLoad,a)}if(a.subscriptions){Object.keys(a.subscriptions).forEach(function(b){return a.stop(b)})}delete a.subscriptions;a.callParent(arguments)},onSubscriptionResponseAvailable:function onSubscriptionResponseAvailable(d,e){var g=conjoon.cn_mail.model.mail.message.MessageItem.getProxy(),f=g.getReader();var c=f.read(e);if(c.getRecords().length){var b=conjoon.cn_mail.data.mail.service.MailboxService.recentMessageItemKeys;var a=c.getRecords().filter(function(a){var c=a.getCompoundKey().toString();if(!b.has(c)){b.add(c);a.set("recent",!0,{dirty:!1});return !0}return !1});if(a.length){Ext.fireEvent("conjoon.cn_mail.event.NewMessagesAvailable",d,a);return a}}return !1}});Ext.define("conjoon.cn_mail.app.plugin.NewMessagesNotificationPlugin",{extend:"coon.core.app.plugin.ControllerPlugin",requires:["l8","coon.user.Manager","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore","conjoon.cn_mail.data.mail.MailboxRunner","coon.comp.window.Toast","coon.core.Environment","coon.core.ConfigManager","conjoon.cn_mail.data.mail.service.MailFolderHelper","conjoon.cn_mail.app.PackageController"],interval:120000,run:function run(b){"use strict";if(!coon.user.Manager.getUser()){return !1}if(!(b instanceof conjoon.cn_mail.app.PackageController)){throw new Error("\"controller\" must be an instance of conjoon.cn_mail.app.PackageController")}var a=this,c=conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance();a.controller=b;a.mailboxRunner=Ext.create("conjoon.cn_mail.data.mail.MailboxRunner",{mailFolderTreeStore:c,interval:a.interval});b.listen({global:{"conjoon.cn_mail.event.NewMessagesAvailable":{fn:a.onNewMessagesAvailable,scope:a}}});b.control({"cn_mail-mailmessagegrid":{"cn_mail-mailmessagegridload":{fn:a.onMessageGridLoad,scope:a}}});return !0},onNewMessagesAvailable:function onNewMessagesAvailable(b,d){var a=this,e=d.length;if(!e){return null}var c=a.getNotificationText(b,e);coon.Toast.info(c);a.showNotification(b,c);a.playSound();a.updateMessageGridWithRecentMessages(b,d);return !0},onMessageGridLoad:function onMessageGridLoad(h,f){var a=this,g=a.controller,d=conjoon.cn_mail.MailboxService.recentMessageItemKeys,e=g.getMailInboxView().getController(),c=e.getSelectedMailFolder();if(!a.folderHasMailboxRunnerSubscription(c)){return null}var b=f.filter(function(a){return a.get("recent")===!0&&!d.has(a.getCompoundKey().toString())});if(!b.length){return null}b.forEach(function(a){d.add(a.getCompoundKey().toString())});a.showNotification(c,a.getNotificationText(c,b.length));a.playSound();return !0},folderHasMailboxRunnerSubscription:function folderHasMailboxRunnerSubscription(b){"use strict";var c=this,a=c.mailboxRunner.getSubscription(b.getCompoundKey().getMailAccountId());return a?a.folder===b:!1},updateMessageGridWithRecentMessages:function updateMessageGridWithRecentMessages(e,d){var c=this,f=c.controller,a=f.getMailInboxView().getController(),b=a.getLivegrid();if(a.getSelectedMailFolder()!==e){return !1}d.forEach(function(a){if(b.getRecordByCompoundKey(a.getCompoundKey())){return}b.add(a);a.join(c.controller.getMailMessageGrid().getStore())});return !0},playSound:function playSound(){var a=this;if(!a.audio){var d=a.getResource("soundFile");if(!d){return null}a.audio=new Audio(d)}var c=a.audio;var b=c.play();if(b!==undefined){b.then(function(){})["catch"](function(a){})}return c},showNotification:function showNotification(e,f){if(Notification.permission==="denied"){return null}var a=this,c=a.getResource("iconFile"),d={},g=coon.core.Environment.getManifest("name"),h=coon.core.ConfigManager.get(g,"title");if(c){d.icon=c}var b=new Notification("".concat(h||a.controller.getApplication().getName()," - new email"),Object.assign({body:f},d));b.onclick=function(){window.focus();a.controller.redirectTo(e.toUrl());this.close()};return b},getNotificationText:function getNotificationText(b,a){return "".concat(conjoon.cn_mail.MailFolderHelper.getInstance().getAccountNode(b.get("mailAccountId")).get("name")," has ").concat(a," new message").concat(a>1?"s":"")},getResource:function getResource(a){var b=this,c=["iconFile","soundFile"];if(!c.includes(a)){throw new Error("\"type\" must be one of ".concat(c.join(", ")))}if(b[a]!==undefined){return b[a]}var d=b.getConfig();b[a]=l8.unchain("resources.".concat(a==="soundFile"?"sounds":"images",".notifications.newEmail"),d,undefined);if(b[a]){b[a]=coon.core.Environment.getPathForResource(b[a],"extjs-app-webmail");return b[a]}return null},getConfig:function getConfig(){var a=this;return a.controller.getApplication().getPackageConfig(a.controller)}});Ext.define("conjoon.cn_mail.data.mail.message.compoundKey.AttachmentItemCompoundKey",{extend:"conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey"});
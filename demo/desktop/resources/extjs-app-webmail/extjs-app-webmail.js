Ext.define("conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog",{requires:["coon.comp.component.MessageMask"],deleteMask:null,canCloseAfterDelete:!0,showMessageDeleteConfirmDialog:function(e,d,c){const a=this;if(a.deleteMask){return a.deleteMask}let b=Ext.create("coon.comp.component.MessageMask",{title:"Delete Message",message:"Are you sure you want to delete the message permanently?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:d,scope:c});a.mon(b,"destroy",function(){this.deleteMask=null},a);b.show();a.deleteMask=b;return b},closeAfterDelete:function(){const a=this;if(!a.canCloseAfterDelete){return !1}if(a.deleteMask){a.deleteMask.close()}a.close();return !0}});Ext.define("conjoon.cn_mail.data.mail.AbstractCompoundKey",{inheritableStatics:{decode(a){return JSON.parse(atob(decodeURIComponent(a)))},fromRecord:function(a){if(!(a instanceof Ext.data.Model)){Ext.raise({msg:"\"rec\" must be an instance of Ext.data.Model",rec:a})}return new this({mailAccountId:a.get("mailAccountId"),id:a.get("id")})},createFor:function(a,b){return new this({mailAccountId:a,id:b})}},config:{mailAccountId:undefined,id:undefined},constructor:function(a){const b=this;if(!a||!a.mailAccountId||!a.id){Ext.raise({msg:"\"cfg\" must be an object containing the properties "+"mailAccountId and id",cfg:a})}b.initConfig(a)},toArray:function(){const a=this;return [a.getMailAccountId(),a.getId()]},toObject:function(){const a=this;return {mailAccountId:a.getMailAccountId(),id:a.getId()}},toString(){return encodeURIComponent(btoa(JSON.stringify(this.toObject())))},toLocalId:function(){const a=this;return a.getMailAccountId()+"-"+a.getId()},applyMailAccountId:function(b){const a=this;if(a.getMailAccountId()!==undefined){Ext.raise({msg:"\"mailAccountId\" was already set",mailAccountId:a.getMailAccountId()})}return b},applyId:function(b){const a=this;if(a.getId()!==undefined){Ext.raise({msg:"\"id\" was already set",id:a.getId()})}return b},equalTo:function(a){const b=this;if(!(a instanceof conjoon.cn_mail.data.mail.AbstractCompoundKey)){return !1}return b.toLocalId()===a.toLocalId()}});Ext.define("conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator",{requires:["coon.core.data.field.CompoundKeyField","conjoon.cn_mail.data.mail.AbstractCompoundKey"],statics:{decorate:function(b){let a=Ext.data.schema.Schema.lookupEntity(b);a.override(this.getPrototypeBody());a.addFields([{name:"localId",type:"string"},{name:"id",type:"cn_core-datafieldcompoundkey"},{name:"mailAccountId",type:"cn_core-datafieldcompoundkey"}]);a.removeFields(["__id__"])},getPrototypeBody:function(){return {idProperty:"localId",callerEntityName:"",compoundKeyFields:[],foreignKeyFields:["mailAccountId","id"],previousCompoundKey:null,inheritableStatics:{loadEntity:function(b,a,c){if(!(b instanceof conjoon.cn_mail.data.mail.AbstractCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.AbstractCompoundKey",compoundKey:b})}let d=b.toLocalId();a=a||{};a.params=a.params||{};Ext.apply(a.params,b.toObject());return this.load(d,a,c)}},save:function(c){const a=this;let b;if(a.dropped&&a.phantom){return a.callParent(arguments)}if(a.phantom){b=a.data}else {b=Ext.applyIf(Ext.apply({},a.modified),a.data)}a.checkForeignKeysForAction(b,"save");return a.callParent(arguments)},commit:function(){const a=this,b=a.getRepresentingCompoundKeyClass();let c=!1;if(!a.phantom&&a.modified){for(let d=0,e=a.foreignKeyFields.length;d<e;d++){if(Object.prototype.hasOwnProperty.call(a.modified,a.foreignKeyFields[d])){c=!0;break}}if(c){let e=Ext.applyIf(Ext.apply({},a.modified),a.data),d=[];for(let c=0,f=a.foreignKeyFields.length;c<f;c++){d.push(e[a.foreignKeyFields[c]])}a.previousCompoundKey=b.createFor.apply(b,d)}}return a.callParent(arguments)},getRepresentingCompoundKeyClass:function(){Ext.raise("abstract method must be overwritten.")},load:function(b){const c=this;let a=b?b.params:{};a=a||{};c.checkForeignKeysForAction(a,"read");return c.callParent(arguments)},checkForeignKeysForAction:function(a,d){const b=this,e=b.phantom;a=a||{};for(let c=0,f=b.foreignKeyFields.length;c<f;c++){if(b.foreignKeyFields[c]!=="id"){if(!a[b.foreignKeyFields[c]]){Ext.raise({msg:"\""+b.foreignKeyFields[c]+"\" must be set",action:d,foreignKeField:a[b.foreignKeyFields[c]]})}}else if((d==="read"||!e)&&!a.id){Ext.raise({msg:"\"id\" must be set before",action:d,id:a.id})}}return !0},getAssociatedCompoundKeyedData:function(){return []},set:function(h,n){const a=this;let i=Ext.isString(h)?h:Ext.clone(h),e=a.getAssociatedCompoundKeyedData(),q=a.callParent(arguments),b=[],f={},d,m,c,g;if(Ext.isString(i)){f[i]=n}else {f=i}for(let j=0,o=e.length;j<o;j++){g=null;c=e[j];b=Ext.isArray(a.compoundKeyFields)?a.compoundKeyFields:a.compoundKeyFields[c.entityName];if(c.entityName===a.callerEntityName){continue}c.callerEntityName=a.entityName;for(d in f){g=d;if((Ext.isArray(b)&&b.indexOf(d)===-1)||(!Ext.isArray(b)&&!b[d])){continue}if(!Ext.isArray(b)){g=b[d]}m=f[d];c.set(g,m,{dirty:!1})}c.callerEntityName=""}let l=!1;for(let k=0,p=a.foreignKeyFields.length;k<p;k++){if(Object.prototype.hasOwnProperty.call(f,a.foreignKeyFields[k])){l=!0;break}}if(l){a.updateLocalId();e=a.getAssociatedCompoundKeyedData();for(let b=0,c=e.length;b<c;b++){e[b].updateLocalId()}}return q},compareAndApplyCompoundKeys:function(f,m=!0){const d=this;let a=Ext.isArray(d.compoundKeyFields)?d.compoundKeyFields:d.compoundKeyFields[f.entityName],c,e,l={};if(Ext.isArray(a)){for(let b=0,c=a.length;b<c;b++){l[a[b]]=a[b]}a=l}for(let b in a){c=b;e=a[b]}let k=0,j=0,i,g;for(let b in a){c=b;e=a[b];if(d.get(c)){k++}if(f.get(e)){j++}}let h=!1;if(j>=k&&m===!0){i=d;g=f;h=!0}else {i=f;g=d}for(let b in a){c=h?a[b]:b;e=h?b:a[b];if(c===d.getIdProperty()||e===f.getIdProperty()){continue}if(g.get(c)){i.set(e,g.get(c),{dirty:!1})}}return !0},updateLocalId:function(){const a=this,d=a.getRepresentingCompoundKeyClass();if(!a.isCompoundKeyConfigured()){return null}let e=[],b;for(let c=0,f=a.foreignKeyFields.length;c<f;c++){e.push(a.get(a.foreignKeyFields[c]))}b=d.createFor.apply(d,e).toLocalId();if(a.getId()===b){return b}a.setId(b,{dirty:!1});return b},isCompoundKeySet:function(){const a=this;for(let b=0,c=a.foreignKeyFields.length;b<c;b++){if(!a.get(a.foreignKeyFields[b])){return !1}}return !0},processRecordAssociation:Ext.emptyFn,getCompoundKey(){"use strict";const a=this,b=a.getRepresentingCompoundKeyClass();a.hasKeysModified(!0);return b.fromRecord(a)},hasKeysModified:function(d=!1){const a=this,c=a.modified;if(!c){return !1}for(let b=0,e=a.foreignKeyFields.length;b<e;b++){if(Object.prototype.hasOwnProperty.call(c,a.foreignKeyFields[b])&&c[a.foreignKeyFields[b]]!==undefined){if(d===!0){Ext.raise("Field was modified, can not use current information.")}return !0}}return !1},getPreviousCompoundKey:function(){const a=this;return a.previousCompoundKey?a.previousCompoundKey:a.getCompoundKey()},isCompoundKeyConfigured:function(){const a=this,c=a.data;for(let b=0,d=a.foreignKeyFields.length;b<d;b++){if(Ext.isEmpty(c[a.foreignKeyFields[b]])){return !1}}return !0}}}}});Ext.define("conjoon.cn_mail.data.mail.message.CompoundKey",{extend:"conjoon.cn_mail.data.mail.AbstractCompoundKey",inheritableStatics:{fromRecord:function(a){if(!(a instanceof Ext.data.Model)){Ext.raise({msg:"\"rec\" must be an instance of Ext.data.Model",rec:a})}return new this({mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId"),id:a.get("id")})},createFor:function(a,b,c){return new this({mailAccountId:a,mailFolderId:b,id:c})}},config:{mailFolderId:undefined},constructor:function(a){const b=this;if(!a||!a.mailAccountId||!a.mailFolderId||!a.id){Ext.raise({msg:"\"cfg\" must be an object containing the properties "+"mailAccountId, mailFolderId and id",cfg:a})}b.callParent(arguments)},toArray:function(){const a=this;return [a.getMailAccountId(),a.getMailFolderId(),a.getId()]},toObject:function(){const a=this;return {mailAccountId:a.getMailAccountId(),mailFolderId:a.getMailFolderId(),id:a.getId()}},toLocalId:function(){const a=this;return a.getMailAccountId()+"-"+a.getMailFolderId()+"-"+a.getId()},applyMailFolderId:function(b){const a=this;if(a.getMailFolderId()!==undefined){Ext.raise({msg:"\"mailFolderId\" was already set",mailFolderId:a.getMailFolderId()})}return b}});Ext.define("conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",{extend:"conjoon.cn_mail.data.mail.message.CompoundKey"});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader",{extend:"Ext.data.reader.Json",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"reader.cn_mail-mailmessageentityjsonreader",rootProperty:"data",getResponseData:function(b){const d=this,c=b.request.action,a=d.callParent(arguments);if(!a.metaData){a.metaData={}}a.metaData.cn_action=c;return a},readRecords:function(a,e,d){const c=this,b=a&&a.metaData?a.metaData.cn_action:"";if(b!=="destroy"){a=c.applyCompoundKey(a,b)}return c.callParent([a,e,d])},applyCompoundKey:function(a,c){const b=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey,d=["create","update","read","destroy"];if(d.indexOf(c)===-1){let b=d.join(", ");Ext.raise(`unexpected value for "action", expected any of "${b}", but got "${c}"`)}if(Ext.isObject(a)){if(Ext.isArray(a.data)){let f=a.data,e,g=f.length,d;for(e=0;e<g;e++){d=f[e];d.localId=b.createFor(d.mailAccountId,d.mailFolderId,d.id).toLocalId()}return a}else if(Ext.isObject(a.data)){a.data.localId=b.createFor(a.data.mailAccountId,a.data.mailFolderId,a.data.id).toLocalId();return a}}if(Ext.isObject(a)&&a.success===!1){return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})}});Ext.define("conjoon.cn_mail.data.mail.message.proxy.UtilityMixin",{purgeFilter:function(b,f){let c=Ext.decode(b.filter),e={},d=[];for(let a=0,g=c.length;a<g;a++){if(f.indexOf(c[a].property)===-1){d.push(c[a])}else {e[c[a].property]=c[a].value}}b=Ext.apply(b,e);if(!d.length){delete b.filter}else {b.filter=Ext.encode(d)}}});Ext.define("conjoon.cn_mail.data.mail.message.proxy.MessageEntityProxy",{extend:"Ext.data.proxy.Rest",requires:["l8","conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader","conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"],mixins:{utilityMixin:"conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"},alias:"proxy.cn_mail-mailmessageentityproxy",reader:{type:"cn_mail-mailmessageentityjsonreader"},idParam:"localId",appendId:!1,validEntityNames:["MessageDraft","MessageItem","MessageBody"],entityName:null,assembleUrl:function(b){if(b.getRecords()&&b.getRecords().length>1){Ext.raise({msg:"Doesn't support batch operations with multiple records.",request:b})}const c=this,d=b.getParams()||{};if(c.validEntityNames.indexOf(c.entityName)===-1){Ext.raise({msg:"The entityName (\""+c.entityName+"\") is not allowed to be used with the url builder of this proxy.",entityName:c.entityName})}let g=c.getUrl(b),f=b.getAction(),e=b.getRecords()?b.getRecords()[0]:null,a;if(!g.match(c.slashRe)){g+="/"}if(f==="read"){a=d;if(a.filter){c.purgeFilter(d,["mailAccountId","mailFolderId"])}else if(e&&!a.id){a.id=e.data.id}}else if(e.phantom){a=e.data}else {a=Ext.applyIf(Ext.apply({},e.modified),e.data)}if(!a.mailAccountId||!a.mailFolderId){Ext.raise({msg:"Missing compound keys.",source:a})}g+="MailAccounts/"+encodeURIComponent(a.mailAccountId)+"/"+"MailFolders/"+encodeURIComponent(a.mailFolderId)+"/"+"MessageItems";let h=c.entityName,i;if((f==="create"||f==="update")&&h==="MessageBody"){h="MessageBodyDraft"}i={target:h};if(h==="MessageItem"&&f==="update"&&a.mailFolderId!==e.get("mailFolderId")){i.action="move"}b.setParams(Ext.apply(b.getParams()||{},i));if(f!=="create"){if(Object.prototype.hasOwnProperty.call(a,"id")){g+="/"+a.id}}if(d){delete d.mailFolderId;delete d.mailAccountId;delete d.id;delete d.localId}return g},buildUrl:function(a){const b=this,c=b.assembleUrl(a);a.setUrl(c);return b.callParent([a])},getDefaultParameters(b){const a={ListMessageItem:{target:"MessageItem",options:JSON.stringify({previewText:{plain:{precedence:!0,length:200},html:{length:200}}}),limit:-1}};return l8.unchain(b,a,{})}});Ext.define("conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey",{extend:"conjoon.cn_mail.data.mail.message.CompoundKey",statics:{fromRecord:function(a){if(!(a instanceof Ext.data.Model)){Ext.raise({msg:"\"rec\" must be an instance of Ext.data.Model",rec:a})}return new this({mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId"),parentMessageItemId:a.get("parentMessageItemId"),id:a.get("id")})},createFor:function(b,c,a,d){return new this({mailAccountId:b,mailFolderId:c,parentMessageItemId:a,id:d})}},config:{parentMessageItemId:undefined},constructor:function(a){const b=this;if(!a||!a.parentMessageItemId){Ext.raise({msg:"\"cfg\" must be an object containing the property parentMessageItemId",cfg:a})}b.callParent(arguments)},toArray:function(){const b=this;let a=b.callParent(arguments);a.splice(2,0,b.getParentMessageItemId());return a},toObject:function(){const b=this;let a=b.callParent(arguments);a.parentMessageItemId=b.getParentMessageItemId();return a},toLocalId:function(){const a=this;return a.getMailAccountId()+"-"+a.getMailFolderId()+"-"+a.getParentMessageItemId()+"-"+a.getId()},applyParentMessageItemId:function(b){const a=this;if(a.getParentMessageItemId()!==undefined){Ext.raise({msg:"\"parentMessageItemId\" was already set",parentMessageItemId:a.getParentMessageItemId()})}return b}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageItemChildJsonReader",{extend:"conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey"],alias:"reader.cn_mail-mailmessageitemchildjsonreader",applyCompoundKey:function(a,b){const f=conjoon.cn_mail.data.mail.message.compoundKey,d=f.MessageEntityCompoundKey,c=f.MessageItemChildCompoundKey,e=["create","update","read","destroy"];if(e.indexOf(b)===-1){let c=e.join(", ");Ext.raise(`unexpected value for "action", expected any of "${c}", but got "${b}"`)}if(Ext.isObject(a)){if(Ext.isArray(a.data)){let g=a.data,h=g.length,e,f;for(f=0;f<h;f++){e=g[f];e.localId=c.createFor(e.mailAccountId,e.mailFolderId,e.parentMessageItemId,e.id).toLocalId();if(b==="read"){e.messageItemId=d.createFor(e.mailAccountId,e.mailFolderId,e.parentMessageItemId).toLocalId()}}return a}else if(Ext.isObject(a.data)){let e=a.data;e.localId=c.createFor(e.mailAccountId,e.mailFolderId,e.parentMessageItemId,e.id).toLocalId();if(b==="read"){e.messageItemId=d.createFor(e.mailAccountId,e.mailFolderId,e.parentMessageItemId).toLocalId()}return a}}if(Ext.isObject(a)&&(a.success===!1||a.success===!0)){return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})}});Ext.define("conjoon.cn_mail.data.mail.message.writer.AttachmentWriter",{extend:"coon.core.data.writer.FormData",alias:"writer.cn_mail-mailmessageattachmentwriter",writeRecords(e,j){const i=this,b=i.callParent(arguments);if(!(b instanceof coon.core.data.FormDataRequest)){return b}const g=b.getFormData(),a=[];for(let f of g.entries()){let g=f[0],d=f[1];const c=/(.*)\[(\d*)\]\[(.*)\]/gmi,h=["","type","index","keyName"];let b;while((b=c.exec(g))!==null){if(b.index===c.lastIndex){c.lastIndex++}let f={};b.forEach((b,a)=>{f[h[a]]=b});if(!a[f.index]){a[f.index]={}}switch(f.type){case "file":{a[f.index]["blob"]=d};break;case "data":{a[f.index][f.keyName]=d};break;}}}const d=new FormData();a.forEach((b,c)=>{const a=Object.entries(b);a.forEach(a=>{const g=a[0],f=a[1];d.set(`files[${c}][${g}]`,f)})});e.setFormData(d);return e}});Ext.define("conjoon.cn_mail.data.mail.message.proxy.AttachmentProxy",{extend:"coon.core.data.proxy.RestForm",requires:["conjoon.cn_mail.data.mail.message.reader.MessageItemChildJsonReader","conjoon.cn_mail.data.mail.message.writer.AttachmentWriter","conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"],mixins:{utilityMixin:"conjoon.cn_mail.data.mail.message.proxy.UtilityMixin"},alias:"proxy.cn_mail-mailmessageattachmentproxy",writer:{type:"cn_mail-mailmessageattachmentwriter"},reader:{type:"cn_mail-mailmessageitemchildjsonreader"},idParam:"localId",appendId:!1,entityName:null,validEntityNames:["DraftAttachment","ItemAttachment"],buildUrl:function(b){if(b.getRecords()&&b.getRecords().length>1){Ext.raise({msg:"Doesn't support batch operations with multiple records.",request:b})}const c=this,d=b.getParams();if(c.validEntityNames.indexOf(c.entityName)===-1){Ext.raise({msg:"The entityName (\""+c.entityName+"\") is not allowed to be used with the url builder of this proxy.",entityName:c.entityName})}let f=c.getUrl(b),g=b.getAction(),e=b.getRecords()?b.getRecords()[0]:null,a;if(c.entityName!=="DraftAttachment"&&["create","update","destroy"].indexOf(g)!==-1){Ext.raise({msg:"Unexpected entityName with specified action",entityName:c.entityName,action:g})}if(!f.match(c.slashRe)){f+="/"}if(g==="read"){a=d;if(a.filter){c.purgeFilter(d,["mailAccountId","mailFolderId","parentMessageItemId"])}else if(e&&!a.id){a.id=e.data.id}}else if(e.phantom){a=e.data}else {a=Ext.applyIf(Ext.apply({},e.modified),e.data)}if(!a.mailAccountId||!a.mailFolderId||!a.parentMessageItemId){Ext.raise({msg:"Missing compound keys.",source:a})}f+="MailAccounts/"+encodeURIComponent(a.mailAccountId)+"/"+"MailFolders/"+encodeURIComponent(a.mailFolderId)+"/"+"MessageItems/"+encodeURIComponent(a.parentMessageItemId)+"/"+"Attachments";if(c.entityName==="DraftAttachment"){b.setParams(Ext.apply(b.getParams()||{},{type:"draft"}))}if(g!=="create"){if(Object.prototype.hasOwnProperty.call(a,"id")){f+="/"+a.id}}if(d){delete d.mailFolderId;delete d.mailAccountId;delete d.parentMessageItemId;delete d.id;delete d.localId}b.setUrl(f);return c.callParent([b])}});Ext.define("conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey",{extend:"conjoon.cn_mail.data.mail.AbstractCompoundKey"});Ext.define("conjoon.cn_mail.data.mail.folder.reader.MailFolderJsonReader",{extend:"Ext.data.reader.Json",requires:["conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey"],alias:"reader.cn_mail-mailfolderjsonreader",mailFolderModelClass:"conjoon.cn_mail.model.mail.folder.MailFolder",readRecords:function(a,d,c){const b=this;a=b.applyCompoundKey(a);return b.callParent([a,d,c])},applyCompoundKey:function(a){const b=this;if(Ext.isObject(a)){if(a.success!==!1){b.recurseChildren([].concat(a.data))}return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})},recurseChildren:function(b){if(!Ext.isArray(b)){return}const d=this,e=conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey;let a;for(let c=0,f=b.length;c<f;c++){a=b[c];if(!a||!a.mailAccountId||!a.id){Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:b})}a.modelType=d.mailFolderModelClass;a.localId=e.createFor(a.mailAccountId,a.id).toLocalId();d.recurseChildren(a.data)}}});Ext.define("conjoon.cn_mail.data.mail.folder.MailFolderTypes",{statics:{INBOX:"INBOX",JUNK:"JUNK",TRASH:"TRASH",SENT:"SENT",FOLDER:"FOLDER",DRAFT:"DRAFT",ACCOUNT:"ACCOUNT"}});Ext.define("conjoon.cn_mail.data.mail.account.reader.MailAccountJsonReader",{extend:"Ext.data.reader.Json",requires:["conjoon.cn_mail.data.mail.folder.reader.MailFolderJsonReader","conjoon.cn_mail.data.mail.folder.MailFolderTypes"],alias:"reader.cn_mail-mailaccountjsonreader",rootProperty:"data",typeProperty:"modelType",mailAccountModelClass:"conjoon.cn_mail.model.mail.account.MailAccount",readRecords:function(a,d,c){const b=this;a=b.processHybridData(a);return b.callParent([a,d,c])},applyModelTypes:function(a){const b=this,c=conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT,d=b.getTypeProperty();if(Ext.isObject(a)){if(Ext.isArray(a.data)){let g=a.data,e,h=g.length,f;for(e=0;e<h;e++){f=g[e];f.folderType=c;f[d]=b.mailAccountModelClass}return a}else if(Ext.isObject(a.data)){let d=a.data;d.folderType=c;d[b.getTypeProperty()]=b.mailAccountModelClass;return a}}if(Ext.isObject(a)&&a.success===!1){return a}Ext.raise({msg:"The \"data\" property was malformed and could not be processed by this Reader",data:a})},processHybridData:function(a){const b=this;if(b.peekFolder(a)){if(!b.mailFolderReader){b.mailFolderReader=Ext.create("conjoon.cn_mail.data.mail.folder.reader.MailFolderJsonReader")}a=b.mailFolderReader.applyCompoundKey(a)}else {a=b.applyModelTypes(a)}return a},peekFolder:function(a){if(Ext.isObject(a)){let b=[].concat(a.data);if(b[0]&&Object.prototype.hasOwnProperty.call(b[0],"mailAccountId")){return !0}}return !1}});Ext.define("conjoon.cn_mail.data.mail.account.proxy.MailAccountProxy",{extend:"Ext.data.proxy.Rest",requires:["conjoon.cn_mail.data.mail.account.reader.MailAccountJsonReader"],alias:"proxy.cn_mail-mailaccountproxy",reader:{type:"cn_mail-mailaccountjsonreader"},idParam:"id",appendId:!1,entityName:"MailAccount",buildUrl:function(a){if(a.getRecords()&&a.getRecords().length>1){Ext.raise({msg:"Doesn't support batch operations with multiple records.",request:a})}const e=this,d=a.getAction();let b=e.getUrl(a),f=a.getRecords()?a.getRecords()[0]:null,c=a.getParams();if(!b.match(e.slashRe)){b+="/"}if(d!=="read"&&d!=="update"){Ext.raise("Unexpected error; any action other but \"read\" and \"update\" not supported.")}b+="MailAccounts";if(d==="read"){if(c.mailAccountId&&c.mailAccountId!=="root"){b+="/"+c.mailAccountId+"/MailFolders"}}else {b+="/"+f.getId()}if(c){delete c.mailAccountId}a.setUrl(b);return e.callParent([a])}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageItemJsonReader",{extend:"conjoon.cn_mail.data.mail.message.reader.MessageEntityJsonReader",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"reader.cn_mail-mailmessageitemjsonreader",foreignKeyProp:"messageBodyId",applyCompoundKey:function(a,d){const b=this,c=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey;a=b.callParent(arguments);if(Ext.isObject(a)){if(Ext.isArray(a.data)){let g=a.data,h=g.length,e,f;for(f=0;f<h;f++){e=g[f];if(d==="read"){e[b.foreignKeyProp]=c.createFor(e.mailAccountId,e.mailFolderId,e.id).toLocalId()}}return a}else if(Ext.isObject(a.data)){if(d==="read"){a.data[b.foreignKeyProp]=c.createFor(a.data.mailAccountId,a.data.mailFolderId,a.data.id).toLocalId()}return a}}if(Ext.isObject(a)&&a.success===!1){return a}}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageBodyJsonReader",{extend:"conjoon.cn_mail.data.mail.message.reader.MessageItemJsonReader",alias:"reader.cn_mail-mailmessagebodyjsonreader",foreignKeyProp:"messageDraftId"});Ext.define("conjoon.cn_mail.data.mail.BaseSchema",{extend:"coon.core.data.schema.BaseSchema",requires:["l8","conjoon.cn_mail.data.mail.message.proxy.MessageEntityProxy","conjoon.cn_mail.data.mail.message.proxy.AttachmentProxy","conjoon.cn_mail.data.mail.account.proxy.MailAccountProxy","conjoon.cn_mail.data.mail.message.reader.MessageItemJsonReader","conjoon.cn_mail.data.mail.message.reader.MessageBodyJsonReader"],alias:"schema.cn_mail-mailbaseschema",namespace:"conjoon.cn_mail.model.mail",id:"cn_mail-baseschema",urlPrefix:"cn_mail",proxy:{type:"rest",url:"{prefix}"},applyUrlPrefix(a){return l8.isString(a)?l8.unify(a,"/","://"):undefined},privates:{constructProxy:function(f){const e=this;let a=e.callParent(arguments),d=Ext.Object.chain(f),b=d.entityName,c=e.getUrlPrefix();if(["MessageItem","MessageDraft","MessageBody"].indexOf(b)!==-1){a.entityName=b;a.prefix=c;a.type="cn_mail-mailmessageentityproxy";if(b!=="MessageBody"){a.reader="cn_mail-mailmessageitemjsonreader"}else {a.reader="cn_mail-mailmessagebodyjsonreader"}}else if(["DraftAttachment","ItemAttachment"].indexOf(b)!==-1){a.entityName=b;a.prefix=c;a.type="cn_mail-mailmessageattachmentproxy"}else if(["MailAccount"].indexOf(b)!==-1){a.prefix=c;a.type="cn_mail-mailaccountproxy"}else {a.url=l8.unify(c+"/"+d.entityName,"/","://")}return a}}});Ext.define("conjoon.cn_mail.model.mail.BaseModel",{extend:"coon.core.data.BaseModel",idProperty:"__id__",requires:["conjoon.cn_mail.data.mail.BaseSchema"],schema:"cn_mail-mailbaseschema",constructor:function(){const a=this;if(a.idProperty==="__id__"){Ext.raise({msg:"\"idProperty\" of coon.core.data.BaseModel needs to be explicitly set",idProperty:a.idProperty})}a.callParent(arguments)}});Ext.define("conjoon.cn_mail.model.mail.AbstractCompoundKeyedModel",{requires:["conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator"],extend:"conjoon.cn_mail.model.mail.BaseModel"},function(){conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator.decorate(this)});Ext.define("conjoon.cn_mail.model.mail.message.CompoundKeyedModel",{extend:"conjoon.cn_mail.model.mail.AbstractCompoundKeyedModel",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],fields:[{name:"mailFolderId",type:"cn_core-datafieldcompoundkey"}],compoundKeyFields:["mailAccountId","mailFolderId","id"],foreignKeyFields:["mailAccountId","mailFolderId","id"],getRepresentingCompoundKeyClass:function(){return conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey}});Ext.define("conjoon.cn_mail.model.mail.message.MessageBody",{extend:"conjoon.cn_mail.model.mail.message.CompoundKeyedModel",requires:["coon.core.data.field.CompoundKeyField"],entityName:"MessageBody",fields:[{name:"textPlain",type:"string"},{name:"textHtml",type:"string"},{persist:!1,name:"messageDraftId",type:"string",reference:{parent:"MessageDraft"},unique:!0,validators:"presence"}],getAssociatedCompoundKeyedData:function(){const a=this;let b=a.getMessageDraft&&a.getMessageDraft()?[a.getMessageDraft()]:[];b=b.concat(a.getMessageItem&&a.getMessageItem()?[a.getMessageItem()]:[]);return b},load:function(a){const c=this,b=c.getAssociatedCompoundKeyedData();a=a||{};a.params=a.params||{};if(b&&b.length===1&&b[0].entityName==="MessageDraft"){Ext.applyIf(a.params,b[0].getCompoundKey().toObject())}return c.callParent([a])}});Ext.define("conjoon.cn_mail.model.mail.message.AbstractMessageItem",{extend:"conjoon.cn_mail.model.mail.message.CompoundKeyedModel",requires:["conjoon.cn_mail.model.mail.message.MessageBody","coon.core.data.field.EmailAddress"],fields:[{name:"subject",type:"string"},{name:"date",type:"date",dateReadFormat:"Y-m-d H:i:s O"},{name:"from",type:"cn_core-datafieldemailaddress"},{persist:!1,name:"messageBodyId",type:"string",reference:{child:"MessageBody"},unique:!0,validators:"presence"},{name:"seen",type:"bool"},{name:"answered",type:"bool"},{name:"flagged",type:"bool"},{name:"draft",type:"bool"},{name:"recent",type:"bool",persist:!1}],loadAttachments:function(b){const a=this;a.attachments().clearFilter(!0);a.attachments().addFilter([{property:"mailAccountId",value:a.get("mailAccountId")},{property:"mailFolderId",value:a.get("mailFolderId")},{property:"parentMessageItemId",value:a.get("id")}],!0);return a.attachments().load(b)},loadMessageBody:function(b){const a=this;b=b||{};b.params=b.params||{};if(!a.get("mailFolderId")||!a.get("mailAccountId")||!a.get("id")){Ext.raise({msg:"Cannot load MessageBody, compound keys missing",data:a.data})}Ext.applyIf(b.params,{mailFolderId:a.get("mailFolderId"),mailAccountId:a.get("mailAccountId"),id:a.get("id")});return a.getMessageBody(b)},getAssociatedCompoundKeyedData:function(){const a=this;let b=a._messageBody?[a._messageBody]:[];return b.concat(a.attachments().getRange())},privates:{onAssociatedRecordSet:function(b,c){const a=this;a.processRecordAssociation(b);return a.callParent(arguments)}},processRecordAssociation:function(a){const b=this;if(a.entityName==="MessageBody"){b.compareAndApplyCompoundKeys(a,!0)}}});Ext.define("conjoon.cn_mail.model.mail.message.MessageItemChildModel",{extend:"conjoon.cn_mail.model.mail.message.CompoundKeyedModel",requires:["conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey"],fields:[{name:"parentMessageItemId",type:"cn_core-datafieldcompoundkey"}],foreignKeyFields:["mailAccountId","mailFolderId","parentMessageItemId","id"],getRepresentingCompoundKeyClass:function(){return conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey}});Ext.define("conjoon.cn_mail.model.mail.message.AbstractAttachment",{extend:"conjoon.cn_mail.model.mail.message.MessageItemChildModel",requires:["coon.core.data.field.FileSize","coon.core.data.field.CompoundKeyField"],fields:[{name:"type",type:"string"},{name:"text",type:"string"},{name:"size",type:"int",persist:!1},{name:"previewImgSrc",type:"string",persist:!1},{name:"downloadUrl",type:"string",persist:!1}]});Ext.define("conjoon.cn_mail.store.mail.message.MessageAttachmentStore",{extend:"Ext.data.Store",alias:"store.cn_mail-mailmessageattachmentstore",load:function(){const a=this;a.checkAndBuildCompoundKeyFilters();return a.callParent(arguments)},add:function(a){const c=this;if(Ext.isArray(a)){let d=[];for(let b=0,e=a.length;b<e;b++){d.push(c.add(a[b]))}return d}const d=[].concat(a);if((a instanceof Ext.data.Model)&&this.findExact("localId",a.getId())>-1){return a}const e=c.callParent(arguments);let b=c.getAssociatedEntity();if(b&&b.entityName==="MessageDraft"){for(let c=0,e=d.length;c<e;c++){b.processRecordAssociation(d[c])}}return e},checkAndBuildCompoundKeyFilters:function(){const c=this,i=c.getFilters(),d={mailFolderId:!1,mailAccountId:!1,parentMessageItemId:!1},b=c.getAssociatedEntity()&&c.getAssociatedEntity().entityName==="MessageDraft"?c.getAssociatedEntity():null;let e,a,h,f;for(a in d){for(let g=i.length-1;g>=0;g--){e=i.getAt(g);h=e.getProperty();if(h===a){delete d[a];if(!b&&!e.getValue()){Ext.raise({msg:"no valid value set for filter \""+a+"\"",mailFolderId:e.getValue()})}if(b){f=a==="parentMessageItemId"?b.get("id"):b.get(a);e.setValue(f)}}else if(h==="messageItemId"){c.removeFilter(i.getAt(g),!0)}}}let g=[];for(a in d){if(d[a]===!1){g.push(a)}}if(g.length){if(b){for(let a in d){f=a==="parentMessageItemId"?b.get("id"):b.get(a);c.addFilter({property:a,value:f},!0)}}else {Ext.raise({msg:"filters for properties \"["+g.join(", ")+"]\" not set"})}}return !0}});Ext.define("conjoon.cn_mail.model.mail.message.ItemAttachment",{extend:"conjoon.cn_mail.model.mail.message.AbstractAttachment",requires:["conjoon.cn_mail.store.mail.message.MessageAttachmentStore"],entityName:"ItemAttachment",fields:[{name:"messageItemId",type:"string",reference:{type:"MessageItem",inverse:{role:"attachments",storeConfig:{type:"cn_mail-mailmessageattachmentstore"}}}}]});Ext.define("conjoon.cn_mail.model.mail.message.MessageItem",{extend:"conjoon.cn_mail.model.mail.message.AbstractMessageItem",requires:["l8","conjoon.cn_mail.model.mail.message.ItemAttachment","coon.core.data.field.EmailAddressCollection","coon.core.data.field.FileSize"],entityName:"MessageItem",fields:[{name:"hasAttachments",type:"bool"},{name:"to",type:"cn_core-datafieldemailaddresscollection"},{name:"previewText",type:"string",persist:!1,convert:function(a,b){return a===undefined?undefined:(l8.isNumber(a)||l8.isString(a)?""+a:"")}},{name:"size",type:"int",persist:!1},{name:"cn_deleted",type:"bool",persist:!1},{name:"cn_moved",type:"bool",persist:!1}]});Ext.define("conjoon.cn_mail.store.mail.message.MessageItemStore",{extend:"Ext.data.BufferedStore",requires:["conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"store.cn_mail-mailmessageitemstore",model:"conjoon.cn_mail.model.mail.message.MessageItem",remoteSort:!0,remoteFilter:!0,pageSize:50,autoLoad:!1,sorters:[{property:"date",direction:"DESC"}],applySorters:function(a){var b=this;if(a&&a.length!==0&&((b.getSorters(!1)&&b.getSorters(!1).length!==0)||a.length!==1)){Ext.raise({sorters:a,msg:"Only one sorter allowed for MessageItem store"})}return b.callParent(arguments)},findByCompoundKey:function(a){if(!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:a})}const b=this;return b.findExact("localId",a.toLocalId())},afterEdit:function(c,a){if(!a||(a.indexOf("cn_moved")===-1&&a.indexOf("cn_deleted")===-1&&a.indexOf("recent")===-1&&a.indexOf("previewText")===-1&&a.indexOf("answered")===-1)){return}const b=this;if(b.contains(c)){b.fireEvent("update",b,c,"edit",a)}}});Ext.define("conjoon.cn_mail.view.mail.inbox.InboxViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.store.mail.message.MessageItemStore"],alias:"viewmodel.cn_mail-mailinboxviewmodel",stores:{"cn_mail_mailmessageitemstore":{type:"cn_mail-mailmessageitemstore",autoLoad:!0,listeners:{beforeload:function(c){let b=c.getFilters();for(let a=0,d=b.length;a<d;a++){if(b.getAt(a).getDisabled()===!0){return !1}}}},filters:[{disabled:"{cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\"}",property:"mailFolderId",value:"{cn_mail_ref_mailfoldertree.selection.id}"},{disabled:"{cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\"}",property:"mailAccountId",value:"{cn_mail_ref_mailfoldertree.selection.mailAccountId}"}]}},data:{messageViewHidden:!1},formulas:{computeMessageGridMargin:function(a){const f=this,d=a("cn_mail_ref_mailfoldertree.selection.folderType"),c=f.getView().down("cn_mail-mailmessagereadermessageview"),b=c.splitter.orientation;let e=d==="ACCOUNT"?"0 0 0 0":a("messageViewHidden")?"0 5 5 0":b==="vertical"?"0 0 5 0":"0 5 0 0";return e}},updateUnreadMessageCount:function(b,c,d){var f=this,e=f.get("cn_mail_mailfoldertreestore"),a;a=e.getRoot().findChild("id",b,!1);if(!a){return}a=a.findChild("id",c,!0);if(!a){return}a.set("unreadCount",a.get("unreadCount")+d)}});Ext.define("conjoon.cn_mail.data.mail.service.mailbox.Operation",{statics:{MOVE_OR_DELETE:1,DELETE:2,MOVE:3,NOOP:4,CANCELED:5,INVALID_TARGET:6},config:{request:undefined,result:undefined},constructor:function(a){a=a||{};const b=this;if(!a.request){Ext.raise({msg:"'request' must be set",request:a.request})}b.initConfig(a)},applyResult:function(b){const a=this;if(a.getResult()!==undefined){Ext.raise({msg:"'result' was already set",result:a.getResult()})}return b},applyRequest:function(b){const a=this;if(a.getRequest()!==undefined){Ext.raise({msg:"'request' was already set",request:a.getRequest()})}return b}});Ext.define("conjoon.cn_mail.model.mail.BaseTreeModel",{extend:"coon.core.data.BaseTreeModel",idProperty:"__id__",requires:["conjoon.cn_mail.data.mail.BaseSchema"],schema:"cn_mail-mailbaseschema",constructor:function(){const a=this;if(a.idProperty==="__id__"){Ext.raise({msg:"\"idProperty\" of coon.core.data.BaseTreeModel needs to be explicitly set",idProperty:a.idProperty})}a.callParent(arguments)}});Ext.define("conjoon.cn_mail.model.mail.AbstractCompoundKeyedTreeModel",{requires:["conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator"],extend:"conjoon.cn_mail.model.mail.BaseTreeModel"},function(){conjoon.cn_mail.model.mail.CompoundKeyedModelDecorator.decorate(this)});Ext.define("conjoon.cn_mail.model.mail.folder.MailFolder",{extend:"conjoon.cn_mail.model.mail.AbstractCompoundKeyedTreeModel",requires:["conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey"],entityName:"MailFolder",fields:[{name:"name",type:"string",validators:[{type:"presence"}]},{name:"unreadCount",type:"int",persist:!1},{name:"folderType",type:"string"}],foreignKeyFields:["mailAccountId","id"],getRepresentingCompoundKeyClass:function(){return conjoon.cn_mail.data.mail.folder.compoundKey.MailFolderCompoundKey},constructor:function(){const a=this;a.callParent(arguments);a.getField("folderType").setModelValidators([{type:"inclusion",list:[conjoon.cn_mail.data.mail.folder.MailFolderTypes.INBOX,conjoon.cn_mail.data.mail.folder.MailFolderTypes.JUNK,conjoon.cn_mail.data.mail.folder.MailFolderTypes.TRASH,conjoon.cn_mail.data.mail.folder.MailFolderTypes.SENT,conjoon.cn_mail.data.mail.folder.MailFolderTypes.FOLDER,conjoon.cn_mail.data.mail.folder.MailFolderTypes.DRAFT]}])},toUrl:function(){const a=this,b="cn_mail/folder/";return b+a.get("mailAccountId")+"/"+a.get("id")}});Ext.define("conjoon.cn_mail.model.mail.account.MailAccount",{extend:"conjoon.cn_mail.model.mail.BaseTreeModel",entityName:"MailAccount",idProperty:"id",requires:["conjoon.cn_mail.data.mail.folder.MailFolderTypes","coon.core.data.field.EmailAddress"],fields:[{name:"name",type:"string",validators:[{type:"presence"}]},{name:"folderType",type:"string"},{name:"from",type:"cn_core-datafieldemailaddress"},{name:"replyTo",type:"cn_core-datafieldemailaddress"},{name:"inbox_type",type:"string"},{name:"inbox_address",type:"string"},{name:"inbox_port",type:"string"},{name:"inbox_user",type:"string"},{name:"inbox_password",type:"string"},{name:"inbox_ssl",type:"boolean"},{name:"outbox_address",type:"string"},{name:"outbox_port",type:"string"},{name:"outbox_user",type:"string"},{name:"outbox_password",type:"string"},{name:"outbox_ssl",type:"boolean"}],constructor:function(){const a=this;a.callParent(arguments);a.getField("folderType").setModelValidators([{type:"inclusion",list:[conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT]}])},toUrl:function(){const b=this,a="cn_mail/account/";return a+b.get("id")}});Ext.define("conjoon.cn_mail.store.mail.folder.MailFolderTreeStore",{extend:"Ext.data.TreeStore",requires:["conjoon.cn_mail.model.mail.folder.MailFolder","conjoon.cn_mail.model.mail.account.MailAccount"],alias:"store.cn_mail-mailfoldertreestore",model:"conjoon.cn_mail.model.mail.account.MailAccount",autoLoad:!1,nodeParam:"mailAccountId",storeId:"cn_mail-mailfoldertreestore",statics:{getInstance(){let a=Ext.StoreManager.get("cn_mail-mailfoldertreestore");if(!a){a=Ext.create("conjoon.cn_mail.store.mail.folder.MailFolderTreeStore")}return Ext.StoreManager.get("cn_mail-mailfoldertreestore")}},root:{expanded:!0,data:[]},constructor:function(){const a=this;a.callParent(arguments);let b=a.getRoot();b.on("append",a.onRootNodeAppend,a)},onRootNodeAppend:function(a,b){const e=this,d=e.getRoot(),c=function(){b.expand(!1,function(){b.collapse();b.expand()})};if(a!==d){return}switch(a.isExpanded()){case !0:a.expand(!1,c);break;default:c();}}});Ext.define("conjoon.cn_mail.data.mail.service.MailFolderHelper",{alternateClassName:["conjoon.cn_mail.MailFolderHelper"],requires:["conjoon.cn_mail.store.mail.folder.MailFolderTreeStore","conjoon.cn_mail.data.mail.folder.MailFolderTypes"],config:{store:null},statics:{getInstance(){let a=this.__inst;if(!a){a=Ext.create(this,{store:conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance()});this.__inst=a}return a}},constructor:function(a){a=a||{};const b=this;b.initConfig(a)},applyStore(a){if(!a||!(a instanceof conjoon.cn_mail.store.mail.folder.MailFolderTreeStore)){Ext.raise({msg:"'store' must be an instance of conjoon.cn_mail.store.mail.folder.MailFolderTreeStore",store:a})}return a},getMailFolder:function(b,c){const d=this,a=d.getAccountNode(b);if(!a){return null}return a.findChild("id",c,!0)},getMailFolderIdForType:function(c,d){const e=this,a=e.getAccountNode(c);if(!a){return null}let b=a.findChild("folderType",d,!1);if(!b){return null}return b.get("id")},getAccountNode:function(c){const d=this,b=d.getStore(),a=b.findBy(function(a){if(a.get("id")===c&&a.get("folderType")===conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT){return !0}});if(a===-1){return null}return b.getAt(a)},doesFolderBelongToAccount:function(b,a){const c=this;if(c.getMailFolder(a,b)){return !0}return !1}});Ext.define("conjoon.cn_mail.data.mail.service.MailboxService",{alternateClassName:["conjoon.cn_mail.MailboxService"],requires:["conjoon.cn_mail.model.mail.message.AbstractMessageItem","conjoon.cn_mail.data.mail.service.mailbox.Operation","conjoon.cn_mail.data.mail.service.MailFolderHelper"],statics:{recentMessageItemKeys:new Set(),getInstance(){let a=this.__inst;if(!a){a=Ext.create(this,{mailFolderHelper:conjoon.cn_mail.MailFolderHelper.getInstance()});this.__inst=a}return a}},constructor:function(a){a=a||{};const b=this;if(!a.mailFolderHelper||!(a.mailFolderHelper instanceof conjoon.cn_mail.data.mail.service.MailFolderHelper)){Ext.raise({msg:"'mailFolderHelper' must be an instance of conjoon.cn_mail.data.mail.service.MailFolderHelper",mailFolderHelper:a.mailFolderHelper})}b.initConfig(a)},moveToTrashOrDeleteMessage:function(a,b){const c=this;a=c.filterMessageItemValue(a);const f=c.getMailFolderHelper(),d=f.getMailFolderIdForType(a.get("mailAccountId"),conjoon.cn_mail.data.mail.folder.MailFolderTypes.TRASH);if(d===null){let d=c.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.MOVE_OR_DELETE,record:a},{success:!1,reason:"Could not find TRASH folder."});if(b&&b.failure){b.failure.apply(b.scope,[d])}return d}let e=a.get("mailFolderId");if(a.phantom===!0||d===e){return c.deleteMessage(a,b)}return c.moveMessage(a,d,b)},deleteMessage:function(b,d){const c=this;b=c.filterMessageItemValue(b);let a=c.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.DELETE,record:b});if(c.callBefore(a,d)===!1){a.setResult({success:!1,code:conjoon.cn_mail.data.mail.service.mailbox.Operation.CANCELED});return a}b.erase(c.configureOperationCallbacks(a,d));return a},moveMessage:function(a,c,d){const e=this,f=e.getMailFolderHelper();let b;a=e.filterMessageItemValue(a);if(!Ext.isString(c)){Ext.raise({msg:"'mailFolderId' must be a string",mailFolderId:c})}if(a.get("mailFolderId")===c){b=e.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.NOOP,record:a},{success:!0});if(d&&d.success){d.success.apply(d.scope,[b])}return b}b=e.createOperation({type:conjoon.cn_mail.data.mail.service.mailbox.Operation.MOVE,record:a,sourceFolderId:a.get("mailFolderId"),targetFolderId:c});if(!f.doesFolderBelongToAccount(c,a.get("mailAccountId"))){b.setResult({success:!1,code:conjoon.cn_mail.data.mail.service.mailbox.Operation.INVALID_TARGET});return b}e.callBefore(b,d);a.set("mailFolderId",c);a.save(e.configureOperationCallbacks(b,d));return b},getMailFolderHelper:function(){const a=this;return a.mailFolderHelper},filterMessageItemValue:function(a){if(!(a instanceof conjoon.cn_mail.model.mail.message.AbstractMessageItem)){Ext.raise({msg:"\"messageItem\" must be an instance of conjoon.cn_mail.model.mail.message.AbstractMessageItem",messageItem:a})}if(!a.get("mailAccountId")){Ext.raise({msg:"\"mailAccountId\" missing in messageItem",messageItem:a})}return a},configureOperationCallbacks:function(a,b){const d=this,c=conjoon.cn_mail.data.mail.service.mailbox.Operation;b=b||{};return {success:function(){a.setResult({success:!0});if(a.getRequest().type===c.MOVE){d.moveCallback(a)}else if(a.getRequest().type===c.DELETE){d.deleteCallback(a)}if(b&&b.success){b.success.apply(b.scope,[a])}},failure:function(){a.setResult({success:!1});if(a.getRequest().type===c.MOVE){d.moveCallback(a)}else if(a.getRequest().type===c.DELETE){d.deleteCallback(a)}if(b&&b.failure){b.failure.apply(b.scope,[a])}},scope:this}},createOperation:function(a,b){let c=a||b?{}:undefined;if(a){c.request=a}if(b){c.result=b}return Ext.create("conjoon.cn_mail.data.mail.service.mailbox.Operation",c)},callBefore:function(b,a){if(a&&a.before){return a.before.apply(a.scope,[b])}},moveCallback:function(g){const j=this,d=g.getRequest(),h=d.sourceFolderId,i=d.targetFolderId,a=d.record,f=a.get("mailAccountId"),e=j.getMailFolderHelper();if(g.getResult().success!==!0){return !1}a.set("messageBodyId",a.getId());if(a.entityName==="MessageDraft"){a.getMessageBody().commit(!0)}if(a.get("seen")){return !0}let b=e.getMailFolder(f,h),c=e.getMailFolder(f,i);if(b){b.set("unreadCount",Math.max(0,b.get("unreadCount")-1),{dirty:!1})}if(c){c.set("unreadCount",c.get("unreadCount")+1,{dirty:!1})}return !0},deleteCallback:function(c){const h=this,g=c.getRequest(),b=g.record,f=b.get("mailFolderId"),e=b.get("mailAccountId"),d=h.getMailFolderHelper();if(c.getResult().success!==!0){return !1}if(b.get("seen")){return}let a=d.getMailFolder(e,f);if(a){a.set("unreadCount",Math.max(0,a.get("unreadCount")-1),{dirty:!1})}return !0}});Ext.define("conjoon.cn_mail.model.mail.message.DraftAttachment",{extend:"conjoon.cn_mail.model.mail.message.AbstractAttachment",requires:["coon.core.data.proxy.RestForm","coon.core.data.field.Blob","conjoon.cn_mail.store.mail.message.MessageAttachmentStore"],entityName:"DraftAttachment",fields:[{persist:!1,name:"messageItemId",type:"string",reference:{parent:"MessageDraft",inverse:{role:"attachments",storeConfig:{type:"cn_mail-mailmessageattachmentstore"}}}},{name:"file",type:"cn_core-datafieldblob"}],compoundKeyFields:{MessageDraft:{"mailAccountId":"mailAccountId","mailFolderId":"mailFolderId","parentMessageItemId":"id"}},getAssociatedCompoundKeyedData:function(){const a=this;return a.getMessageItem&&a.getMessageItem()?[a.getMessageItem()]:[]}});Ext.define("conjoon.cn_mail.model.mail.message.MessageDraft",{extend:"conjoon.cn_mail.model.mail.message.AbstractMessageItem",requires:["coon.core.data.field.EmailAddressCollection","coon.core.data.validator.EmailAddressCollection","conjoon.cn_mail.model.mail.message.DraftAttachment","coon.core.data.field.EmailAddress","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],entityName:"MessageDraft",preBatchCompoundKey:undefined,compoundKeyFields:{MessageBody:["mailAccountId","mailFolderId","id"],DraftAttachment:{"mailAccountId":"mailAccountId","mailFolderId":"mailFolderId","id":"parentMessageItemId"}},fields:[{name:"replyTo",type:"cn_core-datafieldemailaddress"},{name:"to",type:"cn_core-datafieldemailaddresscollection",validators:[{type:"cn_core-datavalidatoremailaddresscollection",allowEmpty:!0}]},{name:"cc",type:"cn_core-datafieldemailaddresscollection",validators:[{type:"cn_core-datavalidatoremailaddresscollection",allowEmpty:!0}]},{name:"bcc",type:"cn_core-datafieldemailaddresscollection",validators:[{type:"cn_core-datavalidatoremailaddresscollection",allowEmpty:!0}]},{name:"draft",type:"bool",defaultValue:!0},{name:"seen",type:"bool",critical:!0,defaultValue:!0},{name:"flagged",type:"bool",critical:!0,defaultValue:!1},{name:"answered",type:"bool",defaultValue:!1},{name:"recent",type:"bool",defaultValue:!1},{name:"messageId",type:"string",persist:!1},{name:"references",type:"string",defaultValue:null},{name:"inReplyTo",type:"string",defaultValue:null},{name:"xCnDraftInfo",type:"string",defaultValue:null},{name:"savedAt",type:"date",persist:!1}],processRecordAssociation:function(a){const b=this;b.callParent(arguments);if(a.entityName==="DraftAttachment"){b.compareAndApplyCompoundKeys(a,!1)}},storePreBatchCompoundKey:function(){const b=this;let a=undefined;if(b.isCompoundKeyConfigured()){a=b.getCompoundKey();b.preBatchCompoundKey=a}return a},getPreBatchCompoundKey:function(){const a=this;return a.preBatchCompoundKey},loadMessageBody:function(a){const b=this;a=a||{};a.params=a.params||{};Ext.applyIf(a.params,{target:"MessageBodyDraft"});return b.callParent([a])}});Ext.define("conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater",{singleton:!0,requires:["conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.model.mail.message.MessageDraft"],updateItemWithDraft:function(b,a){var g=this,e=0,c,d;if(!(b instanceof conjoon.cn_mail.model.mail.message.MessageItem)){Ext.raise({msg:"messageItem must be an instance of 'conjoon.cn_mail.model.mail.message.MessageItem'",cls:Ext.getClassName(g),messageItem:b})}if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({msg:"messageDraft must be an instance of 'conjoon.cn_mail.model.mail.message.MessageDraft'",cls:Ext.getClassName(g),messageDraft:a})}c=a.attachments().getRange();d=a.getMessageBody();e+=d.get("textPlain").length;e+=d.get("textHtml").length;for(var f=0,i=c.length;f<i;f++){e+=c[f].get("size")}let h={date:a.get("date"),to:a.get("to"),subject:a.get("subject"),hasAttachments:c.length>0,previewText:d.get("textPlain"),size:e,from:a.get("from"),seen:a.get("seen"),flagged:a.get("flagged"),recent:a.get("recent"),answered:a.get("answered"),draft:a.get("draft"),id:a.get("id"),messageBodyId:a.get("messageBodyId")};b.set(h);b.commit();return b},createItemFromDraft:function(a){const b=this;if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({msg:"messageDraft must be an instance of 'conjoon.cn_mail.model.mail.message.MessageDraft'",cls:Ext.getClassName(b),messageDraft:a})}let c=Ext.create("conjoon.cn_mail.model.mail.message.MessageItem",{localId:a.getId(),id:a.get("id"),mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId"),messageBodyId:a.getMessageBody().getId()});return b.updateItemWithDraft(c,a)}});Ext.define("conjoon.cn_mail.view.mail.inbox.InboxViewController",{extend:"Ext.app.ViewController",alias:"controller.cn_mail-mailinboxviewcontroller",requires:["conjoon.cn_mail.data.mail.service.MailboxService","conjoon.cn_mail.data.mail.service.mailbox.Operation","conjoon.cn_mail.data.mail.service.MailFolderHelper","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater","conjoon.cn_mail.model.mail.message.MessageDraft"],control:{"cn_mail-mailmessagereadermessageview":{"cn_mail-mailmessageitemread":"onMessageItemRead"},"cn_mail-mailmessagereadermessageview #btn-deletedraft":{"click":"onDeleteClick"},"cn_mail-mailmessagereadermessageview #btn-delete":{"click":"onDeleteClick"},"cn_mail-mailfoldertree":{"beforeselect":"onMailFolderTreeBeforeSelect","select":"onMailFolderTreeSelect"},"cn_mail-mailmessagegrid":{"cn_comp-rowflymenu-itemclick":"onRowFlyMenuItemClick","cn_comp-rowflymenu-beforemenushow":"onRowFlyMenuBeforeShow"}},mailboxService:null,messageGrid:null,mailFolderTree:null,onRowFlyMenuBeforeShow:function(c,d,a){const b=this;if(a.get("cn_deleted")||a.get("cn_moved")){return !1}b.getMessageGrid().updateRowFlyMenu(a)},onRowFlyMenuItemClick:function(d,e,c,a){const b=this;switch(c){case "markunread":a.set("seen",!a.get("seen"));a.set("recent",!1);a.save({callback:b.onMessageItemRead,scope:b});break;case "flag":a.set("flagged",!a.get("flagged"));a.set("recent",!1);a.save();break;case "delete":b.moveOrDeleteMessage(a);break;}},onDeleteClick:function(d){const a=this,c=a.getMessageView(),b=c.getViewModel().get("messageItem");a.moveOrDeleteMessage(b)},onMessageItemRead:function(d){var m=this,k=m.getView(),a={},g,b,e,j;d=[].concat(d);for(var h=0,l=d.length;h<l;h++){g=d[h];b=g.get("mailAccountId");e=g.get("mailFolderId");j=g.get("seen");if(!a[b]){a[b]={}}if(!a[b][e]){a[b][e]=0}a[b][e]+=j?-1:1}let c=null;for(var i in a){c=a[i];for(var f in c){if(!Object.prototype.hasOwnProperty.call(c,f)){continue}if(!c[f]){continue}k.getViewModel().updateUnreadMessageCount(i,f,c[f])}}},onMailFolderTreeSelect:function(c,a){const b=this;b.redirectTo(a)},onMailFolderTreeBeforeSelect:function(e,c){const d=this,a=d.getView(),b=a.down("cn_mail-mailaccountview");if(b.hasPendingChanges()){a.showMailAccountIsBeingEditedNotice(c);return !1}return !0},getMailboxService:function(){const a=this;if(!a.mailboxService){a.mailboxService=conjoon.cn_mail.MailboxService.getInstance()}return a.mailboxService},moveOrDeleteMessage:function(d,c=!1,b=null){const a=this;if(!b){b=a.getView()}return a.getMailboxService().moveToTrashOrDeleteMessage(d,{before:Ext.Function.bind(a.onBeforeMessageMoveOrDelete,a,[c,b],!0),success:Ext.Function.bind(a.onMessageMovedOrDeleted,a,[b],!0),failure:a.onMessageMovedOrDeletedFailure,scope:a})},onBeforeMessageMoveOrDelete:function(d,k,e){const b=this,j=b.getView(),a=d.getRequest().record,h=d.getRequest().type,f=conjoon.cn_mail.data.mail.service.mailbox.Operation,m=b.getMessageGrid(),l=a.entityName==="MessageDraft",i=b.getLivegrid().isConfigured();let g,c;switch(h){case f.MOVE:g="cn_moved";break;case f.DELETE:if(j.fireEvent("cn_mail-beforemessageitemdelete",j,a,e)===!1){return !1};if(k!==!0){e.showMessageDeleteConfirmDialog(a,function(b,f){const c=this;if(b==="yesButton"){c.moveOrDeleteMessage(a,!0,e)}},b);return !1};g="cn_deleted";break;default:Ext.raise({msg:"Unexpected operation type for before-callback",type:h});break;}if(i){if(l||a.store!==b.getMessageGrid().getStore()){c=b.getLivegrid().getRecordById(a.getId())}else {c=a}if(c){c.set(g,!0,{dirty:!1})}}d.getRequest().owningStore=a.store;a.unjoin(a.store);if(h===f.DELETE){a.drop(!1)}if(i){m.getSelectionModel().deselect(c);b.getRowFlyMenu().detachMenuAndUnset()}return d},onMessageMovedOrDeletedFailure:function(f){const i=this,c=f.getRequest(),a=c.record,g=c.type,e=conjoon.cn_mail.data.mail.service.mailbox.Operation,b=c.owningStore,h=a.entityName==="MessageDraft";let d;switch(g){case e.MOVE:d="cn_moved";break;case e.DELETE:d="cn_deleted";break;default:Ext.raise({msg:"Unexpected operation type for failure-callback",type:g});break;}a.reject();b&&a.join(b);if(!h&&b===i.getMessageGrid().getStore()){a.set(d,!1,{dirty:!1})}return f},onMessageMovedOrDeleted:function(p,j){const b=this,d=p.getRequest(),q=b.getView(),a=d.record,e=d.type,c=conjoon.cn_mail.data.mail.service.mailbox.Operation,k=b.getMessageGrid(),f=d.owningStore,o=b.getLivegrid().isConfigured(),i=a.entityName==="MessageDraft",n=b.getMailboxService().getMailFolderHelper();let m;switch(e){case c.MOVE:m="cn_moved";break;case c.DELETE:m="cn_deleted";break;default:Ext.raise({msg:"Unexpected operation type for failure-callback",type:e});break;}if(!i&&f===b.getMessageGrid().getStore()){a.set(m,!1,{dirty:!1})}let g=b.getSelectedMailFolder(),h=e===c.MOVE?d.targetFolderId:a.get("mailFolderId"),r=h&&g&&g.get("id")!==h,s=h&&g&&g.get("id")===h;if(a.isCompoundKeyConfigured()&&o&&(r||e===c.DELETE)){let f=null,d;if(e===c.DELETE){f=a.getCompoundKey()}else {f=i?a.getPreviousCompoundKey():a.getCompoundKey()}d=b.getLivegrid().getRecordByCompoundKey(f);if(d){b.getLivegrid().remove(d)}}let l;switch(e){case (c.MOVE):if(o&&s){if(i){let c=conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.createItemFromDraft(a);c.join(k.getStore());b.getLivegrid().add(c)}else {if(f){a.join(f)}else {a.unjoin(k.getStore());a.join(k.getStore())}b.getLivegrid().add(a)}}else if(!i){f&&a.join(f)};l=a.get("mailAccountId");q.fireEvent("cn_mail-messageitemmove",q,a,j,n.getMailFolder(l,d.sourceFolderId),n.getMailFolder(l,d.targetFolderId));break;case (c.DELETE):if(j){j.closeAfterDelete()};break;}return p},updateViewForCreatedDraft:function(c){const b=this,a=b.getSelectedMailFolder();if(!a||a.get("folderType")!==conjoon.cn_mail.data.mail.folder.MailFolderTypes.DRAFT||a.get("mailAccountId")!==c.get("mailAccountId")){return}let d=conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.createItemFromDraft(c),e=b.getMessageGrid();d.join(e.getStore());b.getLivegrid().add(d)},updateViewForSentDraft:function(b){const a=this,e=a.getSelectedMailFolder(),g=b.getCompoundKey(),d=a.getLivegrid();let f=a.getMailboxService().getMailFolderHelper().getMailFolderIdForType(b.get("mailAccountId"),conjoon.cn_mail.data.mail.folder.MailFolderTypes.SENT),c;if(e){let a=b.get("xCnDraftInfo");if(a){let [e,f,g]=Ext.decode(atob(a)),c=d.getRecordByCompoundKey(conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey.createFor(e,f,g));if(c){c.set("answered",!0,{dirty:!1})}}let f=e.get("id");if(f===b.get("mailFolderId")){c=d.getRecordByCompoundKey(g)}}if(!c){c=conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.createItemFromDraft(b)}c.set("draft",!1);return a.getMailboxService().moveMessage(c,f,{before:a.onBeforeMessageMoveOrDelete,success:a.onMessageMovedOrDeleted,failure:a.onMessageMovedOrDeletedFailure,scope:a})},getMessageView:function(){return this.getView().down("cn_mail-mailmessagereadermessageview")},getLivegrid:function(){return this.getMessageGrid().view.getFeature("cn_mail-mailMessageFeature-livegrid")},getRowFlyMenu:function(){return this.getMessageGrid().view.getFeature("cn_mail-mailMessageFeature-rowFlyMenu")},getSelectedMailFolder:function(){let a=this.getMailFolderTree().getSelection();if(a&&a.length){return a[0]}return null},getMessageGrid:function(){const a=this;if(!a.messageGrid){a.messageGrid=a.getView().down("cn_mail-mailmessagegrid")}return a.messageGrid},getMailFolderTree:function(){const a=this;if(!a.mailFolderTree){a.mailFolderTree=a.getView().down("cn_mail-mailfoldertree")}return a.mailFolderTree}});Ext.define("conjoon.cn_mail.view.mail.folder.MailFolderTreeColumn",{extend:"Ext.tree.Column",alias:"widget.cn_mail-mailfoldertreecolumn",cellTpl:["<tpl for=\"lines\">","<div class=\"{parent.childCls} {parent.elbowCls}-img ","{parent.elbowCls}-<tpl if=\".\">line<tpl else>empty</tpl>\" role=\"presentation\"></div>","</tpl>","<tpl if=\"glyph\">","<span class=\"{baseIconCls}\" ","<tpl if=\"glyphFontFamily\">","style=\"font-family:{glyphFontFamily}\"","</tpl>",">{glyph}</span>","<tpl else>","<tpl if=\"iconCls\">","<tpl if=\"icon\">","<img src=\"{blankUrl}\"","<tpl else>","<div","</tpl>"," role=\"presentation\" class=\"{childCls} {baseIconCls} {customIconCls} ","{baseIconCls}-<tpl if=\"leaf\">leaf<tpl else><tpl if=\"expanded\">parent-expanded<tpl else>parent</tpl></tpl> {iconCls}\" ","<tpl if=\"icon\">style=\"background-image:url({icon})\"/>"+"<tpl else>"+"></div>"+"</tpl>","</tpl>","</tpl>","<tpl if=\"href\">","<a href=\"{href}\" role=\"link\" target=\"{hrefTarget}\" class=\"{textCls} {childCls}\">{value}</a>","<tpl else>","<span class=\"{textCls} {childCls}\">{value}</span>","</tpl>","<div class=\"{childCls} {elbowCls}-img {elbowCls}","<tpl if=\"isLast\">-end</tpl>"+"<tpl if=\"expandable\">-plus {expanderCls}</tpl>\" role=\"presentation\"></div>"],initTemplateRendererData:function(i,e,b,g,f,h,j){const d=this,c=b.get("folderType");let a;a=Ext.tree.Column.prototype.initTemplateRendererData.apply(this,arguments);if(a.lines.length<=1){b.data.iconCls=a.lines.length===0?" ":d.getIconClsForMailFolderType(c)}else {b.data.iconCls=""}if(a.lines&&a.lines.length<2){a.lines=[]}return a},getIconClsForMailFolderType:function(b){var a="fas fa-folder";switch(b){case "INBOX":a="fas fa-inbox";break;case "DRAFT":a="fas fa-edit";break;case "JUNK":a="fas fa-recycle";break;case "TRASH":a="fas fa-trash";break;case "SENT":a="fas fa-paper-plane";break;}return a}});Ext.define("conjoon.cn_mail.view.mail.folder.MailFolderTree",{extend:"Ext.tree.Panel",requires:["conjoon.cn_mail.view.mail.folder.MailFolderTreeColumn"],alias:"widget.cn_mail-mailfoldertree",width:240,cls:"cn_mail-mailfoldertree",useArrows:!0,rootVisible:!1,hideHeaders:!0,selModel:{toggleOnClick:!1},viewConfig:{outerRowTpl:["<table id=\"{rowId}\" role=\"presentation\" ","data-boundView=\"{view.id}\" ","data-recordId=\"{record.internalId}\" ","data-recordIndex=\"{recordIndex}\" ","class=\"{[values.itemClasses.join(\" \")]} {[this.getOuterRowClass(values.record, values.view.dataSource)]}\" cellpadding=\"0\" cellspacing=\"0\" style=\"{itemStyle};width:0;\">","{%","this.nextTpl.applyOut(values, out, parent)","%}","</table>",{getOuterRowClass:function(c,g){let a=c.get("folderType").toLowerCase(),b="cn_"+(a==="folder"?"generic":a),d=c.parentNode,f=g.getRoot(),e=d&&d!==f&&d.parentNode!==f;if(!e&&a!=="account"){b+=" cn_folder"}if(a==="account"&&!c.previousSibling){b+=" first"}else if(e){b+=" cn_subfolder"}return b},priority:9999}]},columns:[{xtype:"cn_mail-mailfoldertreecolumn",dataIndex:"name",flex:1,renderer:function(b,d,c){var a=c.get("unreadCount");if(a>0){return b+"<span class=\"badge-unreadcount\">"+a+"</span>"}return b}}]});Ext.define("conjoon.cn_mail.view.mail.message.grid.feature.Livegrid",{extend:"coon.comp.grid.feature.Livegrid",requires:["conjoon.cn_mail.data.mail.message.CompoundKey","coon.core.data.pageMap.PageMapUtil"],alias:"feature.cn_mail-mailmessagegridfeature-livegrid",getRecordByCompoundKey:function(a){const b=this;if(!(a instanceof conjoon.cn_mail.data.mail.message.CompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.CompoundKey",compoundKey:a})}return coon.core.data.pageMap.PageMapUtil.getRecordBy(b=>!b.hasKeysModified()&&b.getCompoundKey().equalTo(a)===!0,b.pageMapFeeder)}});Ext.define("conjoon.cn_mail.view.mail.message.grid.feature.PreviewTextLazyLoad",{extend:"Ext.grid.feature.Feature",alias:"feature.cn_webmailplug-previewtextlazyload",requires:["l8","conjoon.cn_mail.data.mail.message.CompoundKey","coon.core.data.pageMap.PageMapUtil","coon.core.data.pageMap.RecordPosition"],init(b){"use strict";const a=this;b.on("afterrender",a.installListeners,a,{single:!0})},installListeners(){"use strict";const a=this,b=a.grid;if(a.installed){throw new Error("The listeners for this feature were already installed")}const f=b.view.getFeature("cn_mail-mailMessageFeature-messagePreview");b.on("cn_mail-mailmessagegridbeforeload",a=>a.getProxy().extraParams.attributes="*,previewText",null,{single:!0});f.getPreviewTextRow=b=>{let a=b.get("previewText");return `<div class="previewText${(a===undefined?" loading":"")}">`+(a!==undefined?Ext.util.Format.nbsp(a):"")+"</div>"};const c=a.requestPreviewText,d={buffer:500},e=b.view.getScrollable();a.mon(e,"scroll",c,a,d);a.mon(b,"cn_mail-mailmessagegridload",c,a,d);a.mon(b,"cn_mail-mailmessagegridprefetch",c,a,d);a.installed=!0},requestPreviewText(){"use strict";const a=this,f=a.grid,e=f.getStore();if(!e){return !1}const b=a.getPagesToBrowse();if(!b){return !1}if(!a.pendingLazies){a.pendingLazies={}}const d=a.getUrlGroups(b.browse,b.pageMap),c=a.assembleUrls(d);Object.keys(c).forEach(b=>{a.pendingLazies[b]=a.processRequestedIds(c[b],a.pendingLazies[b]?a.pendingLazies[b]:[],b)});return a.pendingLazies},getPagesToBrowse(){const j=this,i=j.grid,b=i.view.getFeature("cn_mail-mailMessageFeature-livegrid"),c=b.getPageMap(),g=c.getPageSize(),d=[],a=b.getCurrentViewRange();if(!a){return !1}const h=l8.createRange(a.getStart().getPage(),a.getEnd().getPage()),e=a.getStart().getIndex(),f=a.getEnd().getIndex();h.forEach((c,a,b)=>{d.push([c,a===0?e:0,a===b.length-1?f:g-1])});return {browse:d,pageMap:c}},assembleUrls(a){const h=this,c=Object.create(null),b=Ext.create("Ext.data.Request",{action:"read"}),g=h.grid,f=g.getStore(),e=f.getProxy();let d="";Object.keys(a).forEach(f=>{Object.keys(a[f]).forEach(g=>{b.setParams({mailAccountId:f,mailFolderId:g});d=e.assembleUrl(b);c[d]=a[f][g]})});return c},getUrlGroups(e,d){"use strict";const a={},c=coon.core.data.pageMap.PageMapUtil,b=coon.core.data.pageMap.RecordPosition;e.forEach(f=>{for(let g=f[1],h=f[2];g<=h;g++){let h=c.getRecordAt(b.create(f[0],g),d);if(h&&h.get("previewText")===undefined){let b=h.getCompoundKey().toArray();if(!a[b[0]]){a[b[0]]={}}if(!a[b[0]][b[1]]){a[b[0]][b[1]]=[]}a[b[0]][b[1]].push(b[2])}}});return a},processRequestedIds(d,c,e){const b=this;let a=b.computeIdsToLoad(d,c);if(a!==null){b.sendRequest(a.ids,e);return a.pendingLazies}return []},computeIdsToLoad(c,a){let b=c.filter(b=>a.indexOf(b)===-1);a=a.concat(b);if(!b.length){return null}return {ids:b,pendingLazies:a}},processLoadedPreviewText(a){const b=this,d=conjoon.cn_mail.data.mail.message.CompoundKey,c=a.request.url,e=JSON.parse(a.request.params.filter)[0].value,f=b.grid.view.getFeature("cn_mail-mailMessageFeature-livegrid");b.pendingLazies[c]=l8.extract(b.pendingLazies[c].concat(e));let g=JSON.parse(a.responseText);g.data.forEach(b=>{setTimeout(()=>{let c=f.getRecordByCompoundKey(d.createFor(b.mailAccountId,b.mailFolderId,b.id));if(c){c.set("previewText",b.previewText?b.previewText:"")}},1)})},sendRequest(c,f){const a=this,e=a.grid,d=e.getStore(),b=d.getProxy();Ext.Ajax.request({method:"get",url:f,headers:b.headers,params:{attributes:"previewText",options:b.getDefaultParameters("ListMessageItem.options"),target:"MessageItem",filter:JSON.stringify([{"property":"id","operator":"in","value":c}])}}).then(a.processLoadedPreviewText.bind(a))}});Ext.define("conjoon.cn_mail.view.mail.message.MessageGrid",{extend:"Ext.grid.Panel",requires:["Ext.grid.column.Date","coon.comp.grid.feature.RowBodySwitch","conjoon.cn_mail.view.mail.message.grid.feature.Livegrid","conjoon.cn_mail.view.mail.message.grid.feature.PreviewTextLazyLoad","conjoon.cn_mail.store.mail.message.MessageItemStore","coon.comp.grid.feature.RowFlyMenu","coon.core.util.Date"],alias:"widget.cn_mail-mailmessagegrid",myStoreRelayers:null,cls:"cn_mail-mailmessagegrid",flex:1,headerBorders:!1,rowLines:!1,selModel:{toggleOnClick:!1,pruneRemoved:!1},tools:[{itemId:"cn_mail-mailmessagegrid-refresh",type:"refresh"}],emptyText:"This folder is empty.",representedFolderType:null,features:[{ftype:"cn_mail-mailmessagegridfeature-livegrid",id:"cn_mail-mailMessageFeature-livegrid"},{ftype:"cn_comp-gridfeature-rowbodyswitch",variableRowHeight:!1,enableCls:"previewEnabled",disableCls:"previewDisabled",id:"cn_mail-mailMessageFeature-messagePreview",emptySubjectText:"(No subject)",getPreviewTextRow:a=>`<div class="previewText">${Ext.util.Format.nbsp(a.get("previewText"))}</div>`,getAdditionalData:function(d,f,a,e){const b=this,c=coon.core.util.Date;if(b.disabled){return undefined}return {rowBody:"<div class=\"head"+(!a.get("seen")?" unread":"")+(a.get("recent")?" recent":"")+"\">"+"<div class=\"subject"+(!a.get("seen")?" seen":"")+(a.get("recent")?" recent":"")+"\">"+(a.get("answered")?"<span class=\"fa fa-mail-reply\"></span>":"")+(a.get("flagged")?"<span class=\"fa fa-flag\"></span>":"")+(a.get("draft")?"<span class=\"draft\">[Draft]</span>":"")+(a.get("subject")===""?b.emptySubjectText:a.get("subject"))+"</div>"+"<div class=\"date\">"+c.getHumanReadableDate(a.get("date"))+"</div>"+"</div>"+b.getPreviewTextRow(a),rowBodyCls:"cn_mail-mailmessagepreviewfeature"}},previewColumnConfig:{"seen":{hidden:!0},"subject":{hidden:!0},"to":{hidden:!0},"from":{hidden:!0},"draftDisplayAddress":{flex:1},"date":{hidden:!0},"hasAttachments":{},"size":{hidden:!0}}},{ftype:"cn_comp-gridfeature-rowflymenu",id:"cn_mail-mailMessageFeature-rowFlyMenu",items:[{cls:"fa fa-trash","data-qtip":"Delete Message",action:"delete",id:"cn_mail-mailMessageFeature-rowFlyMenu-delete"},{cls:"fa fa-envelope","data-qtip":"Mark as Unread",action:"markunread",id:"cn_mail-mailMessageFeature-rowFlyMenu-markUnread"},{cls:"fa fa-flag","data-qtip":"Add Flag",action:"flag",id:"cn_mail-mailMessageFeature-rowFlyMenu-flag"}],alignTo:["tr-tr",[-12,4]]}],viewConfig:{markDirty:!1,getRowClass:function(a,d,c,e){let b=a.get("recent")?"recent":"";b+=a.get("seen")?"":" boldFont";if(a.get("cn_deleted")){b+=" cn-deleted"}else if(a.get("cn_moved")){b+=" cn-moved"}return b}},columns:[{dataIndex:"seen",hideable:!1,text:"<span class=\"x-fa fa-circle\"></span>",renderer:function(a,b,c){return "<span class=\""+(!a?"fas":"far")+" fa-circle\"></span>"},menuDisabled:!0,width:40},{dataIndex:"hasAttachments",hideable:!1,text:"<span class=\"x-fa fa-paperclip\"></span>",renderer:function(a){return a?"<span class=\"x-fa fa-paperclip\"></span>":""},menuDisabled:!0,width:40},{dataIndex:"subject",text:"Subject",width:150},{dataIndex:"to",text:"To",width:240,renderer:function(a,g,e,d,c,f,b){return b.grid.stringifyTo(a)}},{dataIndex:"from",text:"From",width:140,renderer:function(a,c,g,f,e,h,d){var b=d.getFeature("cn_mail-mailMessageFeature-messagePreview");if(!b.disabled){c.tdCls+="previewLarge"}return a?a.name:""}},{dataIndex:"draftDisplayAddress",hidden:!0,hideable:!1,text:"Draft Display Address",menuDisabled:!0},{dataIndex:"date",xtype:"datecolumn",format:"d.m.Y H:i",align:"right",text:"Date",width:140},{dataIndex:"size",align:"right",text:"Size",width:80,renderer:Ext.util.Format.fileSize}],setRepresentedFolderType:function(a){const b=this;b.representedFolderType=a},initComponent:function(){const a=this;a.fireEvent("cn_init",a);for(let b=0,c=a.columns.length;b<c;b++){if(a.columns[b].dataIndex==="draftDisplayAddress"){a.columns[b].renderer=a.renderDraftDisplayAddress}}a.callParent(arguments);a.relayEvents(a.view.getFeature("cn_mail-mailMessageFeature-rowFlyMenu"),["itemclick","beforemenushow"],"cn_comp-rowflymenu-")},renderDraftDisplayAddress:function(i,d,a,g,f,h,b){const e=this,c=b.getFeature("cn_mail-mailMessageFeature-messagePreview");if(!c.disabled){d.tdCls+="previewLarge";if(a.get("draft")||e.representedFolderType==="SENT"){return b.grid.stringifyTo(a.get("to"))}}return a.get("from")?a.get("from").name:""},enableRowPreview:function(b){const a=this,g=a.getView(),e=g.getFeature("cn_mail-mailMessageFeature-messagePreview"),d=g.getFeature("cn_mail-mailMessageFeature-rowFlyMenu");b=b===undefined?!0:!!b;if(a.getStore().isLoading()){Ext.raise({msg:"cannot call enableRowPreview during store's load-operation",isLoading:a.getStore().isLoading()})}let c=a.getStore().pageRequests;for(let f in c){if(!Object.prototype.hasOwnProperty.call(c,f)){continue}c[f].getOperation().abort()}a.getStore().reload();if(b){e.enable();d.enable()}else {e.disable();d.disable()}},bindStore:function(a,c){const b=this;if(a&&!a.isEmptyStore&&!(a instanceof conjoon.cn_mail.store.mail.message.MessageItemStore)){Ext.raise({msg:"store must be an instance of \"conjoon.cn_mail.store.message.MessageItemStore\"",store:a})}if(a&&b.getStore()!==a){b.myStoreRelayers=b.relayEvents(a,["beforeload","load","prefetch"],"cn_mail-mailmessagegrid")}return b.callParent(arguments)},unbindStore:function(b){const a=this;if(a.myStoreRelayers){a.myStoreRelayers.destroy()}a.myStoreRelayers=null;return a.callParent(arguments)},updateRowFlyMenu:function(c){const f=this,e=f.view.getFeature("cn_mail-mailMessageFeature-rowFlyMenu"),d=e.menu,b=d.query("div[id=cn_mail-mailMessageFeature-rowFlyMenu-markUnread]",!0),a=d.query("div[id=cn_mail-mailMessageFeature-rowFlyMenu-flag]",!0);switch(c.get("seen")){case (!0):b[0].setAttribute("data-qtip","Mark as Unread");break;default:b[0].setAttribute("data-qtip","Mark as Read");}switch(c.get("flagged")){case (!0):a[0].setAttribute("data-qtip","Remove Flag");break;default:a[0].setAttribute("data-qtip","Add Flag");}},stringifyTo:function(b){const c=[];for(var a=0,d=b.length;a<d;a++){c.push(b[a].name)}return c.join(", ")}});Ext.define("conjoon.cn_mail.view.mail.mixin.LoadingFailedDialog",{requires:["coon.comp.component.MessageMask","coon.comp.window.Toast"],loadingFailedMask:null,showLoadingFailedDialog:function(c=!0){const a=this;if(a.loadingFailedMask){return a.loadingFailedMask}let b=Ext.create("coon.comp.component.MessageMask",{title:"Loading failed",message:"I'm sorry, I could not load the message.",buttons:c!==!1?coon.comp.component.MessageMask.OK:undefined,target:a,callback:c!==!1?function(){a.close()}:undefined,scope:a,icon:coon.comp.component.MessageMask.FAILURE,dialogStyle:!1});a.mon(b,"destroy",function(){this.loadingFailedMask=null},a);b.show();a.loadingFailedMask=b;a.updateTargetHeader();a.showToast();return b},updateTargetHeader:function(){const a=this;a.setTitle("oops.");a.setIconCls("far fa-frown")},showToast:function(){return coon.Toast.fail("The message could not be loaded.")}});Ext.define("conjoon.cn_mail.text.mail.message.reader.PlainReadableStrategy",{requires:["l8.text.toBlockquote","l8.text.toHyperlink","l8.text.toEmailLink","l8.text.toLineBreak"],process:function(a){return l8.text.toLineBreak(l8.text.toHyperlink(l8.text.toEmailLink(l8.text.toBlockquote(a))))}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.model.mail.message.ItemAttachment","conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater","conjoon.cn_mail.text.mail.message.reader.PlainReadableStrategy","coon.core.util.Date"],alias:"viewmodel.cn_mail-mailmessagereadermessageviewmodel",bodyLoadOperation:null,attachmentsLoadOperation:null,abortedRequestMap:null,emptySubjectText:"(No subject)",data:{hasImages:!1,iframeLoaded:!1,isLoading:!1,messageItem:null,contextButtonsEnabled:!1},stores:{attachmentStore:{model:"conjoon.cn_mail.model.mail.message.ItemAttachment",data:"{attachments}"}},formulas:{textPlainToHtml:{bind:{textPlain:"{messageBody.textPlain}"},get:function(b){if(!b.textPlain){return ""}const a=this;if(!a.plainReadableStrategy){a.plainReadableStrategy=Ext.create("conjoon.cn_mail.text.mail.message.reader.PlainReadableStrategy")}return a.plainReadableStrategy.process(b.textPlain)}},getSubject:{bind:{subject:"{messageItem.subject}"},get:function(a){return a.subject||this.emptySubjectText}},getDisplayToAddress:function(b){const e=b("messageItem"),d=b("messageItem.to");if(!e){return ""}let c=[];for(let a=0,f=d.length;a<f;a++){c.push(d[a].name)}return c.join(", ")},getDisplayFromAddress:function(b){const c=b("messageItem"),a=b("messageItem.from");if(!c){return ""}return a?a.name:""},getFormattedDate:function(a){return coon.core.util.Date.getHumanReadableDate(a("messageItem.date"))},getIndicatorText:function(a){return !a("messageBody")&&!a("messageItem")?"Select a message for reading.":a("messageItem")&&(!a("messageBody")||!a("iframeLoaded"))?"Loading message body...":""},getIndicatorIcon:function(a){return !a("messageBody")&&!a("messageItem")?"far fa-envelope":a("messageItem")&&(!a("messageBody")||!a("iframeLoaded"))?"fas fa-spin fa-spinner":""}},updateMessageItem:function(a){var b=this,c=b.get("messageItem"),f=[],g,d;if(!c){Ext.raise({msg:"There is currently no messageItem available.",cls:Ext.getClassName(b),messageItem:b.get("messageItem")})}if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({msg:"messageDraft must be an instance of 'conjoon.cn_mail.model.mail.message.MessageDraft'",cls:Ext.getClassName(b),messageDraft:a})}if(a.getCompoundKey().getMailAccountId()!==c.getCompoundKey().getMailAccountId()){Ext.raise({msg:"The accountId of the compoundKey of the messageDraft does not equal to the accountId of the compoundKey of the messageItem",cls:Ext.getClassName(b),messageDraft:a,messageItem:c})}d=a.attachments().getRange();g=a.getMessageBody().copy();for(var e=0,h=d.length;e<h;e++){f.push(d[e].copy())}conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.updateItemWithDraft(c,a);b.set("attachments",f);b.set("messageBody",g)},setMessageItem:function(b){var a=this,c;a.set("messageBody",null);a.set("attachments",[]);if(b&&!(b instanceof conjoon.cn_mail.model.mail.message.MessageItem)){Ext.raise({sourceClass:Ext.getClassName(this),msg:"messageItem needs to be instance of conjoon.cn_mail.model.mail.message.MessageItem"})}a.set("messageItem",b);if(b){c=b.clone();a.loadMessageBodyFor(c);a.loadAttachmentsFor(c)}else {a.messageBodyLoaded(null,null)}},loadMessageBodyFor:function(c){var a=this,b;if(!a.abortedRequestMap){a.abortedRequestMap={}}if(a.bodyLoadOperation){a.abortMessageBodyLoad()}b=c.loadMessageBody({reload:a.abortedRequestMap[c.get("messageBodyId")]===!0,success:a.messageBodyLoaded,failure:a.onMessageBodyLoadFailure,scope:a});if(!b){a.messageBodyLoaded(null,null);return}if(b.loadOperation){a.bodyLoadOperation={messageBodyId:c.get("messageBodyId"),loadOperation:b.loadOperation}}},loadAttachmentsFor:function(b){var a=this;if(a.attachmentsLoadOperation){a.abortMessageAttachmentsLoad()}if(b.get("hasAttachments")){b.attachments().on("beforeload",a.onBeforeAttachmentsLoad,a,{single:!0});b.loadAttachments({callback:a.messageAttachmentsLoaded,scope:a})}},abortMessageAttachmentsLoad:function(){var a=this;if(a.attachmentsLoadOperation){a.attachmentsLoadOperation.abort();a.attachmentsLoadOperation=null}},abortMessageBodyLoad:function(){var b=this,a=b.bodyLoadOperation;if(a&&a.loadOperation&&a.loadOperation.isRunning()){a.loadOperation.abort();b.abortedRequestMap[a.messageBodyId]=!0}b.bodyLoadOperation=null},privates:{messageAttachmentsLoaded:function(b,d,c){var a=this;a.attachmentsLoadOperation=null;if(c!==!0){return}a.set("attachments",b)},onBeforeAttachmentsLoad:function(c,a){var b=this;b.attachmentsLoadOperation=a},onMessageBodyLoadFailure:function(b,a){const d=this,c=d.getView();if(a.error&&a.error.status===-1){return}c.onMessageItemLoadFailure(b,a)},messageBodyLoaded:function(c,d){var a=this,b=a.get("messageItem");a.bodyLoadOperation=null;if(!c){a.set("messageBody",null);return}if(!b){return}delete a.abortedRequestMap[c.getId()];a.set("messageBody",c);b.set("recent",!1);if(b.get("seen")!==!0){b.set("seen",!0);b.save({callback:a.triggerMessageItemRead,scope:a})}},triggerMessageItemRead:function(a,d){var c=this,b=c.getView();b.fireEvent("cn_mail-mailmessageitemread",[a])}}});Ext.define("conjoon.cn_mail.view.mail.message.AbstractAttachmentList",{extend:"Ext.view.View",requires:["conjoon.cn_mail.model.mail.message.AbstractAttachment","coon.core.util.Mime"],cls:"cn_mail-attachment-list",overItemCls:"over",selectedItemCls:"selected",itemSelector:"div.attachment",tpl:["<tpl for=\".\">","<div target=\"_blank\" class=\"attachment {[this.getPreviewCssClass(values.type, values.previewImgSrc)]}\" ","style=\"background-image:url({previewImgSrc})\">","<div class=\"imagecont\">","<span class=\"mimetype far {[this.getMimeTypeIcon(values.type)]}\"></span>","</div>","<div class=\"actioncont\">","<div class=\"attachmenticon fa fa-download\"></div>","<div class=\"linkcont\">","<div class=\"filename\">{text}</div>","<div class=\"filesize\">{[Ext.util.Format.fileSize(values.size)]}</div>","<div class=\"attachmentaction\">","<tpl if=\"this.displayButtonType('DOWNLOAD')\">","<a role=\"link\" href=\"{downloadUrl}\" class=\"downloadbutton fa fa-arrow-down\" download=\"{text}\"></a>","</tpl>","<tpl if=\"this.displayButtonType('REMOVE')\">","<a class=\"removebutton fa fa-times\"></a>","</tpl>","</div>","</div>","</div>","</div>","</tpl>"],initComponent:function(){var a=this;a.tpl=a.tpl.concat([{displayButtonType:a.displayButtonType.bind(a),getPreviewCssClass:a.getPreviewCssClass.bind(a),getMimeTypeIcon:a.getMimeTypeIcon.bind(a)}]);a.callParent(arguments)},getPreviewCssClass:function(a,b){return coon.core.util.Mime.isImage(a)&&b?"preview":""},displayButtonType:Ext.emptyFn,getMimeTypeIcon:function(a){a=a+"";switch(a.toLowerCase()){case "image/jpeg":case "image/jpg":case "image/gif":case "image/png":case "image":return "fa-file-image";case "audio":return "fa-file-audio";case "video":return "fa-file-video";case "application/pdf":return "fa-file-pdf";case "text/plain":return "fa-file-alt";case "text/html":case "application/json":return "fa-file-code";case "application/gzip":case "application/zip":case "application/x-rar-compressed":case "application/x-zip-compressed":return "fa-file-archive";}return "fa-file"}});Ext.define("conjoon.cn_mail.view.mail.message.AbstractAttachmentListController",{extend:"Ext.app.ViewController",init:function(){var a=this;a.mon(a.getView(),"itemclick",a.onAttachmentItemClick,a)},onAttachmentItemClick:Ext.emptyFn});Ext.define("conjoon.cn_mail.view.mail.message.reader.AttachmentListController",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentListController",alias:"controller.cn_mail-mailmessagereaderattachmentlistcontroller"});Ext.define("conjoon.cn_mail.view.mail.message.reader.AttachmentList",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentList",requires:["conjoon.cn_mail.view.mail.message.reader.AttachmentListController"],alias:"widget.cn_mail-mailmessagereaderattachmentlist",controller:"cn_mail-mailmessagereaderattachmentlistcontroller",displayButtonType:function(a){return a==="DOWNLOAD"}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageViewIframe",{extend:"coon.comp.component.Iframe",alias:"widget.cn_mail-mailmessagereadermessageviewiframe",requires:["coon.core.Template","coon.core.ThemeManager","coon.core.Environment","coon.core.ConfigManager"],publishes:["imagesAllowed"],imagesAllowed:!1,async setSrcDoc(b,d=!1){const a=this;a.imagesAllowed=!!d;a.publishState("imagesAllowed",a.imagesAllowed);if(!b){return a.callParent([b])}const f=coon.core.ThemeManager.getTheme(),c=f.get(),e=coon.core.Environment.getPathForResource(coon.core.ConfigManager.get("extjs-app-webmail","resources.templates.html.reader"),"extjs-app-webmail"),g=await coon.core.Template.load(e);b=g.render({theme:c?c:{},reader:{body:b,imagesAllowed:a.imagesAllowed}});return a.callParent([b])},getImagesAllowed:function(){return this.imagesAllowed}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageViewController",{extend:"Ext.app.ViewController",alias:"controller.cn_mail-mailmessagereadermessageviewcontroller",requires:["coon.core.Environment"],control:{"cn_mail-mailmessagereadermessageviewiframe":{load:"onIframeLoad",beforesrcdoc:"onBeforeSrcDoc"},"#remoteImageWarning":{afterrender:"onRemoteImageWarningAfterrender"},"cn_mail-mailmessagereadermessageview":{resize:"onViewResize"}},onViewResize:function(i,e,d,h,g){const f=this,a=f.getIframe(),c=a.getBody(),b=Ext.getScrollbarSize();a.setSize(e-b.width,d-b.height);a.setSize(c.scrollWidth,c.scrollHeight)},onRemoteImageWarningAfterrender:function(b){const a=this;b.getEl().on("click",a.reloadWithImages,a)},onBeforeSrcDoc:function(b,c){const a=this;a.getView().getViewModel().set("iframeLoaded",!1)},onIframeLoad:function(a){const c=this,h=c.getView(),d=h.getViewModel(),f=a.getBody(),b=h.down("#msgBodyContainer"),e=Ext.getScrollbarSize();c.sanitizeLinks(a.cn_iframeEl.dom.contentWindow.document.getElementsByTagName("a"));let g=a.cn_iframeEl.dom.contentWindow.document.getElementsByTagName("img");d.set("hasImages",g.length>0);if(!a.getImagesAllowed()){c.sanitizeImages(g)}b.setScrollY(0);b.setScrollX(0);d.set("iframeLoaded",!0);d.notify();a.setSize(b.getWidth()-e.width,b.getHeight()-e.height);a.setSize(f.scrollWidth,f.scrollHeight)},sanitizeLinks:function(d){let a,b;for(let c=0,e=d.length;c<e;c++){a=d[c];b=a.getAttribute("href");if(!b||b.indexOf("#")===0){a.removeAttribute("target");continue}if(b.indexOf("mailto:")===0){a.setAttribute("href","#cn_mail/message/compose/"+encodeURIComponent(b));a.setAttribute("target","_top");continue}a.setAttribute("target","_blank")}},reloadWithImages:function(){const a=this,b=a.getIframe();b.setSrcDoc(a.getViewModel().get("messageBody.textHtml"),!0)},sanitizeImages:function(c){let b,a,d=c.length;for(a=0;a<d;a++){b=c[a];b.style.border="1px solid black";b.setAttribute("src",coon.core.Environment.getPathForResource("resources/images/img_block.png","extjs-app-webmail"))}},getIframe:function(){const b=this,a=b.getView();return a.down("cn_mail-mailmessagereadermessageviewiframe")}});Ext.define("conjoon.cn_mail.view.mail.message.reader.MessageView",{extend:"Ext.Panel",mixins:["conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog","conjoon.cn_mail.view.mail.mixin.LoadingFailedDialog"],requires:["conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.view.mail.message.reader.MessageViewModel","conjoon.cn_mail.view.mail.message.reader.AttachmentList","conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.view.mail.message.reader.MessageViewIframe","conjoon.cn_mail.view.mail.message.reader.MessageViewController"],alias:"widget.cn_mail-mailmessagereadermessageview",config:{contextButtonsEnabled:!1},isCnMessageView:!0,layout:{type:"vbox",align:"stretch"},controller:"cn_mail-mailmessagereadermessageviewcontroller",viewModel:{type:"cn_mail-mailmessagereadermessageviewmodel"},hideMode:"offsets",split:!0,cls:"cn_mail-mailmessagereadermessageview shadow-panel",flex:1,title:"Loading...",iconCls:"fa fa-spin fa-spinner",bind:{title:"{isLoading ? \"Loading...\" : getSubject}",iconCls:"{isLoading ? \"fas fa-spin fa-spinner\" : \"far fa-envelope\"}"},closable:!0,loadingItem:null,loadingMask:null,items:[{xtype:"container",itemId:"msgHeaderContainer",cls:"cn_mail-header",height:82,layout:{type:"hbox",align:"stretch"},hidden:!0,bind:{hidden:"{!messageItem}"},items:[{xtype:"box",cls:"sender-img fas fa-user",margin:"8 8 0 8"},{xtype:"container",flex:1,layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",margin:"5 5 0 0",layout:{type:"hbox"},items:[{xtype:"component",flex:1,cls:"message-subject",bind:{data:{date:"{getFormattedDate}",displayToAddress:"{getDisplayToAddress}",displayFromAddress:"{getDisplayFromAddress}"}},tpl:["<div class=\"from\">{displayFromAddress}</div>","<div class=\"to\">to {displayToAddress} on {date}</div>"]},{xtype:"segmentedbutton",hidden:!0,disabled:!0,bind:{disabled:"{!messageBody.textHtml || !messageBody.textPlain}",visible:"{messageBody.textHtml || messageBody.textPlain}"},items:[{xtype:"button",scale:"small",iconCls:"fas fa-code",itemId:"btn-showhtml",reference:"htmlplainButton",bind:{pressed:"{!!messageBody.textHtml}"},tooltip:{text:"Show text/html"}},{xtype:"button",scale:"small",itemId:"btn-showplain",iconCls:"fas fa-align-left",bind:{pressed:"{!messageBody.textHtml}"},tooltip:{text:"Show text/plain"}}]},{xtype:"button",scale:"small",iconCls:"fas fa-edit",tooltip:{text:"Edit this draft"},itemId:"btn-editdraft",visible:!1,bind:{visible:"{messageItem.draft && contextButtonsEnabled}"}},{xtype:"button",scale:"small",iconCls:"fas fa-trash",itemId:"btn-deletedraft",tooltip:{text:"Delete this draft"},visible:!1,bind:{visible:"{messageItem.draft && contextButtonsEnabled}"}},{visible:!1,bind:{visible:"{!messageItem.draft && contextButtonsEnabled}"},xtype:"splitbutton",iconCls:"fas fa-reply-all",text:"Reply all",itemId:"btn-replyall",menuAlign:"tr-br",menu:{items:[{text:"Reply",iconCls:"fas fa-reply",itemId:"btn-reply"},{text:"Forward",iconCls:"fas fa-share",itemId:"btn-forward"},"-",{text:"Delete",iconCls:"fas fa-trash",itemId:"btn-delete"}]}}]},{xtype:"component",flex:1,cls:"message-subject",bind:{data:{subject:"{getSubject}",hasAttachments:"{messageItem.hasAttachments}",isDraft:"{messageItem.draft}"}},tpl:["<div class=\"subject\">"+"<tpl if=\"isDraft\"><span class=\"draft\">[Draft]</span></tpl>"+"<tpl if=\"hasAttachments\"><span class=\"fa fa-paperclip\"></span></tpl>"+"{subject}","</div>"]}]}]},{xtype:"component",hidden:!0,bind:{hidden:"{!hasImages || cn_mail_iframe.imagesAllowed || !iframeLoaded}"},itemId:"remoteImageWarning",autoEl:{cls:"cn_mail-reloadWithImages",tag:"div",html:"Remote images are blocked in this message to protect your privacy. <span class=\"loadImg\">Display Images</span>"}},{flex:1,xtype:"box",hidden:!1,bind:{hidden:"{messageItem && messageBody && iframeLoaded}",data:{indicatorText:"{getIndicatorText}",indicatorIcon:"{getIndicatorIcon}"}},itemId:"msgIndicatorBox",tpl:["<div class=\"messageIndicator\">","<div class=\"{indicatorIcon} icon\"></div>","<div>{indicatorText}</div>","</div>"]},{xtype:"container",hideMode:"offsets",flex:1,cls:"cn_mail-body",hidden:!0,bind:{hidden:"{!messageBody || !iframeLoaded}"},itemId:"msgBodyContainer",scrollable:!0,layout:"auto",items:[{xtype:"cn_mail-mailmessagereaderattachmentlist",hidden:!0,bind:{store:"{attachmentStore}",hidden:"{!messageItem.hasAttachments}"}},{reference:"cn_mail_iframe",cls:"cn_mail-mailmessagereadermessageviewiframe",xtype:"cn_mail-mailmessagereadermessageviewiframe",scrolling:"no",sandbox:Ext.isGecko?"allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-top-navigation":"allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation",src:"",bind:{srcDoc:"{htmlplainButton.pressed ? messageBody.textHtml : textPlainToHtml}"}}]}],initComponent:function(){var a=this;a.on("afterrender",function(){var a=this;a.loadingMask=Ext.create("Ext.LoadMask",{target:a,bind:{hidden:"{!isLoading}"},listeners:{hide:function(b){b.destroy();a.loadingMask=null}}});a.loadingMask.show()},a,{single:!0});a.on("beforedestroy",function(){var a=this,b=a.getViewModel();if(a.loadingMask){a.loadingMask.destroy();a.loadingMask=null}if(a.loadingFailedMask){a.loadingFailedMask.destroy();a.loadingFailedMask=null}if(a.loadingItem){a.loadingItem.abort();a.loadingItem=null}b.abortMessageBodyLoad();b.abortMessageAttachmentsLoad()},a);a.callParent(arguments)},getMessageItem:function(){const a=this;return a.getViewModel().get("messageItem")},setMessageItem:function(b){var a=this;if(a.loadingFailedMask){a.loadingFailedMask.close();a.loadingFailedMask=null}a.getViewModel().setMessageItem(b?b:null)},loadMessageItem:function(b){var a=this,c=a.getViewModel();if(!(b instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:b})}c.set("isLoading",!0);if(a.loadingItem){a.loadingItem.abort()}a.loadingItem=conjoon.cn_mail.model.mail.message.MessageItem.loadEntity(b,{success:a.onMessageItemLoaded,failure:a.onMessageItemLoadFailure,scope:a})},updateMessageItem:function(a){var b=this;b.getViewModel().updateMessageItem(a)},privates:{onMessageItemLoadFailure:function(e,b){const a=this,c=a.getViewModel();c.set("isLoading",!1);c.notify();if(b.error&&b.error.status===-1){return}let d=(a.ownerCt instanceof Ext.tab.Panel);return a.showLoadingFailedDialog(d)},onMessageItemLoaded:function(b){const a=this,c=a.getViewModel();a.setMessageItem(b);c.set("isLoading",!1);a.loadingItem=null;a.fireEvent("cn_mail-messageitemload",a,b)}},updateContextButtonsEnabled:function(a){const b=this;b.getViewModel().set("contextButtonsEnabled",a)}});Ext.define("conjoon.cn_mail.view.mail.account.MailAccountViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.model.mail.account.MailAccount"],alias:"viewmodel.cn_mail-mailaccountviewmodel",sourceMailAccounts:null,data:{mailAccount:null},formulas:{processReplyTo:{get:function(b){let a=b("mailAccount.replyTo");return a.address},set:function(c){const b=this,a=Ext.clone(b.get("mailAccount.replyTo")),d=b.get("mailAccount");a.address=c;d.set("replyTo",a)}},processFrom:{get:function(b){let a=b("mailAccount.from");return a.address},set:function(c){const b=this,a=Ext.clone(b.get("mailAccount.from")),d=b.get("mailAccount");a.address=c;d.set("from",a)}},processUserName:{get:function(b){let a=b("mailAccount.from");return a.name},set:function(c){const a=this,d=Ext.clone(a.get("mailAccount.from")),b=Ext.clone(a.get("mailAccount.replyTo")),e=a.get("mailAccount");d.name=c;b.name=c;e.set("from",d);e.set("replyTo",b)}}},constructor:function(){const a=this;a.callParent(arguments);a.sourceMailAccounts={};a.saveOperations={}},setMailAccount:function(b){if(!(b instanceof conjoon.cn_mail.model.mail.account.MailAccount)){Ext.raise({msg:"\"mailAccount\" must be an instance of conjoon.cn_mail.model.mail.account.MailAccount",mailAccount:b})}const a=this,c=b.getId(),e=a.saveOperations[c]?a.saveOperations[c].getRecords()[0]:null;a.cleanup();if(a.saveOperations[c]){a.set("mailAccount",e);return e}let d=b.clone();a.sourceMailAccounts[c]=b;a.set("mailAccount",d);return d},cleanup:function(){const b=this,a=b.get("mailAccount.id");if(a&&b.saveOperations[a]&&b.saveOperations[a].isComplete()){delete b.saveOperations[a];delete b.sourceMailAccounts[a];return !0}return !1},savePendingChanges:function(){const a=this,c=a.getView(),b=a.get("mailAccount");if(!b||!b.modified){return null}c.fireEvent("cn_mail-mailaccountbeforesave",c,b);let d=b.save({success:a.onSaveSuccess,failure:a.onSaveFailure,scope:a});a.saveOperations[b.getId()]=d;return d},onSaveSuccess:function(a){const d=this,c=d.getView(),b=d.sourceMailAccounts[a.getId()];let e=Ext.copy({},a.data,["name","from","replyTo","inbox_type","inbox_address","inbox_port","inbox_ssl","inbox_user","inbox_password","outbox_type","outbox_address","outbox_port","outbox_ssl","outbox_user","outbox_password"].join(","));b.set(e);b.commit();c.fireEvent("cn_mail-mailaccountsave",c,a)},onSaveFailure:function(b){const c=this,a=c.getView();a.fireEvent("cn_mail-mailaccountsavefailure",a,b)}});Ext.define("conjoon.cn_mail.view.mail.account.MailAccountViewController",{extend:"Ext.app.ViewController",alias:"controller.cn_mail-mailaccountviewcontroller",control:{"cn_mail-mailaccountview":{"cn_mail-mailaccountbeforesave":"onBeforeMailAccountSave","cn_mail-mailaccountsave":"onMailAccountSaveCallback","cn_mail-mailaccountsavefailure":"onMailAccountSaveCallback",hide:"onMailAccountViewHide"},"#saveButton":{click:"onSaveButtonClick"},"#cancelButton":{click:"onCancelButtonClick"}},onSaveButtonClick:function(c){const b=this,a=b.getView();return a.getViewModel().savePendingChanges()},onCancelButtonClick:function(c){const b=this,a=b.getView();return a.rejectPendingChanges()},onBeforeMailAccountSave:function(a,b){a.setBusy()},onMailAccountSaveCallback:function(a,b){a.setBusy(!1);if(!a.isVisible()){a.getViewModel().cleanup()}},onMailAccountViewHide:function(a){a.getViewModel().cleanup()}});Ext.define("conjoon.cn_mail.view.mail.account.MailAccountView",{extend:"Ext.Panel",requires:["Ext.form.FieldSet","conjoon.cn_mail.view.mail.account.MailAccountViewModel","conjoon.cn_mail.view.mail.account.MailAccountViewController"],alias:"widget.cn_mail-mailaccountview",viewModel:"cn_mail-mailaccountviewmodel",controller:"cn_mail-mailaccountviewcontroller",cls:"cn_mail-mailaccountview",layout:{type:"vbox",align:"center"},busyMask:null,items:[{scrollable:"y",bodyPadding:"0 40 0 40",margin:"0 0 5 0",flex:1,layout:{type:"vbox",align:"stretch"},xtype:"form",bind:{title:"Account Settings - {mailAccount.name}"},buttons:[{text:"Cancel",width:108,itemId:"cancelButton"},{text:"Save",itemId:"saveButton",width:108}],minWidth:800,cls:"fieldsetCnt",defaults:{margin:"40 0 0 0",defaults:{labelWidth:160,labelAlign:"right",flex:"1"},layout:{type:"vbox",align:"stretch"}},items:[{xtype:"fieldset",title:"General Information",margin:"10 0 0 0",items:[{xtype:"textfield",fieldLabel:"Account Name",name:"name",bind:{value:"{mailAccount.name}"}},{xtype:"textfield",fieldLabel:"Your Name",name:"userName",bind:{value:"{processUserName}"}},{xtype:"textfield",name:"from",fieldLabel:"Email-Address",bind:{value:"{processFrom}"}},{xtype:"textfield",name:"replyTo",fieldLabel:"Reply-To",bind:{value:"{processReplyTo}"}}]},{xtype:"fieldset",bind:{title:"Incoming Server ({mailAccount.inbox_type})"},items:[{xtype:"container",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:9,labelWidth:160,fieldLabel:"Address",name:"inbox_address",bind:{value:"{mailAccount.inbox_address}"}},{xtype:"textfield",margin:"0 0 0 5",flex:1,labelWidth:10,fieldLabel:" ",name:"inbox_port",bind:{value:"{mailAccount.inbox_port}"}}]},{xtype:"checkbox",labelWidth:160,inputValue:!0,fieldLabel:"Use SSL",name:"inbox_ssl",bind:{value:"{mailAccount.inbox_ssl}"}},{xtype:"container",margin:"0 0 10 0",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:1,labelWidth:160,name:"inbox_user",fieldLabel:"Username",bind:{value:"{mailAccount.inbox_user}"}},{xtype:"textfield",margin:"0 0 0 20",inputType:"password",flex:1,labelWidth:80,name:"inbox_password",fieldLabel:"Password",bind:{value:"{mailAccount.inbox_password}"}}]}]},{xtype:"fieldset",title:"SMTP Server",items:[{xtype:"container",anchor:"100%",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:9,labelWidth:160,fieldLabel:"Address",name:"outbox_address",bind:{value:"{mailAccount.outbox_address}"}},{xtype:"textfield",margin:"0 0 0 5",flex:1,name:"outbox_port",labelWidth:10,fieldLabel:" ",bind:{value:"{mailAccount.outbox_port}"}}]},{xtype:"checkbox",labelWidth:160,inputValue:!0,fieldLabel:"Use SSL",name:"outbox_ssl",bind:{value:"{mailAccount.outbox_ssl}"}},{xtype:"container",margin:"0 0 10 0",layout:{type:"hbox",align:"stretch"},defaults:{labelAlign:"right"},items:[{xtype:"textfield",flex:1,labelWidth:160,name:"outbox_user",fieldLabel:"Username",bind:{value:"{mailAccount.outbox_user}"}},{xtype:"textfield",margin:"0 0 0 20",inputType:"password",flex:1,labelWidth:80,name:"outbox_password",fieldLabel:"Password",bind:{value:"{mailAccount.outbox_password}"}}]}]}]}],setMailAccount:function(a){const b=this,c=b.getViewModel(),d=a?a.getId():null;if(!a){return null}b.setBusy(!!c.saveOperations[d]);return c.setMailAccount(a)},hasPendingChanges:function(){const b=this,a=b.getViewModel().get("mailAccount");return !!(a&&a.modified)},rejectPendingChanges:function(){const b=this,a=b.getViewModel().get("mailAccount");if(!a||!a.modified){return !1}a.reject();return !0},setBusy:function(c=!0){const b=this;let a=b.busyMask;if(c===!1){if(a){a.hide()}return a}if(!a&&c!==!1){a=Ext.create("coon.comp.component.LoadMask",{msg:"Saving account",msgAction:"Please wait...",glyphCls:"fa fa-spin fa-gear",target:b});b.busyMask=a}a.show();a.loopProgress();return a}});Ext.define("conjoon.cn_mail.view.mail.inbox.InboxView",{extend:"Ext.Panel",alias:"widget.cn_mail-mailinboxview",mixins:["conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog"],requires:["conjoon.cn_mail.view.mail.inbox.InboxViewModel","conjoon.cn_mail.view.mail.inbox.InboxViewController","conjoon.cn_mail.view.mail.folder.MailFolderTree","conjoon.cn_mail.view.mail.message.MessageGrid","conjoon.cn_mail.view.mail.message.reader.MessageView","conjoon.cn_mail.view.mail.account.MailAccountView"],layout:{type:"hbox",align:"stretch"},viewModel:"cn_mail-mailinboxviewmodel",controller:"cn_mail-mailinboxviewcontroller",bodyCls:"cn_mail-panel-body",iconCls:"fa fa-paper-plane",title:"Emails",canCloseAfterDelete:!1,deleteMask:null,items:[{xtype:"cn_mail-mailfoldertree",margin:"0 0 5 0",reference:"cn_mail_ref_mailfoldertree",bind:{store:"{cn_mail_mailfoldertreestore}"}},{split:!0,xtype:"panel",itemId:"cn_mail-mailInboxViewPanelBody",flex:1,bodyCls:"cn_mail-panel-body",layout:{type:"hbox",enableSplitters:!0,align:"stretch"},items:[{xtype:"container",itemId:"cn_mail-mailmessagegridcontainer",cls:"messageGridContainer shadow-panel",bind:{margin:"{computeMessageGridMargin}"},layout:{type:"vbox",align:"stretch"},flex:1,items:[{flex:1,xtype:"box",margin:"0 5 5 0",hidden:!1,cls:"cn-lightestBox shadow-panel",bind:{hidden:"{cn_mail_ref_mailfoldertree.selection}"},data:{indicatorIcon:"fa-folder",indicatorText:"Select a folder to view its contents."},itemId:"msgIndicatorBox",tpl:["<div class=\"messageIndicator\">","<div class=\"far {indicatorIcon} icon\"></div>","<div>{indicatorText}</div>","</div>"]},{flex:1,hidden:!0,xtype:"cn_mail-mailaccountview",bind:{mailAccount:"{cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\" && cn_mail_ref_mailfoldertree.selection}",hidden:"{!cn_mail_ref_mailfoldertree.selection || cn_mail_ref_mailfoldertree.selection.folderType !== \"ACCOUNT\"}"}},{flex:1,hidden:!0,xtype:"cn_mail-mailmessagegrid",reference:"cn_mail_ref_mailmessagegrid",bind:{representedFolderType:"{cn_mail_ref_mailfoldertree.selection.folderType}",title:"{cn_mail_ref_mailfoldertree.selection.name}",hidden:"{!cn_mail_ref_mailfoldertree.selection || cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\"}",store:"{cn_mail_mailmessageitemstore}"}}]},{flex:1,xtype:"cn_mail-mailmessagereadermessageview",margin:"0 5 5 0",header:!1,hidden:!0,bind:{contextButtonsEnabled:"{cn_mail_ref_mailmessagegrid.selection}",hidden:"{messageViewHidden || (!cn_mail_ref_mailfoldertree.selection || cn_mail_ref_mailfoldertree.selection.folderType === \"ACCOUNT\")}",messageItem:"{cn_mail_ref_mailmessagegrid.selection}"}}]}],toggleReadingPane:function(a){a=(a==="right"||a==="bottom")?a:!1;var d=this,g=a==="right"?"vertical":"horizontal",f=a==="right"?"left":"bottom",c=d.down("#cn_mail-mailInboxViewPanelBody"),b=c.down("cn_mail-mailmessagereadermessageview"),e=c.down("#cn_mail-mailmessagegridcontainer");if(!a){d.getViewModel().set("messageViewHidden",!0);return}d.getViewModel().set("messageViewHidden",!1);d.getViewModel().notify();b.splitter.destroy();b.splitter=null;b.collapseDirection=f;c.getLayout().setVertical(a!=="right");c.getLayout().insertSplitter(b,1,!1,{collapseTarget:"next"});b.splitter.setOrientation(g);if(a==="right"){e.setMargin("0 0 5 0")}else {e.setMargin("0 5 0 0")}},updateViewForCreatedDraft:function(a){const b=this;b.getController().updateViewForCreatedDraft(a)},updateViewForSentDraft:function(a){const b=this;b.getController().updateViewForSentDraft(a)},showMailAccountIsBeingEditedNotice:function(e){var a=this,d=a.getIconCls(),f=a.down("cn_mail-mailfoldertree"),c=a.down("cn_mail-mailaccountview"),b;b=Ext.create("coon.comp.component.MessageMask",{title:"Pending Changes",message:"The changes to the Email-Account have not been saved yet. Do you want to discard the changes?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:function(a){const b=this;b.setIconCls(d);if(a==="yesButton"){c.rejectPendingChanges();f.getSelectionModel().select(e);return}},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);b.show();return b}});Ext.define("conjoon.cn_mail.view.mail.message.editor.AttachmentListController",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentListController",requires:["coon.core.util.Mime","conjoon.cn_mail.model.mail.message.DraftAttachment"],alias:"controller.cn_mail-mailmessageeditorattachmentlistcontroller",control:{"cn_mail-mailmessageeditorattachmentlist":{"beforedestroy":"onAttachmentListBeforeDestroy"}},addAttachment:function(a){var f=this,g=f.getView(),e=g.getStore(),d=e.getModel().getName(),h=d==="conjoon.cn_mail.model.mail.message.DraftAttachment",b,c;if(!(a instanceof File)){Ext.raise({source:Ext.getClassName(this),msg:"argument for addAttachment must be a native File Object"})}if(!h){Ext.raise({source:Ext.getClassName(this),msg:"The store's model must be of type DraftAttachment."})}c=Ext.create(d,{text:a.name,size:a.size,type:a.type,downloadUrl:window.URL.createObjectURL(a),file:a});e.add(c);if(coon.core.util.Mime.isImage(a.type)){b=new FileReader();b.addEventListener("load",f.onFileReaderLoad.bind(this),{once:!0});b.cn_id=c.getId();b.readAsDataURL(a)}return c},onFileReaderLoad:function(b){var f=this,d=f.getView(),c=d.getStore(),e=b.target.cn_id,a;a=c.findExact("localId",e);if(a===-1){return}a=c.getAt(a);a.set("previewImgSrc",b.target.result);b=null;return a},onAttachmentItemClick:function(b,a,f,e,c,d){if(c.target.className.indexOf("removebutton")!==-1){b.getStore().remove(a)}},onAttachmentListBeforeDestroy:function(){var b=this,a=b.getView().getStore(),c=a&&!a.destroyed?a.getRange():[];b.destroyFileAssociations(c)},privates:{destroyFileAssociations:function(b){for(var a=0,c=b.length;a<c;a++){window.URL.revokeObjectURL(b[a].get("downloadUrl"))}}}});Ext.define("conjoon.cn_mail.view.mail.message.editor.AttachmentList",{extend:"conjoon.cn_mail.view.mail.message.AbstractAttachmentList",requires:["conjoon.cn_mail.model.mail.message.AbstractAttachment","conjoon.cn_mail.view.mail.message.editor.AttachmentListController","coon.core.util.Mime"],alias:"widget.cn_mail-mailmessageeditorattachmentlist",controller:"cn_mail-mailmessageeditorattachmentlistcontroller",config:{editMode:undefined},applyEditMode:function(a){var b=this;a=a===undefined?"CREATE":a;if(Ext.Array.indexOf(["CREATE","EDIT"],a)===-1){Ext.raise({source:Ext.getClassName(b),msg:"editMode must be one of EDIT or CREATE"});return}if(b.getEditMode()===undefined){return a}else {Ext.raise({source:Ext.getClassName(b),msg:"Property editMode cannot be changed during runtime"})}},addAttachment:function(a){return this.getController().addAttachment(a)},displayButtonType:function(a){return !0}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditorDragDropListener",{dragEnterCount:0,view:null,constructor:function(a){var b=this;Ext.apply(b,a)},init:function(){var a=this,b=a.view;b.on("afterrender",a.installDragDropListeners,a,{single:!0})},installDragDropListeners:function(){var a=this,b=a.view,c=b.down("#attachmentListWrap").el;b.mon(c,"dragenter",a.onAttachmentListWrapDragEnter,a);b.mon(c,"dragover",a.onAttachmentListWrapDragOver,a);b.mon(c,"dragleave",a.onAttachmentListWrapDragLeave,a);b.mon(c,"dragend",a.onAttachmentListWrapDragEnd,a);b.mon(c,"drop",a.onAttachmentListWrapDrop,a)},registerAttachmentListWrapEnter:function(c,b){var a=this,d=a.view;if(c){a.dragEnterCount++}else {a.dragEnterCount--}a.dragEnterCount=a.dragEnterCount<0||b===!0?0:a.dragEnterCount;d.down("#attachmentListWrap").el[a.dragEnterCount?"addCls":"removeCls"]("hover")},onAttachmentListWrapDragOver:function(a){a.preventDefault()},onAttachmentListWrapDragEnter:function(b){b.preventDefault();var a=this;a.registerAttachmentListWrapEnter(!0)},onAttachmentListWrapDragLeave:function(b){b.preventDefault();var a=this;a.registerAttachmentListWrapEnter(!1)},onAttachmentListWrapDragEnd:function(b){b.preventDefault();var a=this;a.registerAttachmentListWrapEnter(!1,!0)},onAttachmentListWrapDrop:function(c){c.preventDefault();var b=this,a=c.event.dataTransfer,d=b.view.getController();b.registerAttachmentListWrapEnter(!1,!0);if(a&&a.files){d.addAttachmentsFromFileList(a.files)}}});Ext.define("conjoon.cn_mail.data.mail.message.EditingModes",{statics:{EDIT:"EDIT",CREATE:"CREATE",REPLY_TO:"REPLY_TO",REPLY_ALL:"REPLY_ALL",FORWARD:"FORWARD"}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditorViewController",{extend:"Ext.app.ViewController",requires:["l8","coon.core.ConfigManager","conjoon.cn_mail.view.mail.message.editor.MessageEditorDragDropListener","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.service.MailboxService"],alias:"controller.cn_mail-mailmessageeditorviewcontroller",control:{"cn_mail-mailmessageeditorhtmleditor > toolbar > cn_comp-formfieldfilebutton":{change:"onFormFileButtonChange"},"#showCcBccButton":{click:"onShowCcBccButtonClick"},"#sendButton":{click:"onSendButtonClick"},"#saveButton":{click:"onSaveButtonClick"},"cn_mail-mailmessageeditor":{"beforedestroy":"onMailMessageEditorBeforeDestroy","cn_mail-mailmessagesaveoperationcomplete":"onMailMessageSaveOperationComplete","cn_mail-mailmessagesaveoperationexception":"onMailMessageSaveOperationException","cn_mail-mailmessagesavecomplete":"onMailMessageSaveComplete","cn_mail-mailmessagebeforesave":"onMailMessageBeforeSave","cn_mail-mailmessagebeforesend":"onMailMessageBeforeSend","cn_mail-mailmessagesendcomplete":"onMailMessageSendComplete","cn_mail-mailmessagesendexception":"onMailMessageSendException"}},deferTimers:null,ddListener:null,mailboxService:null,closeAfterMs:1000,init:function(){var a=this,b=a.getView();a.deferTimers={};a.ddListener=Ext.create("conjoon.cn_mail.view.mail.message.editor.MessageEditorDragDropListener",{view:b});b.on({"afterrender":{fn:a.onMessageEditorAfterrender,scope:a,single:!0},"beforeclose":{fn:a.onMailEditorBeforeClose,scope:a}});a.ddListener.init()},onMessageEditorAfterrender:function(e){var d=this,a=d.getView(),c,b;a.showMessageDraftLoadingNotice(a.editMode==="CREATE");if(a.editMode===conjoon.cn_mail.data.mail.message.EditingModes.FORWARD){c=a.down("#toField");d.deferTimers["toFieldFocus"]=Ext.Function.defer(c.focus,100,c)}else {b=a.down("cn_mail-mailmessageeditorhtmleditor");d.deferTimers["htmlEditorFocus"]=Ext.Function.defer(b.focus,100,b)}},onMailEditorBeforeClose(){const b=this,c=b.getViewModel(),a=b.getView();if(!a.getMessageDraft()||!c.isDraftDirty()){return !0}b.redirectTo(a.cn_href);a.showConfirmCloseDialog();return !1},onMailMessageEditorBeforeDestroy:function(){var a=this,b=a.getView();for(var c in a.deferTimers){if(!Object.prototype.hasOwnProperty.call(a.deferTimers,c)){continue}window.clearTimeout(a.deferTimers[c]);delete a.deferTimers[c]}if(b.busyMask){b.busyMask.destroy();b.busyMask=null}if(b.loadingMask){b.loadingMask.destroy();b.loadingMask=null}if(a.ddListener){a.ddListener.destroy();a.ddListener=null}},addAttachmentsFromFileList:function(b){var f=this,d=f.getView(),c=d.down("cn_mail-mailmessageeditorattachmentlist");for(var a=0,e=b.length;a<e;a++){c.addAttachment(b[a])}},onFormFileButtonChange:function(c,e,d,a){var b=this;b.addAttachmentsFromFileList(a)},onShowCcBccButtonClick:function(c){var b=this,a=b.getView();a.showCcBccFields(a.down("#ccField").isHidden())},onSendButtonClick:function(b){var a=this;a.configureAndStartSaveBatch(!0)},onSaveButtonClick:function(b){var a=this;a.configureAndStartSaveBatch()},onMailMessageSaveOperationComplete:function(d,c,a){var b=this;b.setViewBusy(a)},onMailMessageSaveOperationException:function(h,b,e,d,c,f){var a=this,g=a.getView();a.endBusyState("saving");g.showMailMessageSaveFailedNotice(b,e,Ext.Function.bindCallback(function(k,j,l,g){var i=this,a=i.getView();if(g!=="yesButton"||a.fireEvent("cn_mail-mailmessagebeforesave",a,b,k,j,!0)===!1){if(g!=="yesButton"){a.getViewModel().get("messageDraft.attachments").rejectChanges()}i.endBusyState("saving");return}l.retry()},a,[d,c,f]));return !1},onMailMessageSaveComplete:function(f,d,c,b,e){var a=this;a.setViewBusy(c,1);if(b!==!0){a.deferTimers["savecomplete"]=Ext.Function.defer(a.endBusyState,750,a,["saving"])}else {a.deferTimers["savecompletesend"]=Ext.Function.defer(function(){var a=this;a.endBusyState("saving");a.sendMessage()},750,a)}},onMailMessageBeforeSave:function(k,a,j,i){var h=this,e=h.getView(),d=e.getViewModel();if(!a.get("mailFolderId")||!a.get("mailAccountId")){Ext.raise({msg:"compound key for message draft missing",mailAccountId:a.get("mailAccountId"),mailFolderId:a.get("mailFolderId")});return !1}if(!Ext.String.trim(a.get("subject"))&&d.get("isSubjectRequired")===!0){e.showSubjectMissingNotice(a,Ext.Function.bindCallback(function(c,b,d,e,f){var g=this;if(e!=="okButton"){return}if(!Ext.String.trim(f)){d.set("isSubjectRequired",!1)}g.configureAndStartSaveBatch(c,b)},h,[j,i,d]));return !1}let g=d.get("messageDraft.attachments").getRange(),b,c;for(let f=g.length-1;f>=0;f--){b=g[f];c=b.modified?Object.keys(b.modified):null;if(b.crudState==="U"&&c&&c.length===1&&c[0]==="messageItemId"){b.commit(!0)}}d.set("isSaving",!0);e.setBusy({msg:"Saving Mail",msgAction:"Stand by..."})},onMailMessageBeforeSend:function(e,a){var c=this,b=c.getView(),d=b.getViewModel();if(!a.get("to").length&&!a.get("cc").length&&!a.get("bcc").length){b.showAddressMissingNotice(a);return !1}d.set("isSending",!0);b.setBusy({msg:"Sending Mail",msgAction:"Please wait..."})},onMailMessageSendComplete(d,c){const a=this,b=a.getView();b.setBusy({msgAction:"Message sent successfully.",progress:1});b.un("beforeclose",a.onMailEditorBeforeClose,a);a.deferTimers.sendcomplete=Ext.Function.defer(b.close,a.closeAfterMs,b)},onMailMessageSendException:function(e,d){var a=this,b=a.getView(),c=b.getViewModel();c.set("isSending",!1);b.setBusy({msgAction:"Error :(",progress:1});a.deferTimers["sendexception"]=Ext.Function.defer(a.endBusyState,750,a,["sending"])},privates:{getSendMessageDraftRequestConfig:function(b,a){if(!l8.isString(a)){throw ("\"baseAddress\" must be a string")}return {url:l8.unify(a+"/SendMessage","/","://"),params:b.getCompoundKey().toObject()}},sendMessage:function(){"use strict";const c=this,a=c.getView(),e=a.getViewModel(),b=e.get("messageDraft");if(b.dirty||b.phantom){Ext.raise({msg:"Cannot send MessageDraft: Needs to get saved before.",cls:Ext.getClassName(c)})}if(a.fireEvent("cn_mail-mailmessagebeforesend",a,b)===!1){return !1}const d=coon.core.ConfigManager.get("extjs-app-webmail","service.rest-api-email.base");Ext.Ajax.request(c.getSendMessageDraftRequestConfig(b,d)).then(function(c,d){a.fireEvent("cn_mail-mailmessagesendcomplete",a,b)},function(c,d){a.fireEvent("cn_mail-mailmessagesendexception",a,b)})},configureAndStartSaveBatch:function(e){var f=this,a=f.getView(),h=a.getViewModel(),g=a.getSession(),b=h.get("messageDraft"),d=b.phantom===!0,c;f.applyAccountInformation(b);if(a.fireEvent("cn_mail-mailmessagebeforesave",a,b,e===!0,d===!0)===!1){return !1}c=g.getSaveBatch();c.setPauseOnException(!0);c.on({operationcomplete:{fn:function(d,c){a.fireEvent("cn_mail-mailmessagesaveoperationcomplete",a,b,c)},scope:a},exception:{fn:function(f,c){a.fireEvent("cn_mail-mailmessagesaveoperationexception",a,b,c,e===!0,d===!0,f)},scope:a},complete:{fn:function(f,c){b.set("savedAt",new Date());a.fireEvent("cn_mail-mailmessagesavecomplete",a,b,c,e===!0,d===!0)},scope:a,single:!0}});c.start()},applyAccountInformation:function(a){const d=this,f=d.getView(),g=f.getViewModel(),e=d.getMailboxService(),c=a.get("mailAccountId");if(!a.get("mailFolderId")){let b=e.getMailFolderHelper().getMailFolderIdForType(c,conjoon.cn_mail.data.mail.folder.MailFolderTypes.DRAFT);if(!b){Ext.raise({msg:"Unexpected error: No draft folder for mailAccountId found",mailAccountId:c})}a.set("mailFolderId",b)}let b=g.get("cn_mail_mailfoldertreestore").findRecord("id",c);a.set("from",{name:b.get("from").name,address:b.get("from").address});a.set("replyTo",{name:b.get("replyTo").name,address:b.get("replyTo").address});a.set("date",new Date())},getMailboxService:function(){const a=this;if(!a.mailboxService){a.mailboxService=conjoon.cn_mail.MailboxService.getInstance()}return a.mailboxService},endBusyState:function(a){var c=this,b=c.getView(),d=b.getViewModel();switch(a){case "sending":d.set("isSending",!1);break;case "saving":d.set("isSaving",!1);break;default:Ext.raise({msg:"Unknown busy type.",type:a,cls:Ext.getClassName(c)});}b.setBusy(!1)},setViewBusy:function(a,b){var d=this,c=d.getView();c.setBusy({msgAction:Ext.String.format("{1} {0}.",a.getAction()==="destroy"?"removed":"saved",a.entityType.entityName),progress:b})}}});Ext.define("conjoon.cn_mail.model.mail.message.EmailAddress",{extend:"conjoon.cn_mail.model.mail.BaseModel",entityName:"EmailAddress",idProperty:"id",fields:[{name:"name",type:"string"},{name:"address",type:"string"}]});Ext.define("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",{config:{to:undefined,cc:undefined,bcc:undefined,subject:undefined,seen:!0,textPlain:undefined,textHtml:undefined,attachments:undefined,answered:!1,recent:!1,draft:!0,flagged:!1,mailAccountId:undefined,mailFolderId:undefined,references:undefined,inReplyTo:undefined,xCnDraftInfo:undefined},constructor:function(a){this.initConfig(a)},toObject:function(){var a=this,b={};if(a.getTo()!==undefined){b.to=a.getTo()}if(a.getCc()!==undefined){b.cc=a.getCc()}if(a.getBcc()!==undefined){b.bcc=a.getBcc()}if(a.getSubject()!==undefined){b.subject=a.getSubject()}if(a.getTextPlain()!==undefined){b.messageBody=b.messageBody||{};b.messageBody.textPlain=a.getTextPlain()}if(a.getTextHtml()!==undefined){b.messageBody=b.messageBody||{};b.messageBody.textHtml=a.getTextHtml()}if(a.getAttachments()!==undefined){b.attachments=a.getAttachments()}if(a.getSeen()!==undefined){b.seen=a.getSeen()}if(a.getAnswered()!==undefined){b.answered=a.getAnswered()}if(a.getDraft()!==undefined){b.draft=a.getDraft()}if(a.getFlagged()!==undefined){b.flagged=a.getFlagged()}if(a.getRecent()!==undefined){b.recent=a.getRecent()}if(a.getMailFolderId()!==undefined){b.mailFolderId=a.getMailFolderId()}if(a.getMailAccountId()!==undefined){b.mailAccountId=a.getMailAccountId()}if(a.getReferences()!==undefined){b.references=a.getReferences()}if(a.getInReplyTo()!==undefined){b.inReplyTo=a.getInReplyTo()}if(a.getXCnDraftInfo()!==undefined){b.xCnDraftInfo=a.getXCnDraftInfo()}return b},applyFlagged:function(b){var a=this;if(a.getFlagged()!==undefined){Ext.raise({flagged:a.getFlagged(),msg:"\"flagged\" is immutable"})}return b},applySeen:function(b){var a=this;if(a.getSeen()!==undefined){Ext.raise({seen:a.getSeen(),msg:"\"seen\" is immutable"})}return b},applyRecent:function(b){var a=this;if(a.getRecent()!==undefined){Ext.raise({recent:a.getRecent(),msg:"\"recent\" is immutable"})}return b},applyDraft:function(b){var a=this;if(a.getDraft()!==undefined){Ext.raise({draft:a.getDraft(),msg:"\"draft\" is immutable"})}return b},applyAnswered:function(b){var a=this;if(a.getAnswered()!==undefined){Ext.raise({answered:a.getAnswered(),msg:"\"answered\" is immutable"})}return b},applyTextPlain:function(b){var a=this;if(a.getTextPlain()!==undefined){Ext.raise({textPlain:a.getTextPlain(),msg:"\"textPlain\" is immutable"})}return b},applyTextHtml:function(b){var a=this;if(a.getTextHtml()!==undefined){Ext.raise({textHtml:a.getTextHtml(),msg:"\"textHtml\" is immutable"})}return b},applySubject:function(b){var a=this;if(a.getSubject()!==undefined){Ext.raise({subject:a.getSubject(),msg:"\"subject\" is immutable"})}return b},applyMailFolderId:function(b){var a=this;if(a.getMailFolderId()!==undefined){Ext.raise({mailFolderId:a.getMailFolderId(),msg:"\"mailFolderId\" is immutable"})}return b},applyMailAccountId:function(b){var a=this;if(a.getMailAccountId()!==undefined){Ext.raise({mailAccountId:a.getMailAccountId(),msg:"\"mailAccountId\" is immutable"})}return b},applyAttachments:function(a){var d=this,c=[];if(a===undefined){return}if(d.getAttachments()!==undefined){Ext.raise({attachments:d.getAttachments(),msg:"\"attachments\" is immutable"})}if(!Ext.isArray(a)){Ext.raise({attachments:a,msg:"\"attachments\" must be an array"})}for(var b=0,e=a.length;b<e;b++){c.push(Ext.copy({},a[b],"type,text,size,previewImgSrc,downloadImgUrl,sourceId"))}return c},applyTo:function(b){var a=this;return a.applyAddressFactory(b,"to")},applyCc:function(a){var b=this;return b.applyAddressFactory(a,"cc")},applyBcc:function(a){var b=this;return b.applyAddressFactory(a,"bcc")},applyAddressFactory:function(a,c){var g=this,b=a,e;if(g["get"+c.charAt(0).toUpperCase()+c.substring(1)]()!==undefined){Ext.raise({value:a,type:c,msg:"\""+c+"\" is immutable"})}if(Ext.isString(a)&&a!==""){b=[{name:a,address:a}]}else if(Ext.isArray(b)){b=[];for(var d=0,f=a.length;d<f;d++){e=a[d];if(Ext.isObject(e)){if(Object.prototype.hasOwnProperty.call(e,"address")&&Object.prototype.hasOwnProperty.call(e,"name")){b.push(e)}else {Ext.raise({value:a,type:c,msg:"\""+c+"\" seems to be malformed"})}}else if(a[d]!==""){b.push({name:a[d],address:a[d]})}}}return b},applyReferences:function(b){var a=this;if(a.getReferences()!==undefined){Ext.raise({references:a.getReferences(),msg:"\"references\" is immutable"})}return b},applyInReplyTo:function(b){var a=this;if(a.getInReplyTo()!==undefined){Ext.raise({inReplyTo:a.getInReplyTo(),msg:"\"inReplyTo\" is immutable"})}return b},applyXCnDraftInfo:function(b){var a=this;if(a.getXCnDraftInfo()!==undefined){Ext.raise({xCnDraftInfo:a.getXCnDraftInfo(),msg:"\"xCnDraftInfo\" is immutable"})}return b}});Ext.define("conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest",{requires:["conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],config:{compoundKey:undefined,editMode:undefined,defaultMailAccountId:undefined,defaultMailFolderId:undefined},constructor:function(a){var b=this;a=a||{};if(!Object.prototype.hasOwnProperty.call(a,"compoundKey")){Ext.raise({config:a,msg:"Property \"compoundKey\" must be specified."})}if(!Object.prototype.hasOwnProperty.call(a,"editMode")){Ext.raise({config:a,msg:"Property \"editMode\" must be specified."})}b.initConfig(a)},isConfigured:function(){const a=this;return !!(a.getDefaultMailFolderId()&&a.getDefaultMailAccountId())},applyDefaultMailFolderId:function(b){var a=this;if(a.getDefaultMailFolderId()!==undefined){Ext.raise({compoundKey:a.getDefaultMailFolderId(),msg:"Property \"defaultMailFolderId\" was already set."})}return b},applyDefaultMailAccountId:function(b){var a=this;if(a.getDefaultMailAccountId()!==undefined){Ext.raise({compoundKey:a.getDefaultMailAccountId(),msg:"Property \"defaultMailAccountId\" was already set."})}return b},applyCompoundKey:function(a){var b=this;if(b.getCompoundKey()!==undefined){Ext.raise({compoundKey:b.getCompoundKey(),msg:"Property \"compoundKey\" was already set."})}if(!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:a})}return a},applyEditMode:function(b){var d=this,c,a;if(d.getEditMode()!==undefined){Ext.raise({editMode:d.getEditMode(),msg:"Property \"editMode\" was already set."})}a=conjoon.cn_mail.data.mail.message.EditingModes;c=[a.REPLY_TO,a.REPLY_ALL,a.FORWARD];if(c.indexOf(b)===-1){Ext.raise({editMode:b,msg:Ext.String.format("Property \"editMode\" must be one of {0}.",c.join(", "))})}return b}});Ext.define("conjoon.cn_mail.text.mail.message.CopyDecorator",{requires:["conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig"],messageDraft:null,constructor:function(a){var b=this;if(!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise({messageDraft:a,msg:"\"messageDraft\" must be an instance of conjoon.cn_mail.model.mail.message.MessageDraft",cls:Ext.getClassName(b)})}if(!a.getMessageBody()||a.getMessageBody().loadOperation){Ext.raise({messageDraft:a,msg:"\"MessageBody\" of messageDraft is not available",cls:Ext.getClassName(b)})}if(a.attachments().getRange().length===0&&!a.attachments().isLoaded()){Ext.raise({messageDraft:a,msg:"\"Attachments\" of messageDraft are not available",cls:Ext.getClassName(b)})}b.messageDraft=a},getTextPlain:function(){var a=this;return a.messageDraft.getMessageBody().get("textPlain")},getTextHtml:function(){var a=this;return a.messageDraft.getMessageBody().get("textHtml")},getSubject:function(){var a=this;return a.messageDraft.get("subject")},getSeen:function(){return !0},getDraft:function(){return !0},getAnswered:function(){return !1},getRecent:function(){return !1},getFlagged:function(){return !1},getFrom:function(){var b=this,a=b.messageDraft.get("from");return a?Ext.copy({},a,"name,address"):null},getReplyTo:function(){var b=this,a=b.messageDraft.get("replyTo");return a?Ext.copy({},a,"name,address"):b.getFrom()},getTo:function(){return this.copyAddresses("to")},getCc:function(){return this.copyAddresses("cc")},getBcc:function(){return this.copyAddresses("bcc")},getAttachments:function(){var e=this,c=e.messageDraft.attachments().getRange(),b=[];for(var a=0,d=c.length;a<d;a++){b.push(Ext.copy({},c[a].data,"type,text,size,previewImgSrc,downloadImgUrl,sourceId"))}return b},toMessageDraftConfig:function(b={}){const a=this;let c=Ext.applyIf({to:a.getTo(),cc:a.getCc(),bcc:a.getBcc(),subject:a.getSubject(),textPlain:a.getTextPlain(),textHtml:a.getTextHtml(),attachments:a.getAttachments(),seen:a.getSeen(),flagged:a.getFlagged(),answered:a.getAnswered(),draft:a.getDraft(),recent:a.getRecent()},b);return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",c)},privates:{copyAddresses:function(a){var f=this,e=["to","cc","bcc"],c=f.messageDraft.get(a),d=[];if(e.indexOf(a)===-1){Ext.raise({type:a,msg:Ext.String.format("\"type\" is not in list of {0}",e.join(", ")),cls:Ext.getClassName(f)})}for(var b=0,g=c.length;b<g;b++){d.push(Ext.copy({},c[b],"name,address"))}return d}}});Ext.define("conjoon.cn_mail.text.mail.message.DecoratorFormat",{singleton:!0,stringifyEmailAddress:function(d){var b=[].concat(d),c=[];for(var a=0,e=b.length;a<e;a++){if(!b[a]){continue}c.push(Ext.String.format("&lt;{0}&gt; {1}",b[a].address,b[a].name))}return c.join(", ")}});Ext.define("conjoon.cn_mail.text.mail.message.ForwardMessageDecorator",{extend:"conjoon.cn_mail.text.mail.message.CopyDecorator",requires:["conjoon.cn_mail.text.mail.message.DecoratorFormat"],getTo:function(){return []},getCc:function(){return []},getBcc:function(){return []},getTextHtml:function(){var b=this,a=b.messageDraft;return ["<br /><br />",b.getMessageBodyIntroText(a),"<br/>","<blockquote style=\"margin-left:4px;padding-left:10px;border-left:4px solid #bee9fc\">",b.getMessageBodyIntroHeaderFields(a),"<br /><br />",a.getMessageBody().get("textHtml"),"</blockquote>"].join("")},getMessageBodyIntroText:function(a){return "--- Begin of the forwarded message:"},getMessageBodyIntroHeaderFields:function(a){var d=a.get("from"),b=conjoon.cn_mail.text.mail.message.DecoratorFormat,c;c=[Ext.String.format("<b>From:</b> {0}",b.stringifyEmailAddress(d)),Ext.String.format("<b>Date:</b> {0}",Ext.util.Format.date(a.get("date"),"d.m.Y H:i")),Ext.String.format("<b>To:</b> {0}",b.stringifyEmailAddress(a.get("to"))),Ext.String.format("<b>Subject:</b> {0}",a.get("subject")),Ext.String.format("<b>Reply to:</b> {0}",a.get("replyTo")?b.stringifyEmailAddress(a.get("replyTo")):b.stringifyEmailAddress(d))].join("<br />");return c}});Ext.define("conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator",{extend:"conjoon.cn_mail.text.mail.message.CopyDecorator",requires:["conjoon.cn_mail.text.mail.message.DecoratorFormat"],getTo:function(){var a=this;return [a.getReplyTo()]},getCc:function(){return []},getBcc:function(){return []},getTextHtml:function(){var b=this,a=b.messageDraft;return ["<br /><br/>","<blockquote style=\"margin-left:4px;padding-left:10px;border-left:4px solid #bee9fc\">",b.getMessageBodyIntroHeaderFields(a),"<br /><br />",a.getMessageBody().get("textHtml"),"</blockquote>"].join("")},getMessageBodyIntroHeaderFields:function(a){var d=a.get("from"),c=conjoon.cn_mail.text.mail.message.DecoratorFormat,b;b=[Ext.String.format("<b>On {0} at {1}, {2} wrote:</b>",Ext.util.Format.date(a.get("date"),"d.m.Y"),Ext.util.Format.date(a.get("date"),"H:i"),c.stringifyEmailAddress(d))].join("<br />");return b},getAttachments:function(){return []},getReferences:function(){const c=this,d=c.messageDraft,b=d.get("messageId");let a=c.messageDraft.get("references");return a?a+" "+b:b},getInReplyTo:function(){const c=this,a=c.messageDraft,b=a.get("messageId");return b},getXCnDraftInfo:function(){const b=this,a=b.messageDraft;return btoa(Ext.encode([a.get("mailAccountId"),a.get("mailFolderId"),a.get("id")]))},toMessageDraftConfig:function(a={}){const b=this;a["references"]=b.getReferences();a["inReplyTo"]=b.getInReplyTo();a["xCnDraftInfo"]=b.getXCnDraftInfo();return b.callParent([a])}});Ext.define("conjoon.cn_mail.text.mail.message.ReplyAllMessageDecorator",{extend:"conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator",requires:["conjoon.cn_mail.text.mail.message.DecoratorFormat"],getTo:function(){var a=this;return a.callParent().concat(a.copyAddresses("to"))},getCc:function(){var a=this;return a.copyAddresses("cc")}});Ext.define("conjoon.cn_mail.data.mail.message.editor.MessageDraftCopier",{requires:["conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.text.mail.message.ForwardMessageDecorator","conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator","conjoon.cn_mail.text.mail.message.ReplyAllMessageDecorator","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest"],loadMessageDraftCopy:function(a,c,e){var b=this,f,d;if(!(a instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest)){Ext.raise({messageDraftCopyRequest:a,msg:"\"messageDraftCopyRequest\" must be an instance of conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest"})}if(!a.isConfigured()){Ext.raise({msg:"\"messageDraftCopyRequest\" is not fully configured",messageDraftCopyRequest:a})}if(!Ext.isFunction(c)){Ext.raise({callback:c,msg:"\"callback\" must be a valid callback"})}f=a.getCompoundKey();d=a.getEditMode();conjoon.cn_mail.model.mail.message.MessageDraft.loadEntity(f,{success:Ext.Function.bind(b.onMessageDraftLoad,b,[d,c,e,a],!0),failure:Ext.Function.bind(b.onLoadMessageDraftCopyFailure,b,[c,e],!0),scope:b})},privates:{onMessageDraftLoad:function(c,g,f,b,d,e){var a=this;c.loadMessageBody({success:Ext.Function.bind(a.onMessageBodyLoad,a,[c,f,b,d,e],!0),failure:Ext.Function.bind(a.onLoadMessageDraftCopyFailure,a,[b,d],!0),scope:a})},onMessageBodyLoad:function(h,g,b,e,d,f,c){var a=this;b.loadAttachments({callback:Ext.Function.bind(a.onAttachmentsLoad,a,[b,e,d,f,c],!0),scope:a})},onAttachmentsLoad:function(c,h,a,f,j,i,k,e){var d=this,g=[];if(a){for(var b=0,l=c.length;b<l;b++){g.push(c[b].copy(null))}}i.apply(k||null,[d,a?d.createMessageDraftConfig(f,j,e):null,a,h])},onLoadMessageDraftCopyFailure:function(e,a,b,c){const d=this;b.apply(c||null,[d,null,!1,a])},createMessageDraftConfig:function(b,d,c){var a=null;switch(d){case conjoon.cn_mail.data.mail.message.EditingModes.FORWARD:a=Ext.create("conjoon.cn_mail.text.mail.message.ForwardMessageDecorator",b);break;case conjoon.cn_mail.data.mail.message.EditingModes.REPLY_TO:a=Ext.create("conjoon.cn_mail.text.mail.message.ReplyToMessageDecorator",b);break;case conjoon.cn_mail.data.mail.message.EditingModes.REPLY_ALL:a=Ext.create("conjoon.cn_mail.text.mail.message.ReplyAllMessageDecorator",b);break;}return a.toMessageDraftConfig({mailAccountId:c.getDefaultMailAccountId(),mailFolderId:c.getDefaultMailFolderId()})}}});Ext.define("conjoon.cn_mail.data.mail.message.session.MessageCompoundBatchVisitor",{extend:"coon.core.data.session.SplitBatchVisitor",config:{messageDraft:undefined},applyMessageDraft:function(a){const b=this;if(b.getMessageDraft()){Ext.raise("\"messageDraft\" was already set")}if(a!==undefined&&!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise("\"messageDraft\" must be an instance of conjoon.cn_mail.model.mail.message.MessageDraft")}return a},getBatch:function(c){const a=this,b=a.callParent(arguments);b.un("operationcomplete",a.onBatchOperationComplete,a);b.on("operationcomplete",a.onBatchOperationComplete,a);b.start=Ext.Function.createInterceptor(b.start,function(){const b=this,a=b.getMessageDraft();a.storePreBatchCompoundKey()},a);return b},onBatchOperationComplete:function(g,f){const d=this;if(f.hasException()){return null}let i=g.current+1,e=g.getOperations(),b=e[i],a,c,h;if(!d.getMessageDraft()){Ext.raise("Missing messageDraft configuration.")}d.seedRetrievedKey(f);d.refreshKeyForDestroy(b);if(!b){return null}a=b.getRecords();if(!a||!a.length){return null}if(a.length>1){Ext.raise("Unexpected number of records. Need 1, got "+a.length)}a=a[0];c=null;if(d.isOperationSwappable(b)){h=a.getProxy();c=h.createOperation("update",{records:[a],params:{origin:b.getAction()}});c.entityType=Ext.getClass(a);b.destroy();b=null;e[i]=c}return c},seedRetrievedKey:function(a){if(!a||!a.getRecords()){return !1}const g=this,f=a.getRecords()[0],c=g.getMessageDraft(),b=a.getResponse(),d=b.responseType,e=d==="json"?b.responseJson:Ext.decode(b.responseText);if(a.getAction()==="destroy"&&f.entityName==="DraftAttachment"){c.set("id",e.data.id);c.commit();return !0}return !1},refreshKeyForDestroy:function(b){if(!b||b.getAction()!=="destroy"){return !1}const d=this,a=b.getRecords()[0],c=d.getMessageDraft();if(a.entityName!=="DraftAttachment"){Ext.raise("no handler for \""+a.entityName+"\" found")}a.reject();a.set("parentMessageItemId",c.get("id"));a.commit();a.drop();return !0},isOperationSwappable:function(b){let a=b.getRecords();a=Ext.isArray(a)?a[0]:a;return b.getAction()==="create"&&(a.entityName==="MessageDraft"||a.entityName==="MessageItem")&&a.isCompoundKeyConfigured()}});Ext.define("conjoon.cn_mail.data.mail.message.session.MessageDraftSession",{extend:"coon.core.data.Session",requires:["conjoon.cn_mail.data.mail.BaseSchema","conjoon.cn_mail.data.mail.message.session.MessageCompoundBatchVisitor","conjoon.cn_mail.model.mail.message.MessageDraft"],config:{messageDraft:undefined},schema:"cn_mail-mailbaseschema",batchVisitorClassName:"conjoon.cn_mail.data.mail.message.session.MessageCompoundBatchVisitor",applyMessageDraft:function(a){const b=this;if(b.getMessageDraft()){Ext.raise("\"messageDraft\" was already set")}if(a!==undefined&&!(a instanceof conjoon.cn_mail.model.mail.message.MessageDraft)){Ext.raise("\"messageDraft\" must be an instance of conjoon.cn_mail.model.mail.message.MessageDraft")}if(a!==undefined){b.adopt(a)}return a},privates:{createVisitor:function(){const c=this,b=c.callParent(arguments),a=c.getMessageDraft();if(!a){Ext.raise("\"messageDraft\" must be set.")}b.setMessageDraft(a);return b}}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditorViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.model.mail.message.MessageDraft","conjoon.cn_mail.model.mail.message.MessageBody","conjoon.cn_mail.model.mail.message.EmailAddress","conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopier","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.message.session.MessageDraftSession"],alias:"viewmodel.cn_mail-mailmessageeditorviewmodel",loadingDraft:null,loadingFailed:!1,emptySubjectText:"(No subject)",messageDraftCopier:null,pendingCopyRequest:null,data:{isSaving:!1,isSending:!1,isSubjectRequired:!0},formulas:{lastSavedMessage:{bind:{date:"{messageDraft.savedAt}"},get(a){return a.date?`Last saved at ${Ext.Date.format(a.date,"d.m.Y H:i:s")}`:"Opened for editing"}},isPhantom:function(a){return a("messageDraft").phantom&&!a("messageDraft.savedAt")},isAccountAndFolderSet:function(a){var b=a("messageDraft.mailAccountId"),c=a("messageDraft.mailFolderId");return !!(b&&c)},isMessageBodyLoading:function(b){var a=b("messageDraft.messageBody");return a&&a.loading!==undefined?a.loading:!1},isCcOrBccValueSet:{bind:{cc:"{messageDraft.cc}",bcc:"{messageDraft.bcc}"},get:function(a){return !!(a.cc&&a.cc.length)||!!(a.bcc&&a.bcc.length)}},addressStoreData:{single:!0,bind:{to:"{messageDraft.to}",cc:"{messageDraft.cc}",bcc:"{messageDraft.bcc}"},get:function(a){return [].concat(a.to,a.cc,a.bcc)}},getSubject:{bind:{subject:"{messageDraft.subject}"},get:function(a){var b=a.subject||this.emptySubjectText;return b},set:function(a){this.set("messageDraft.subject",a||this.emptySubjectText)}}},stores:{mailAccountStore:{source:"{cn_mail_mailfoldertreestore}",filters:[{property:"folderType",value:"ACCOUNT"}]},addressStore:{model:"conjoon.cn_mail.model.mail.message.EmailAddress",data:"{addressStoreData}"}},constructor:function(c){var a=this,b;if(!c||!c.messageDraft){Ext.raise({source:Ext.getClassName(this),msg:"arguments \"config\" and  \"config.messageDraft\" must be set."})}b=c.messageDraft;delete c.messageDraft;Ext.apply(c,{formulas:a.createAddressFormulas()});a.callParent([c]);let e=a.getSession();if(!(e instanceof conjoon.cn_mail.data.mail.message.session.MessageDraftSession)){Ext.raise({msg:"This ViewModel requires a data session of the type conjoon.cn_mail.data.mail.message.session.MessageDraftSession",session:e})}let g=conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey,f,d;switch(!0){case (b instanceof g):f=b.toLocalId();d=e.peekRecord("MessageDraft",f);if(!d){let d={params:b.toObject(),success:function(b){const a=this,d=a.getView();a.getSession().setMessageDraft(b);b.loadMessageBody({success:function(e){a.set("messageDraft",b);a.notify();a.loadingDraft=null;d.fireEvent("cn_mail-messagedraftload",d,b)},scope:a})},failure:a.processMessageDraftLoadFailure,scope:a};a.loadingDraft=conjoon.cn_mail.model.mail.message.MessageDraft.loadEntity(b,d)}else {a.getSession().setMessageDraft(d);a.set("messageDraft",d)};return;case (b instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig):a.createDraftFromData(b);return;case (b instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest):a.messageDraftCopier=Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftCopier");if(b.isConfigured()){a.pendingCopyRequest=b;a.processPendingCopyRequest()}else {a.pendingCopyRequest=b};return;}Ext.raise({messageDraft:b,msg:"\"messageDraft\" must either be an instance of "+"MessageDraftConfig, of MessageDraftCopyRequest or of "+"MessageEntityCompoundKey."})},processMessageDraftLoadFailure:function(c,b){const a=this;a.loadingFailed=!0;a.loadingDraft=null;if(b.error&&b.error.status===-1){return null}return a.getView().showLoadingFailedDialog()},hasPendingCopyRequest:function(){const a=this;return !!a.pendingCopyRequest},processPendingCopyRequest:function(c,d){const b=this;let a=b.pendingCopyRequest;if(!a){Ext.raise({msg:"\"pendingCopyRequest\" is not available."})}if(!a.isConfigured()){if(!c||!d){Ext.raise({msg:"\"pendingCopyRequest\" is not properly configured, and arguments are missing.",args:arguments,pendingCopyRequest:a})}a.setDefaultMailAccountId(c);a.setDefaultMailFolderId(d)}b.messageDraftCopier.loadMessageDraftCopy(a,b.onMessageDraftCopyLoad,b);b.pendingCopyRequest=null},destroy:function(){var a=this;if(a.messageDraftCopier){a.messageDraftCopier.destroy();a.messageDraftCopier=null}a.callParent(arguments)},privates:{onMessageDraftCopyLoad:function(f,c,e,d){var a=this,b=a.getView();if(e===!1){return a.processMessageDraftLoadFailure(null,d)}a.createDraftFromData(c);a.notify();b.fireEvent("cn_mail-messagedraftload",b,a.get("messageDraft"))},createDraftFromData(c){"use strict";const b=this;let e,d,a;if(!(c instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig)){Ext.raise({messageDraftConfig:c,msg:"\"messageDraftConfig\" must be an instance of conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig"})}a=c.toObject();e=a.messageBody;d=a.attachments;delete a.messageBody;delete a.attachments;b.linkTo("messageDraft",{type:"MessageDraft",create:a});const f=b.getSession();f.setMessageDraft(b.get("messageDraft"));b.set("messageDraft.messageBody",f.createRecord("MessageBody",e||{}));b.get("messageDraft").attachments().add(d||[])},createAddressFormulas:function(){var f=["to","cc","bcc"],a=null,e={},b={},d;for(var c=0,g=f.length;c<g;c++){a=f[c];d="get"+Ext.String.capitalize(a);b={bind:{},get:this.getAddressValuesFromDraft.bind(this,a),set:this.setAddressesForDraft.bind(this,a)};b["bind"][a]="{messageDraft."+a+"}";e[d]=b}return e},getAddressValuesFromDraft:function(e,d){var c=[],b=d[e]||[];for(var a=0,f=b.length;a<f;a++){c.push(b[a]["address"])}return c},setAddressesForDraft:function(g,c){var i=this,a=[],e=i.getStore("addressStore"),d,f;for(var b=0,h=c.length;b<h;b++){d=e.find("address",c[b],0,!1,!1,!0);if(d!==-1){f=e.getAt(d);a.push(Ext.copy({},f.data,"address,name"))}else {a.push({address:c[b]})}}this.set("messageDraft."+g,a);return a},isDraftDirty(){const c=this,b=c.get("messageDraft"),a=b.attachments();return !!b.modified||!!b.getMessageBody().modified||!!a.getRemovedRecords().length||!!a.getRange().filter(a=>a.dirty===!0).length||!!a.getRange().filter(a=>a.phantom===!0).length}}});Ext.define("conjoon.cn_mail.view.mail.message.editor.HtmlEditor",{extend:"Ext.form.field.HtmlEditor",requires:["coon.comp.form.field.FileButton","coon.core.ThemeManager","coon.core.Environment","coon.core.ConfigManager","coon.core.FileLoader","coon.core.Template"],alias:"widget.cn_mail-mailmessageeditorhtmleditor",createToolbar:function(){var c=this,a=c.callParent(arguments);a.add("-");a.add({xtype:"cn_comp-formfieldfilebutton",iconCls:"fas fa-paperclip",tooltip:{title:"Add Attachment(s)...",text:"Add one or more attachments to this message.",cls:Ext.baseCSSPrefix+"html-editor-tip"}});let b=a.getLayout().overflowHandler;b.addComponentToMenu=c.createOverflowHandlerInterceptor(b.addComponentToMenu);return a},getToolbarCfg:function(){const b=this,a=b.callParent(arguments);a.listeners.click=function(b,a){if(a.className.indexOf("x-form-file-input")!==-1){return}b.preventDefault()};return a},async initFrameDoc(){const a=this;if(a.destroying||a.destroyed){return a.callParent(arguments)}a.editorHtmlTemplateTxt=await a.loadMarkup();return a.callParent(arguments)},async loadMarkup(){const b=coon.core.ThemeManager.getTheme(),a=coon.core.Environment.getPathForResource(coon.core.ConfigManager.get("extjs-app-webmail","resources.templates.html.editor"),"extjs-app-webmail"),d=await coon.core.Template.load(a);let c=d.render({theme:b});return c},getDocMarkup(){const a=this;if(a.editorHtmlTemplateTxt){return a.editorHtmlTemplateTxt}return ["<!DOCTYPE html>","<html><head>","<style type=\"text/css\">","</style></head><body></body></html>"].join("")},createOverflowHandlerInterceptor(a){"use strict";return Ext.Function.createInterceptor(a,function(c,b){if(b instanceof coon.comp.form.field.FileButton){return !1}})}});Ext.define("conjoon.cn_mail.view.mail.message.editor.AddressField",{extend:"Ext.form.field.Tag",requires:["conjoon.cn_mail.model.mail.message.EmailAddress"],alias:"widget.cn_mail-mailmessageeditoraddressfield",cls:"cn_mail-mailmessageeditoraddressfield",displayField:"name",valueField:"address",config:{addressType:undefined},store:{data:[],model:"conjoon.cn_mail.model.mail.message.EmailAddress"},queryMode:"local",forceSelection:!1,triggerOnClick:!1,createNewOnEnter:!0,hideTrigger:!0,createNewOnBlur:!1,initComponent:function(){var b=this,a=b.getAddressType();if(a==="cc"||a==="bcc"){b.tagItemTextCls=Ext.baseCSSPrefix+"tagfield-item-text x-fa "+a}b.callParent(arguments)}});Ext.define("conjoon.cn_mail.view.mail.message.editor.MessageEditor",{extend:"Ext.form.Panel",mixins:{deleteConfirmDialog:"conjoon.cn_mail.view.mail.mixin.DeleteConfirmDialog",loadingFailedDialog:"conjoon.cn_mail.view.mail.mixin.LoadingFailedDialog"},requires:["coon.comp.component.LoadMask","conjoon.cn_mail.view.mail.message.editor.AttachmentList","conjoon.cn_mail.view.mail.message.editor.MessageEditorViewController","conjoon.cn_mail.view.mail.message.editor.MessageEditorViewModel","conjoon.cn_mail.view.mail.message.editor.HtmlEditor","conjoon.cn_mail.view.mail.message.editor.AddressField","conjoon.cn_mail.model.mail.message.EmailAddress","conjoon.cn_mail.data.mail.message.session.MessageDraftSession","coon.comp.component.MessageMask","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey"],alias:"widget.cn_mail-mailmessageeditor",controller:"cn_mail-mailmessageeditorviewcontroller",viewModel:"cn_mail-mailmessageeditorviewmodel",isCnMessageEditor:!0,layout:{type:"vbox",align:"stretch"},margin:"0 5 14 0",bodyPadding:"8 8 8 8",cls:"cn_mail-mailmessageeditor shadow-panel",title:"Loading...",iconCls:"fa fa-spin fa-spinner",bind:{closable:"{!isMessageBodyLoading && !isSaving && !isSending}",title:"{!isMessageBodyLoading ? getSubject : \"Loading...\"}",iconCls:"{getSubject && !isSaving && !isSending && !isMessageBodyLoading ? \"fa fa-edit\" : \"fa fa-spin fa-spinner\"}"},closable:!1,buttonAlign:"right",editMode:"CREATE",busyMask:null,loadingMask:null,dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{xtype:"combobox",itemId:"accountCombo",flex:1,cls:"accountCombo",matchFieldWidth:!1,hideTrigger:!0,editable:!1,forceSelection:!0,queryMode:"local",bind:{disabled:"{!isPhantom}",store:"{mailAccountStore}",value:"{messageDraft.mailAccountId}"},labelWidth:50,fieldLabel:"Account",displayField:"name",valueField:"id",listConfig:{getInnerTpl:function(){return "{from.name} &lt;{from.address}&gt;"}},displayTpl:"<tpl for=\".\">{name}</tpl>"},"->",{xtype:"button",iconCls:"fa fa-envelope",cls:"seenButton",enableToggle:!0,bind:{pressed:"{messageDraft.seen}"}},{xtype:"button",iconCls:"fa fa-flag",cls:"flagButton",enableToggle:!0,bind:{pressed:"{messageDraft.flagged}"}},{width:213,xtype:"displayfield",cls:"lastSavedDateField",bind:{value:"{lastSavedMessage}"}},{scale:"small",text:"Save",width:108,itemId:"saveButton"},{scale:"small",text:"Send",itemId:"sendButton",width:108}]}],items:[{xtype:"container",margin:"0 0 12 0",layout:"hbox",items:[{flex:1,xtype:"cn_mail-mailmessageeditoraddressfield",emptyText:"To",itemId:"toField",bind:{value:"{getTo}",store:"{addressStore}"}},{xtype:"button",itemId:"showCcBccButton",cls:"showCcBccButton",text:"CC / BCC",bind:{hidden:"{isCcOrBccValueSet}"}}]},{xtype:"cn_mail-mailmessageeditoraddressfield",emptyText:"Cc",itemId:"ccField",addressType:"cc",bind:{hidden:{bindTo:"{!isCcOrBccValueSet}",single:!0},value:"{getCc}",store:"{addressStore}"}},{xtype:"cn_mail-mailmessageeditoraddressfield",emptyText:"Bcc",addressType:"bcc",itemId:"bccField",bind:{hidden:{bindTo:"{!isCcOrBccValueSet}",single:!0},value:"{getBcc}",store:"{addressStore}"}},{xtype:"textfield",emptyText:"Subject",cls:"subjectField",itemId:"subjectField",bind:{value:"{messageDraft.subject}"}},{xtype:"container",flex:1,margin:"12 0 0 0",layout:{type:"hbox",align:"stretch"},items:[{flex:1,xtype:"cn_mail-mailmessageeditorhtmleditor",bind:{value:"{messageDraft.messageBody.textHtml}"}},{xtype:"container",itemId:"attachmentListWrap",cls:"attachmentlist-wrap",layout:"fit",width:230,margin:"0 0 0 10",items:[{xtype:"box",autoEl:{tag:"div",cls:"dropzone-text",html:"Attach files by dragging and dropping them here."}},{flex:1,xtype:"cn_mail-mailmessageeditorattachmentlist",reference:"cn_mail_ref_mailmessageeditorattachmentlist",margin:"10 0 10 0",width:228,scrollable:"y",bind:{store:"{messageDraft.attachments}"}}]}]}],constructor:function(a){var c=this,d=conjoon.cn_mail.data.mail.message.EditingModes,b;if(!a||!a.messageDraft){Ext.raise({source:Ext.getClassName(this),msg:"argument \"config\" and \"config.messageDraft\" must be set."})}b=a.messageDraft;if(a.viewModel){Ext.raise({source:Ext.getClassName(this),msg:"Cannot set ViewModel for MessageEditor without overriding constructor."})}Ext.apply(a,{session:Ext.create("conjoon.cn_mail.data.mail.message.session.MessageDraftSession"),viewModel:{type:"cn_mail-mailmessageeditorviewmodel",messageDraft:b}});c.editMode=d.CREATE;if(b instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey){c.editMode=d.EDIT}else if(b instanceof conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest){c.editMode=b.getEditMode()}delete a.messageDraft;this.callParent(arguments)},initComponent:function(){var b=this,c=null,a=conjoon.cn_mail.data.mail.message.EditingModes,e=[a.CREATE,a.REPLY_TO,a.REPLY_ALL,a.FORWARD],d=function(a){Ext.each(a,function(b){if(b.xtype==="cn_mail-mailmessageeditorattachmentlist"){c=b;return !1}if(b.items){return d(b.items)}})};d(b.items);if(c){c.editMode=e.indexOf(b.editMode)!==-1?a.CREATE:a.EDIT}else {Ext.raise({sourceClass:Ext.getClassName(b),msg:"MessageEditor needs to have conjoon.cn_mail.view.mail.message.AttachmentList"})}b.callParent(arguments)},showCcBccFields:function(a){var b=this;a=a===undefined?!0:a;b.down("#ccField").setHidden(!a);b.down("#bccField").setHidden(!a);return this},setBusy:function(b){var d=this,a=d.busyMask,c=b===!1,f=!c?b.progress:undefined,g=!c?b.msg:undefined,e=!c?b.msgAction:undefined;if(b!==!1&&!Ext.isObject(b)){Ext.raise({conf:b,cls:Ext.getClassName(d),msg:"Argument \"conf\" must either be boolean=false or an "+"object suiting configuration options for "+"coon.comp.component.LoadMask"})}if(c&&!a){return this}if(!a&&!c){a=Ext.create("coon.comp.component.LoadMask",{msg:g,msgAction:e,glyphCls:"fa fa-envelope",target:d});d.busyMask=a}if(c){a.hide();return this}a.show();if(f===undefined){a.loopProgress()}if(f!==undefined){a.updateProgress(f)}if(e!==undefined){a.updateActionMsg(e)}if(g!==undefined){a.updateMsg(g)}return this},showAddressMissingNotice:function(d){var a=this,c,b;a.getViewModel().notify();b=a.getIconCls();c=Ext.create("coon.comp.component.MessageMask",{title:"Address Missing",message:"Could not send the message. Please specify one or more recipients.",target:a,buttons:coon.comp.component.MessageMask.OK,icon:coon.comp.component.MessageMask.ERROR,callback:function(c){var a=this;a.down("#toField").focus();a.setClosable(!0);a.setIconCls(b)},scope:a});a.setIconCls("fa fa-exclamation-circle");a.setClosable(!1);c.show()},showConfirmCloseDialog(){"use strict";const a=this;let c,b;a.getViewModel().notify();b=a.getIconCls();c=Ext.create("coon.comp.component.MessageMask",{title:"Close without saving",message:"Do you want to close the editor without saving your changes?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:function(c){const a=this;if(c==="noButton"){a.setClosable(!0);a.setIconCls(b);return}a.suspendEvent("beforeclose");a.close();a.resumeEvent("beforeclose")},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);c.show()},showSubjectMissingNotice:function(e,b){var a=this,d,c;a.getViewModel().notify();c=a.getIconCls();d=Ext.create("coon.comp.component.MessageMask",{title:"Subject Missing",message:"If you wish, you can specify a subject here before leaving it empty.",target:a,buttons:coon.comp.component.MessageMask.OKCANCEL,icon:coon.comp.component.MessageMask.QUESTION,input:{emptyText:"Subject"},callback:function(d,f){var a=this;if(d==="okButton"){e.set("subject",f)}a.setClosable(!0);a.setIconCls(c);if(b){b.apply(a,[d,f])}},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);d.show()},showMailMessageSaveFailedNotice:function(e,f,b){var a=this,d,c;a.getViewModel().notify();c=a.getIconCls();d=Ext.create("coon.comp.component.MessageMask",{title:"Saving Failed",message:"Saving the message failed. Do you want to retry to save the message?",target:a,buttons:coon.comp.component.MessageMask.YESNO,icon:coon.comp.component.MessageMask.QUESTION,callback:function(d,g){var a=this;a.setClosable(!0);a.setIconCls(c);if(b){b.apply(a,arguments)}},scope:a});a.setIconCls("fa fa-question-circle");a.setClosable(!1);d.show()},showMessageDraftLoadingNotice:function(b){var a=this;a.loadingMask=Ext.create("Ext.LoadMask",{target:a,bind:{hidden:b?"{isAccountAndFolderSet}":"{!isMessageBodyLoading}"},listeners:{hide:function(a){var c=this;c.loadingMask=null;a.destroy()},scope:this}});a.loadingMask.show()},getMessageDraft:function(){return this.getViewModel().get("messageDraft")},isDraftLoading:function(){const b=this,a=b.getViewModel();return !!(a.get("isMessageBodyLoading")||a.hasPendingCopyRequest()||a.loadingDraft)},hasLoadingFailed:function(){const a=this,b=a.getViewModel();return b.loadingFailed},showLoadingFailedDialog:function(){const a=this;a.setClosable(!0);a.mixins.loadingFailedDialog.showLoadingFailedDialog.call(a)}});Ext.define("conjoon.cn_mail.text.QueryStringParser",{parse:function(a){a=a+"";var d=/(\?|&)([^=]+)=([^&|^#]+)/g,b=null,c={};if(!Ext.String.startsWith(a,"?")){Ext.raise({text:a,msg:"\"text\" must start with a \"?\""})}while((b=d.exec(a))!==null){c[b[2]]=b[3]}return c}});Ext.define("conjoon.cn_mail.view.mail.MailDesktopViewController",{extend:"Ext.app.ViewController",requires:["conjoon.cn_mail.view.mail.message.reader.MessageView","conjoon.cn_mail.view.mail.message.editor.MessageEditor","conjoon.cn_mail.view.mail.message.editor.MessageEditorViewModel","conjoon.cn_mail.text.QueryStringParser","conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig","conjoon.cn_mail.data.mail.message.EditingModes","conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore"],alias:"controller.cn_mail-maildesktopviewcontroller",control:{"cn_mail-maildesktopview":{"tabchange":"onTabChange"},"cn_mail-maildesktopview > cn_mail-mailmessagereadermessageview":{"cn_mail-mailmessageitemread":"onMessageItemRead"},"cn_mail-mailmessagegrid":{"rowdblclick":"onMailMessageGridDoubleClick"},"cn_mail-mailmessagegrid #cn_mail-mailmessagegrid-refresh":{"click":"onMailMessageGridRefreshClick"},"cn_mail-mailmessageeditor":{"cn_mail-mailmessagesavecomplete":"onMailMessageSaveComplete","cn_mail-mailmessagesendcomplete":"onMailMessageSendComplete"},"cn_mail-maildesktopview > cn_mail-mailinboxview":{"cn_mail-beforemessageitemdelete":"onBeforeMessageItemDelete","cn_mail-messageitemmove":"onMessageItemMove"},"cn_mail-mailinboxview #btn-replyall":{"click":"onInboxViewReplyAllClick"},"cn_mail-mailinboxview #btn-reply":{"click":"onInboxViewReplyClick"},"cn_mail-mailinboxview #btn-forward":{"click":"onInboxViewForwardClick"},"cn_mail-mailinboxview #btn-editdraft":{"click":"onInboxViewEditDraftClick"}},mailInboxView:null,messageViewIdMap:null,parser:null,starvingEditors:null,defaultAccountInformations:null,constructor:function(){const a=this;a.messageViewIdMap={};a.callParent(arguments)},init(){this.configureWithMailFolderTreeStore()},configureWithMailFolderTreeStore(){const b=this,a=conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance();a.on("load",b.onMailFolderTreeStoreLoad,this);if(a.isLoaded()){a.getRootNode().childNodes.forEach(a=>{a.childNodes&&b.seedFolders(a.childNodes)})}},onBeforeMessageItemDelete:function(i,a,g=null){const f=this,e=f.getView(),c=a.isCompoundKeyConfigured()?a.getCompoundKey():null;if(!c){return !0}let d=f.getMessageItemsFromOpenedViews(c,!0);for(let b=0,h=d.length;b<h;b++){let c=d[b].view;if(c&&c!==g){e.showMessageCannotBeDeletedWarning(a);e.setActiveTab(c);return !1}}return !0},onMessageItemMove:function(j,a,h,i,d){const b=this;if(h!==j){b.getView().showMessageMovedInfo(a,i,d)}b.updateMessageItemsFromOpenedViews(a.getPreviousCompoundKey(),{"mailFolderId":d.get("id"),"id":a.get("id")});let e=b.getMessageItemsFromOpenedViews(a.getCompoundKey(),!0),c,g,f;for(c=0,g=e.length;c<g;c++){f=e[c].view;b.updateHistoryForMessageRelatedView(f,a)}},showMailEditor:function(b,g){const a=this,k=a.getView(),h=conjoon.cn_mail.data.mail.message.EditingModes,i="conjoon.cn_mail.data.mail.message.editor.MessageDraftCopyRequest",e=a.defaultAccountInformations;let f,c={messageDraft:null},j=a.getItemIdForMessageRelatedView(b,g),l=a.buildCnHref(b,g),d={};if(a.defaultAccountInformations){d.defaultMailAccountId=e.mailAccountId;d.defaultMailFolderId=e.mailFolderId}switch(g){case "edit":c.messageDraft=b;break;case "replyTo":c.messageDraft=Ext.create(i,Ext.apply({compoundKey:b,editMode:h.REPLY_TO},d));break;case "replyAll":c.messageDraft=Ext.create(i,Ext.apply({compoundKey:b,editMode:h.REPLY_ALL},d));break;case "forward":c.messageDraft=Ext.create(i,Ext.apply({compoundKey:b,editMode:h.FORWARD},d));break;default:c.messageDraft=a.createMessageDraftConfig(b,e?e:{});break;}f=k.down("#"+j);if(!f){f=k.add(Ext.apply(c,{xtype:"cn_mail-mailmessageeditor",margin:"12 5 5 0",itemId:j,cn_href:l}));if(!e&&g!=="edit"){if(!a.starvingEditors){a.starvingEditors=[]}a.starvingEditors.push(j)}}k.setActiveTab(f);return f},showMailAccountFor:function(c){const a=this,f=a.getView(),b=f.down("cn_mail-mailinboxview"),g=b.down("cn_mail-mailaccountview"),e=b.down("cn_mail-mailfoldertree"),d=e.getStore();if(d.isLoading()||d.getProxy().type==="memory"){b.mon(e,"load",Ext.Function.bind(a.processMailFolderSelectionForRouting,a,[c,null,!0]),a,{single:!0})}else {a.processMailFolderSelectionForRouting(c,null,!0)}f.setActiveTab(b);return g},showInboxViewFor:function(c,d){const a=this,g=a.getView(),b=g.down("cn_mail-mailinboxview"),f=b.down("cn_mail-mailfoldertree"),e=f.getStore();if(e.isLoading()||e.getProxy().type==="memory"){b.mon(f,"load",Ext.Function.bind(a.processMailFolderSelectionForRouting,a,[c,d]),a)}else {a.processMailFolderSelectionForRouting(c,d)}return g.setActiveTab(b)},processMailFolderSelectionForRouting:function(h,e,g=!1){const j=this,i=j.getView(),d=i.down("cn_mail-mailinboxview"),f=d.down("cn_mail-mailfoldertree");let a,c=f.getStore().getRoot().findChild("id",h,!1);if(!c){return !1}else if(g===!0&&e===null){a=c}else {a=c.findChild("id",e,!0);if(!a){return !1}}d.cn_href=a.toUrl();f.getSelectionModel().select(a);Ext.History.add(d.cn_href);let b=a.parentNode;while(b){b.expand();b=b.parentNode}return !0},showMailMessageViewFor:function(a){if(!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:a})}var d=this,e=d.getView(),g=d.getItemIdForMessageRelatedView(a,"read"),b=e.down("#"+g),f=e.down("cn_mail-mailmessagegrid"),c=f?f.getStore():null,h=c&&!c.isEmptyStore?c.findByCompoundKey(a):-1;if(!b){b=e.add({xtype:"cn_mail-mailmessagereadermessageview",itemId:g,cn_href:d.buildCnHref(a,"read"),margin:"12 5 5 0"});if(h>-1){b.setMessageItem(c.getAt(h))}else {b.loadMessageItem(a)}}d.getView().setActiveTab(b);return b},onMailMessageSendComplete:function(c,a){const b=this;b.getView().down("cn_mail-mailinboxview").updateViewForSentDraft(a)},onMailMessageSaveComplete:function(p,a,q,r,o){const g=this,j=g.getView(),c=j.down("cn_mail-mailmessagegrid"),n=c?c.getStore():null,i=j.down("cn_mail-mailinboxview"),h=i?i.down("cn_mail-mailmessagereadermessageview"):null;let k,l,e,f,m,b;b=a.getPreBatchCompoundKey();if(b){m=g.getItemIdForMessageRelatedView(b,"read");f=j.down("#"+m)}g.updateHistoryForMessageRelatedView(p,a);if(o){i.updateViewForCreatedDraft(a);return}let d=[];if(b){d.push(b)}if(h&&b){k=h.getViewModel().get("messageItem.localId");if(k===b.toLocalId()){h.updateMessageItem(a);d.push(a.getCompoundKey())}}if(c&&d.length){for(let b=d.length-1;b>=0;b--){e=n.findExact("localId",d[b].toLocalId());if(e>-1){break}}if(e>-1){l=n.getAt(e);let b=c.getSelectionModel().getSelected().getAt(0);if(b&&b.getId()===a.getId()){c.getSelectionModel().clearSelections();c.getSelectionModel().select(e)}conjoon.cn_mail.data.mail.message.reader.MessageItemUpdater.updateItemWithDraft(l,a)}}if(f){f.updateMessageItem(a);g.updateHistoryForMessageRelatedView(f,a)}},onMessageItemRead:function(b){var a=this;if(!a.mailInboxView){a.mailInboxView=a.getView().down("cn_mail-mailinboxview")}a.mailInboxView.getController().onMessageItemRead(b)},onMailMessageGridDoubleClick:function(c,a){var b=this;b.redirectTo(["cn_mail/message/read",conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey.fromRecord(a).toArray().join("/")].join("/"))},onTabChange:function(f,a,g,h){const c=this,d=a.getItemId();if(!a.cn_href){return}let b=!1;for(let e in c.messageViewIdMap){let i=c.messageViewIdMap[e];if(i.itemId===d&&i.deprecated===!0){b=!0;break}}if(b===!0){Ext.History.replace(a.cn_href)}else {Ext.History.add(a.cn_href)}},getItemIdForMessageRelatedView:function(a,c){const b=this;let d,e=b.checkArgumentsForEditorOrView(a,c);d="cn_mail-"+c+"-"+Ext.id();a=(e?a.toLocalId():a);a=b.computeIdForMessageViewMap(a,c);if(!b.messageViewIdMap[a]){b.messageViewIdMap[a]={itemId:d}}return b.messageViewIdMap[a].itemId},buildCnHref:function(a,b){const d=this;let c=d.checkArgumentsForEditorOrView(a,b);a=c?a.toArray().join("/"):a;switch(b){case "read":return "cn_mail/message/read/"+a;case "edit":return "cn_mail/message/edit/"+a;case "replyTo":return "cn_mail/message/replyTo/"+a;case "replyAll":return "cn_mail/message/replyAll/"+a;case "forward":return "cn_mail/message/forward/"+a;default:return "cn_mail/message/compose/"+a;}},createMessageDraftConfig:function(e,f={}){const i=this;if(!e||(!Ext.isString(e)&&!Ext.isNumber(e))){Ext.raise({key:e,msg:"\"id\" is not a valid value"})}let h,c,b,d,a=decodeURIComponent(e+"");if(Ext.String.startsWith(a,"mailto:",!0)){a=a.substring(7)}else {return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",f)}c="";if((h=a.indexOf("?"))!==-1){c=a.substring(0,h).split(",");a=a.substring(h)}else {c=a?a.split(","):[];a=""}if(!a){if(c&&c.length){return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",Ext.apply({to:c},f))}return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",f)}if(!i.parser){i.parser=Ext.create("conjoon.cn_mail.text.QueryStringParser")}b=i.parser.parse(a);for(var g in b){if(!Object.prototype.hasOwnProperty.call(b,g)){continue}d=!0;while(d){d=decodeURIComponent(b[g]);if(!d||(d===b[g])){break}b[g]=d}}if(Object.prototype.hasOwnProperty.call(b,"body")){b.textHtml=b.body;delete b.body}return Ext.create("conjoon.cn_mail.data.mail.message.editor.MessageDraftConfig",Ext.apply(Ext.apply({to:c},b),f))},updateHistoryForMessageRelatedView:function(a,b){const e=this,g=e.getView();let d=null;if(a){d=a.isCnMessageEditor?"edit":"read"}if(!(b instanceof conjoon.cn_mail.model.mail.message.AbstractMessageItem)){Ext.raise({msg:"\"messageItem\" must be an instance of conjoon.cn_mail.model.mail.message.AbstractMessageItem",messageItem:b})}let f=b.getCompoundKey(),c=e.buildCnHref(f,d);if(c===a.cn_href){return null}e.updateMessageViewIdMapForMessage(a,b,d);a.cn_href=c;if(g.getActiveTab()===a){Ext.History.suspendEvents();window.location.replace("#"+c);Ext.Function.defer(function(){Ext.History.resumeEvents()},500)}return c},updateMessageViewIdMapForMessage:function(a,g,i){const c=this,b=conjoon.cn_mail.data.mail.message.EditingModes;if(!a||(!a.isCnMessageEditor&&!a.isCnMessageView)){Ext.raise({msg:Ext.String.format("\"panel\" does not seem to be a MessageEditor or MessageView"),panel:a})}let e=[b.CREATE,b.EDIT,b.REPLY_TO,b.REPLY_ALL,b.FORWARD];if(a.isCnMessageEditor&&e.indexOf(a.editMode)===-1){Ext.raise({msg:Ext.String.format("'editMode' of Editor must be any of {0}",e.join(", ")),editor:a})}let f=g.getCompoundKey(),d=a.getItemId(),h=c.computeIdForMessageViewMap(f.toLocalId(),i);for(let j in c.messageViewIdMap){let b=c.messageViewIdMap[j];if(b.itemId===d){b.deprecated=!0}}c.messageViewIdMap[h]={itemId:d}},onInboxViewReplyClick:function(){this.redirectToEditorFromInboxMessageView("replyTo")},onInboxViewForwardClick:function(){this.redirectToEditorFromInboxMessageView("forward")},onInboxViewReplyAllClick:function(){this.redirectToEditorFromInboxMessageView("replyAll")},onInboxViewEditDraftClick:function(){this.redirectToEditorFromInboxMessageView("edit")},redirectToEditorFromInboxMessageView:function(c){const b=this,d=b.getCompoundKeyFromInboxMessageView(),a=["cn_mail/message/"+c,d.toArray().join("/")].join("/");b.redirectTo(a);return a},getCompoundKeyFromInboxMessageView:function(){let a=this.getView().down("cn_mail-mailinboxview").down("cn_mail-mailmessagereadermessageview").getViewModel().get("messageItem");return a.getCompoundKey()},getMessageItemsFromOpenedViews:function(d=null,h=!1){const j=this,g=j.getView(),b=h!==!0?g.down("cn_mail-mailinboxview").down("cn_mail-mailmessagereadermessageview"):null;let f=[],e=(b,a)=>f.push({view:b,messageItem:a}),c=b?b.getMessageItem():null;if(b&&c){if(d===null){e(b,c)}else if(!c.hasKeysModified()&&c.getCompoundKey().equalTo(d)){e(b,c)}}let i=g.items,a;i.each(function(b){a=null;if(b.isCnMessageView===!0){a=b.getMessageItem()}else if(b.isCnMessageEditor===!0){a=b.getMessageDraft()}if(!a||(d!==null&&(!a.isCompoundKeyConfigured()||!a.getCompoundKey().equalTo(d)))){return}e(b,a)});return f},updateMessageItemsFromOpenedViews:function(d,a,g){const h=this,e=h.getMessageItemsFromOpenedViews(d);if(!(d instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"\"compoundKey\" must be an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",compoundKey:d})}if(!Ext.isObject(a)){let b=a;a={};a[b]=g}let c,b,f;for(c=0,f=e.length;c<f;c++){b=e[c].messageItem;for(let f in a){if(!b.getField(f)){Ext.raise({msg:"cannot set field \""+f+"\" since it was not defined in the Model",field:f,messageItem:b})}b.set(f,a[f])}b.commit()}},checkArgumentsForEditorOrView:function(a,b){if(!a||(!Ext.isString(a)&&!Ext.isNumber(a)&&!(a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey))){Ext.raise({id:a,msg:"\"id\" is not a valid value"})}if(["edit","compose","replyTo","replyAll","forward","read"].indexOf(b)===-1){Ext.raise({type:b,msg:"\"type\" is not a valid value"})}let c=a instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey;if(b!=="compose"&&!c){Ext.raise({msg:"anything but \"compose\" expects an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",id:a,type:b})}return c},onMailFolderTreeStoreLoad:function(e,a,b,d){const c=this;if(!b||!a){return null}return c.seedFolders(a)},seedFolders(b){const a=this,d=a.getView(),c=conjoon.cn_mail.data.mail.folder.MailFolderTypes;if(!b.length||b[0].get("folderType")===c.ACCOUNT){return null}if(!a.defaultAccountInformations){let d=b[0].parentNode,e=d.findChild("folderType",c.DRAFT,!1);if(!e){Ext.raise({msg:"No suitable node found for saving drafts"})}a.defaultAccountInformations={mailAccountId:d.get("id"),mailFolderId:e.get("id")}}if(a.starvingEditors){let g,f,e,c=a.defaultAccountInformations;for(let h=a.starvingEditors.length-1;h>-1;h--){e=d.down("#"+a.starvingEditors.pop());f=e.getViewModel();if(f.hasPendingCopyRequest()){f.processPendingCopyRequest(c.mailAccountId,c.mailFolderId)}else {g=f.get("messageDraft");if(e.editMode!=="CREATE"){Ext.raise({msg:"Unexpected editMode for starving editor: "+e.editMode})}g.set({"mailAccountId":c.mailAccountId,"mailFolderId":c.mailFolderId},{dirty:!1})}}}return a.defaultAccountInformations},computeIdForMessageViewMap:function(b,a){return a+"-"+b},onMailMessageGridRefreshClick:function(){const d=this,c=d.getView(),a=c.down("cn_mail-mailmessagegrid"),b=a?a.getStore():null;if(b){b.reload()}}});Ext.define("conjoon.cn_mail.view.mail.MailDesktopViewModel",{extend:"Ext.app.ViewModel",requires:["conjoon.cn_mail.store.mail.folder.MailFolderTreeStore"],alias:"viewmodel.cn_mail-maildesktopviewmodel",stores:{"cn_mail_mailfoldertreestore":{type:"cn_mail-mailfoldertreestore",autoLoad:!0}},privates:{applyStores(a){if(a.cn_mail_mailfoldertreestore){const b=!!a.cn_mail_mailfoldertreestore;a.cn_mail_mailfoldertreestore=conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance();b&&a.cn_mail_mailfoldertreestore.load()}return this.callParent([a])}}});Ext.define("conjoon.cn_mail.view.mail.MailDesktopView",{extend:"Ext.tab.Panel",alias:"widget.cn_mail-maildesktopview",requires:["conjoon.cn_mail.view.mail.inbox.InboxView","conjoon.cn_mail.view.mail.MailDesktopViewController","conjoon.cn_mail.view.mail.MailDesktopViewModel","conjoon.cn_mail.data.mail.BaseSchema","coon.comp.window.Toast"],controller:"cn_mail-maildesktopviewcontroller",viewModel:"cn_mail-maildesktopviewmodel",layout:"fit",cls:"cn_mail-tab-panel",bodyCls:"cn_mail-tab-body",flex:1,margin:"10 10 10 10",maxTabWidth:240,items:[{margin:"12 0 0 0",xtype:"cn_mail-mailinboxview",cn_href:"cn_mail/home"}],showMailMessageViewFor:function(a){var b=this;b.getController().showMailMessageViewFor(a)},showMailEditor:function(b,a){var c=this;return c.getController().showMailEditor(b,a)},showInboxViewFor:function(a,b){const c=this;return c.getController().showInboxViewFor(a,b)},showMessageMovedInfo:function(c,b,a){return coon.Toast.info(Ext.String.format("The message was moved to the \"{0}\" folder.",a.get("name")))},showMessageCannotBeDeletedWarning:function(a){return coon.Toast.warn("Please close all related tabs to this message first.")},showMailAccountFor:function(a){const b=this;return b.getController().showMailAccountFor(a)}});Ext.define("conjoon.cn_mail.app.PackageController",{extend:"coon.core.app.PackageController",requires:["l8","conjoon.cn_mail.view.mail.MailDesktopView","conjoon.cn_mail.view.mail.message.editor.MessageEditor","conjoon.cn_mail.view.mail.message.reader.MessageView","conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.data.mail.BaseSchema","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore"],routes:{"cn_mail/message/compose/:id":{action:"onComposeMessageRoute",conditions:{":id":"([0-9]+$)"},before:"onBeforePackageRoute"},"cn_mail/message/compose/mailto%3A:id":{action:"onComposeMailtoMessageRoute",conditions:{":id":"(.+)"},before:"onBeforePackageRoute"},"cn_mail/message/edit/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onEditMessageRoute",before:"onBeforePackageRoute"},"cn_mail/message/replyTo/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onReplyToRoute",before:"onBeforePackageRoute"},"cn_mail/message/replyAll/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onReplyAllRoute",before:"onBeforePackageRoute"},"cn_mail/message/forward/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onForwardRoute",before:"onBeforePackageRoute"},"cn_mail/message/read/:mailAccountId/:mailFolderId/:id":{conditions:{":mailAccountId":"(.+)",":mailFolderId":"(.+)",":id":"(.+)"},action:"onReadMessageRoute",before:"onBeforePackageRoute"},"cn_mail/folder/:mailAccountId/:id":{action:"onMailFolderRoute",conditions:{":mailAccountId":"(.+)",":id":"(.+)"},before:"onBeforePackageRoute"},"cn_mail/account/:mailAccountId":{action:"onMailAccountRoute",conditions:{":mailAccountId":"(.+)"},before:"onBeforePackageRoute"},"cn_mail/home":{action:"onHomeTabRoute",before:"onBeforePackageRoute"}},control:{"cn_mail-maildesktopview":{tabchange:"onMailDesktopViewTabChange"},"cn_mail-maildesktopview > cn_mail-mailinboxview > cn_mail-mailfoldertree":{selectionchange:"onMailFolderTreeSelectionChange"},"cn_mail-maildesktopview > cn_mail-mailinboxview":{activate:"onMailInboxViewActivate",deactivate:"onMailInboxViewDeactivate"},"cn_mail-maildesktopview > cn_mail-mailinboxview > panel > container > cn_mail-mailmessagegrid":{deselect:"onMailMessageGridDeselect",select:"onMailMessageGridSelect","cn_mail-mailmessagegridbeforeload":"onMailMessageGridBeforeLoad","cn_mail-mailmessagegridload":"onMailMessageGridLoad"},"cn_navport-tbar > #cn_mail-nodeNavCreateMessage":{click:"onMessageComposeButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavEditMessage":{click:"onMessageEditButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavDeleteMessage":{click:"onMessageDeleteButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavReplyTo":{click:"onReplyToButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavReplyAll":{click:"onReplyAllButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavForward":{click:"onForwardButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavReadingPane > menu > menucheckitem":{checkchange:"onReadingPaneCheckChange"},"cn_navport-tbar > #cn_mail-nodeNavToggleList":{toggle:"onToggleListViewButtonClick"},"cn_navport-tbar > #cn_mail-nodeNavToggleFolder":{toggle:"onToggleFolderViewButtonClick"}},refs:[{ref:"mailDesktopView",selector:"cn_mail-maildesktopview"},{ref:"mailInboxView",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview"},{ref:"mailMessageGrid",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview > panel > container > cn_mail-mailmessagegrid"},{ref:"gridContainer",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview > panel > container > cn_mail-mailmessagegridcontainer"},{ref:"mailFolderTree",selector:"cn_mail-maildesktopview > cn_mail-mailinboxview > cn_mail-mailfoldertree"},{ref:"navigationToolbar",selector:"cn_navport-tbar"},{ref:"toggleGridListButton",selector:"cn_navport-tbar > #cn_mail-nodeNavToggleList"},{ref:"switchReadingPaneButton",selector:"cn_navport-tbar > #cn_mail-nodeNavReadingPane"},{ref:"replyToButton",selector:"cn_navport-tbar > #cn_mail-nodeNavReplyTo"},{ref:"replyAllButton",selector:"cn_navport-tbar > #cn_mail-nodeNavReplyAll"},{ref:"forwardButton",selector:"cn_navport-tbar > #cn_mail-nodeNavForward"},{ref:"editButton",selector:"cn_navport-tbar > #cn_mail-nodeNavEditMessage"},{ref:"deleteButton",selector:"cn_navport-tbar > #cn_mail-nodeNavDeleteMessage"}],observedMessageView:null,observedMessageEditor:null,init(b){"use strict";const c=this,a=b.getPackageConfig(c,"service.rest-api-email.base");if(!l8.isString(a)){throw ("no configured \"base\"-address found in the Package Configuration for \"conjoon.cn_mail.data.mail.BaseSchema\"")}Ext.data.schema.Schema.get("cn_mail-mailbaseschema").setUrlPrefix(l8.unify(a,"/","://"))},onMailDesktopViewTabChange:function(c,b){const a=this;if(a.observedMessageView){a.observedMessageView.un("cn_mail-messageitemload",a.onMailMessageItemLoadForActivatedView,a)}if(a.observedMessageEditor){a.observedMessageEditor.un("cn_mail-messagedraftload",a.messageEditorIsActivatedTab,a)}if(b===a.getMailInboxView()){return !1}a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0);if(b.isCnMessageEditor){if(b.isDraftLoading()){a.observedMessageEditor=b.on("cn_mail-messagedraftload",a.messageEditorIsActivatedTab,a,{single:!0})}else if(b.hasLoadingFailed()!==!0){a.messageEditorIsActivatedTab()}}else if(b.isCnMessageView){if(b.loadingItem){a.observedMessageView=b.on("cn_mail-messageitemload",a.onMailMessageItemLoadForActivatedView,a,{single:!0})}else {a.onMailMessageItemLoadForActivatedView(b)}}return !0},disableEmailEditButtons:function(b,a){const c=this,e=c.getEditButton(),d=c.getDeleteButton();if(arguments.length===1){a=b}e.setDisabled(b);d.setDisabled(a)},disableEmailActionButtons:function(a){const b=this,e=b.getReplyToButton(),c=b.getReplyAllButton(),d=b.getForwardButton();e.setDisabled(a);c.setDisabled(a);d.setDisabled(a)},activateButtonsForMessageGrid:function(){const a=this,b=a.getMailMessageGrid().getSelection();if(b.length){a.activateButtonsForMessageItem(b[0])}else {a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)}},activateButtonsForMessageItem:function(c){const a=this,b=c.get("draft");switch(b){case !0:a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!1,!1);break;default:a.disableEmailActionButtons(!1);a.disableEmailEditButtons(!0,!1);break;}},onMailInboxViewActivate:function(h){const a=this,f=conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT;let e=!1,c=!1,d=a.getMailFolderTree().getSelection(),g=d.length&&d[0].get("folderType"),b=g===f;if(d.length===0||b){e=!0;c=!0;if(b){a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)}}else if(a.getMailMessageGrid().getStore().isLoading()){c=!0}if(!b){a.activateButtonsForMessageGrid()}a.getToggleGridListButton().setDisabled(c);a.getSwitchReadingPaneButton().setDisabled(e)},onMailInboxViewDeactivate:function(b){var a=this;a.getToggleGridListButton().setDisabled(!0);a.getSwitchReadingPaneButton().setDisabled(!0)},onMailMessageGridBeforeLoad:function(b){var a=this;a.getToggleGridListButton().setDisabled(!0)},onMailMessageGridLoad:function(b){var a=this;if(a.getMailDesktopView().getLayout().getActiveItem()!==a.getMailInboxView()){return}a.getToggleGridListButton().setDisabled(!1)},onToggleFolderViewButtonClick:function(d,b){var c=this,a=c.getMailFolderTree();if(b){a.show()}else {a.hide()}},onToggleListViewButtonClick:function(d,b){var c=this,a=c.getMailMessageGrid();a.enableRowPreview(!b)},onReadingPaneCheckChange:function(b,c){if(!c){return}var d=this,a=d.getMailInboxView();b=b.getItemId();switch(b){case "right":return a.toggleReadingPane("right");case "bottom":return a.toggleReadingPane("bottom");case "hide":return a.toggleReadingPane();}},onMailFolderTreeSelectionChange:function(d,b){const a=this;if(b.length>1){Ext.raise({records:b,msg:"unexpected multiple records"})}let c=b.length<=0||b[0].get("folderType")===conjoon.cn_mail.data.mail.folder.MailFolderTypes.ACCOUNT;a.getSwitchReadingPaneButton().setDisabled(c);a.getToggleGridListButton().setDisabled(c);if(c){a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)}else {a.activateButtonsForMessageGrid()}},onMailMessageGridDeselect:function(b,c){const a=this;if(a.getMailDesktopView().getActiveTab()!==a.getMailInboxView()){return}a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0)},onMailMessageGridSelect:function(c,a){const b=this;b.activateButtonsForMessageItem(a)},onHomeTabRoute:function(){var b=this,a=b.getMainPackageView();a.setActiveTab(a.down("cn_mail-mailinboxview"))},onReadMessageRoute:function(c,d,f){const a=this,b=a.getMainPackageView(),e=a.createCompoundKeyFromUrlFragments(c,d,f);b.showMailMessageViewFor(e)},onMailAccountRoute:function(b){const c=this,a=c.getMainPackageView();a.showMailAccountFor(decodeURI(b))},onMailFolderRoute:function(b,c){const d=this,a=d.getMainPackageView();a.showInboxViewFor(decodeURI(b),decodeURI(c))},onComposeMessageRoute:function(a){this.showMailEditor(a,"compose")},onComposeMailtoMessageRoute:function(a){a="mailto%3A"+a;this.showMailEditor(a,"compose")},onMessageComposeButtonClick:function(a){this.showMailEditor(Date.now(),"compose")},onEditMessageRoute:function(b,c,d){const a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"edit")},onReplyToRoute:function(b,c,d){const a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"replyTo")},onReplyAllRoute:function(b,c,d){const a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"replyAll")},onForwardRoute:function(b,c,d){const a=this;a.showMailEditor(a.createCompoundKeyFromUrlFragments(b,c,d),"forward")},onMessageEditButtonClick:function(c){const a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"edit")},onMessageDeleteButtonClick:function(c){const a=this,b=a.getItemOrDraftFromActiveView();if(b===null){Ext.raise("Unexpected null-value for item.")}a.getMailInboxView().getController().moveOrDeleteMessage(b,!1,a.getMailDesktopView().getActiveTab())},onReplyToButtonClick:function(c){const a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"replyTo")},onReplyAllButtonClick:function(c){const a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"replyAll")},onForwardButtonClick:function(c){const a=this,b=a.getCompoundKeyFromGridOrMessageView();a.showMailEditor(b,"forward")},postLaunchHook:function(){conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance().load();return {navigation:[{text:"Email",route:"cn_mail/home",view:"conjoon.cn_mail.view.mail.MailDesktopView",iconCls:"fas fa-paper-plane",nodeNav:[{xtype:"button",iconCls:"fas fa-plus",itemId:"cn_mail-nodeNavCreateMessage"},{xtype:"tbseparator"},{xtype:"button",iconCls:"fas fa-reply",disabled:!0,itemId:"cn_mail-nodeNavReplyTo"},{xtype:"button",iconCls:"fas fa-reply-all",itemId:"cn_mail-nodeNavReplyAll",disabled:!0},{xtype:"button",iconCls:"fas fa-share",itemId:"cn_mail-nodeNavForward",disabled:!0},{xtype:"button",iconCls:"fas fa-edit",itemId:"cn_mail-nodeNavEditMessage",disabled:!0},{xtype:"button",iconCls:"fas fa-trash",itemId:"cn_mail-nodeNavDeleteMessage",disabled:!0},{xtype:"tbseparator"},{xtype:"button",iconCls:"far fa-folder",disabled:!1,cls:"toggleFolderViewBtn",itemId:"cn_mail-nodeNavToggleFolder",enableToggle:!0,pressed:!0},{xtype:"button",iconCls:"fas fa-list",disabled:!0,cls:"toggleGridViewBtn",itemId:"cn_mail-nodeNavToggleList",enableToggle:!0},{xtype:"button",disabled:!0,iconCls:"fas fa-columns",itemId:"cn_mail-nodeNavReadingPane",menu:[{iconCls:"fas fa-toggle-right",text:"Right",itemId:"right",checked:!0,xtype:"menucheckitem",group:"cn_mail-nodeNavReadingPaneRGroup"},{iconCls:"fas fa-toggle-down",text:"Bottom",itemId:"bottom",xtype:"menucheckitem",group:"cn_mail-nodeNavReadingPaneRGroup"},{iconCls:"fas fa-close",text:"Hidden",itemId:"hide",xtype:"menucheckitem",group:"cn_mail-nodeNavReadingPaneRGroup"}]}]}]}},getMainPackageView:function(){var b=this,a=b.getApplication();return a.activateViewForHash("cn_mail/home")},privates:{getItemOrDraftFromActiveView:function(){const b=this,a=b.getMailDesktopView().getActiveTab();if(a instanceof conjoon.cn_mail.view.mail.message.editor.MessageEditor){return a.getMessageDraft()}else if(a instanceof conjoon.cn_mail.view.mail.message.reader.MessageView){return a.getMessageItem()}else if(a===b.getMailInboxView()){return b.getMailMessageGrid().getSelection()[0]}return null},getCompoundKeyFromGridOrMessageView:function(){const b=this,a=b.getMailDesktopView().getActiveTab();if(a instanceof conjoon.cn_mail.view.mail.message.reader.MessageView){return a.getMessageItem().getCompoundKey()}else if(a===b.getMailInboxView()){return b.getMailMessageGrid().getSelection()[0].getCompoundKey()}return null},onMailMessageItemLoadForActivatedView:function(c,b){const a=this;if(!b){b=c.getViewModel().get("messageItem")}if(b.get("draft")){a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!1,!1)}else {a.disableEmailActionButtons(!1);a.disableEmailEditButtons(!0,!1)}a.observedMessageView=null},showMailEditor:function(b,a){var d=this,c=d.getMainPackageView();if(a!=="compose"&&!(b instanceof conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey)){Ext.raise({msg:"anything but \"compose\" expects an instance of conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey",key:b,type:a})}c.showMailEditor(b,a)}},createCompoundKeyFromUrlFragments:function(a,b,c){return conjoon.cn_mail.data.mail.message.compoundKey.MessageEntityCompoundKey.createFor(decodeURIComponent(a),decodeURIComponent(b),decodeURIComponent(c))},messageEditorIsActivatedTab:function(){const a=this;a.disableEmailActionButtons(!0);a.disableEmailEditButtons(!0,!1)}});Ext.define("conjoon.cn_mail.data.mail.MailboxRunner",{requires:["l8","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore","conjoon.cn_mail.data.mail.folder.MailFolderTypes","conjoon.cn_mail.model.mail.message.MessageItem","conjoon.cn_mail.data.mail.service.MailboxService"],interval:120000,constructor(a){a=a||{};const c=this,b=a.mailFolderTreeStore;delete a.mailFolderTreeStore;Object.assign(c,a);if(b){this.init(b)}},init(a){"use strict";const b=this;if(b.mailFolderTreeStore){throw new Error("MailboxRunner was already initialized")}if(!(a instanceof conjoon.cn_mail.store.mail.folder.MailFolderTreeStore)){throw new Error("\"treeStore\" must be an instance of conjoon.cn_mail.store.mail.folder.MailFolderTreeStore")}b.mailFolderTreeStore=a;a.on("load",b.onMailFolderTreeStoreLoad,b);if(a.isLoaded()){const c=a.getRoot().childNodes;c&&c.forEach(c=>b.createSubscription(c))}},createSubscription(a){"use strict";const c=this;if(c.getSubscription(a)){return !1}const b=conjoon.cn_mail.data.mail.folder.MailFolderTypes;if(a.get("folderType")!==b.ACCOUNT){throw new Error(`The folderType of the passed node must be ${b.ACCOUNT}`)}if(a.childNodes.length===0){throw new Error("need at least one child node to subscribe to")}const d=a.findChild("folderType",b.INBOX,!1);if(!d){throw new Error("no INBOX node found for creating a subscription")}const e=c.addSubscription(a,{folder:d});c.start(a);return e},async visitSubscription(a){"use strict";const e=this,f=a.get("mailAccountId"),g=a.get("id"),d=a.get("uidNext"),b=conjoon.cn_mail.model.mail.message.MessageItem.getProxy(),i=[{property:"mailAccountId",value:f},{property:"mailFolderId",value:g}],c=[{property:"recent",value:!0,operator:"="}];if(d){c.push({property:"id",value:d,operator:">="})}const j=b.assembleUrl(Ext.create("Ext.data.Request",{action:"read",params:{filter:JSON.stringify(i)}}));const h=b.getDefaultParameters("ListMessageItem");Ext.Ajax.request({method:"get",action:"read",url:j,headers:b.headers,params:Object.assign(h,{filter:JSON.stringify(c)})}).then(e.onSubscriptionResponseAvailable.bind(e,a))},start(c){"use strict";const b=this,a=b.getSubscription(c);if(!a){return !1}if(!a.extjsTask){a.extjsTask=Ext.TaskManager.start({run:b.visitSubscription,fireOnStart:!1,scope:b,args:[a.folder],interval:b.interval})}return a},stop(c){"use strict";const b=this,a=b.getSubscription(c);if(!a){return !1}if(a.extjsTask){Ext.TaskManager.stop(a.extjsTask,!0);delete a.extjsTask}delete b.subscriptions[b.getSubscriptionId(c)];return a},pause(b){"use strict";const c=this,a=c.getSubscription(b);if(!a||!a.extjsTask){return !1}if(a.extjsTask){Ext.TaskManager.stop(a.extjsTask,!1)}return a},resume(b){"use strict";const c=this,a=c.getSubscription(b);if(!a||!a.extjsTask){return !1}if(a.extjsTask&&a.extjsTask.stopped){Ext.TaskManager.start(a.extjsTask,!1)}return a},onMailFolderTreeStoreLoad(e,a,b){"use strict";if(!b){return}const d=this;const c=conjoon.cn_mail.data.mail.folder.MailFolderTypes;if(a[0].get("folderType")===c.ACCOUNT){return}d.createSubscription(a[0].parentNode)},initSubscriptions(){"use strict";const a=this;if(!a.subscriptions){a.subscriptions={}}},getSubscription(b){"use strict";const a=this;a.initSubscriptions();const c=a.getSubscriptionId(b);return a.subscriptions[c]},addSubscription(c,b){"use strict";const a=this;a.initSubscriptions();const d=a.getSubscriptionId(c);a.subscriptions[d]=b;return b},getSubscriptionId(a){"use strict";if(l8.isObject(a)&&l8.isFunction(a.get)){return a.get("id")}if(!l8.isString(a)){throw new Error("Unexpected type for \"mailAccount\" submitted")}return a},destroy(){const a=this;if(a.mailFolderTreeStore){a.mailFolderTreeStore.un("load",a.onMailFolderTreeStoreLoad,a)}if(a.subscriptions){Object.keys(a.subscriptions).forEach(b=>a.stop(b))}delete a.subscriptions;a.callParent(arguments)},onSubscriptionResponseAvailable(d,e){const g=conjoon.cn_mail.model.mail.message.MessageItem.getProxy(),f=g.getReader();const c=f.read(e);if(c.getRecords().length){const b=conjoon.cn_mail.data.mail.service.MailboxService.recentMessageItemKeys;const a=c.getRecords().filter(a=>{const c=a.getCompoundKey().toString();if(!b.has(c)){b.add(c);a.set("recent",!0,{dirty:!1});return !0}return !1});if(a.length){Ext.fireEvent("conjoon.cn_mail.event.NewMessagesAvailable",d,a);return a}}return !1}});Ext.define("conjoon.cn_mail.app.plugin.NewMessagesNotificationPlugin",{extend:"coon.core.app.plugin.ControllerPlugin",requires:["l8","coon.user.Manager","conjoon.cn_mail.store.mail.folder.MailFolderTreeStore","conjoon.cn_mail.data.mail.MailboxRunner","coon.comp.window.Toast","coon.core.Environment","conjoon.cn_mail.data.mail.service.MailFolderHelper","conjoon.cn_mail.app.PackageController"],interval:120000,run(b){"use strict";if(!coon.user.Manager.getUser()){return !1}if(!(b instanceof conjoon.cn_mail.app.PackageController)){throw new Error("\"controller\" must be an instance of conjoon.cn_mail.app.PackageController")}const a=this,c=conjoon.cn_mail.store.mail.folder.MailFolderTreeStore.getInstance();a.controller=b;a.mailboxRunner=Ext.create("conjoon.cn_mail.data.mail.MailboxRunner",{mailFolderTreeStore:c,interval:a.interval});b.listen({global:{"conjoon.cn_mail.event.NewMessagesAvailable":{fn:a.onNewMessagesAvailable,scope:a}}});b.control({"cn_mail-mailmessagegrid":{"cn_mail-mailmessagegridload":{fn:a.onMessageGridLoad,scope:a}}});return !0},onNewMessagesAvailable(b,d){const a=this,e=d.length;if(!e){return null}const c=a.getNotificationText(b,e);coon.Toast.info(c);a.showNotification(b,c);a.playSound();a.updateMessageGridWithRecentMessages(b,d);return !0},onMessageGridLoad(h,f){const a=this,g=a.controller,c=conjoon.cn_mail.MailboxService.recentMessageItemKeys,e=g.getMailInboxView().getController(),d=e.getSelectedMailFolder(),b=f.filter(a=>a.get("recent")===!0&&!c.has(a.getCompoundKey().toString()));if(!b.length){return null}b.forEach(a=>{c.add(a.getCompoundKey().toString())});a.showNotification(d,a.getNotificationText(d,b.length));a.playSound();return !0},updateMessageGridWithRecentMessages(e,d){const c=this,f=c.controller,a=f.getMailInboxView().getController(),b=a.getLivegrid();if(a.getSelectedMailFolder()!==e){return !1}d.forEach(a=>{if(b.getRecordByCompoundKey(a.getCompoundKey())){return}b.add(a);a.join(c.controller.getMailMessageGrid().getStore())});return !0},playSound(){const a=this;if(!a.audio){const d=a.getResource("soundFile");if(!d){return null}a.audio=new Audio(d)}const c=a.audio;const b=c.play();if(b!==undefined){b.then(()=>{}).catch(a=>{})}return c},showNotification(e,f){if(Notification.permission==="denied"){return null}const a=this,c=a.getResource("iconFile"),d={};if(c){d.icon=c}let b=new Notification(`${a.controller.getApplication().getName()} - new email`,Object.assign({body:f},d));b.onclick=function(){window.focus();a.controller.redirectTo(e.toUrl());this.close()};return b},getNotificationText(b,a){return `${conjoon.cn_mail.MailFolderHelper.getInstance().getAccountNode(b.get("mailAccountId")).get("name")} has ${a} new message${a>1?"s":""}`},getResource(a){const b=this,c=["iconFile","soundFile"];if(!c.includes(a)){throw new Error(`"type" must be one of ${c.join(", ")}`)}if(b[a]!==undefined){return b[a]}const d=b.getConfig();b[a]=l8.unchain(`resources.${a==="soundFile"?"sounds":"images"}.notifications.newEmail`,d,undefined);if(b[a]){b[a]=coon.core.Environment.getPathForResource(b[a],"extjs-app-webmail");return b[a]}return null},getConfig(){const a=this;return a.controller.getApplication().getPackageConfig(a.controller)}});Ext.define("conjoon.cn_mail.data.mail.message.compoundKey.AttachmentItemCompoundKey",{extend:"conjoon.cn_mail.data.mail.message.compoundKey.MessageItemChildCompoundKey"});